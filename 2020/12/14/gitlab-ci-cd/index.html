<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"horus-k.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"remove","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="安装docker1234567891011docker run \    --detach \    --hostname gitlab.qh.com \    --publish 2222:22 \    --publish 80:80 \    --name gitlab \    --restart unless-stopped \    -v &#x2F;data&#x2F;gitlab&#x2F;etc:&#x2F;etc&#x2F;g">
<meta property="og:type" content="article">
<meta property="og:title" content="GitLab-CI&#x2F;CD">
<meta property="og:url" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/index.html">
<meta property="og:site_name" content="Q&#39;s blog">
<meta property="og:description" content="安装docker1234567891011docker run \    --detach \    --hostname gitlab.qh.com \    --publish 2222:22 \    --publish 80:80 \    --name gitlab \    --restart unless-stopped \    -v &#x2F;data&#x2F;gitlab&#x2F;etc:&#x2F;etc&#x2F;g">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/image-20201229194148698.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/02.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/03.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/04.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/05.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/06.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/05.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/07.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/08.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/17.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/18.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/09.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/10.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/11.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/12.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/19.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/13.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/14.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/15.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/16.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/20.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/22.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/21.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/23.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/24.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/25.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/26.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/27.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/28.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/30.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/29.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/31.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/32.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/33.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/38.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/34.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/35.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/36.png">
<meta property="og:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/003.png">
<meta property="article:published_time" content="2020-12-14T02:12:33.000Z">
<meta property="article:modified_time" content="2021-01-19T11:01:21.068Z">
<meta property="article:author" content="屈辉">
<meta property="article:tag" content="gitlab">
<meta property="article:tag" content="ci&#x2F;cd">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/image-20201229194148698.png">


<link rel="canonical" href="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://horus-k.github.io/2020/12/14/gitlab-ci-cd/","path":"2020/12/14/gitlab-ci-cd/","title":"GitLab-CI/CD"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>GitLab-CI/CD | Q's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Q's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一些个人文档笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">124</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">45</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">265</span></a></li><li class="menu-item menu-item-ceph"><a href="/ceph/" rel="section"><i class="address-book fa-fw"></i>ceph</a></li><li class="menu-item menu-item-k8s"><a href="/categories/k8s/" rel="section"><i class="archive fa-fw"></i>k8s</a></li><li class="menu-item menu-item-network"><a href="/network/" rel="section"><i class="archive fa-fw"></i>network</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="屈辉">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Q's blog">
      <meta itemprop="description" content="开心就好">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="GitLab-CI/CD | Q's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GitLab-CI/CD
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-14 10:12:33" itemprop="dateCreated datePublished" datetime="2020-12-14T10:12:33+08:00">2020-12-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-01-19 19:01:21" itemprop="dateModified" datetime="2021-01-19T19:01:21+08:00">2021-01-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>35k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a><strong>docker</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    --detach \</span><br><span class="line">    --hostname gitlab.qh.com \</span><br><span class="line">    --publish <span class="number">2222</span>:<span class="number">22</span> \</span><br><span class="line">    --publish <span class="number">80</span>:<span class="number">80</span> \</span><br><span class="line">    --name gitlab \</span><br><span class="line">    --restart unless-stopped \</span><br><span class="line">    -v <span class="regexp">/data/gi</span>tlab<span class="regexp">/etc:/</span>etc/gitlab \</span><br><span class="line">    -v <span class="regexp">/data/gi</span>tlab<span class="regexp">/log:/</span>var<span class="regexp">/log/gi</span>tlab \</span><br><span class="line">    -v <span class="regexp">/data/gi</span>tlab<span class="regexp">/data:/</span>var<span class="regexp">/opt/gi</span>tlab \</span><br><span class="line">    gitlab/gitlab-ce:<span class="number">13.6</span>.<span class="number">3</span>-ce.<span class="number">0</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a><strong>k8s</strong></h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">gitlab</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">devops</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">gitlab/gitlab-ce:12.9.0-ce.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">30088</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">22</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/users/sign_in</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">30088</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">12</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/users/sign_in</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">30088</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">12</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab-conf</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/gitlab</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab-log</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log/gitlab</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/opt/gitlab</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab_HOME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/var/lib/gitlab</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab-conf</span></span><br><span class="line">          <span class="attr">hostPath:</span> </span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/devops/gitlab/config</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab-log</span></span><br><span class="line">          <span class="attr">hostPath:</span> </span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/devops/gitlab/logs</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gitlab-data</span></span><br><span class="line">          <span class="attr">hostPath:</span> </span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/devops/gitlab/data</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">30088</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">30088</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30088</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">slave</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">22</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">22</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30022</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">   <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">   <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"> <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">   <span class="attr">resources:</span> [<span class="string">&quot;pods/exec&quot;</span>]</span><br><span class="line">   <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"> <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">   <span class="attr">resources:</span> [<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">   <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"> <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">   <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">   <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"> <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">gitlab</span></span><br><span class="line">   <span class="attr">namespace:</span> <span class="string">devops</span></span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a><strong>配置</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/gitlab/gitlab.rb</span><br><span class="line">external_url <span class="string">&#x27;http://&#123;Host-ip&#125;:30088&#x27;</span>   <span class="comment">#gitlabUrl</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 30022  <span class="comment">#ssh端口</span></span><br></pre></td></tr></table></figure>

<h1 id="GitLab-Runner"><a href="#GitLab-Runner" class="headerlink" title="GitLab-Runner"></a>GitLab-Runner</h1><p><strong>简介</strong></p>
<p>GitLab Runner是一个开源项目，用于运行您的作业并将结果发送回GitLab。它与<a target="_blank" rel="noopener" href="https://about.gitlab.com/product/continuous-integration/">GitLab CI</a>结合使用，<a target="_blank" rel="noopener" href="https://about.gitlab.com/product/continuous-integration/">GitLab CI</a>是<a target="_blank" rel="noopener" href="https://about.gitlab.com/product/continuous-integration/">GitLab</a>随附的用于协调作业的开源持续集成服务。</p>
<h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><ul>
<li><p>GitLab Runner是用<a target="_blank" rel="noopener" href="https://golang.org/">Go</a>编写的，可以作为一个二进制文件运行，不需要特定于语言的要求。它旨在在GNU &#x2F; Linux，macOS和Windows操作系统上运行。只要您可以在其他操作系统上编译Go二进制文件，其他操作系统就可能会运行。</p>
</li>
<li><p>如果要<a target="_blank" rel="noopener" href="https://docs.gitlab.com/12.8/runner/executors/docker.html">使用Docker</a>，请安装最新版本。GitLab Runner需要最少的Docker <code>v1.13.0</code>。</p>
</li>
<li><p>GitLab Runner版本应与GitLab版本同步。尽管较旧的Runner仍可以使用较新的GitLab版本，反之亦然，但在某些情况下，如果版本存在差异，则功能可能不可用或无法正常工作。在次要版本更新之间可以保证向后兼容性，但是请注意，GitLab的次要版本更新会引入新功能，这些新功能将要求Runner在同一次要版本上使用。</p>
</li>
</ul>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ul>
<li>允许运行：<ul>
<li>同时执行多个作业。</li>
<li>对多个服务器（甚至每个项目）使用多个令牌。</li>
<li>限制每个令牌的并行作业数。</li>
</ul>
</li>
<li>可以运行作业：<ul>
<li>在本地。</li>
<li>使用Docker容器。</li>
<li>使用Docker容器并通过SSH执行作业。</li>
<li>使用Docker容器在不同的云和虚拟化管理程序上自动缩放。</li>
<li>连接到远程SSH服务器。</li>
</ul>
</li>
<li>用Go编写并以单个二进制文件的形式分发，而没有其他要求。</li>
<li>支持Bash，Windows Batch和Windows PowerShell。</li>
<li>在GNU &#x2F; Linux，macOS和Windows（几乎可以在任何可以运行Docker的地方）上运行。</li>
<li>允许自定义作业运行环境。</li>
<li>自动重新加载配置，无需重启。</li>
<li>易于使用的设置，并支持Docker，Docker-SSH，Parallels或SSH运行环境。</li>
<li>启用Docker容器的缓存。</li>
<li>易于安装，可作为GNU &#x2F; Linux，macOS和Windows的服务。</li>
<li>嵌入式Prometheus指标HTTP服务器。</li>
<li>裁判工作者监视Prometheus度量标准和其他特定于工作的数据并将其传递给GitLab。</li>
</ul>
<img src="/2020/12/14/gitlab-ci-cd/image-20201229194148698.png" alt="image-20201229194148698" style="zoom:67%;">

<h2 id="安装注册"><a href="#安装注册" class="headerlink" title="安装注册"></a>安装注册</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="params">--rm</span> -t -id -v ~<span class="string">/data/gitlab-runner/config</span>:<span class="string">/etc/gitlab-runner</span> gitlab/gitlab-runner<span class="function">:v13.7.0</span></span><br><span class="line"></span><br><span class="line">gitlab-runner register \</span><br><span class="line">  <span class="params">--non-interactive</span> \</span><br><span class="line">  <span class="params">--executor</span> <span class="string">&quot;shell&quot;</span> \</span><br><span class="line">  <span class="params">--url</span> <span class="string">&quot;http://172.12.1.10:30088/&quot;</span> \</span><br><span class="line">  <span class="params">--registration-token</span> <span class="string">&quot;z5Lffq2a91xNt37S2y1d&quot;</span> \</span><br><span class="line">  <span class="params">--description</span> <span class="string">&quot;devops-runner&quot;</span> \</span><br><span class="line">  <span class="params">--tag-list</span> <span class="string">&quot;build,deploy&quot;</span> \</span><br><span class="line">  <span class="params">--run-untagged=</span><span class="string">&quot;true&quot;</span> \</span><br><span class="line">  <span class="params">--locked=</span><span class="string">&quot;false&quot;</span> \</span><br><span class="line">  <span class="params">--access-level=</span><span class="string">&quot;not_protected&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner verify #检查runner</span><br></pre></td></tr></table></figure>



<h1 id="Pipeline-基础语法"><a href="#Pipeline-基础语法" class="headerlink" title="Pipeline 基础语法"></a>Pipeline 基础语法</h1><h2 id="job"><a href="#job" class="headerlink" title="job"></a>job</h2><p>在每个项目中，我们使用名为<code>.gitlab-ci.yml</code>的YAML文件配置GitLab CI &#x2F; CD 管道。</p>
<ul>
<li>可以定义一个或多个作业(job)。</li>
<li>每个作业必须具有唯一的名称（不能使用关键字）。</li>
<li>每个作业是独立执行的。</li>
<li>每个作业至少要包含一个script。</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">job1:</span></span><br><span class="line"><span class="symbol">  script:</span> <span class="string">&quot;execute-script-for-job1&quot;</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">job2:</span></span><br><span class="line"><span class="symbol">  script:</span> <span class="string">&quot;execute-script-for-job2&quot;</span></span><br></pre></td></tr></table></figure>

<p>注释： 这里在pipeline中定义了两个作业，每个作业运行不同的命令。命令可以是shell或脚本。</p>
<h2 id="script"><a href="#script" class="headerlink" title="script"></a>script</h2><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">job</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uname -a</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle exec rspec</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>有时， <code>script</code>命令将需要用单引号或双引号引起来. 例如，包含冒号命令（ <code>:</code> ）需要加引号，以便被包裹的YAML解析器知道来解释整个事情作为一个字符串，而不是一个”键：值”对. 使用特殊字符时要小心： <code>:</code> ， <code>&#123;</code> ， <code>&#125;</code> ， <code>[</code> ， <code>]</code> ， <code>,</code> ， <code>&amp;</code> ， <code>*</code> ， <code>#</code> ， <code>?</code> ， <code>|</code> ， <code>-</code> ， <code>&lt;</code> ， <code>&gt;</code> ， <code>=</code> <code>!</code> ， <code>%</code> ， <code>@</code> ， &#96;&#96;&#96; .</p>
<h2 id="before-script"><a href="#before-script" class="headerlink" title="before_script"></a>before_script</h2><p>用于定义一个命令，该命令在每个作业之前运行。必须是一个数组。指定的<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#script"><code>script</code></a>与主脚本中指定的任何脚本串联在一起，并在单个shell中一起执行。</p>
<h2 id="after-script"><a href="#after-script" class="headerlink" title="after_script"></a>after_script</h2><p>用于定义将在每个作业（包括失败的作业）之后运行的命令。这必须是一个数组。指定的脚本在新的shell中执行，与任何<code>before_script</code>或<code>script</code>脚本分开。</p>
<p>可以在全局定义，也可以在job中定义。在job中定义会覆盖全局。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;before-script!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;before-script in job&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn clean &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn install&quot;</span></span><br><span class="line">  <span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;after script in job&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello deploy&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;after-script&quot;</span></span><br></pre></td></tr></table></figure>



<p>after_script失败不会影响作业失败。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/02.png" alt="images"></p>
<p>before_script失败导致整个作业失败，其他作业将不再执行。作业失败不会影响after_script运行。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/03.png" alt="images"></p>
<h2 id="stages"><a href="#stages" class="headerlink" title="stages"></a>stages</h2><p>用于定义作业可以使用的阶段，并且是全局定义的。同一阶段的作业并行运行，不同阶段按顺序执行。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stages：</span><br><span class="line"><span class="bullet">  -</span> build</span><br><span class="line"><span class="bullet">  -</span> test</span><br><span class="line"><span class="bullet">  -</span> deploy</span><br></pre></td></tr></table></figure>

<p>这里定义了三个阶段，首先build阶段并行运行，然后test阶段并行运行，最后deploy阶段并行运行。deploy阶段运行成功后将提交状态标记为passed状态。如果任何一个阶段运行失败，最后提交状态为failed。</p>
<p><strong>未定义stages</strong></p>
<p>全局定义的stages是来自于每个job。如果job没有定义stage则默认是test阶段。如果全局未定义stages,则按顺序运行 build,test,deploy。 </p>
<p><img src="/2020/12/14/gitlab-ci-cd/04.png" alt="images"></p>
<p>如果作业中定义了其他阶段，例如”codescan”则会出现错误。原因是因为除了build test deploy阶段外的其他阶段作为.pre运行（也就是作为第一个阶段运行，需要将此作业的stage指定为.pre）。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/05.png" alt="images"></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">codescan:</span></span><br><span class="line"><span class="symbol">  stage:</span> .pre</span><br><span class="line"><span class="symbol">  script:</span></span><br><span class="line">    - echo <span class="string">&quot;codescan&quot;</span></span><br></pre></td></tr></table></figure>



<p><strong>定义stages控制stage运行顺序</strong></p>
<p>一个标准的yaml文件中是需要定义stages，可以帮助我们对每个stage进行排序。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">codescan</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br></pre></td></tr></table></figure>



<p><img src="/2020/12/14/gitlab-ci-cd/06.png" alt="iamges"></p>
<h2 id="pre-amp-post"><a href="#pre-amp-post" class="headerlink" title=".pre &amp; .post"></a>.pre &amp; .post</h2><p>.pre始终是整个管道的第一个运行阶段，.post始终是整个管道的最后一个运行阶段。 用户定义的阶段都在两者之间运行。<code>.pre</code>和<code>.post</code>的顺序无法更改。如果管道仅包含<code>.pre</code>或<code>.post</code>阶段的作业，则不会创建管道。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/05.png" alt="iamges"></p>
<h2 id="stage"><a href="#stage" class="headerlink" title="stage"></a>stage</h2><p>是按JOB定义的，并且依赖于全局定义的<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#stages"><code>stages</code></a> 。 它允许将作业分为不同的阶段，并且同一<code>stage</code>作业可以并行执行（取决于<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#using-your-own-runners">特定条件</a> ）。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">unittest:</span></span><br><span class="line"><span class="symbol">  stage:</span> test</span><br><span class="line"><span class="symbol">  script:</span></span><br><span class="line">    - echo <span class="string">&quot;run test&quot;</span></span><br><span class="line"><span class="symbol">    </span></span><br><span class="line"><span class="symbol">interfacetest:</span></span><br><span class="line"><span class="symbol">  stage:</span> test</span><br><span class="line"><span class="symbol">  script:</span></span><br><span class="line">    - echo <span class="string">&quot;run test&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/14/gitlab-ci-cd/07.png" alt="images"></p>
<p>可能遇到的问题： 阶段并没有并行运行。</p>
<p>在这里我把这两个阶段在同一个runner运行了，所以需要修改runner每次运行的作业数量。默认是1，改为10.</p>
<p><img src="/2020/12/14/gitlab-ci-cd/08.png" alt="images"></p>
<p>vim &#x2F;etc&#x2F;gitlab-runner&#x2F;config.toml 更改后自动加载无需重启。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">concurrent</span> <span class="operator">=</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>



<h2 id="variables"><a href="#variables" class="headerlink" title="variables"></a>variables</h2><p>定义变量，pipeline变量、job变量、Runner变量。job变量优先级最大。</p>
<h3 id="综合实例"><a href="#综合实例" class="headerlink" title="综合实例"></a>综合实例</h3><p>综合实例:</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;before-script!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">codescan</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;before-script in job&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn clean &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn install&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;$DOMAIN&quot;</span></span><br><span class="line">  <span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;after script in buildjob&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">unittest</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;run test&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 2;</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">codescan</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">codescan</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;codescan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 5;</span></span><br><span class="line"> </span><br><span class="line"><span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;after-script&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ech</span></span><br></pre></td></tr></table></figure>



<p>实验效果</p>
<p><img src="/2020/12/14/gitlab-ci-cd/17.png" alt="images"></p>
<p>可能遇到的问题： pipeline卡主,为降低复杂性目前没有学习tags，所以流水线是在共享的runner中运行的。需要设置共享的runner运行没有tag的作业。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/18.png" alt="images"></p>
<h2 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h2><p>用于从允许运行该项目的所有Runner列表中选择特定的Runner,在Runner注册期间，您可以指定Runner的标签。</p>
<p><code>tags</code>可让您使用指定了标签的跑步者来运行作业,此runner具有ruby和postgres标签。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">job</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ruby</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure>



<p>给定带有<code>osx</code>标签的OS X Runner和带有<code>windows</code>标签的Windows Runner，以下作业将在各自的平台上运行。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">windows job</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">windows</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo Hello, %USERNAME%!</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">osx job</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">osx</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;Hello, $USER!&quot;</span></span><br></pre></td></tr></table></figure>



<p><img src="/2020/12/14/gitlab-ci-cd/09.png" alt="images"></p>
<h2 id="allow-failure"><a href="#allow-failure" class="headerlink" title="allow_failure"></a>allow_failure</h2><p><code>allow_failure</code>允许作业失败，默认值为<code>false</code> 。启用后，如果作业失败，该作业将在用户界面中显示橙色警告. 但是，管道的逻辑流程将认为作业成功&#x2F;通过，并且不会被阻塞。 假设所有其他作业均成功，则该作业的阶段及其管道将显示相同的橙色警告。但是，关联的提交将被标记为”通过”，而不会发出警告。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">job1</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">execute_script_that_will_fail</span></span><br><span class="line">  <span class="attribute">allow_failure</span><span class="punctuation">:</span> <span class="string">true</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/14/gitlab-ci-cd/10.png" alt="images"></p>
<h2 id="when"><a href="#when" class="headerlink" title="when"></a>when</h2><p><code>on_success</code>前面阶段中的所有作业都成功（或由于标记为<code>allow_failure</code>而被视为成功）时才执行作业。 这是默认值。</p>
<p><code>on_failure</code>当前面阶段出现失败则执行。</p>
<p><code>always</code> -执行作业，而不管先前阶段的作业状态如何，放到最后执行。总是执行。</p>
<h3 id="manual-手动"><a href="#manual-手动" class="headerlink" title="manual 手动"></a>manual 手动</h3><p><code>manual</code> -手动执行作业,不会自动执行，需要由用户显式启动. 手动操作的示例用法是部署到生产环境. 可以从管道，作业，环境和部署视图开始手动操作。</p>
<p>此时在deploy阶段添加manual，则流水线运行到deploy阶段为锁定状态，需要手动点击按钮才能运行deploy阶段。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/11.png" alt="images"></p>
<h3 id="delayed-延迟"><a href="#delayed-延迟" class="headerlink" title="delayed 延迟"></a>delayed 延迟</h3><p><code>delayed</code> 延迟一定时间后执行作业（在GitLab 11.14中已添加）。 </p>
<p>有效值<code>&#39;5&#39;,10 seconds,30 minutes, 1 day, 1 week</code> 。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/12.png" alt="images"></p>
<p>实验demo</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;before-script!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">codescan</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;before-script in job&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn clean &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn install&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;$DOMAIN&quot;</span></span><br><span class="line">  <span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;after script in buildjob&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">unittest</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ech &quot;run test&quot;</span></span><br><span class="line">  <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">delayed</span></span><br><span class="line">  <span class="attribute">start_in</span><span class="punctuation">:</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">  <span class="attribute">allow_failure</span><span class="punctuation">:</span> <span class="string">true</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 2;</span></span><br><span class="line">  <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">manual</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">codescan</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">codescan</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;codescan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 5;</span></span><br><span class="line">  <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line"> </span><br><span class="line"><span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;after-script&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ech</span></span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h2><p>配置在失败的情况下重试作业的次数。</p>
<p>当作业失败并配置了<code>retry</code> ，将再次处理该作业，直到达到<code>retry</code>关键字指定的次数。如果<code>retry</code>设置为2，并且作业在第二次运行成功（第一次重试），则不会再次重试. <code>retry</code>值必须是一个正整数，等于或大于0，但小于或等于2（最多两次重试，总共运行3次）.</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">unittest:</span></span><br><span class="line"><span class="symbol">  stage:</span> test</span><br><span class="line"><span class="symbol">  retry:</span> <span class="number">2</span></span><br><span class="line"><span class="symbol">  script:</span></span><br><span class="line">    - ech <span class="string">&quot;run test&quot;</span></span><br></pre></td></tr></table></figure>



<p><img src="/2020/12/14/gitlab-ci-cd/19.png" alt="images"></p>
<p>默认情况下，将在所有失败情况下重试作业。为了更好地控制<code>retry</code>哪些失败，可以是具有以下键的哈希值：</p>
<ul>
<li><code>max</code> ：最大重试次数.</li>
<li><code>when</code> ：重试失败的案例.</li>
</ul>
<p>根据错误原因设置重试的次数。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">always ：在发生任何故障时重试（默认）.</span><br><span class="line">unknown_failure ：当失败原因未知时。</span><br><span class="line"><span class="keyword">script_failure </span>：脚本失败时重试。</span><br><span class="line">api_failure ：API失败重试。</span><br><span class="line">stuck_or_timeout_failure ：作业卡住或超时时。</span><br><span class="line">runner_system_failure ：运行系统发生故障。</span><br><span class="line"><span class="symbol">missing_dependency_failure:</span> 如果依赖丢失。</span><br><span class="line">runner_unsupported ：Runner不受支持。</span><br><span class="line">stale_schedule ：无法执行延迟的作业。</span><br><span class="line"><span class="keyword">job_execution_timeout </span>：脚本超出了为作业设置的最大执行时间。</span><br><span class="line">archived_failure ：作业已存档且无法运行。</span><br><span class="line">unmet_prerequisites ：作业未能完成先决条件任务。</span><br><span class="line"><span class="keyword">scheduler_failure </span>：调度程序未能将作业分配给运行<span class="keyword">scheduler_failure。</span></span><br><span class="line"><span class="keyword"></span>data_integrity_failure ：检测到结构完整性问题。</span><br></pre></td></tr></table></figure>



<p>实验</p>
<p>定义当出现脚本错误重试两次，也就是会运行三次。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">unittest</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ech &quot;run test&quot;</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">2</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img src="/2020/12/14/gitlab-ci-cd/13.png" alt="images"></p>
<h2 id="timeout-超时"><a href="#timeout-超时" class="headerlink" title="timeout 超时"></a>timeout 超时</h2><p>特定作业配置超时，作业级别的超时可以超过<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/pipelines/settings.html#timeout">项目级别的超时，</a>但不能超过Runner特定的超时。</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">build:</span><br><span class="line">  script: build.sh</span><br><span class="line">  timeout: 3 hours 30 minutes</span><br><span class="line"></span><br><span class="line"><span class="keyword">test:</span></span><br><span class="line"><span class="keyword">  </span>script: rspec</span><br><span class="line">  timeout: 3h 30m</span><br></pre></td></tr></table></figure>



<h3 id="项目设置流水线超时时间"><a href="#项目设置流水线超时时间" class="headerlink" title="项目设置流水线超时时间"></a>项目设置流水线超时时间</h3><p>超时定义了作业可以运行的最长时间（以分钟为单位）。 这可以在项目的**”设置”&gt;” CI &#x2F; CD”&gt;”常规管道”设置下进行配置** 。 默认值为60分钟。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/14.png" alt="images"></p>
<h3 id="runner超时时间"><a href="#runner超时时间" class="headerlink" title="runner超时时间"></a>runner超时时间</h3><p>此类超时（如果小于<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/pipelines/settings.html#timeout">项目定义的超时</a> ）将具有优先权。此功能可用于通过设置大超时（例如一个星期）来防止Shared Runner被项目占用。未配置时，Runner将不会覆盖项目超时。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/15.png" alt="images"></p>
<p>此功能如何工作：</p>
<p><strong>示例1-运行程序超时大于项目超时</strong></p>
<p>runner超时设置为24小时，项目的<em>CI &#x2F; CD超时</em>设置为**2小时。该工作将在2小时后超时。</p>
<p><strong>示例2-未配置运行程序超时</strong></p>
<p>runner不设置超时时间，项目的<em>CI &#x2F; CD超时</em>设置为<strong>2小时</strong>。该工作将在<strong>2小时</strong>后超时。</p>
<p><strong>示例3-运行程序超时小于项目超时</strong></p>
<p>runner超时设置为30分钟，项目的CI &#x2F; CD超时设置为2小时。工作在30分钟后将超时</p>
<h2 id="parallel"><a href="#parallel" class="headerlink" title="parallel"></a>parallel</h2><p>配置要并行运行的作业实例数,此值必须大于或等于2并且小于或等于50。</p>
<p>这将创建N个并行运行的同一作业实例. 它们从<code>job_name 1/N</code>到<code>job_name N/N</code>依次命名。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">codescan</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">codescan</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;codescan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 5;</span></span><br><span class="line">  <span class="attribute">parallel</span><span class="punctuation">:</span> <span class="string">5</span></span><br></pre></td></tr></table></figure>



<p><img src="/2020/12/14/gitlab-ci-cd/16.png" alt="images"></p>
<h3 id="综合实例-1"><a href="#综合实例-1" class="headerlink" title="综合实例"></a>综合实例</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;before-script!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">codescan</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;before-script in job&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn clean &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn install&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;$DOMAIN&quot;</span></span><br><span class="line">  <span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;after script in buildjob&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">unittest</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ech &quot;run test&quot;</span></span><br><span class="line">  <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">delayed</span></span><br><span class="line">  <span class="attribute">start_in</span><span class="punctuation">:</span> <span class="string">&#x27;5&#x27;</span></span><br><span class="line">  <span class="attribute">allow_failure</span><span class="punctuation">:</span> <span class="string">true</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br><span class="line">  <span class="attribute">timeout</span><span class="punctuation">:</span> <span class="string">1 hours 10 minutes</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 2;</span></span><br><span class="line">  <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">manual</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">codescan</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">codescan</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;codescan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 5;</span></span><br><span class="line">  <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line">  <span class="attribute">parallel</span><span class="punctuation">:</span> <span class="string">5</span></span><br><span class="line"> </span><br><span class="line"><span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;after-script&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ech</span></span><br></pre></td></tr></table></figure>



<h2 id="only-amp-except"><a href="#only-amp-except" class="headerlink" title="only &amp; except"></a>only &amp; except</h2><p>only&#96;和except是两个参数用分支策略来限制jobs构建：</p>
<ol>
<li><code>only</code>定义哪些分支和标签的git项目将会被job执行。</li>
<li><code>except</code>定义哪些分支和标签的git项目将不会被job执行。</li>
</ol>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">job</span><span class="punctuation">:</span></span><br><span class="line">  <span class="comment"># use regexp</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/^issue-.*$/</span></span><br><span class="line">  <span class="comment"># use special keyword</span></span><br><span class="line">  <span class="attribute">except</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">branches</span></span><br></pre></td></tr></table></figure>



<h2 id="rules"><a href="#rules" class="headerlink" title="rules"></a>rules</h2><p><code>rules</code>允许<em>按顺序</em>评估单个规则对象的列表，直到一个匹配并为作业动态提供属性. 请注意， <code>rules</code>不能<code>only/except</code>与<code>only/except</code>组合使用。</p>
<p>可用的规则条款包括：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#rulesif"><code>if</code></a> （类似于<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#onlyvariablesexceptvariables"><code>only:variables</code></a> ）</li>
<li><a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#ruleschanges"><code>changes</code></a> （ <a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#onlychangesexceptchanges"><code>only:changes</code></a>相同）</li>
<li><a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#rulesexists"><code>exists</code></a></li>
</ul>
<h3 id="rules-if"><a href="#rules-if" class="headerlink" title="rules:if"></a>rules:if</h3><p>如果<code>DOMAIN</code>的值匹配，则需要手动运行。不匹配<code>on_success</code>。 条件判断从上到下，匹配即停止。多条件匹配可以使用<code>&amp;&amp; ||</code></p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">codescan</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">codescan</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;codescan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 5;</span></span><br><span class="line">  <span class="comment">#parallel: 5</span></span><br><span class="line">  <span class="attribute">rules</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if: &#x27;$DOMAIN == &quot;example.com&quot;&#x27;</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">manual</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">when: on_success</span></span><br></pre></td></tr></table></figure>



<h3 id="rules-changes"><a href="#rules-changes" class="headerlink" title="rules:changes"></a>rules:changes</h3><p>接受文件路径数组。 如果提交中<code>Jenkinsfile</code>文件发生的变化则为true。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">codescan</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">codescan</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;codescan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 5;</span></span><br><span class="line">  <span class="comment">#parallel: 5</span></span><br><span class="line">  <span class="attribute">rules</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">changes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Jenkinsfile</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">manual</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if: &#x27;$DOMAIN == &quot;example.com&quot;&#x27;</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">when: on_success</span></span><br></pre></td></tr></table></figure>



<h3 id="rules-exists"><a href="#rules-exists" class="headerlink" title="rules:exists"></a>rules:exists</h3><p>接受文件路径数组。当仓库中存在指定的文件时操作。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">codescan</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">codescan</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;codescan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 5;</span></span><br><span class="line">  <span class="comment">#parallel: 5</span></span><br><span class="line">  <span class="attribute">rules</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">exists:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Jenkinsfile</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">manual </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">changes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Jenkinsfile</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if: &#x27;$DOMAIN == &quot;example.com&quot;&#x27;</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">when: on_success</span></span><br></pre></td></tr></table></figure>



<h3 id="rules-allow-failure"><a href="#rules-allow-failure" class="headerlink" title="rules:allow_failure"></a>rules:allow_failure</h3><p>使用<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#allow_failure"><code>allow_failure: true</code></a> <code>rules:</code>在不停止管道本身的情况下允许作业失败或手动作业等待操作. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job:</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">&quot;echo Hello, Rules!&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">&#x27;$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == &quot;master&quot;&#x27;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">      <span class="attr">allow_failure:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>在此示例中，如果第一个规则匹配，则作业将具有以下<code>when: manual</code>和<code>allow_failure: true</code>。</p>
<h2 id="workflow-rules"><a href="#workflow-rules" class="headerlink" title="workflow:rules"></a>workflow:rules</h2><p>顶级<code>workflow:</code>关键字适用于整个管道，并将确定是否创建管道。<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#when"><code>when</code></a> ：可以设置为<code>always</code>或<code>never</code> . 如果未提供，则默认值<code>always</code>。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">workflow</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">rules</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if: &#x27;$DOMAIN == &quot;example.com&quot;&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">when: always</span></span><br></pre></td></tr></table></figure>

<h3 id="综合实例-2"><a href="#综合实例-2" class="headerlink" title="综合实例"></a>综合实例</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;before-script!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">workflow</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">rules</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if: &#x27;$DOMAIN == &quot;example.com&quot;&#x27;</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">when: never</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">codescan</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;before-script in job&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn clean &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn install&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ech &quot;$DOMAIN&quot;</span></span><br><span class="line">  <span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;after script in buildjob&quot;</span></span><br><span class="line">  <span class="attribute">rules</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">exists:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Dockerfile</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success </span></span><br><span class="line">      <span class="attribute">allow_failure</span><span class="punctuation">:</span> <span class="string">true</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">changes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Dockerfile</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">manual</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">when: on_failure</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">unittest</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ech &quot;run test&quot;</span></span><br><span class="line">  <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">delayed</span></span><br><span class="line">  <span class="attribute">start_in</span><span class="punctuation">:</span> <span class="string">&#x27;5&#x27;</span></span><br><span class="line">  <span class="attribute">allow_failure</span><span class="punctuation">:</span> <span class="string">true</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br><span class="line">  <span class="attribute">timeout</span><span class="punctuation">:</span> <span class="string">1 hours 10 minutes</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 2;</span></span><br><span class="line">  <span class="attribute">rules</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if: &#x27;$DOMAIN == &quot;example.com&quot;&#x27;</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">manual</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if: &#x27;$DOMAIN == &quot;aexample.com&quot;&#x27;</span></span><br><span class="line">      <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">delayed</span></span><br><span class="line">      <span class="attribute">start_in</span><span class="punctuation">:</span> <span class="string">&#x27;5&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">when: on_failure</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">codescan</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">codescan</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;codescan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 5;</span></span><br><span class="line">  <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line">  <span class="attribute">parallel</span><span class="punctuation">:</span> <span class="string">5</span></span><br><span class="line"> </span><br><span class="line"><span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;after-script&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ech</span></span><br></pre></td></tr></table></figure>

<h2 id="cache-缓存"><a href="#cache-缓存" class="headerlink" title="cache 缓存"></a>cache 缓存</h2><p>用来指定需要在job之间缓存的文件或目录。只能使用该项目工作空间内的路径。不要使用缓存在阶段之间传递工件，因为缓存旨在存储编译项目所需的运行时依赖项。</p>
<p>如果在job范围之外定义了<code>cache</code> ，则意味着它是全局设置，所有job都将使用该定义。如果未全局定义或未按job定义则禁用该功能。</p>
<h3 id="cache-paths"><a href="#cache-paths" class="headerlink" title="cache:paths"></a>cache:paths</h3><p>使用<code>paths</code>指令选择要缓存的文件或目录，路径是相对于项目目录，不能直接链接到项目目录之外。</p>
<p> <code>$CI_PROJECT_DIR</code>  项目目录</p>
<p>在job build中定义缓存，将会缓存target目录下的所有.jar文件。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/*.jar</span></span><br></pre></td></tr></table></figure>



<p>当在全局定义了cache:paths会被job中覆盖。以下实例将缓存binaries目录。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">my/files</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">echo &quot;hello&quot;</span></span><br><span class="line">  <span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">key</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">    <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/</span></span><br></pre></td></tr></table></figure>



<p>由于缓存是在job之间共享的，如果不同的job使用不同的路径就出现了缓存覆盖的问题。如何让不同的job缓存不同的cache呢？设置不同的<code>cache:key</code>。</p>
<h3 id="cache-key-缓存标记"><a href="#cache-key-缓存标记" class="headerlink" title="cache:key  缓存标记"></a>cache:key  缓存标记</h3><p>为缓存做个标记，可以配置job、分支为key来实现分支、作业特定的缓存。为不同 job 定义了不同的 <code>cache:key</code> 时， 会为每个 job 分配一个独立的 cache。cache:key<code>变量可以使用任何预定义变量，默认</code>default ，从GitLab 9.0开始，默认情况下所有内容都在管道和作业之间共享。</p>
<p>按照分支设置缓存</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cache:</span></span><br><span class="line"><span class="symbol">  key:</span> $<span class="punctuation">&#123;</span>CI_COMMIT_REF_SLUG<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>files： 文件发生变化自动重新生成缓存(files最多指定两个文件)，提交的时候检查指定的文件。</p>
<p>根据指定的文件生成密钥计算SHA校验和，如果文件未改变值为default。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">key</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">files</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Gemfile.lock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">package.json</span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vendor/ruby</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node_modules</span></span><br></pre></td></tr></table></figure>



<p>prefix: 允许给定prefix的值与指定文件生成的秘钥组合。 </p>
<p>在这里定义了全局的cache，如果文件发生变化则值为 rspec-xxx111111111222222   ，未发生变化为rspec-default。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">key</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">files</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Gemfile.lock</span></span><br><span class="line">    <span class="attribute">prefix</span><span class="punctuation">:</span> <span class="string">$&#123;CI_JOB_NAME&#125;</span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vendor/ruby</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">rspec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle exec rspec</span></span><br></pre></td></tr></table></figure>

<p>例如，添加<code>$CI_JOB_NAME</code> <code>prefix</code>将使密钥看起来像： <code>rspec-feef9576d21ee9b6a32e30c5c79d0a0ceb68d1e5</code> ，并且作业缓存在不同分支之间共享，如果分支更改了<code>Gemfile.lock</code> ，则该分支将为<code>cache:key:files</code>具有新的SHA校验和. 将生成一个新的缓存密钥，并为该密钥创建一个新的缓存. 如果<code>Gemfile.lock</code>未发生变化 ，则将前缀添加<code>default</code> ，因此示例中的键为<code>rspec-default</code> 。</p>
<h3 id="cache-policy-策略"><a href="#cache-policy-策略" class="headerlink" title="cache:policy  策略"></a>cache:policy  策略</h3><p>默认：在执行开始时下载文件，并在结束时重新上传文件。称为” <code>pull-push</code>缓存策略.</p>
<p><code>policy: pull</code> 跳过下载步骤</p>
<p><code>policy: push</code>  跳过上传步骤</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">setup</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">prepare</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">setup</span></span><br><span class="line">  <span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">key</span><span class="punctuation">:</span> <span class="string">gems</span></span><br><span class="line">    <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vendor/bundle</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle install --deployment</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">rspec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">key</span><span class="punctuation">:</span> <span class="string">gems</span></span><br><span class="line">    <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vendor/bundle</span></span><br><span class="line">    <span class="attribute">policy</span><span class="punctuation">:</span> <span class="string">pull</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle exec rspec ...</span></span><br></pre></td></tr></table></figure>

<h3 id="综合实例-一-全局缓存"><a href="#综合实例-一-全局缓存" class="headerlink" title="综合实例(一) 全局缓存"></a>综合实例(一) 全局缓存</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;before-script!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">cache</span><span class="punctuation">: </span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">target/</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;before-script in job&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">id</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn clean package -DskipTests</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;$DOMAIN&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">false &amp;&amp; true ; exit_code=$?</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if [ $exit_code -ne 0 ]; then echo &quot;Previous command failed&quot;; fi;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 2;</span></span><br><span class="line">  <span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;after script in job&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">unittest</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;run test&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &#x27;test&#x27; &gt;&gt; target/a.txt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">2</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;run deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">2</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;after-script&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>Pipeline日志分析</p>
<p>build作业运行时会对项目代码打包，然后生成target目录。作业结束创建缓存。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/20.png" alt="images"></p>
<p>开始第二个作业test，此时会把当前目录中的target目录删除掉（因为做了git 对比）。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/22.png" alt="images"></p>
<p>获取到第一个作业生成的缓存target目录。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/21.png" alt="images"></p>
<p>开始第三个作业，同样先删除了target目录，然后获取了第二个作业的缓存。最后生成了当前的缓存。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/23.png" alt="images"></p>
<p>Runner缓存</p>
<p>在做本次实验的时候我现在本地runner清除了项目的工作目录和历史缓存。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service ~]<span class="meta"># cd /home/gitlab-runner/builds/1Cxihk7-/0/demo/demo-maven-service/</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo-maven-service]<span class="meta"># ls</span></span><br><span class="line">Jenkinsfile  README.md  aaaaa  jenkins  pom.xml  src  target</span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo-maven-service]<span class="meta"># cd ..</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># ls</span></span><br><span class="line">demo-maven-service  demo-maven-service.tmp</span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># rm -fr demo-maven-service</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># rm -fr demo-maven-service.tmp/</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># cd</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service ~]<span class="meta"># cd /home/gitlab-runner/cache/</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service cache]<span class="meta"># ls</span></span><br><span class="line">demo</span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service cache]<span class="meta"># rm -rf *</span></span><br></pre></td></tr></table></figure>



<p>项目代码默认不会删除，可以发现是第二次作业的缓存。（因为上面的例子中第三次作业并没有修改缓存内容）</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service cache]<span class="meta"># cd /home/gitlab-runner/builds/1Cxihk7-/0/demo/demo-maven-service/</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo-maven-service]<span class="meta"># ls</span></span><br><span class="line">Jenkinsfile  README.md  aaaaa  jenkins  pom.xml  src  target</span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo-maven-service]<span class="meta"># cd ..</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># ls</span></span><br><span class="line">demo-maven-service  demo-maven-service.tmp</span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># rm -fr *</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># ls</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># ls</span></span><br><span class="line">demo-maven-service  demo-maven-service.tmp</span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo]<span class="meta"># cd demo-maven-service</span></span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo-maven-service]<span class="meta"># ls</span></span><br><span class="line">Jenkinsfile  README.md  aaaaa  jenkins  pom.xml  src  target</span><br><span class="line">[root<span class="symbol">@zeyang</span>-nuc-service demo-maven-service]<span class="meta"># cat target/a.txt</span></span><br><span class="line">test</span><br></pre></td></tr></table></figure>



<p>进入runner缓存目录中查看缓存。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@zeyang-nuc-service ~]# cd <span class="regexp">/home/gi</span>tlab-runner<span class="regexp">/cache/</span>demo<span class="regexp">/demo-maven-service/</span><span class="keyword">default</span>/</span><br><span class="line">[root@zeyang-nuc-service <span class="keyword">default</span>]# ls</span><br><span class="line">cache.zip</span><br><span class="line">[root@zeyang-nuc-service <span class="keyword">default</span>]# unzip cache.zip</span><br><span class="line">Archive:  cache.zip</span><br><span class="line">   creating: target/</span><br><span class="line">  inflating: target/a.txt</span><br><span class="line">   creating: target<span class="regexp">/classes/</span></span><br><span class="line">   creating: target<span class="regexp">/classes/</span>com/</span><br><span class="line">   creating: target<span class="regexp">/classes/</span>com<span class="regexp">/mycompany/</span></span><br><span class="line">   creating: target<span class="regexp">/classes/</span>com<span class="regexp">/mycompany/</span>app/</span><br><span class="line">  inflating: target<span class="regexp">/classes/</span>com<span class="regexp">/mycompany/</span>app/App.<span class="keyword">class</span></span><br><span class="line">   creating: target<span class="regexp">/maven-archiver/</span></span><br><span class="line">  inflating: target<span class="regexp">/maven-archiver/</span>pom.properties</span><br><span class="line">   creating: target<span class="regexp">/maven-status/</span></span><br><span class="line">   creating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin/</span><br><span class="line">   creating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin<span class="regexp">/compile/</span></span><br><span class="line">   creating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin<span class="regexp">/compile/</span><span class="keyword">default</span>-<span class="keyword">compile</span>/</span><br><span class="line">  inflating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin<span class="regexp">/compile/</span><span class="keyword">default</span>-<span class="keyword">compile</span>/createdFiles.lst</span><br><span class="line">  inflating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin<span class="regexp">/compile/</span><span class="keyword">default</span>-<span class="keyword">compile</span>/inputFiles.lst</span><br><span class="line">   creating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin<span class="regexp">/testCompile/</span></span><br><span class="line">   creating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin<span class="regexp">/testCompile/</span><span class="keyword">default</span>-testCompile/</span><br><span class="line">  inflating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin<span class="regexp">/testCompile/</span><span class="keyword">default</span>-testCompile/createdFiles.lst</span><br><span class="line">  inflating: target<span class="regexp">/maven-status/m</span>aven-compiler-plugin<span class="regexp">/testCompile/</span><span class="keyword">default</span>-testCompile/inputFiles.lst</span><br><span class="line">  inflating: target/my-app-<span class="number">1.1</span>-SNAPSHOT.jar</span><br><span class="line">   creating: target<span class="regexp">/test-classes/</span></span><br><span class="line">   creating: target<span class="regexp">/test-classes/</span>com/</span><br><span class="line">   creating: target<span class="regexp">/test-classes/</span>com<span class="regexp">/mycompany/</span></span><br><span class="line">   creating: target<span class="regexp">/test-classes/</span>com<span class="regexp">/mycompany/</span>app/</span><br><span class="line">  inflating: target<span class="regexp">/test-classes/</span>com<span class="regexp">/mycompany/</span>app/AppTest.<span class="keyword">class</span></span><br><span class="line">[root@zeyang-nuc-service <span class="keyword">default</span>]# ls</span><br><span class="line">cache.zip  target</span><br><span class="line">[root@zeyang-nuc-service <span class="keyword">default</span>]# cd target/</span><br><span class="line">[root@zeyang-nuc-service target]# ls</span><br><span class="line">a.txt  classes  maven-archiver  maven-status  my-app-<span class="number">1.1</span>-SNAPSHOT.jar  test-classes</span><br><span class="line">[root@zeyang-nuc-service target]# cat a.txt</span><br><span class="line">test</span><br></pre></td></tr></table></figure>



<p>此时此刻再次运行流水线作业，第一个作业用的是上个作业最后生成的缓存。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/24.png" alt="images"></p>
<p>进入runner缓存目录查看,cache.zip时间已经发生的变化。</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zeyang-nuc-service default]<span class="comment"># ll</span></span><br><span class="line">total 12</span><br><span class="line">-rw-------<span class="number"> 1 </span>gitlab-runner gitlab-runner<span class="number"> 9172 </span>Apr<span class="number"> 29 </span>10:27 cache.zip</span><br><span class="line">drwxrwxr-x<span class="number"> 6 </span>root          root          <span class="number"> 127 </span>Apr<span class="number"> 29 </span>10:05 target</span><br></pre></td></tr></table></figure>



<p>结论： 全局缓存生效于未在作业中定义缓存的所有作业，这种情况如果每个作业都对缓存目录做了更改，会出现缓存被覆盖的场景。</p>
<h3 id="综合实例（二）"><a href="#综合实例（二）" class="headerlink" title="综合实例（二）"></a>综合实例（二）</h3><p>控制缓存策略</p>
<p>例如build阶段我们需要生成新的target目录内容，可以优化设置job运行时不下载缓存。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/25.png" alt="images"></p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;before-script!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">cache</span><span class="punctuation">: </span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">target/</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;before-script in job&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">id</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat target/a.txt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn clean package -DskipTests</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;$DOMAIN&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">false &amp;&amp; true ; exit_code=$?</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if [ $exit_code -ne 0 ]; then echo &quot;Previous command failed&quot;; fi;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 2;</span></span><br><span class="line">  <span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;after script in job&quot;</span></span><br><span class="line">  <span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">policy</span><span class="punctuation">:</span> <span class="string">pull   #不下载缓存</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">unittest</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;run test&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &#x27;test&#x27; &gt;&gt; target/a.txt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat target/a.txt</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">2</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat target/a.txt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;run deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;deploy&quot; &gt;&gt; target/a.txt</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">2</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;after-script&quot;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="artifacts"><a href="#artifacts" class="headerlink" title="artifacts"></a>artifacts</h2><p>用于指定在作业成功或者失败时应附加到作业的文件或目录的列表。作业完成后，工件将被发送到GitLab，并可在GitLab UI中下载。</p>
<h3 id="artifacts-paths"><a href="#artifacts-paths" class="headerlink" title="artifacts:paths"></a>artifacts:paths</h3><p>路径是相对于项目目录的，不能直接链接到项目目录之外。</p>
<p>将制品设置为target目录</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">artifacts</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">target/</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/14/gitlab-ci-cd/26.png" alt="images"></p>
<p>禁用工件传递</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">job:</span></span><br><span class="line"><span class="symbol">  stage:</span> build</span><br><span class="line"><span class="symbol">  script:</span> make build</span><br><span class="line"><span class="symbol">  dependencies:</span> []</span><br></pre></td></tr></table></figure>



<p>您可能只想为标记发行版的创建构件，以避免用临时构建构件填充构建服务器存储。仅为标签创建工件（ <code>default-job</code>不会创建工件）：</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">default-job</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn test -U</span></span><br><span class="line">  <span class="attribute">except</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tags</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">release-job</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn package -U</span></span><br><span class="line">  <span class="attribute">artifacts</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/*.war</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tags</span></span><br></pre></td></tr></table></figure>

<h3 id="artifacts-expose-as"><a href="#artifacts-expose-as" class="headerlink" title="artifacts:expose_as"></a>artifacts:expose_as</h3><p>关键字<code>expose_as</code>可用于在合并请求 UI中公开作业工件。</p>
<p>例如，要匹配单个文件：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">test:</span></span><br><span class="line"><span class="keyword">  </span>script: </span><br><span class="line">    - echo 1</span><br><span class="line">  artifacts:</span><br><span class="line">    expose_as: &#x27;artifact 1&#x27;</span><br><span class="line">    paths: </span><br><span class="line">      - path/to/file.txt</span><br></pre></td></tr></table></figure>

<p>使用此配置，GitLab将在指向的相关合并请求中添加链接<code>file1.txt</code>。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/27.png" alt="images"></p>
<p>制品浏览</p>
<p><img src="/2020/12/14/gitlab-ci-cd/28.png" alt="images"></p>
<p>请注意以下几点：</p>
<ul>
<li>每个合并请求最多可以公开10个作业工件。</li>
<li>如果指定了目录，那么如果目录中有多个文件，则该链接将指向指向作业工件浏览器。</li>
<li>如果开启GitlabPages可以对.html .htm .txt .json .log扩展名单个文件工件渲染工件。</li>
</ul>
<h3 id="artifacts-name"><a href="#artifacts-name" class="headerlink" title="artifacts:name"></a>artifacts:name</h3><p>通过<code>name</code>指令定义所创建的工件存档的名称。可以为每个存档使用唯一的名称。 <code>artifacts:name</code>变量可以使用任何<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/variables/README.html">预定义变量</a>。默认名称是<code>artifacts</code>，下载<code>artifacts</code>改为<code>artifacts.zip</code>。</p>
<p>使用当前作业的名称创建存档</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">job:</span></span><br><span class="line"><span class="symbol">  artifacts:</span></span><br><span class="line"><span class="symbol">    name:</span> <span class="string">&quot;$CI_JOB_NAME&quot;</span></span><br><span class="line"><span class="symbol">    paths:</span></span><br><span class="line">      - binaries/</span><br></pre></td></tr></table></figure>

<p>使用内部分支或标记的名称（仅包括binaries目录）创建存档，</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">job:</span></span><br><span class="line"><span class="symbol">  artifacts:</span></span><br><span class="line"><span class="symbol">    name:</span> <span class="string">&quot;$CI_COMMIT_REF_NAME&quot;</span></span><br><span class="line"><span class="symbol">    paths:</span></span><br><span class="line">      - binaries/</span><br></pre></td></tr></table></figure>



<p>使用当前作业的名称和当前分支或标记（仅包括二进制文件目录）创建存档</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">job:</span></span><br><span class="line"><span class="symbol">  artifacts:</span></span><br><span class="line"><span class="symbol">    name:</span> <span class="string">&quot;$CI_JOB_NAME-$CI_COMMIT_REF_NAME&quot;</span></span><br><span class="line"><span class="symbol">    paths:</span></span><br><span class="line">      - binaries/</span><br></pre></td></tr></table></figure>



<p>要创建一个具有当前<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#stages">阶段</a>名称和分支名称的存档</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">job:</span></span><br><span class="line"><span class="symbol">  artifacts:</span></span><br><span class="line"><span class="symbol">    name:</span> <span class="string">&quot;$CI_JOB_STAGE-$CI_COMMIT_REF_NAME&quot;</span></span><br><span class="line"><span class="symbol">    paths:</span></span><br><span class="line">      - binaries/</span><br></pre></td></tr></table></figure>



<h3 id="artifacts-when"><a href="#artifacts-when" class="headerlink" title="artifacts:when"></a>artifacts:when</h3><p>用于在作业失败时或尽管失败而上传工件。on_success仅在作业成功时上载工件。这是默认值。on_failure仅在作业失败时上载工件。always 上载工件，无论作业状态如何。</p>
<p>要仅在作业失败时上传工件：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">job:</span></span><br><span class="line"><span class="symbol">  artifacts:</span></span><br><span class="line"><span class="symbol">    when:</span> on_failure</span><br></pre></td></tr></table></figure>



<h3 id="artifacts-expire-in"><a href="#artifacts-expire-in" class="headerlink" title="artifacts:expire_in"></a>artifacts:expire_in</h3><p>制品的有效期，从上传和存储到GitLab的时间开始算起。如果未定义过期时间，则默认为30天。</p>
<p><code>expire_in</code>的值以秒为单位的经过时间，除非提供了单位。可解析值的示例：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">‘42’</span><br><span class="line">‘3 mins<span class="number"> 4 </span>sec’</span><br><span class="line">‘2 hrs<span class="number"> 20 </span>min’</span><br><span class="line">‘2h20min’</span><br><span class="line">‘6 mos<span class="number"> 1 </span>day’</span><br><span class="line">‘47 yrs<span class="number"> 6 </span>mos and 4d’</span><br><span class="line">‘3 weeks and<span class="number"> 2 </span>days’</span><br></pre></td></tr></table></figure>



<p>一周后过期</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">job:</span></span><br><span class="line"><span class="symbol">  artifacts:</span></span><br><span class="line"><span class="symbol">    expire_in:</span> <span class="number">1</span> week</span><br></pre></td></tr></table></figure>



<h3 id="artifacts-reports"><a href="#artifacts-reports" class="headerlink" title="artifacts:reports"></a>artifacts:reports</h3><p>用于从作业中收集测试报告，代码质量报告和安全报告. 在GitLab的UI中显示这些报告。</p>
<p><strong>注意：</strong>无论作业结果（成功或失败），都将收集测试报告。</p>
<p><code>artifacts:reports:junit</code></p>
<p>收集junit单元测试报告，收集的JUnit报告将作为工件上传到GitLab，并将自动显示在合并请求中。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn test</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn cobertura:cobertura</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">  <span class="attribute">artifacts</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">&quot;$CI_JOB_NAME-$CI_COMMIT_REF_NAME&quot;</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line">    <span class="attribute">expose_as</span><span class="punctuation">:</span> <span class="string">&#x27;artifact 1&#x27;</span></span><br><span class="line">    <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/*.jar</span></span><br><span class="line">    <span class="attribute">reports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">junit</span><span class="punctuation">:</span> <span class="string">target/surefire-reports/TEST-*.xml</span></span><br></pre></td></tr></table></figure>



<p><strong>注意：</strong>如果您使用的JUnit工具导出到多个XML文件，则可以在一个作业中指定多个测试报告路径，它们将被自动串联到一个文件中. 使用文件名模式（ <code>junit: rspec-*.xml</code> ），文件名数组（ <code>junit: [rspec-1.xml, rspec-2.xml, rspec-3.xml]</code> ）或其组合（ <code>junit: [rspec.xml, test-results/TEST-*.xml]</code> ）。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/30.png" alt="images"></p>
<p><img src="/2020/12/14/gitlab-ci-cd/29.png" alt="images"></p>
<p>如果无法显示此页面，需要更改系统设置。此选项可能会加大资源占用，默认禁用了需要启用。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">登录gitlab</span><br><span class="line">su -  git</span><br><span class="line"><span class="section">$ gitlab-rails console</span></span><br><span class="line"><span class="section">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="code"> GitLab:       12.9.0 (9a382ff2c82) FOSS</span></span><br><span class="line"><span class="code"> GitLab Shell: 12.0.0</span></span><br><span class="line"><span class="section"> PostgreSQL:   10.12</span></span><br><span class="line"><span class="section">--------------------------------------------------------------------------------</span></span><br><span class="line">Feature.enable(:junit<span class="emphasis">_pipeline_view)Loading production environment (Rails 6.0.2)</span></span><br><span class="line"><span class="emphasis">irb(main):001:0&gt;</span></span><br><span class="line"><span class="emphasis">irb(main):002:0&gt;</span></span><br><span class="line"><span class="emphasis">irb(main):003:0&gt; Feature.enable(:junit_pipeline_</span>view)</span><br><span class="line">=&gt; true</span><br><span class="line">irb(main):004:0&gt;</span><br></pre></td></tr></table></figure>

<p>参考链接：<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/junit_test_reports.html">https://docs.gitlab.com/ee/ci/junit_test_reports.html</a></p>
<p><code>artifacts:reports:cobertura</code></p>
<p>收集的Cobertura覆盖率报告将作为工件上传到GitLab，并在合并请求中自动显示。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn test</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn cobertura:cobertura</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">  <span class="attribute">artifacts</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">&quot;$CI_JOB_NAME-$CI_COMMIT_REF_NAME&quot;</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line">    <span class="attribute">expose_as</span><span class="punctuation">:</span> <span class="string">&#x27;artifact 1&#x27;</span></span><br><span class="line">    <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/*.jar</span></span><br><span class="line">    <span class="attribute">reports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">junit</span><span class="punctuation">:</span> <span class="string">target/surefire-reports/TEST-*.xml</span></span><br><span class="line">      <span class="attribute">cobertura</span><span class="punctuation">:</span> <span class="string">target/site/cobertura/coverage.xml</span></span><br></pre></td></tr></table></figure>



<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">$ gitlab-rails console</span></span><br><span class="line"><span class="section">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="code"> GitLab:       12.9.0 (9a382ff2c82) FOSS</span></span><br><span class="line"><span class="code"> GitLab Shell: 12.0.0</span></span><br><span class="line"><span class="section"> PostgreSQL:   10.12</span></span><br><span class="line"><span class="section">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Loading production environment (Rails 6.0.2)</span><br><span class="line">irb(main):001:0&gt;</span><br><span class="line">irb(main):002:0&gt;</span><br><span class="line">irb(main):003:0&gt; Feature.enable(:coverage_report_view)</span><br><span class="line">=&gt; true</span><br></pre></td></tr></table></figure>



<h3 id="maven集成cobertura插件"><a href="#maven集成cobertura插件" class="headerlink" title="maven集成cobertura插件"></a>maven集成cobertura插件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span>       </span><br><span class="line">  <span class="comment">&lt;!--  cobertura plugin start --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cobertura-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">formats</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">format</span>&gt;</span>html<span class="tag">&lt;/<span class="name">format</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">format</span>&gt;</span>xml<span class="tag">&lt;/<span class="name">format</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;/<span class="name">formats</span>&gt;</span>  </span><br><span class="line">  	<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>       </span><br><span class="line">  <span class="comment">&lt;!--  cobertura plugin end --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行 mvn cobertura:cobertura 运行测试并产生 Cobertura 覆盖率报告。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://docs.gitlab.com/12.9/ee/user/project/merge_requests/test_coverage_visualization.html">https://docs.gitlab.com/12.9/ee/user/project/merge_requests/test_coverage_visualization.html</a></p>
<p>备注实验未做出效果，具体问题待排查。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/31.png" alt="images"></p>
<h2 id="dependencies"><a href="#dependencies" class="headerlink" title="dependencies"></a>dependencies</h2><p>定义要获取工件的作业列表，只能从当前阶段之前执行的阶段定义作业。定义一个空数组将跳过下载该作业的任何工件不会考虑先前作业的状态，因此，如果它失败或是未运行的手动作业，则不会发生错误。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/32.png" alt="images"></p>
<p>如果设置为依赖项的作业的工件已过期或删除，那么依赖项作业将失败。</p>
<h2 id="综合实例-3"><a href="#综合实例-3" class="headerlink" title="综合实例"></a>综合实例</h2><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;before-script!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">DOMAIN</span><span class="punctuation">:</span> <span class="string">example.com</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">cache</span><span class="punctuation">: </span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">target/</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;before-script in job&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">id</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn test</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn cobertura:cobertura</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;$DOMAIN&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">false &amp;&amp; true ; exit_code=$?</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">if [ $exit_code -ne 0 ]; then echo &quot;Previous command failed&quot;; fi;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 2;</span></span><br><span class="line">  <span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;after script in job&quot;</span></span><br><span class="line">  <span class="attribute">artifacts</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">&quot;$CI_JOB_NAME-$CI_COMMIT_REF_NAME&quot;</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span> <span class="string">on_success</span></span><br><span class="line">    <span class="comment">#expose_as: &#x27;artifact 1&#x27;</span></span><br><span class="line">    <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/*.jar</span></span><br><span class="line">      <span class="comment">#- target/surefire-reports/TEST*.xml</span></span><br><span class="line">    <span class="attribute">reports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">junit</span><span class="punctuation">:</span> <span class="string">target/surefire-reports/TEST-*.xml</span></span><br><span class="line">      <span class="attribute">cobertura</span><span class="punctuation">:</span> <span class="string">target/site/cobertura/coverage.xml</span></span><br><span class="line">  <span class="attribute">coverage</span><span class="punctuation">:</span> <span class="string">&#x27;/Code coverage: \d+\.\d+/&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">unittest</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">dependencies</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;run test&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &#x27;test&#x27; &gt;&gt; target/a.txt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">2</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;run deploy&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls target</span></span><br><span class="line">  <span class="attribute">retry</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">max</span><span class="punctuation">:</span> <span class="string">2</span></span><br><span class="line">    <span class="attribute">when</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">script_failure</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="attribute">after_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo &quot;after-script&quot;</span></span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="needs-并行阶段"><a href="#needs-并行阶段" class="headerlink" title="needs 并行阶段"></a>needs 并行阶段</h2><p>可无序执行作业，无需按照阶段顺序运行某些作业，可以让多个阶段同时运行。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">module-a-build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">: </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello3a&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 10</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">module-b-build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">: </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello3b&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 10</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">module-a-test</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">: </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello3a&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 10</span></span><br><span class="line">  <span class="attribute">needs</span><span class="punctuation">:</span> <span class="string">[&quot;module-a-build&quot;]</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">module-b-test</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">: </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello3b&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 10</span></span><br><span class="line">  <span class="attribute">needs</span><span class="punctuation">:</span> <span class="string">[&quot;module-b-build&quot;]</span></span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/2020/12/14/gitlab-ci-cd/33.png" alt="images"></p>
<p>如果<code>needs:</code>设置为指向因<code>only/except</code>规则而未实例化的作业，或者不存在，则创建管道时会出现YAML错误。</p>
<p>暂时限制了作业在<code>needs:</code>可能需要的最大作业数分配,<code>ci_dag_limit_needs</code>功能标志已启用（默认）分配10个，如果功能被禁用为50。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Feature</span>::disable(<span class="symbol">:ci_dag_limit_needs</span>)   <span class="comment"># 50</span></span><br><span class="line"><span class="title class_">Feature</span>::enable(<span class="symbol">:ci_dag_limit_needs</span>)  <span class="comment">#10</span></span><br></pre></td></tr></table></figure>

<h2 id="制品下载"><a href="#制品下载" class="headerlink" title="制品下载"></a>制品下载</h2><p>在使用<code>needs</code>，可通过<code>artifacts: true</code>或<code>artifacts: false</code>来控制工件下载。 默认不指定为true。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">module-a-test</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">: </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello3a&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 10</span></span><br><span class="line">  <span class="attribute">needs</span><span class="punctuation">: </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">job: &quot;module-a-build&quot;</span></span><br><span class="line">      <span class="attribute">artifacts</span><span class="punctuation">:</span> <span class="string">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>相同项目中的管道制品下载,通过将<code>project</code>关键字设置为当前项目的名称，并指定引用，可以使用<code>needs</code>从当前项目的不同管道中下载工件。在下面的示例中，<code>build_job</code>将使用<code>other-ref</code>ref下载最新成功的<code>build-1</code>作业的工件：</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">build_job</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls -lhR</span></span><br><span class="line">  <span class="attribute">needs</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">project: group/same-project-name</span></span><br><span class="line">      <span class="attribute">job</span><span class="punctuation">:</span> <span class="string">build-1</span></span><br><span class="line">      <span class="attribute">ref</span><span class="punctuation">:</span> <span class="string">other-ref</span></span><br><span class="line">      <span class="attribute">artifacts</span><span class="punctuation">:</span> <span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>不支持从<a target="_blank" rel="noopener" href="http://s0docs0gitlab0com.icopy.site/12.9/ee/ci/yaml/README.html#parallel"><code>parallel:</code></a>运行的作业中下载工件。</p>
<h2 id="include"><a href="#include" class="headerlink" title="include"></a>include</h2><p><a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab/-/tree/master/lib/gitlab/ci/templates">https://gitlab.com/gitlab-org/gitlab/-/tree/master/lib/gitlab/ci/templates</a></p>
<p>可以允许引入外部YAML文件，文件具有扩展名<code>.yml</code>或<code>.yaml</code> 。使用合并功能可以自定义和覆盖包含本地定义的CI &#x2F; CD配置。相同的job会合并，参数值以源文件为准。</p>
<h3 id="local"><a href="#local" class="headerlink" title="local"></a>local</h3><p>引入同一存储库中的文件，使用相对于根目录的完整路径进行引用，与配置文件在同一分支上使用。</p>
<p>ci&#x2F;localci.yml: 定义一个作业用于发布。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">deployjob</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &#x27;deploy&#x27;</span></span><br></pre></td></tr></table></figure>



<p>.gitlab-ci.yml 引入本地的CI文件’ci&#x2F;localci.yml’。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">local</span><span class="punctuation">:</span> <span class="string">&#x27;ci/localci.yml&#x27;</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="attribute">buildjob</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">ls</span></span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line"><span class="attribute">testjob</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">ls</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img src="/2020/12/14/gitlab-ci-cd/38.png" alt="images"></p>
<h3 id="file"><a href="#file" class="headerlink" title="file"></a>file</h3><p>包含来自另一个项目的文件</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include:</span><br><span class="line">  - project: demo/demo-java-service</span><br><span class="line">    <span class="keyword">ref</span>: <span class="keyword">master</span></span><br><span class="line">    <span class="title">file</span>: &#x27;.gitlab-ci.yml&#x27;</span><br></pre></td></tr></table></figure>



<h3 id="template"><a href="#template" class="headerlink" title="template"></a>template</h3><p>只能使用官方提供的模板 <a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab/tree/master/lib/gitlab/ci/templates">https://gitlab.com/gitlab-org/gitlab/tree/master/lib/gitlab/ci/templates</a></p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">template: Auto-DevOps.gitlab-ci.yml</span></span><br></pre></td></tr></table></figure>



<h3 id="remote"><a href="#remote" class="headerlink" title="remote"></a>remote</h3><p>用于通过HTTP &#x2F; HTTPS包含来自其他位置的文件，并使用完整URL进行引用. 远程文件必须可以通过简单的GET请求公开访问，因为不支持远程URL中的身份验证架构。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>:</span><br><span class="line">  - remote: &#x27;https://gitlab.com/awesome-<span class="keyword">project</span>/raw/master/.gitlab-ci-template.yml&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="extens"><a href="#extens" class="headerlink" title="extens"></a>extens</h3><p>继承模板作业</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">RSPEC</span><span class="punctuation">:</span> <span class="string">&#x27;test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">.tests</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">echo &quot;mvn test&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">refs</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">branches</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">testjob</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">extends</span><span class="punctuation">:</span> <span class="string">.tests</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">echo &quot;mvn clean test&quot;</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$RSPEC</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>合并后</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">testjob</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">mvn clean test</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$RSPEC</span></span><br><span class="line">    <span class="attribute">refs</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">branches</span></span><br></pre></td></tr></table></figure>

<h2 id="extends-amp-include"><a href="#extends-amp-include" class="headerlink" title="extends &amp; include"></a>extends &amp; include</h2><p>aa.yml</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#stages:</span></span><br><span class="line"><span class="comment">#  - deploy</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">deployjob</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &#x27;deploy&#x27;</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">.template</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">: </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;build&quot;</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">local</span><span class="punctuation">:</span> <span class="string">&#x27;ci/localci.yml&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build </span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">RSPEC</span><span class="punctuation">:</span> <span class="string">&#x27;test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">.tests</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">echo &quot;mvn test&quot;</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">refs</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">branches</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">testjob</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">extends</span><span class="punctuation">:</span> <span class="string">.tests</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span> <span class="string">echo &quot;mvn clean test&quot;</span></span><br><span class="line">  <span class="attribute">only</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$RSPEC</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="attribute">newbuildjob</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;123&quot;</span></span><br><span class="line">  <span class="attribute">extends</span><span class="punctuation">:</span> <span class="string">.template</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这将运行名为<code>useTemplate</code>的作业，该作业运行<code>echo Hello!</code> 如<code>.template</code>作业中所定义，并使用本地作业中所定义的<code>alpine</code> Docker映像.</p>
<h2 id="trigger-管道触发"><a href="#trigger-管道触发" class="headerlink" title="trigger 管道触发"></a>trigger 管道触发</h2><p>当GitLab从<code>trigger</code>定义创建的作业启动时，将创建一个下游管道。允许创建多项目管道和子管道。将<code>trigger</code>与<code>when:manual</code>一起使用会导致错误。</p>
<p>多项目管道： 跨多个项目设置流水线，以便一个项目中的管道可以触发另一个项目中的管道。[微服务架构]</p>
<p>父子管道: 在同一项目中管道可以触发一组同时运行的子管道,子管道仍然按照阶段顺序执行其每个作业，但是可以自由地继续执行各个阶段，而不必等待父管道中无关的作业完成。</p>
<h3 id="多项目管道"><a href="#多项目管道" class="headerlink" title="多项目管道"></a>多项目管道</h3><p>当前面阶段运行完成后，触发demo&#x2F;demo-java-service项目master流水线。创建上游管道的用户需要具有对下游项目的访问权限。如果发现下游项目用户没有访问权限以在其中创建管道，则<code>staging</code>作业将被标记为<em>失败</em>。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">staging:</span></span><br><span class="line"><span class="symbol">  variables:</span></span><br><span class="line"><span class="symbol">    ENVIRONMENT:</span> staging</span><br><span class="line"><span class="symbol">  stage:</span> deploy</span><br><span class="line"><span class="symbol">  trigger:</span> </span><br><span class="line"><span class="symbol">    project:</span> demo/demo-java-service</span><br><span class="line"><span class="symbol">    branch:</span> master</span><br><span class="line"><span class="symbol">    strategy:</span> depend</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>project</code>关键字，用于指定下游项目的完整路径。该<code>branch</code>关键字指定由指定的项目分支的名称。使用<code>variables</code>关键字将变量传递到下游管道。 全局变量也会传递给下游项目。上游管道优先于下游管道。如果在上游和下游项目中定义了两个具有相同名称的变量，则在上游项目中定义的变量将优先。默认情况下，一旦创建下游管道，<code>trigger</code>作业就会以<code>success</code>状态完成。<code>strategy: depend</code>将自身状态从触发的管道合并到源作业。</p>
<p><img src="/2020/12/14/gitlab-ci-cd/34.png" alt="images"></p>
<p>在下游项目中查看管道信息</p>
<p><img src="/2020/12/14/gitlab-ci-cd/35.png" alt="images"></p>
<p>在此示例中，一旦创建了下游管道，该<code>staging</code>将被标记为成功。</p>
<h2 id="父子管道"><a href="#父子管道" class="headerlink" title="父子管道"></a>父子管道</h2><p>创建子管道ci&#x2F;child01.yml </p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">child-a-build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">: </span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;hello3a&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 10</span></span><br></pre></td></tr></table></figure>



<p>在父管道触发子管道</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">staging2:</span></span><br><span class="line"><span class="symbol">  variables:</span></span><br><span class="line"><span class="symbol">    ENVIRONMENT:</span> staging</span><br><span class="line"><span class="symbol">  stage:</span> deploy</span><br><span class="line"><span class="symbol">  trigger:</span> </span><br><span class="line"><span class="symbol">    include:</span> ci/child01.yml  </span><br><span class="line"><span class="symbol">    strategy:</span> depend</span><br></pre></td></tr></table></figure>



<p><img src="/2020/12/14/gitlab-ci-cd/36.png" alt="images"></p>
<p>注册docker执行器类型的runner。可以参考以下命令指定：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner register \</span><br><span class="line">  <span class="params">--non-interactive</span> \</span><br><span class="line">  <span class="params">--executor</span> <span class="string">&quot;docker&quot;</span> \</span><br><span class="line">  <span class="params">--docker-image</span> alpine<span class="function">:latest</span> \</span><br><span class="line">  <span class="params">--url</span> <span class="string">&quot;http://172.12.1.10:30088/&quot;</span> \</span><br><span class="line">  <span class="params">--registration-token</span> <span class="string">&quot;z5Lffq2a91xNt37S2y1d&quot;</span> \</span><br><span class="line">  <span class="params">--description</span> <span class="string">&quot;docker-runner&quot;</span> \</span><br><span class="line">  <span class="params">--tag-list</span> <span class="string">&quot;newdocker&quot;</span> \</span><br><span class="line">  <span class="params">--run-untagged=</span><span class="string">&quot;true&quot;</span> \</span><br><span class="line">  <span class="params">--locked=</span><span class="string">&quot;false&quot;</span> \</span><br><span class="line">  <span class="params">--access-level=</span><span class="string">&quot;not_protected&quot;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  <span class="attr">name</span> = <span class="string">&quot;docker-runner&quot;</span></span><br><span class="line">  <span class="attr">url</span> = <span class="string">&quot;http://192.168.1.200:30088/&quot;</span></span><br><span class="line">  <span class="attr">token</span> = <span class="string">&quot;xuaLZD7xUVviTsyeJAWh&quot;</span></span><br><span class="line">  <span class="attr">executor</span> = <span class="string">&quot;docker&quot;</span></span><br><span class="line">  <span class="section">[runners.custom_build_dir]</span></span><br><span class="line">  <span class="section">[runners.cache]</span></span><br><span class="line">    <span class="section">[runners.cache.s3]</span></span><br><span class="line">    <span class="section">[runners.cache.gcs]</span></span><br><span class="line">  <span class="section">[runners.docker]</span></span><br><span class="line">    <span class="attr">pull_policy</span> = <span class="string">&quot;if-not-present&quot;</span></span><br><span class="line">    <span class="attr">tls_verify</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">image</span> = <span class="string">&quot;alpine:latest&quot;</span></span><br><span class="line">    <span class="attr">privileged</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">disable_entrypoint_overwrite</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">oom_kill_disable</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">disable_cache</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">volumes</span> = [<span class="string">&quot;/cache&quot;</span>]</span><br><span class="line">    <span class="attr">shm_size</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>



<h2 id="image"><a href="#image" class="headerlink" title="image"></a>image</h2><p>默认在注册runner的时候需要填写一个基础的镜像，请记住一点只要使用执行器为docker类型的runner所有的操作运行都会在容器中运行。 如果全局指定了images则所有作业使用此image创建容器并在其中运行。 全局未指定image，再次查看job中是否有指定，如果有此job按照指定镜像创建容器并运行，没有则使用注册runner时指定的默认镜像。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#image: maven:3.6.3-jdk-8</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">before_script</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ls</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">maven:3.6.3-jdk-8</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">newdocker</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;mvn clean &quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 10</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attribute">tags</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">newdocker</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo &quot;deploy&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="services"><a href="#services" class="headerlink" title="services"></a>services</h2><p>工作期间运行的另一个Docker映像，并link到<code>image</code>关键字定义的Docker映像。这样，您就可以在构建期间访问服务映像.</p>
<p>服务映像可以运行任何应用程序，但是最常见的用例是运行数据库容器，例如<code>mysql</code> 。与每次安装项目时都安装<code>mysql</code>相比，使用现有映像并将其作为附加容器运行更容易，更快捷。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">services</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">name: mysql:latest</span></span><br><span class="line">    <span class="attribute">alias</span><span class="punctuation">:</span> <span class="string">mysql-1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h2><p>声明所部署的环境名称和访问地址，后续可以直接在gitlab 环境变量中查看。非常方便。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">deploy to production:</span><br><span class="line"><span class="symbol">  stage:</span> deploy</span><br><span class="line"><span class="symbol">  script:</span> git push production HEAD:master</span><br><span class="line"><span class="symbol">  environment:</span></span><br><span class="line"><span class="symbol">    name:</span> production</span><br><span class="line"><span class="symbol">    url:</span> https:<span class="comment">//prod.example.com</span></span><br></pre></td></tr></table></figure>

<h2 id="inherit"><a href="#inherit" class="headerlink" title="inherit"></a>inherit</h2><p>使用或禁用全局定义的环境变量（variables）或默认值(default)。</p>
<p><em>使用true、false决定是否使用，默认为true</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inherit:</span></span><br><span class="line">  <span class="attr">default:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">variables:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>



<p><em>继承其中的一部分变量或默认值使用list</em></p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">inherit</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">default</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">parameter1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">parameter2</span></span><br><span class="line">  <span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">VARIABLE1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">VARIABLE2</span></span><br></pre></td></tr></table></figure>



<h1 id="工具链集成"><a href="#工具链集成" class="headerlink" title="工具链集成"></a>工具链集成</h1><h2 id="mvn"><a href="#mvn" class="headerlink" title="mvn"></a>mvn</h2><p>在template目录中创建maven流水线模板。 templates&#x2F;java-pipeline.yml</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">project: &#x27;cidevops/cidevops-gitlabci-service&#x27;</span></span><br><span class="line">    <span class="attribute">ref</span><span class="punctuation">:</span> <span class="string">master</span></span><br><span class="line">    <span class="attribute">file</span><span class="punctuation">:</span> <span class="string">&#x27;jobs/build.yml&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">project: &#x27;cidevops/cidevops-gitlabci-service&#x27;</span></span><br><span class="line">    <span class="attribute">ref</span><span class="punctuation">:</span> <span class="string">master</span></span><br><span class="line">    <span class="attribute">file</span><span class="punctuation">:</span> <span class="string">&#x27;jobs/test.yml&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">BUILD_SHELL</span><span class="punctuation">:</span> <span class="string">&#x27;mvn clean package  -DskipTests&#x27;  ##构建命令</span></span><br><span class="line">  <span class="attribute">CACHE_DIR</span><span class="punctuation">:</span> <span class="string">&#x27;target/&#x27;</span></span><br><span class="line">  <span class="attribute">TEST_SHELL</span><span class="punctuation"> :</span> <span class="string">&#x27;mvn test&#x27;                                   ##测试命令</span></span><br><span class="line">  <span class="attribute">JUNIT_REPORT_PATH</span><span class="punctuation">:</span> <span class="string">&#x27;target/surefire-reports/TEST-*.xml&#x27;   ##单元测试报告</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$&#123;CACHE_DIR&#125;</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">extends</span><span class="punctuation">:</span> <span class="string">.build</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">test</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">test</span></span><br><span class="line">  <span class="attribute">extends</span><span class="punctuation">:</span> <span class="string">.test</span></span><br></pre></td></tr></table></figure>

<p>最后我们在项目中添加.gitlab-ci.yml来引用模板构建流水线。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>:</span><br><span class="line">    - <span class="keyword">project</span>: <span class="string">&#x27;cidevops/cidevops-gitlabci-service&#x27;</span></span><br><span class="line">      ref: master</span><br><span class="line">      <span class="keyword">file</span>: <span class="string">&#x27;templates/java-pipeline.yml&#x27;</span></span><br><span class="line">  </span><br><span class="line">variables:</span><br><span class="line">  BUILD_SHELL: <span class="string">&#x27;mvn clean package  -DskipTests&#x27;</span>  </span><br><span class="line">  TEST_SHELL: <span class="string">&#x27;mvn  test&#x27;</span></span><br><span class="line">  CACHE_DIR: <span class="string">&#x27;target/&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/14/gitlab-ci-cd/003.png" alt="images"></p>
<h2 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h2><p>template&#x2F;web-pipeline.yml</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">project: &#x27;cidevops/cidevops-gitlabci-service&#x27;</span></span><br><span class="line">    <span class="attribute">ref</span><span class="punctuation">:</span> <span class="string">master</span></span><br><span class="line">    <span class="attribute">file</span><span class="punctuation">:</span> <span class="string">&#x27;jobs/build.yml&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">variables</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">BUILD_SHELL</span><span class="punctuation">:</span> <span class="string">&#x27;npm run build&#x27;     ##构建命令                                   </span></span><br><span class="line">  <span class="attribute">CACHE_DIR</span><span class="punctuation">  :</span> <span class="string">&quot;dist/&quot;             ##构建缓存</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="attribute">cache</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">paths</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$&#123;CACHE_DIR&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node_modules/</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">stages</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">install</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  </span><br><span class="line"><span class="attribute">install</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">install</span></span><br><span class="line">  <span class="attribute">script</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;npm install&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">build</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">stage</span><span class="punctuation">:</span> <span class="string">build</span></span><br><span class="line">  <span class="attribute">extends</span><span class="punctuation">:</span> <span class="string">.build</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="sonar"><a href="#sonar" class="headerlink" title="sonar"></a>sonar</h2><p>部署sonar yaml在github(lib路径先别挂载)</p>
<p>工具连接：</p>
<p>sonar-scanner：<a target="_blank" rel="noopener" href="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</a></p>
<p>参考</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/analysis/gitlab-cicd/">https://docs.sonarqube.org/latest/analysis/gitlab-cicd/</a>  </p>
<p>扩展插件：  <a target="_blank" rel="noopener" href="https://github.com/mc1arke/sonarqube-community-branch-plugin/releases">https://github.com/mc1arke/sonarqube-community-branch-plugin/releases</a> #ee多分支扫描插件  需sonar8.5及以下</p>
<p>复制插件的JAR文件到<code>extensions/plugins/</code> ，<code>lib/common/</code></p>
<p>Gitlab内置环境变量： <a target="_blank" rel="noopener" href="http://192.168.1.200:30088/help/ci/variables/README#variables">http://192.168.1.200:30088/help/ci/variables/README#variables</a></p>
<p>参考文章：<a target="_blank" rel="noopener" href="http://119.3.228.122/jenkins/pipelineintegrated/chapter04/#%E9%85%8D%E7%BD%AE%E5%A4%9A%E5%88%86%E6%94%AF">http://119.3.228.122/jenkins/pipelineintegrated/chapter04/#%E9%85%8D%E7%BD%AE%E5%A4%9A%E5%88%86%E6%94%AF</a></p>
<p>下载工具，配置环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NODE_HOME=/usr/local/node-v10.15.3-linux-x64</span><br><span class="line"><span class="built_in">export</span> SONAR_HOME=/usr/local/sonar-scanner-3.2.0.1227-linux</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$NODE_HOME</span>/bin:<span class="variable">$SONAR_HOME</span>/bin</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>屈辉
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://horus-k.github.io/2020/12/14/gitlab-ci-cd/" title="GitLab-CI&#x2F;CD">https://horus-k.github.io/2020/12/14/gitlab-ci-cd/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/gitlab/" rel="tag"># gitlab</a>
              <a href="/tags/ci-cd/" rel="tag"># ci/cd</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/12/08/gitlab%E9%83%A8%E7%BD%B2/" rel="prev" title="gitlab部署">
                  <i class="fa fa-chevron-left"></i> gitlab部署
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/12/15/ingress/ingress-nginx-yaml%E9%83%A8%E7%BD%B2%E6%96%87%E4%BB%B6/" rel="next" title="ingress-nginx-yaml部署文件">
                  ingress-nginx-yaml部署文件 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">屈辉</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.6m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">23:56</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
