<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"horus-k.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"remove","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="存储基础">
<meta property="og:type" content="website">
<meta property="og:title" content="ceph">
<meta property="og:url" content="https://horus-k.github.io/ceph11/index.html">
<meta property="og:site_name" content="Q&#39;s blog">
<meta property="og:description" content="存储基础">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201024224735002.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201024224655443.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201024224854558.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201024225000923.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025204658001.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025210520508.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025210603427.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025210841602.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025211114850.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025211412781.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025214601818.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025214854737.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025215415736.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025215506969-1604217444470.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025222956312.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025225832909.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025225849996.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025225849996.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025230755329.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201025235628922.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201026220448819.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201026223002059.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201029221514361.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201029221457258.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201031150413977.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201031153325508.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201101152926819.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201101154218826.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201101154727560.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201101161000176.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201101161322118.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201101171351988.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/c71970eb16b0dacbe6c8a79391a0003.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201101173648245.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201101193539386.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201102210436157.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201102210500438.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201107160800195.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201107160945188.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201107161954468.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201107173342143.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201110150639939.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201110232102291.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201110232310060.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201111170121442.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201112194658307.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201112195805183.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201112205640001.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201114141237208.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201114141537505.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201114142245017.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201114214342564.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201114215425196.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201114221925729.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201115174324449.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201115210128101.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201116150526801.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201116151706061.png">
<meta property="og:image" content="https://horus-k.github.io/ceph11/index/image-20201116154123566.png">
<meta property="article:published_time" content="2020-10-31T11:42:38.000Z">
<meta property="article:modified_time" content="2023-06-20T09:17:19.893Z">
<meta property="article:author" content="屈辉">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://horus-k.github.io/ceph11/index/image-20201024224735002.png">


<link rel="canonical" href="https://horus-k.github.io/ceph11/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":false,"lang":"zh-CN","comments":true,"permalink":"https://horus-k.github.io/ceph11/index.html","path":"ceph11/index.html","title":"ceph"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ceph | Q's blog
</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Q's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一些个人文档笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">124</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">45</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">264</span></a></li><li class="menu-item menu-item-ceph"><a href="/ceph/" rel="section"><i class="address-book fa-fw"></i>ceph</a></li><li class="menu-item menu-item-k8s"><a href="/categories/k8s/" rel="section"><i class="archive fa-fw"></i>k8s</a></li><li class="menu-item menu-item-network"><a href="/network/" rel="section"><i class="archive fa-fw"></i>network</a></li>
  </ul>
</nav>




</header>
    </div>

    <div class="main-inner page posts-expand">


    
    
    
    <div class="post-block" lang="zh-CN"><header class="post-header">

<h1 class="post-title" itemprop="name headline">ceph
</h1>

<div class="post-meta-container">
</div>

</header>

      
      
      <div class="post-body">
          <h1 id="存储基础"><a href="#存储基础" class="headerlink" title="存储基础"></a>存储基础</h1><p><img src="/ceph11/index/image-20201024224735002.png" alt="image-20201024224735002"></p>
<span id="more"></span>

<p><img src="/ceph11/index/image-20201024224655443.png" alt="image-20201024224655443"></p>
<h1 id="存储架构"><a href="#存储架构" class="headerlink" title="存储架构"></a>存储架构</h1><p><img src="/ceph11/index/image-20201024224854558.png" alt="image-20201024224854558"></p>
<table>
<thead>
<tr>
<th>组件</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Monitor</td>
<td>它是一个在主机上面运行的守护进程，这个守护进程，扮演着监控集群整个组件的职责，包括多少个存储池，存储池中有多少个PG，PG与osd映射的关系，每个节点有多少个osd等等，都要监视，它是整个集群运行图（Cluster Map）的持有者，一共5个运行图。 它还维护集群的认证信息，客户端有用户名密码等；内部的OSD也需要与mon通信，也需要认证，它是通过cephX协议进行认证的，各个组件之间通信，都必须认证，认证都需要经过mon,因此mon还是认证中心，有些同学就会想到，如果集群很大了的话，认证中心会不会成为瓶颈，所以这也是需要多台mon的原因，mon在认证上是无状态的，可以做任意横向扩展，可以使用负载均衡负载的；</td>
</tr>
<tr>
<td>Managers</td>
<td>它的专门守护进程是ceph-mgr，负责收集集群的状态指标，运行时的metrics，存储的利用率，当前性能指标和系统负载，它有很多基于Python的插件，以实现ceph-mgr功能的提升，用户辅助mon的。</td>
</tr>
<tr>
<td>OSD</td>
<td>Osd是指的单独的资源存储设备，一般情况下一台服务器上面放多块磁盘，ceph为了使用每个节点上面的osd单独进行管理，每一个osd都会有一个单独的、专用的守护进程，比如说，一台服务器上面有6个osd，就需要6个ceph-osd进程，每一个磁盘上面，都有一个守护进程。它提供存储 PG 的数据、数据复制、恢复、再均衡，并提供一些监控信息供mon和mgr来check，并且还可以通过心跳检测其它副本；至少需要有三个osd，不是三台节点哦，这里要注意下，一般情况下我们是1主2从，1主PG、2个副本PG、以确保其高可用性；</td>
</tr>
<tr>
<td>CURSH</td>
<td>CRUSH 是 Ceph 使用的数据分布算法，类似一致性哈希，让数据分配到预期的位置。</td>
</tr>
<tr>
<td>PG</td>
<td>PG 全称 Placement Groups，是一个逻辑的概念，一个 PG 包含多个 OSD 。引入 PG 这一层其实是为了更好的分配数据和定位数据。</td>
</tr>
<tr>
<td>Object</td>
<td>文件需要切分成大小为4M（默认）的块即对象，Ceph 最底层的存储单元就是 Object对象，每个 Object 包含元数据和原始数据；</td>
</tr>
<tr>
<td>RADOS</td>
<td>实现数据分配、Failover 等集群操作。</td>
</tr>
<tr>
<td>Libradio</td>
<td>librados提供了访问RADOS存储集群支持异步通信的API接口，支持对集群中对象数据的直接并行访问，用户可通过支持的编程语言开发自定义客户端程序通过RADOS协议与存储系统进行交互；</td>
</tr>
<tr>
<td>MDS</td>
<td>MDS全称Ceph Metadata Server，是CephFS服务依赖的元数据服务；</td>
</tr>
<tr>
<td>RBD</td>
<td>RBD全称 RADOS Block Device，是 Ceph 对外提供的块设备服务；</td>
</tr>
<tr>
<td>RGW</td>
<td>RGW依赖于在RADOS集群基础上独立运行的守护进程(ceph-radosgw)基于http 或https协议提供相关的API服务，不过，通常仅在需要以REST对象形式存取数据时才部署RGW；</td>
</tr>
<tr>
<td>CephFS</td>
<td>CephFS全称Ceph File System，是 Ceph 对外提供的文件系统服务，它是最早出现的，但也是最后可用于生产的，目前的版本，可以用在生产中。</td>
</tr>
<tr>
<td>Admin</td>
<td>Ceph常用管理接口通常都是命令行工具，如rados、ceph、rbd等命令，另外Ceph还有可以有一个专用的管理节点，在此节点上面部署专用的管理工具来实现近乎集群的一些管理工作，如集群部署，集群组件管理等。</td>
</tr>
</tbody></table>
<h1 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h1><p><img src="/ceph11/index/image-20201024225000923.png" alt="image-20201024225000923"></p>
<h2 id="主机名和hosts"><a href="#主机名和hosts" class="headerlink" title="主机名和hosts"></a>主机名和hosts</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.211.56.201 node-1</span><br><span class="line">10.211.56.202 node-2</span><br><span class="line">10.211.56.203 node-3</span><br></pre></td></tr></table></figure>

<h2 id="ssh免密"><a href="#ssh免密" class="headerlink" title="ssh免密"></a>ssh免密</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id</span><br></pre></td></tr></table></figure>

<h2 id="安全设置"><a href="#安全设置" class="headerlink" title="安全设置"></a>安全设置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">systemctl stop NetworkManager</span><br><span class="line">systemctl <span class="built_in">disable</span> NetworkManager</span><br></pre></td></tr></table></figure>

<h2 id="ntp时间同步"><a href="#ntp时间同步" class="headerlink" title="ntp时间同步"></a>ntp时间同步</h2><h2 id="yum源"><a href="#yum源" class="headerlink" title="yum源"></a>yum源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-6.repo</span><br><span class="line">sed -i -e <span class="string">&#x27;/mirrors.cloud.aliyuncs.com/d&#x27;</span> -e <span class="string">&#x27;/mirrors.aliyuncs.com/d&#x27;</span> /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum makecache</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/ceph.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[norch]</span></span><br><span class="line"><span class="string">name=norch</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7/noarch/</span></span><br><span class="line"><span class="string">enable=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[x86_64]</span></span><br><span class="line"><span class="string">name=x86_64</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7/x86_64/</span></span><br><span class="line"><span class="string">enable=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="安装ceph-deploy"><a href="#安装ceph-deploy" class="headerlink" title="安装ceph-deploy"></a>安装ceph-deploy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y python-setuptools</span><br><span class="line">yum install -y ceph-deploy  <span class="comment">#ceph-deploy v2.0.1</span></span><br></pre></td></tr></table></figure>

<h2 id="安装monitor节点"><a href="#安装monitor节点" class="headerlink" title="安装monitor节点"></a>安装monitor节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> my-cluster</span><br><span class="line"><span class="built_in">cd</span> my-cluster</span><br><span class="line">ceph-deploy new --public-network 10.211.55.0/24 --cluster-network 10.211.56.0/24 node-1</span><br><span class="line"><span class="comment">#创建集群</span></span><br><span class="line"><span class="comment">#cluster-network用于内部数据同步</span></span><br><span class="line"><span class="comment">#public-network：ceph对外入口</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201025204658001.png" alt="image-20201025204658001"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ceph ceph-mon ceph-mgr ceph-radosgw ceph-mds <span class="comment">#所有节点</span></span><br><span class="line">ceph-deploy mon create-initial <span class="comment">#初始化</span></span><br><span class="line">ceph-deploy admin node-1 node-2 node-3 <span class="comment">#推送秘钥</span></span><br><span class="line">ceph-deploy mgr create node-1 <span class="comment">#创建监控节点</span></span><br><span class="line">ceph  quorum_status --format json-pretty <span class="comment"># 查看节点信息</span></span><br></pre></td></tr></table></figure>

<h2 id="安装osd"><a href="#安装osd" class="headerlink" title="安装osd"></a>安装osd</h2><p>先在宿主机挂盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;- - -&quot;</span> &gt; /sys/class/scsi_host/host0/scan</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;- - -&quot;</span> &gt; /sys/class/scsi_host/host1/scan</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;- - -&quot;</span> &gt; /sys/class/scsi_host/host2/scan</span><br><span class="line"></span><br><span class="line">$ ceph-deploy osd create --data /dev/sdb node-1</span><br><span class="line">$ ceph-deploy osd create --data /dev/sdb node-2</span><br><span class="line">$ ceph-deploy osd create --data /dev/sdb node-3</span><br><span class="line">$ ceph osd pool create ceph-demo 32 32</span><br></pre></td></tr></table></figure>

<h2 id="扩展mon与mgr"><a href="#扩展mon与mgr" class="headerlink" title="扩展mon与mgr"></a>扩展mon与mgr</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mon add node-2 --address 10.211.55.202 <span class="comment">#添加监控节点</span></span><br><span class="line">ceph-deploy mon add node-3 --address 10.211.55.203 <span class="comment">#添加监控节点</span></span><br><span class="line">ceph mon dump <span class="comment">#mon状态</span></span><br><span class="line">ceph mon <span class="built_in">stat</span></span><br><span class="line">ceph-deploy mgr  create node-2 node-3 <span class="comment">#添加mgr节点</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201025210520508.png" alt="image-20201025210520508"></p>
<p><img src="/ceph11/index/image-20201025210603427.png" alt="image-20201025210603427"></p>
<h1 id="RBD块存储"><a href="#RBD块存储" class="headerlink" title="RBD块存储"></a>RBD块存储</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><img src="/ceph11/index/image-20201025210841602.png" alt="image-20201025210841602"></p>
<h2 id="创建资源池Pool"><a href="#创建资源池Pool" class="headerlink" title="创建资源池Pool"></a>创建资源池Pool</h2><h3 id="关于存储池"><a href="#关于存储池" class="headerlink" title="关于存储池"></a>关于存储池</h3><p>Ceph 存储系统支持“池”概念，它是存储对象的逻辑分区。</p>
<p>Ceph 客户端从监视器获取一张<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/architecture/#id4">集群运行图</a>，并把对象写入存储池。存储池的 <code>size</code> 或副本数、 CRUSH 规则集和归置组数量决定着 Ceph 如何放置数据。</p>
<p><img src="/ceph11/index/image-20201025211114850.png" alt="image-20201025211114850"></p>
<p>存储池至少可设置以下参数：</p>
<ul>
<li>对象的所有权&#x2F;访问权限；</li>
<li>归置组数量；以及，</li>
<li>使用的 CRUSH 规则集。</li>
</ul>
<h3 id="PG-映射到-OSD"><a href="#PG-映射到-OSD" class="headerlink" title="PG 映射到 OSD"></a>PG 映射到 OSD</h3><p>每个存储池都有很多归置组， CRUSH 动态的把它们映射到 OSD 。 Ceph 客户端要存对象时， CRUSH 将把各对象映射到某个归置组。</p>
<p>把对象映射到归置组在 OSD 和客户端间创建了一个间接层。由于 Ceph 集群必须能增大或缩小、并动态地重均衡。如果让客户端“知道”哪个 OSD 有哪个对象，就会导致客户端和 OSD 紧耦合；相反， CRUSH 算法把对象映射到归置组、然后再把各归置组映射到一或多个 OSD ，这一间接层可以让 Ceph 在 OSD 守护进程和底层设备上线时动态地重均衡。下列图表描述了 CRUSH 如何将对象映射到归置组、再把归置组映射到 OSD 。</p>
<p><img src="/ceph11/index/image-20201025211412781.png" alt="image-20201025211412781"></p>
<p>有了集群运行图副本和 CRUSH 算法，客户端就能精确地计算出到哪个 OSD 读、写某特定对象。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create ceph-demo  32      32 </span><br><span class="line"> <span class="comment">#                   名称		  pg数量  pgp数量</span></span><br><span class="line">ceph osd <span class="built_in">ls</span></span><br><span class="line">ceph osd lspools</span><br><span class="line">ceph osd pool get ceph-demo pg_num</span><br><span class="line">ceph osd pool get ceph-demo pgp_num</span><br><span class="line">ceph osd pool get ceph-demo size</span><br><span class="line">ceph osd pool get ceph-demo crush_rule</span><br><span class="line">ceph osd pool <span class="built_in">set</span> ceph-demo size 2 <span class="comment">#设置pool副本数，默认3</span></span><br><span class="line">ceph osd pool <span class="built_in">set</span> ceph-demo pg_num 128 <span class="comment">#调整pg</span></span><br><span class="line">ceph osd pool <span class="built_in">set</span> ceph-demo pgp_num 128 <span class="comment">#调整pg，对应的pgp也要调整</span></span><br><span class="line">rbd poll init &lt;pool-name&gt; <span class="comment">##先不做</span></span><br></pre></td></tr></table></figure>

<h2 id="RBD创建和映射"><a href="#RBD创建和映射" class="headerlink" title="RBD创建和映射"></a>RBD创建和映射</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rbd create -p ceph-demo --image rbd-demo.img --size 10G</span><br><span class="line">rbd create -p ceph-demo/rbd-demo.img --size 10G </span><br><span class="line">rbd  -p ceph-demo <span class="built_in">ls</span></span><br><span class="line">rbd info ceph-demo/rbd-demo.img </span><br><span class="line">rbd <span class="built_in">rm</span> -p ceph-demo/rbd-demo.img <span class="comment">#删除</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201025214601818.png" alt="image-20201025214601818"></p>
<p>有些参数内核不支持：</p>
<ul>
<li><p>升级内核</p>
<p>5+版都支持</p>
</li>
<li><p>去掉参数</p>
<p><img src="/ceph11/index/image-20201025214854737.png" alt="image-20201025214854737"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rbd feature <span class="built_in">disable</span> ceph-demo/rbd-demo.img deep-flatten <span class="comment">#从后往前依次关闭特性</span></span><br><span class="line">rbd feature <span class="built_in">disable</span> ceph-demo/rbd-demo.img fast-diff</span><br><span class="line">rbd feature <span class="built_in">disable</span> ceph-demo/rbd-demo.img object-map</span><br><span class="line">rbd feature <span class="built_in">disable</span> ceph-demo/rbd-demo.img exclusive-lock</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="映射块设备"><a href="#映射块设备" class="headerlink" title="映射块设备"></a>映射块设备</h3><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd <span class="built_in">map</span> ceph-<span class="built_in">demo</span>/rbd-<span class="built_in">demo</span>.img </span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201025215415736.png" alt="image-20201025215415736"></p>
<p><img src="/ceph11/index/image-20201025215506969-1604217444470.png" alt="image-20201025215506969-1604217444470.png"></p>
<h3 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/rbd0</span><br><span class="line"><span class="built_in">mkdir</span> /mnt/rbd-demo</span><br><span class="line">mount /dev/rbd0 /mnt/rbd-demo</span><br></pre></td></tr></table></figure>

<h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rbd resize ceph-demo/rbd-demo.img --size 15G <span class="comment">#扩容</span></span><br><span class="line">rbd info ceph-demo/rbd-demo.img <span class="comment">#查询</span></span><br><span class="line">resize2fs /dev/rbd0</span><br></pre></td></tr></table></figure>

<h2 id="数据流写入过程"><a href="#数据流写入过程" class="headerlink" title="数据流写入过程"></a>数据流写入过程</h2><p><img src="/ceph11/index/image-20201025222956312.png" alt="image-20201025222956312"></p>
<h3 id="查看对象信息"><a href="#查看对象信息" class="headerlink" title="查看对象信息"></a>查看对象信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rbd info  ceph-demo/rbd-demo.img <span class="comment">#查看pool信息</span></span><br><span class="line">rados -p ceph-demo <span class="built_in">ls</span> | grep rbd_data.1e505c9f4eed1 <span class="comment">#查询object id = oid</span></span><br><span class="line">rados -p ceph-demo <span class="built_in">stat</span> rbd_data.1e505c9f4eed1.0000000000000020 <span class="comment">#obj情况</span></span><br><span class="line">ceph osd map ceph-demo rbd_data.1e505c9f4eed1.0000000000000620 <span class="comment">#落盘情况</span></span><br><span class="line">ceph osd tree <span class="comment">#osd信息</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `rados -p ceph-demo <span class="built_in">ls</span> | grep rbd_data.1e505c9f4eed1`;<span class="keyword">do</span> rados -p ceph-demo <span class="built_in">stat</span> <span class="variable">$&#123;i&#125;</span>;<span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `rados -p ceph-demo <span class="built_in">ls</span> | grep rbd_data.1e505c9f4eed1`;<span class="keyword">do</span> ceph osd map ceph-demo <span class="variable">$&#123;i&#125;</span>;<span class="keyword">done</span></span><br><span class="line">watch -n 1 <span class="string">&#x27;rados -p ceph-demo ls | grep rbd_data.1e505c9f4eed1 | wc -l&#x27;</span> <span class="comment">#查看有多少个object</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201025225832909.png" alt="image-20201025225832909"></p>
<p><img src="/ceph11/index/image-20201025225849996.png" alt="image-20201025225849996"></p>
<p><img src="/ceph11/index/image-20201025225849996.png" alt="image-20201025225849996"></p>
<p><img src="/ceph11/index/image-20201025230755329.png" alt="image-20201025230755329"></p>
<h2 id="报警排查"><a href="#报警排查" class="headerlink" title="报警排查"></a>报警排查</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ceph -s</span><br><span class="line">ceph health detail</span><br><span class="line">ceph osd pool application <span class="built_in">enable</span> ceph-demo rbd</span><br><span class="line">$ ceph osd pool application get ceph-demo</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;rbd&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">ceph crash <span class="built_in">ls</span> </span><br><span class="line">ceph crash info  &lt;crash-name&gt;</span><br><span class="line">ceph crash archive &lt;crash-name&gt;<span class="comment">#打包</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201025235628922.png"></p>
<h1 id="RGW对象存储"><a href="#RGW对象存储" class="headerlink" title="RGW对象存储"></a>RGW对象存储</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><img src="/ceph11/index/image-20201026220448819.png"></p>
<p><a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/glossary/#term-34"><em>Ceph 对象网关</em></a>是一个构建在 <code>librados</code> 之上的对象存储接口，它为应用程序访问Ceph 存储集群提供了一个 RESTful 风格的网关 。 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/glossary/#term-30"><em>Ceph 对象存储</em></a>支持 2 种接口：</p>
<ol>
<li><strong>兼容S3:</strong> 提供了对象存储接口，兼容 亚马逊S3 RESTful 接口的一个大子集。</li>
<li><strong>兼容Swift:</strong> 提供了对象存储接口，兼容 Openstack Swift 接口的一个大子集。</li>
</ol>
<p>Ceph 对象存储使用 Ceph 对象网关守护进程（ <code>radosgw</code> ），它是个与 Ceph 存储集群交互的 FastCGI 模块。因为它提供了与 OpenStack Swift 和 Amazon S3 兼容的接口， RADOS 要有它自己的用户管理。 Ceph 对象网关可与 Ceph FS 客户端或 Ceph 块设备客户端共用一个存储集群。 S3 和 Swift 接口共用一个通用命名空间，所以你可以用一个接口写如数据、然后用另一个接口取出数据。</p>
<p><img src="/ceph11/index/image-20201026223002059.png" alt="image-20201026223002059"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[21:49:43 root@node-1 ~] $ rados <span class="built_in">df</span></span><br><span class="line">POOL_NAME    USED OBJECTS CLONES COPIES MISSING_ON_PRIMARY UNFOUND DEGRADED RD_OPS  RD WR_OPS  WR USED COMPR UNDER COMPR </span><br><span class="line">ceph-demo 2.4 GiB     226      0    678                  0       0        0      1 0 B      0 0 B        0 B         0 B </span><br><span class="line">testpool      0 B       0      0      0                  0       0        0      0 0 B      0 0 B        0 B         0 B </span><br><span class="line"></span><br><span class="line">total_objects    226</span><br><span class="line">total_used       5.4 GiB <span class="comment">#使用情况</span></span><br><span class="line">total_avail      145 GiB</span><br><span class="line">total_space      150 GiB</span><br></pre></td></tr></table></figure>

<h2 id="部署RGW存储网关"><a href="#部署RGW存储网关" class="headerlink" title="部署RGW存储网关"></a>部署RGW存储网关</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yum list | grep ceph-radosgw</span></span><br><span class="line">ceph-radosgw.x86_64                       2:14.2.12-0.el7              @x86_64 </span><br><span class="line">$ <span class="built_in">cd</span> ceph-deploy/</span><br><span class="line">$ ceph-deploy rgw create node-1  <span class="comment">#部署RGW存储网关</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">$ ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    <span class="built_in">id</span>:     a96a9084-601e-46ca-a8b1-cf6b1ab5edf1</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"> </span><br><span class="line">  services:</span><br><span class="line">    mon: 3 daemons, quorum node-1,node-2,node-3 (age 25m)</span><br><span class="line">    mgr: node-1(active, since 2h), standbys: node-2, node-3</span><br><span class="line">    osd: 3 osds: 3 up (since 72m), 3 <span class="keyword">in</span> (since 25h)</span><br><span class="line">    rgw: 1 daemon active (node-1)  <span class="comment">#新节点</span></span><br><span class="line"> </span><br><span class="line">  task status:</span><br><span class="line"> </span><br><span class="line">  data:</span><br><span class="line">    pools:   6 pools, 224 pgs</span><br><span class="line">    objects: 413 objects, 825 MiB</span><br><span class="line">    usage:   5.4 GiB used, 145 GiB / 150 GiB avail</span><br><span class="line">    pgs:     224 active+clean</span><br><span class="line">$ ss -antupl | grep 7480</span><br><span class="line">tcp    LISTEN     0      128       *:7480                  *:*                   <span class="built_in">users</span>:((&quot;radosgw&quot;,pid=<span class="number">8526</span>,fd=<span class="number">48</span>))</span><br><span class="line">tcp    LISTEN     0      128    [::]:7480               [::]:*                   <span class="built_in">users</span>:((&quot;radosgw&quot;,pid=<span class="number">8526</span>,fd=<span class="number">49</span>))</span><br><span class="line">$ yum whatprovides netstat查询命令包</span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * elrepo: mirror-hk.koddos.net</span><br><span class="line">net-tools-2.0-0.25.20131004git.el7.x86_64 : Basic networking tools</span><br><span class="line">源    ：@base</span><br><span class="line">匹配来源：</span><br><span class="line">文件名    ：/usr/bin/netstat</span><br><span class="line"></span><br><span class="line">$ curl http://node-1:7480</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;&lt;ListAllMyBucketsResult xmlns=<span class="string">&quot;http://s3.amazonaws.com/doc/2006-03-01/&quot;</span>&gt;&lt;Owner&gt;&lt;ID&gt;anonymous&lt;/ID&gt;&lt;DisplayName&gt;&lt;/DisplayName&gt;&lt;/Owner&gt;&lt;Buckets&gt;&lt;/Buckets&gt;&lt;/ListAllMyBucketsResult&gt;</span><br></pre></td></tr></table></figure>

<h2 id="修改RGW默认端口"><a href="#修改RGW默认端口" class="headerlink" title="修改RGW默认端口"></a>修改RGW默认端口</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改ceph配置文件</span></span><br><span class="line">[19:14:03 root@node-1 ~/ceph-deploy] <span class="comment"># cat ceph.conf </span></span><br><span class="line">......</span><br><span class="line">[client.rgw.node-1]</span><br><span class="line">rgw_frontends = <span class="string">&quot;civetweb port=80&quot;</span></span><br><span class="line"></span><br><span class="line">$ ceph-deploy --overwrite-conf config push node-1 node-2 node-3 <span class="comment">#强制推送配置文件</span></span><br><span class="line">$ systemctl restart ceph-radosgw.target <span class="comment">#重启服务</span></span><br></pre></td></tr></table></figure>

<h2 id="S3接口使用"><a href="#S3接口使用" class="headerlink" title="S3接口使用"></a>S3接口使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ radosgw-admin user create --uid=<span class="string">&quot;ceph-s3-user&quot;</span> --display-name=<span class="string">&quot;Ceph S3 User Demo&quot;</span>  <span class="comment">#创建用户</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;ceph-s3-user&quot;</span>,</span><br><span class="line">    <span class="string">&quot;display_name&quot;</span>: <span class="string">&quot;Ceph S3 User Demo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;suspended&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;max_buckets&quot;</span>: 1000,</span><br><span class="line">    <span class="string">&quot;subusers&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;keys&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;user&quot;</span>: <span class="string">&quot;ceph-s3-user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;access_key&quot;</span>: <span class="string">&quot;LGHYIQC44CM0T7BHKW2U&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secret_key&quot;</span>: <span class="string">&quot;olbc2icqlZwT3JA9d3dx86JAOIGtLZbopdneH8gu&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;swift_keys&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;caps&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;op_mask&quot;</span>: <span class="string">&quot;read, write, delete&quot;</span>,</span><br><span class="line">    <span class="string">&quot;default_placement&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;default_storage_class&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;placement_tags&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;bucket_quota&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;check_on_raw&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;max_size&quot;</span>: -1,</span><br><span class="line">        <span class="string">&quot;max_size_kb&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;max_objects&quot;</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;user_quota&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;check_on_raw&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;max_size&quot;</span>: -1,</span><br><span class="line">        <span class="string">&quot;max_size_kb&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;max_objects&quot;</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;temp_url_keys&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;rgw&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mfa_ids&quot;</span>: []</span><br><span class="line">&#125;</span><br><span class="line">$ radosgw-admin user info --uid  ceph-s3-user <span class="comment">#查询</span></span><br></pre></td></tr></table></figure>

<h3 id="测试-S3-访问"><a href="#测试-S3-访问" class="headerlink" title="测试 S3 访问"></a>测试 S3 访问</h3><p>为了验证 S3 访问，你需要编写并运行一个 Python 测试脚本。S3 访问测试脚本将连接 <code>radosgw</code>, 新建一个新的 bucket 并列出所有的 buckets。 <code>aws_access_key_id</code> 和 <code>aws_secret_access_key</code> 的值来自于命令<code>radosgw_admin</code> 的返回值 <code>access_key</code> 和 <code>secret_key</code> 。</p>
<p>执行下面的步骤:</p>
<ol>
<li><p>你需要安装 <code>python-boto</code> 包:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum <span class="keyword">install</span> python-boto</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建 Python 脚本文件:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> s3test.<span class="keyword">py</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将下面的内容添加到文件中:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import boto</span><br><span class="line">import boto.s3.connection</span><br><span class="line"></span><br><span class="line">access_key = <span class="string">&#x27;LGHYIQC44CM0T7BHKW2U&#x27;</span></span><br><span class="line">secret_key = <span class="string">&#x27;olbc2icqlZwT3JA9d3dx86JAOIGtLZbopdneH8gu&#x27;</span></span><br><span class="line">conn = boto.connect_s3(</span><br><span class="line">    <span class="attribute">aws_access_key_id</span>=access_key,</span><br><span class="line">    <span class="attribute">aws_secret_access_key</span>=secret_key,</span><br><span class="line">    <span class="attribute">host</span>=<span class="string">&#x27;10.211.55.201&#x27;</span>, <span class="attribute">port</span>=7480,</span><br><span class="line">    <span class="attribute">is_secure</span>=<span class="literal">False</span>,  # uncomment <span class="keyword">if</span> you are <span class="keyword">not</span> using ssl</span><br><span class="line">    <span class="attribute">calling_format</span>=boto.s3.connection.OrdinaryCallingFormat(),</span><br><span class="line">)</span><br><span class="line">bucket = conn.create_bucket(<span class="string">&#x27;my-new-bucket&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> bucket <span class="keyword">in</span> conn.get_all_buckets():</span><br><span class="line">    <span class="built_in">print</span></span><br><span class="line">    <span class="string">&quot;&#123;name&#125; &#123;created&#125;&quot;</span>.format(</span><br><span class="line">        <span class="attribute">name</span>=bucket.name,</span><br><span class="line">        <span class="attribute">created</span>=bucket.creation_date,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将 <code>&#123;hostname&#125;</code> 替换为你配置了网关服务的节点的主机名。比如 <code>gateway host</code>. 将 {port} 替换为 Civetweb 所使用的端口。</p>
</li>
<li><p>运行脚本:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">python</span> s3test.<span class="keyword">py</span>	</span><br></pre></td></tr></table></figure>

<p>输出类似下面的内容:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my-new-bucket 2015-02-16T17:09:10.000Z <span class="comment">#个人做实验不会输出，但bucket已创建</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="S3cmd使用"><a href="#S3cmd使用" class="headerlink" title="S3cmd使用"></a>S3cmd使用</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install s3cmd</span></span><br><span class="line">$ s3cmd --configure</span><br><span class="line"></span><br><span class="line">Enter new values or accept defaults <span class="keyword">in</span> brackets with Enter.</span><br><span class="line">Refer to user manual <span class="keyword">for</span> detailed description of all options.</span><br><span class="line"></span><br><span class="line">Access key and Secret key are your identifiers <span class="keyword">for</span> Amazon S3. Leave them empty <span class="keyword">for</span> using the <span class="built_in">env</span> variables.</span><br><span class="line">Access Key: LGHYIQC44CM0T7BHKW2U <span class="comment">#Access Key</span></span><br><span class="line">Secret Key: olbc2icqlZwT3JA9d3dx86JAOIGtLZbopdneH8gu <span class="comment">#Secret Key</span></span><br><span class="line">Default Region [US]: <span class="comment">#默认</span></span><br><span class="line"></span><br><span class="line">Use <span class="string">&quot;s3.amazonaws.com&quot;</span> <span class="keyword">for</span> S3 Endpoint and not modify it to the target Amazon S3.</span><br><span class="line">S3 Endpoint [s3.amazonaws.com]: 10.211.55.201:80 <span class="comment">#地址</span></span><br><span class="line"></span><br><span class="line">Use <span class="string">&quot;%(bucket)s.s3.amazonaws.com&quot;</span> to the target Amazon S3. <span class="string">&quot;%(bucket)s&quot;</span> and <span class="string">&quot;%(location)s&quot;</span> vars can be used</span><br><span class="line"><span class="keyword">if</span> the target S3 system supports dns based buckets.</span><br><span class="line">DNS-style bucket+hostname:port template <span class="keyword">for</span> accessing a bucket [%(bucket)s.s3.amazonaws.com]: 10.211.55.201:80/%(bucket)s <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">Encryption password is used to protect your files from reading</span><br><span class="line">by unauthorized persons <span class="keyword">while</span> <span class="keyword">in</span> transfer to S3</span><br><span class="line">Encryption password: </span><br><span class="line">Path to GPG program [/usr/bin/gpg]: </span><br><span class="line"></span><br><span class="line">When using secure HTTPS protocol all communication with Amazon S3</span><br><span class="line">servers is protected from 3rd party eavesdropping. This method is</span><br><span class="line">slower than plain HTTP, and can only be proxied with Python 2.7 or newer</span><br><span class="line">Use HTTPS protocol [Yes]: no</span><br><span class="line"></span><br><span class="line">On some networks all internet access must go through a HTTP proxy.</span><br><span class="line">Try setting it here <span class="keyword">if</span> you can<span class="string">&#x27;t connect to S3 directly</span></span><br><span class="line"><span class="string">HTTP Proxy server name: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">New settings:</span></span><br><span class="line"><span class="string">  Access Key: LGHYIQC44CM0T7BHKW2U</span></span><br><span class="line"><span class="string">  Secret Key: olbc2icqlZwT3JA9d3dx86JAOIGtLZbopdneH8gu</span></span><br><span class="line"><span class="string">  Default Region: US</span></span><br><span class="line"><span class="string">  S3 Endpoint: 10.211.55.201:80</span></span><br><span class="line"><span class="string">  DNS-style bucket+hostname:port template for accessing a bucket: 10.211.55.201:80/%(bucket)s</span></span><br><span class="line"><span class="string">  Encryption password: </span></span><br><span class="line"><span class="string">  Path to GPG program: /usr/bin/gpg</span></span><br><span class="line"><span class="string">  Use HTTPS protocol: False</span></span><br><span class="line"><span class="string">  HTTP Proxy server name: </span></span><br><span class="line"><span class="string">  HTTP Proxy server port: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Test access with supplied credentials? [Y/n] y</span></span><br><span class="line"><span class="string">Please wait, attempting to list all buckets...</span></span><br><span class="line"><span class="string">Success. Your access key and secret key worked fine :-)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Now verifying that encryption works...</span></span><br><span class="line"><span class="string">Not configured. Never mind.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Save settings? [y/N] y</span></span><br><span class="line"><span class="string">Configuration saved to &#x27;</span>/root/.s3cfg<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="创建Bucket"><a href="#创建Bucket" class="headerlink" title="创建Bucket"></a>创建Bucket</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ s3cmd mb s3://test-demo</span><br><span class="line">ERROR: S3 error: 403 (SignatureDoesNotMatch)</span><br><span class="line">$ vim /root.s3</span><br><span class="line">...</span><br><span class="line">signature_v2 = False <span class="comment">#替换为True</span></span><br><span class="line">...</span><br><span class="line">$ s3cmd mb s3://test-demo</span><br><span class="line">Bucket <span class="string">&#x27;s3://test-demo/&#x27;</span> created</span><br><span class="line">$ s3cmd <span class="built_in">ls</span></span><br><span class="line">2020-10-29 13:47  s3://test-demo</span><br></pre></td></tr></table></figure>

<h3 id="坑："><a href="#坑：" class="headerlink" title="坑："></a>坑：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[22:06:38 root@node-1 ~/my-cluster] <span class="comment">#s3cmd put /etc/fstab s3://my-new-bucket/fstab-demo</span></span><br><span class="line">upload: <span class="string">&#x27;/etc/fstab&#x27;</span> -&gt; <span class="string">&#x27;s3://my-new-bucket/fstab-demo&#x27;</span>  [1 of 1]</span><br><span class="line"> 389 of 389   100% <span class="keyword">in</span>    0s   515.09 B/s  <span class="keyword">done</span></span><br><span class="line">ERROR: S3 error: 416 (InvalidRange) <span class="comment">####</span></span><br><span class="line">将默认pg_num和pgp_num设置为较低的值（例如8）(未测试)，或在ceph.conf中将mon_max_pg_per_osd=300设置为较高的值(已测试)</span><br></pre></td></tr></table></figure>

<h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ s3cmd put /etc/fstab s3://test-demo/fstab-demo</span><br><span class="line">$ s3cmd <span class="built_in">ls</span> s3://test-demo/</span><br><span class="line">$ s3cmd put /etc s3://test-demo/fstab-demo/etc --recursive <span class="comment">#递归上传文件夹</span></span><br><span class="line">$ s3cmd get s3://ceph-s3-<span class="built_in">test</span>/test test2 <span class="comment">#下载</span></span><br><span class="line">$ s3cmd <span class="built_in">rm</span> s3://ceph-s3-<span class="built_in">test</span>/test <span class="comment">#删除</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201029221514361.png" alt="image-20201029221514361"></p>
<p><img src="/ceph11/index/image-20201029221457258.png" alt="image-20201029221457258"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd lspools</span><br><span class="line">2 testpool</span><br><span class="line">3 ceph-demo</span><br><span class="line">4 .rgw.root</span><br><span class="line">5 default.rgw.control</span><br><span class="line">6 default.rgw.meta</span><br><span class="line">7 default.rgw.log</span><br><span class="line">8 default.rgw.buckets.index <span class="comment">#索引</span></span><br><span class="line">9 default.rgw.buckets.data <span class="comment">#bucket存储池</span></span><br><span class="line"></span><br><span class="line">$ s3cmd put /etc/fstab s3://test-demo/test</span><br><span class="line"></span><br><span class="line">$ rados -p default.rgw.buckets.data  <span class="built_in">ls</span>  <span class="comment">#查看池文件</span></span><br><span class="line">b7384d89-0aff-4a0b-acc9-c461bf7e5471.204143.2_test</span><br></pre></td></tr></table></figure>

<h2 id="swift风格api接口"><a href="#swift风格api接口" class="headerlink" title="swift风格api接口"></a>swift风格api接口</h2><ul>
<li>需要新建一个 Swift 子用户</li>
<li>创建 Swift 用户包括两个步骤。第一步是创建用户。第二步是创建 secret key。</li>
</ul>
<p>新建 Swift 用户:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin subuser create --uid=ceph-s3-user &lt;--主用户<span class="built_in">id</span>&gt; --subuser=ceph-s3-user:swift --access=full</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;ceph-s3-user&quot;</span>,</span><br><span class="line">    <span class="string">&quot;display_name&quot;</span>: <span class="string">&quot;Ceph S3 User Demo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;suspended&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;max_buckets&quot;</span>: 1000,</span><br><span class="line">    <span class="string">&quot;subusers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="string">&quot;ceph-s3-user:swift&quot;</span>,</span><br><span class="line">            <span class="string">&quot;permissions&quot;</span>: <span class="string">&quot;full-control&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;keys&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;user&quot;</span>: <span class="string">&quot;ceph-s3-user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;access_key&quot;</span>: <span class="string">&quot;LGHYIQC44CM0T7BHKW2U&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secret_key&quot;</span>: <span class="string">&quot;olbc2icqlZwT3JA9d3dx86JAOIGtLZbopdneH8gu&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;swift_keys&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;user&quot;</span>: <span class="string">&quot;ceph-s3-user:swift&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secret_key&quot;</span>: <span class="string">&quot;bVLptVg3gFoyXzEFY2Trg4uMAXHP5954hkdl0vTr&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;caps&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;op_mask&quot;</span>: <span class="string">&quot;read, write, delete&quot;</span>,</span><br><span class="line">    <span class="string">&quot;default_placement&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;default_storage_class&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;placement_tags&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;bucket_quota&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;check_on_raw&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;max_size&quot;</span>: -1,</span><br><span class="line">        <span class="string">&quot;max_size_kb&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;max_objects&quot;</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;user_quota&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;check_on_raw&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;max_size&quot;</span>: -1,</span><br><span class="line">        <span class="string">&quot;max_size_kb&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;max_objects&quot;</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;temp_url_keys&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;rgw&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mfa_ids&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建 secret key:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin key create --subuser=ceph-s3-user:swift --key-type=swift --gen-secret</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;ceph-s3-user&quot;</span>,</span><br><span class="line">    <span class="string">&quot;display_name&quot;</span>: <span class="string">&quot;Ceph S3 User Demo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;suspended&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;max_buckets&quot;</span>: 1000,</span><br><span class="line">    <span class="string">&quot;subusers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="string">&quot;ceph-s3-user:swift&quot;</span>,</span><br><span class="line">            <span class="string">&quot;permissions&quot;</span>: <span class="string">&quot;full-control&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;keys&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;user&quot;</span>: <span class="string">&quot;ceph-s3-user&quot;</span>,</span><br><span class="line">            <span class="string">&quot;access_key&quot;</span>: <span class="string">&quot;LGHYIQC44CM0T7BHKW2U&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secret_key&quot;</span>: <span class="string">&quot;olbc2icqlZwT3JA9d3dx86JAOIGtLZbopdneH8gu&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;swift_keys&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;user&quot;</span>: <span class="string">&quot;ceph-s3-user:swift&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secret_key&quot;</span>: <span class="string">&quot;lB93qfuWfaIyIZpPM5cbubajOWvS2ADtyN1pp8aS&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;caps&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;op_mask&quot;</span>: <span class="string">&quot;read, write, delete&quot;</span>,</span><br><span class="line">    <span class="string">&quot;default_placement&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;default_storage_class&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;placement_tags&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;bucket_quota&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;check_on_raw&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;max_size&quot;</span>: -1,</span><br><span class="line">        <span class="string">&quot;max_size_kb&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;max_objects&quot;</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;user_quota&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;check_on_raw&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;max_size&quot;</span>: -1,</span><br><span class="line">        <span class="string">&quot;max_size_kb&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;max_objects&quot;</span>: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;temp_url_keys&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;rgw&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mfa_ids&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;secret_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bVLptVg3gFoyXzEFY2Trg4uMAXHP5954hkdl0vTr&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装环境</span></span><br><span class="line">easy_install pip</span><br><span class="line">pip install --upgrade setuptools</span><br><span class="line">pip install --upgrade python-swiftclient</span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">$ swift -A http://10.211.55.201:7480/auth/1.0 -U ceph-s3-user:swift -K <span class="string">&#x27;lB93qfuWfaIyIZpPM5cbubajOWvS2ADtyN1pp8aS&#x27;</span> list</span><br><span class="line">ceph-s3-test</span><br><span class="line">my-new-bucket</span><br><span class="line"><span class="comment">##可将变量保存开机启动脚本/etc/profile</span></span><br><span class="line"><span class="built_in">export</span> ST_AUTH=http://10.211.55.201:7480/auth</span><br><span class="line"><span class="built_in">export</span> ST_USER=ceph-s3-user:swift</span><br><span class="line"><span class="built_in">export</span> ST_KEY=lB93qfuWfaIyIZpPM5cbubajOWvS2ADtyN1pp8aS</span><br><span class="line">$ swift list</span><br><span class="line">ceph-s3-test</span><br><span class="line">my-new-bucket</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="文件操作-1"><a href="#文件操作-1" class="headerlink" title="文件操作"></a>文件操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ swift post swift-demo</span><br><span class="line">$ swift list</span><br><span class="line">ceph-s3-test</span><br><span class="line">my-new-bucket</span><br><span class="line">swift-demo</span><br><span class="line">$ swift upload swift-demo /etc/fstab <span class="comment">#上传</span></span><br><span class="line">etc/fstab</span><br><span class="line">$ swift list swift-demo</span><br><span class="line">etc/fstab</span><br><span class="line">$ swift download swift-demo etc/fstab <span class="comment">#下载</span></span><br><span class="line">etc/fstab [auth 0.003s, headers 0.006s, total 0.006s, 0.105 MB/s]</span><br></pre></td></tr></table></figure>

<h2 id="查找文件"><a href="#查找文件" class="headerlink" title="查找文件"></a>查找文件</h2><p>所有资源都是以对象的形式存储在资源池pool中，对象最终会映射到pg上，再由pg落盘到osd上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#rados -p default.rgw.buckets.data ls</span></span><br><span class="line">b7384d89-0aff-4a0b-acc9-c461bf7e5471.204143.3_etc/fstab</span><br><span class="line">b7384d89-0aff-4a0b-acc9-c461bf7e5471.204143.2_test$ ceph osd lspools</span><br><span class="line">2 testpool</span><br><span class="line">3 ceph-demo</span><br><span class="line">4 .rgw.root</span><br><span class="line">5 default.rgw.control</span><br><span class="line">6 default.rgw.meta</span><br><span class="line">7 default.rgw.log</span><br><span class="line">8 default.rgw.buckets.index</span><br><span class="line">9 default.rgw.buckets.data</span><br><span class="line">$ rados -p default.rgw.buckets.data <span class="built_in">ls</span></span><br><span class="line">b7384d89-0aff-4a0b-acc9-c461bf7e5471.204143.3_etc/fstab</span><br><span class="line">b7384d89-0aff-4a0b-acc9-c461bf7e5471.204143.2_test</span><br><span class="line">$ ceph osd map default.rgw.buckets.data b7384d89-0aff-4a0b-acc9-c461bf7e5471.204143.2_test</span><br><span class="line">osdmap e255 pool <span class="string">&#x27;default.rgw.buckets.data&#x27;</span> (9) object <span class="string">&#x27;b7384d89-0aff-4a0b-acc9-c461bf7e5471.204143.2_test&#x27;</span> -&gt; pg 9.fc424a45 (9.5) -&gt; up ([2,1,0], p2) acting ([2,1,0], p2)</span><br><span class="line">obj_id <span class="string">&#x27;b7384d89-0aff-4a0b-acc9-c461bf7e5471.204143.2_test&#x27;</span>--&gt;  pg 9.fc424a45 pg_id 9.5 --&gt; osd [2,1,0]</span><br></pre></td></tr></table></figure>

<h1 id="CephFs文件系统"><a href="#CephFs文件系统" class="headerlink" title="CephFs文件系统"></a>CephFs文件系统</h1><p><img src="/ceph11/index/image-20201031150413977.png"></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#挂载安装依赖</span></span><br><span class="line">yum <span class="keyword">install</span> nfs-utils</span><br></pre></td></tr></table></figure>

<h2 id="组件架构"><a href="#组件架构" class="headerlink" title="组件架构"></a>组件架构</h2><p>Ceph文件系统或<strong>CephFS</strong>是在Ceph的分布式对象存储<strong>RADOS</strong>之上构建的POSIX兼容文件系统。CephFS致力于为各种应用程序提供最新，多用途，高可用性和高性能的文件存储，包括传统用例（如共享主目录，HPC暂存空间和分布式工作流共享存储）。</p>
<p>CephFS通过使用一些新颖的架构选择来实现这些目标。值得注意的是，文件元数据与文件数据存储在单独的RADOS池中，并通过可调整大小的<em>元数据服务器</em>或<strong>MDS</strong>集群提供服务，该集群可扩展以支持更高吞吐量的元数据工作负载。文件系统的客户端可以直接访问RADOS来读写文件数据块。因此，工作负载可能会随着基础RADOS对象存储的大小线性扩展。也就是说，没有网关或代理为客户端中介数据I &#x2F; O。</p>
<p>通过MDS集群协调对数据的访问，该集群充当客户端和MDS共同维护的分布式元数据缓存状态的授权机构。每个MDS都会将对元数据的突变汇总为对RADOS上日记的一系列有效写入。MDS不会在本地存储任何元数据状态。此模型允许在POSIX文件系统的上下文中客户端之间进行连贯且快速的协作。</p>
<p><img src="/ceph11/index/image-20201031153325508.png" alt="image-20201031153325508"></p>
<h2 id="安装部署MDS集群"><a href="#安装部署MDS集群" class="headerlink" title="安装部署MDS集群"></a>安装部署MDS集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ceph-deploy/</span><br><span class="line">$ ceph-deploy mds create node-1</span><br><span class="line">$ ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    <span class="built_in">id</span>:     a96a9084-601e-46ca-a8b1-cf6b1ab5edf1</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"> </span><br><span class="line">  services:</span><br><span class="line">    mon: 3 daemons, quorum node-1,node-2,node-3 (age 114m)</span><br><span class="line">    mgr: node-2(active, since 115m), standbys: node-1, node-3</span><br><span class="line">    mds:  1 up:standby  <span class="comment">#还没有文件系统,是standby状态</span></span><br><span class="line">    osd: 3 osds: 3 up (since 114m), 3 <span class="keyword">in</span> (since 5d)</span><br><span class="line">    rgw: 1 daemon active (node-1)</span><br><span class="line"> </span><br><span class="line">  task status:</span><br><span class="line"> </span><br><span class="line">  data:</span><br><span class="line">    pools:   8 pools, 288 pgs</span><br><span class="line">    objects: 460 objects, 825 MiB</span><br><span class="line">    usage:   5.5 GiB used, 145 GiB / 150 GiB avail</span><br><span class="line">    pgs:     288 active+clean</span><br><span class="line">$ ceph-deploy mds create node-2 node-3</span><br><span class="line">$ ceph mds <span class="built_in">stat</span></span><br><span class="line"> 3 up:standby</span><br></pre></td></tr></table></figure>

<h2 id="创建文件系统"><a href="#创建文件系统" class="headerlink" title="创建文件系统"></a>创建文件系统</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd pool create cephfs_data 16 16</span><br><span class="line">$ ceph osd pool create cephfs_meta 16 16</span><br><span class="line">$ ceph fs new cephfs-demo cephfs_meta cephfs_data</span><br><span class="line">$ ceph fs <span class="built_in">ls</span></span><br><span class="line">name: cephfs-demo, metadata pool: cephfs_meta, data pools: [cephfs_data ]</span><br><span class="line">$ ceph -s</span><br><span class="line">...</span><br><span class="line">    mds: cephfs-demo:1 &#123;0=node-2=up:active&#125; 2 up:standby</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="内核挂载"><a href="#内核挂载" class="headerlink" title="内核挂载"></a>内核挂载</h2><p><code>&#123;path-to-be-mounted&#125;</code>是CephFS中将要挂载的路径， <code>&#123;mount-point&#125;</code>是文件系统中将要挂载CephFS的点，并且<code>&#123;user-name&#125;</code>是有权在机器上挂载CephFS的CephX用户的名称。以下命令是扩展形式，但是这些额外的细节由mount.ceph帮助程序自动找出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t ceph &#123;ip-address-of-MON&#125;:&#123;port-number-of-MON&#125;:&#123;path-to-be-mounted&#125; -o name=&#123;user-name&#125;,secret=&#123;secret-key&#125; &#123;mount-point&#125;</span><br><span class="line">$ mount -t ceph 10.211.55.201:6789:/ /mnt/cephfs/ -o name=admin</span><br></pre></td></tr></table></figure>

<p>如果群集上有多个文件系统，则需要将<code>fs=&#123;fs-name&#125;</code>option传递 给<code>-o</code>option <code>mount</code>：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t ceph :<span class="regexp">/ /m</span>nt/kcephfs2 -o name=admin,fs=mycephfs2</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">lsmod | grep ceph</span></span><br><span class="line">ceph                  438272  1 </span><br><span class="line">libceph               339968  1 ceph</span><br><span class="line">fscache               376832  1 ceph</span><br><span class="line">libcrc32c              16384  2 xfs,libceph</span><br></pre></td></tr></table></figure>

<h2 id="用户态挂载"><a href="#用户态挂载" class="headerlink" title="用户态挂载"></a>用户态挂载</h2><p>要使用FUSE（用户空间中的文件系统）挂载CephFS，请运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install ceph-fuse -y</span><br><span class="line"><span class="built_in">mkdir</span> /mnt/ceph-fuse</span><br><span class="line">ceph-fuse -n client.admin -m 10.211.55.201:6789,10.211.55.202:6789,10.211.55.203:6789 /mnt/ceph-fuse</span><br></pre></td></tr></table></figure>

<p>要在CephFS中挂载特定目录，您可以使用<code>-r</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-fuse -r &#123;path-to-be-mounted&#125; /mnt/mycephfs</span><br></pre></td></tr></table></figure>

<p>如果群集上有多个文件系统，则需要传递 给命令：<code>--client_fs &#123;fs-name&#125;``ceph-fuse</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-fuse /mnt/mycephfs2 --client_fs mycephfs2</span><br></pre></td></tr></table></figure>

<h1 id="osd扩容与换盘"><a href="#osd扩容与换盘" class="headerlink" title="osd扩容与换盘"></a>osd扩容与换盘</h1><h2 id="osd纵向扩容"><a href="#osd纵向扩容" class="headerlink" title="osd纵向扩容"></a>osd纵向扩容</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ceph-deploy disk list node-1 <span class="comment">#查看节点磁盘</span></span><br><span class="line">$ ceph-deploy disk zap node-1 /dev/sdc <span class="comment"># 清理磁盘分区 ceph-deploy disk zap &#123;osd-server-name&#125; &#123;disk-name&#125;</span></span><br><span class="line">$ ceph-deploy osd create node-1 --data /dev/sdc</span><br><span class="line">$ ceph-deploy osd create node-2 --data /dev/sdc</span><br><span class="line">$ ceph-deploy osd create node-3 --data /dev/sdc</span><br></pre></td></tr></table></figure>

<h2 id="数据rebalancing重分布"><a href="#数据rebalancing重分布" class="headerlink" title="数据rebalancing重分布"></a>数据rebalancing重分布</h2><p>当您将Ceph OSD守护程序添加到Ceph存储群集时，群集映射将使用新的OSD更新。再次参考<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/architecture/#calculating-pg-ids">计算PG ID</a>，这将更改群集映射。因此，它更改了对象放置，因为它更改了计算的输入。下图描述了重新平衡过程（尽管相当粗略，因为它对大型集群的影响较小），其中一些（但不是全部）PG从现有OSD（OSD 1和OSD 2）迁移到新OSD（OSD 3） ）。即使重新平衡，破碎也很稳定。许多放置组仍保持其原始配置，并且每个OSD都增加了一些容量，因此重新平衡完成后，新OSD上不会出现负载峰值。</p>
<p><img src="/ceph11/index/image-20201101152926819.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ceph <span class="built_in">df</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201101154218826.png" alt="image-20201101154218826"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=rebalancing-file.img bs=1M count=5120</span><br><span class="line"><span class="built_in">cp</span> rebalancing-file.img /mnt/cephfs/</span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201101154727560.png" alt="image-20201101154727560"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> rebalancing-file.img /mnt/rbd-demo/</span><br><span class="line"><span class="comment"># node-3加盘</span></span><br><span class="line"><span class="built_in">cd</span> ceph-deploy</span><br><span class="line">ceph-deploy osd create node-3 --data /dev/sdd</span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201101161000176.png"></p>
<p>recovery流量进行数据重分布</p>
<p><img src="/ceph11/index/image-20201101161322118.png" alt="image-20201101161322118"></p>
<h2 id="临时关闭rebalancing"><a href="#临时关闭rebalancing" class="headerlink" title="临时关闭rebalancing"></a>临时关闭rebalancing</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ceph --admin-daemon /var/run/ceph/ceph-mon.node-1.asok config show| grep max_backfills</span><br><span class="line">    <span class="string">&quot;osd_max_backfills&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line"><span class="comment">#最多有一个线程做数据填充,每个osd会拿1个线程同步数据</span></span><br><span class="line"><span class="built_in">cat</span> ceph.conf </span><br><span class="line">...</span><br><span class="line">public_network = 10.211.55.0/24 <span class="comment">#客户端连接网络</span></span><br><span class="line">cluster_network = 10.211.56.0/24 <span class="comment"># 扩容重分布走cluster_network</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd <span class="built_in">set</span> norebalance <span class="comment">#关闭数据分布标志位</span></span><br><span class="line">$ ceph osd <span class="built_in">set</span> nobackfill <span class="comment">#关闭数据填充</span></span><br><span class="line">$ ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    <span class="built_in">id</span>:     a96a9084-601e-46ca-a8b1-cf6b1ab5edf1</span><br><span class="line">    health: HEALTH_WARN</span><br><span class="line">            nobackfill,norebalance flag(s) <span class="built_in">set</span></span><br><span class="line">...</span><br><span class="line">$ ceph osd <span class="built_in">unset</span> norebalance <span class="comment">#取消数据分布标志位</span></span><br><span class="line">$ ceph osd <span class="built_in">unset</span> nobackfill <span class="comment">#取消数据填充</span></span><br></pre></td></tr></table></figure>

<h2 id="osd坏盘更换"><a href="#osd坏盘更换" class="headerlink" title="osd坏盘更换"></a>osd坏盘更换</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dmesg <span class="comment">#查看日志信息</span></span><br><span class="line">ceph osd perf <span class="comment">#查看osd延迟</span></span><br></pre></td></tr></table></figure>

<p>删除OSD，通常为<code>up</code>和<code>in</code>。您需要将其从群集中删除，以便Ceph可以开始重新平衡并将其数据复制到其他OSD。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd <span class="keyword">out</span> &#123;osd-num&#125;</span><br></pre></td></tr></table></figure>

<h3 id="模拟坏盘"><a href="#模拟坏盘" class="headerlink" title="模拟坏盘"></a>模拟坏盘</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd tree</span><br><span class="line">ID CLASS WEIGHT  TYPE NAME       STATUS REWEIGHT PRI-AFF </span><br><span class="line">....</span><br><span class="line">-7       0.17569     host node-3                         </span><br><span class="line"> 2   hdd 0.04880         osd.2       up  1.00000 1.00000 </span><br><span class="line"> 5   hdd 0.04880         osd.5       up  1.00000 1.00000 </span><br><span class="line"> 6   hdd 0.07809         osd.6       up  1.00000 1.00000  <span class="comment">##第六快盘</span></span><br><span class="line"> [root@node-3 ~] $ systemctl stop ceph-osd@6.service </span><br><span class="line">$ ceph osd tree</span><br><span class="line">....</span><br><span class="line">-7       0.17569     host node-3                         </span><br><span class="line"> 2   hdd 0.04880         osd.2       up  1.00000 1.00000 </span><br><span class="line"> 5   hdd 0.04880         osd.5       up  1.00000 1.00000 </span><br><span class="line"> 6   hdd 0.07809         osd.6     down  1.00000 1.00000  <span class="comment">#down状态</span></span><br></pre></td></tr></table></figure>

<ul>
<li>坏盘后大约10分钟后数据重分布</li>
</ul>
<p><img src="/ceph11/index/image-20201101171351988.png" alt="image-20201101171351988"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd out osd.6</span><br><span class="line">$ ceph osd tree</span><br><span class="line">ID CLASS WEIGHT  TYPE NAME       STATUS REWEIGHT PRI-AFF </span><br><span class="line">....</span><br><span class="line">-7       0.17569     host node-3                         </span><br><span class="line">....</span><br><span class="line"> 6   hdd 0.07809         osd.6     down        0 1.00000 <span class="comment">#权重为0</span></span><br><span class="line">$ ceph osd crush dump  | less <span class="comment">#osd6依然在crush算法里</span></span><br><span class="line">$ ceph osd crush <span class="built_in">rm</span> osd.6 <span class="comment">#删除osd.6 crush算法</span></span><br><span class="line">$ ceph osd <span class="built_in">rm</span> osd.6 <span class="comment">#删除osd</span></span><br><span class="line">$ ceph auth list &amp;&amp; ceph auth <span class="built_in">rm</span> osd.6 <span class="comment">#删除认证</span></span><br><span class="line">$ dmsetup status <span class="comment">#查看lvm信息</span></span><br><span class="line">$ ceph-volume lvm zap /dev/sdd --destroy <span class="comment">#在所在osd删除lvm卷</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;w&quot;</span> | fdisk /dev/sdd <span class="comment">#更新磁盘信息</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/c71970eb16b0dacbe6c8a79391a0003.png" alt="c71970eb16b0dacbe6c8a79391a0003"></p>
<p><img src="/ceph11/index/image-20201101173648245.png"></p>
<h3 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h3><ol>
<li>ceph osd out 驱逐</li>
<li>ceph osd crush rm osd.6删除osd.6 crush算法</li>
<li>ceph osd rm osd.6 #删除osd</li>
<li>ceph auth rm osd.6 #删除认证</li>
</ol>
<h2 id="数据一致性检查DATA-CONSISTENCY"><a href="#数据一致性检查DATA-CONSISTENCY" class="headerlink" title="数据一致性检查DATA CONSISTENCY"></a>数据一致性检查DATA CONSISTENCY</h2><p>作为保持数据一致性和整洁度的一部分，Ceph OSD还可以清理放置组中的对象。也就是说，Ceph OSD可以将一个放置组中的对象元数据与其存储在其他OSD中的放置组中的副本进行比较。</p>
<p><code>清理</code>（通常每天执行一次）会捕获OSD错误或文件系统错误。OSD还可以通过逐位比较对象中的数据来执行更深入的清理。</p>
<p><code>深度清理</code>（通常每周执行一次）会发现磁盘上的坏扇区在轻度清理中并不明显。 </p>
<p>Ceph清理类似于<code>fsck</code>对象存储层上的清理。对于每个pg，Ceph都会生成所有对象的目录，并比较每个主要对象及其副本，以确保没有对象丢失或不匹配。轻擦洗（每天）检查对象的大小和属性。深度清理（每周一次）读取数据并使用校验和以确保数据完整性。</p>
<p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/configuration/osd-config-ref/#scrubbing">配置清理参数</a></p>
<p>清理有两种，针对pg，针对osd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ceph pg dump <span class="comment">#获取pg_id</span></span><br><span class="line">$ ceph pg scrub 6.1b <span class="comment">#轻度检查</span></span><br><span class="line">$ ceph pg deep-scrub 6.1b</span><br><span class="line">$ ceph pg dump | grep <span class="string">&quot;active&quot;</span> |awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs -I&#123;&#125;  -- ceph pg deep-scrub &#123;&#125; <span class="comment">#深度检查所有pg</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> `ceph pg dump | grep <span class="string">&quot;active&quot;</span> |awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`;<span class="keyword">do</span> ceph pg deep-scrub <span class="variable">$&#123;i&#125;</span>;<span class="keyword">done</span> <span class="comment">#停不下来</span></span><br></pre></td></tr></table></figure>



<p><img src="/ceph11/index/image-20201101193539386.png"></p>
<p>出现deep scrub </p>
<h1 id="ceph集群运维"><a href="#ceph集群运维" class="headerlink" title="ceph集群运维"></a>ceph集群运维</h1><h2 id="守护服务管理"><a href="#守护服务管理" class="headerlink" title="守护服务管理"></a>守护服务管理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ceph.target       <span class="comment"># 对应所有服务</span></span><br></pre></td></tr></table></figure>

<p>要列出节点上的Ceph systemd单元</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status ceph\*.service ceph\*.target | grep Load</span><br></pre></td></tr></table></figure>

<p>按类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ceph-osd.target <span class="comment">#对应所有osd的守护进程</span></span><br><span class="line">systemctl start ceph-mon.target</span><br><span class="line">systemctl start ceph-mds.target</span><br></pre></td></tr></table></figure>

<p>特定的守护程序实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ceph-osd@1</span><br></pre></td></tr></table></figure>

<h2 id="服务日志分析"><a href="#服务日志分析" class="headerlink" title="服务日志分析"></a>服务日志分析</h2><p><code>/var/log/ceph</code>（默认位置）下查看Ceph日志文件</p>
<h2 id="集群状态监控"><a href="#集群状态监控" class="headerlink" title="集群状态监控"></a>集群状态监控</h2><h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p>要<code>ceph</code>以交互方式运行该工具，请<code>ceph</code>在命令行中键入，不带参数。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph</span><br><span class="line"><span class="meta prompt_">ceph&gt; </span><span class="language-bash">health</span></span><br><span class="line"><span class="meta prompt_">ceph&gt; </span><span class="language-bash">status</span></span><br><span class="line"><span class="meta prompt_">ceph&gt; </span><span class="language-bash">quorum_status</span></span><br><span class="line"><span class="meta prompt_">ceph&gt; </span><span class="language-bash">mon <span class="built_in">stat</span></span></span><br></pre></td></tr></table></figure>

<p>ceph -s &#x3D; ceph status</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph -s <span class="operator">=</span> ceph status</span><br><span class="line">ceph -w</span><br></pre></td></tr></table></figure>

<h3 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h3><p>要检查集群在池中的数据使用情况和数据分布，可以使用该<code>df</code>选项。它类似于Linux <code>df</code>。执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph <span class="built_in">df</span></span><br></pre></td></tr></table></figure>

<p>输出的<strong>RAW STORAGE</strong>部分提供了群集管理的存储量的概述。</p>
<ul>
<li><p><strong>类别：</strong> OSD设备的类别（或群集的总数）</p>
</li>
<li><p><strong>大小：</strong>集群管理的存储容量。</p>
</li>
<li><p><strong>可用：</strong>自由空间的集群中使用的量。</p>
</li>
<li><p><strong>已用：</strong>用户数据消耗的原始存储量。</p>
</li>
<li><p><strong>原始使用</strong>量<strong>：</strong>用户数据，内部开销或保留的容量消耗的原始存储量。</p>
</li>
<li><p><strong>已用％RAW：</strong>已用原始存储空间的百分比。将此数字与和结合使用，以确保未达到群集的容量。有关更多详细信息，请参见<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/configuration/mon-config-ref#storage-capacity">存储容量</a>。<code>full ratio near full ratio</code></p>
</li>
</ul>
<p>输出的<strong>POOLS</strong>部分提供了池的列表以及每个池的概念用法。本节的输出<strong>不</strong>反映副本，克隆或快照。例如，如果存储的对象具有1MB的数据，则名义使用量将为1MB，但实际使用量可能为2MB或更多，具体取决于副本，克隆和快照的数量。</p>
<ul>
<li><strong>NAME：</strong>池的名称。</li>
<li><strong>ID：</strong>池ID。</li>
<li><strong>已使用：</strong>名义上存储的数据量（以千字节为单位），除非数字在<strong>M</strong>（兆字节）后附加<strong>G</strong>（千兆字节）。</li>
<li><strong>％USED：</strong>每个池<strong>使用</strong>的名义存储百分比。</li>
<li><strong>MAX AVAIL：</strong>可以写入此池的名义数据量的估计值。</li>
<li><strong>对象：</strong>每个池中存储的对象的名义数量。</li>
</ul>
<p>注意：</p>
<p><strong>POOLS</strong>部分中的数字是名义上的。它们不包括副本，快照或克隆的数量。其结果是，在总和<strong>USED</strong>和<strong>％USED</strong>金额不会加起来 <strong>USED</strong>和<strong>％USED</strong>的数量<strong>RAW</strong>输出的部分。</p>
<p>该<strong>MAX AVAIL</strong>值是用于复制或纠删码的复杂函数，映射到存储设备上的CRUSH规则，这些设备的利用率，以及配置的mon_osd_full_ratio。</p>
<h3 id="osd"><a href="#osd" class="headerlink" title="osd"></a>osd</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph osd <span class="built_in">status</span></span><br><span class="line">ceph osd <span class="built_in">dump</span></span><br><span class="line">ceph osd tree</span><br><span class="line">ceph osd df</span><br></pre></td></tr></table></figure>

<h3 id="mon"><a href="#mon" class="headerlink" title="mon"></a>mon</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph mon <span class="built_in">stat</span></span><br><span class="line">ceph mon dump</span><br></pre></td></tr></table></figure>

<p>要检查监视器群集的仲裁状态，请执行以下操作：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph quorum_status <span class="string">| jq</span></span><br></pre></td></tr></table></figure>

<h3 id="mds"><a href="#mds" class="headerlink" title="mds"></a>mds</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph mds <span class="keyword">stat</span></span><br><span class="line">ceph fs <span class="keyword">dump</span></span><br></pre></td></tr></table></figure>

<h3 id="使用socket"><a href="#使用socket" class="headerlink" title="使用socket"></a>使用socket</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph --admin-daemon /var/run/ceph/ceph-mon.node-1.asok <span class="built_in">help</span> | jq</span><br><span class="line">ceph --admin-daemon /var/run/ceph/ceph-mon.node-1.asok config show | jq</span><br><span class="line">ceph --admin-daemon /var/run/ceph/ceph-mon.node-1.asok config <span class="built_in">set</span> &lt;参数&gt; &lt;值&gt;</span><br></pre></td></tr></table></figure>

<h2 id="POOL管理"><a href="#POOL管理" class="headerlink" title="POOL管理"></a>POOL管理</h2><p>首次部署群集而不创建池时，Ceph使用默认池来存储数据。</p>
<ul>
<li><strong>弹性Resilience</strong>：可以设置允许多少OSD发生故障而不丢失数据。对于复制池，它是对象的所需副本数&#x2F;副本数。典型的配置存储一个对象和一个附加副本，但是您可以确定副本&#x2F;副本的数量。对于<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/erasure-code">擦除编码池</a>，它是编码块的数量（即在擦除代码配置文件中**）<code>size = 2``m=2</code></li>
<li><strong>Placement Groups</strong>：您可以设置池的放置组数。一个典型的配置每个OSD使用大约100个放置组，以提供最佳的平衡，而不会消耗太多的计算资源。设置多个池时，请确保为池和整个群集设置合理数量的放置组。</li>
<li><strong>CRUSH规则</strong>：将数据存储在池中时，对象及其副本（或用于擦除编码池的块）在群集中的位置由CRUSH规则控制。如果默认规则不适用于您的用例，则可以为您的池创建自定义的CRUSH规则。</li>
<li><strong>快照</strong>：使用创建快照时，可以有效地为特定池拍摄快照。<code>ceph osd pool mksnap</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph osd lspools</span><br><span class="line">ceph osd pool create &#123;pool-name&#125; [&#123;pg-num&#125; [&#123;pgp-num&#125;]] [replicated] \</span><br><span class="line">     [crush-rule-name] [expected-num-objects最大允许对象obj数量]</span><br><span class="line">ceph osd pool get testpool size</span><br><span class="line">ceph osd pool <span class="built_in">set</span> testpool size 1</span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201102210436157.png"></p>
<p><img src="/ceph11/index/image-20201102210500438.png"></p>
<h3 id="将pool关联到应用程序"><a href="#将pool关联到应用程序" class="headerlink" title="将pool关联到应用程序"></a>将pool关联到应用程序</h3><p>对于其他情况，您可以手动将自由格式的应用程序名称关联到池。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool application <span class="keyword">enable</span> &#123;pool-<span class="type">name</span>&#125; &#123;application-<span class="type">name</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>CephFS使用应用程序名称<code>cephfs</code>，RBD使用应用程序名称<code>rbd</code>，而RGW使用应用程序名称<code>rgw</code>。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd pool application get testpool</span><br><span class="line">&#123;&#125;</span><br><span class="line">$ ceph osd pool application <span class="built_in">enable</span> testpool rbd</span><br><span class="line">enabled application <span class="string">&#x27;rbd&#x27;</span> on pool <span class="string">&#x27;testpool&#x27;</span></span><br><span class="line">$ ceph osd pool application get testpool</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;rbd&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="设置pool配额"><a href="#设置pool配额" class="headerlink" title="设置pool配额"></a>设置pool配额</h3><p>您可以将池配额设置为每个池的最大字节数和&#x2F;或最大对象数。</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ceph</span> <span class="string">osd</span> <span class="string">pool</span> <span class="built_in">set-quota</span> &#123;<span class="string">pool-name</span>&#125; [<span class="string">max_objects</span> &#123;<span class="string">obj-count</span>&#125;] [<span class="string">max_bytes</span> &#123;<span class="string">bytes</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd pool set-quota testpool max_objects 100</span><br><span class="line">set-quota max_objects = 100 <span class="keyword">for</span> pool testpool</span><br><span class="line">$ ceph osd pool get-quota testpool</span><br><span class="line">quotas <span class="keyword">for</span> pool <span class="string">&#x27;testpool&#x27;</span>:</span><br><span class="line">  max objects: 100 objects</span><br><span class="line">  max bytes  : N/A</span><br></pre></td></tr></table></figure>

<p>删除配额，将其值设置为<code>0</code>。</p>
<h3 id="重命名"><a href="#重命名" class="headerlink" title="重命名"></a>重命名</h3><p>要重命名池，请执行：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool <span class="keyword">rename</span> &#123;<span class="keyword">current</span>-pool-<span class="type">name</span>&#125; &#123;<span class="built_in">new</span>-pool-<span class="type">name</span>&#125;</span><br></pre></td></tr></table></figure>

<p>如果重命名池，并且您具有针对经过身份验证的用户的每个池功能，则必须使用新的池名称更新用户的功能（即上限）。</p>
<h3 id="pool利用率"><a href="#pool利用率" class="headerlink" title="pool利用率"></a>pool利用率</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rados <span class="built_in">df</span></span><br></pre></td></tr></table></figure>

<p>要获取特定池或全部池的I &#x2F; O信息，请执行以下操作：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ceph</span> osd pool stats<span class="meta"> [&#123;pool-name&#125;]</span></span><br></pre></td></tr></table></figure>

<h3 id="命名一个pool"><a href="#命名一个pool" class="headerlink" title="命名一个pool"></a>命名一个pool</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool <span class="keyword">rename</span> &#123;<span class="keyword">current</span>-pool-<span class="type">name</span>&#125; &#123;<span class="built_in">new</span>-pool-<span class="type">name</span>&#125;</span><br></pre></td></tr></table></figure>

<p>如果重命名了一个存储池，且认证用户有每存储池能力，那你必须用新存储池名字更新用户的能力（即 caps ）。</p>
<h3 id="pool参数"><a href="#pool参数" class="headerlink" title="pool参数"></a>pool参数</h3><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/pools/#set-pool-values">https://docs.ceph.com/en/octopus/rados/operations/pools/#set-pool-values</a></p>
<h2 id="pg数据分布"><a href="#pg数据分布" class="headerlink" title="pg数据分布"></a>pg数据分布</h2><p>存储池内的归置组（ PG ）把对象汇聚在一起，因为跟踪每一个对象的位置及其元数据需要大量计算——即一个拥有数百万对象的系统，不可能在对象这一级追踪位置。</p>
<p><img src="/ceph11/index/image-20201107160800195.png"></p>
<p>Ceph 客户端会计算某一对象应该位于哪个归置组里，它是这样实现的，先给对象 ID 做哈希操作，然后再根据指定存储池里的 PG 数量、存储池 ID 做一个运算。</p>
<p><img src="/ceph11/index/image-20201107160945188.png"></p>
<h3 id="计算pg"><a href="#计算pg" class="headerlink" title="计算pg"></a>计算pg</h3><p><img src="/ceph11/index/image-20201107161954468.png" alt="image-20201107161954468"></p>
<p><strong>总pg数 &#x3D; (OSD数量 * 100) &#x2F; pool 副本数(默认为3)</strong></p>
<p><strong>然后取其最近的 2的n次方</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(200<span class="number">*100</span>)/<span class="attribute">3</span>=6667 #去最近2的n次方: 4096或8192</span><br></pre></td></tr></table></figure>

<h3 id="创建pool是指定大小"><a href="#创建pool是指定大小" class="headerlink" title="创建pool是指定大小"></a>创建pool是指定大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd pool <span class="built_in">set</span> mypool target_size_bytes 100T</span><br><span class="line"><span class="comment">#会告诉系统mypool预计会占用100 TiB的空间。</span></span><br><span class="line">$ ceph osd pool <span class="built_in">set</span> mypool target_size_ratio 1.0 <span class="comment">#设置百分比</span></span><br></pre></td></tr></table></figure>

<p><strong>如果mypool是群集中唯一的池，则意味着预期使用了总容量的100％。</strong></p>
<p>如果第二个池的<code>target_size_ratio</code>&#x3D; 1.0，则两个池都将使用50％的群集容量。</p>
<p>如果指定了不可能的目标大小值（例如，容量大于整个群集的容量），则会发出健康警告（<code>POOL_TARGET_SIZE_BYTES_OVERCOMMITTED</code>）。</p>
<p>如果为池指定了<code>target_size_ratio</code>和<code>target_size_bytes</code>，则仅考虑比率，并发出运行状况警告（<code>POOL_HAS_TARGET_SIZE_BYTES_AND_RATIO</code>）。</p>
<h3 id="指定池的PG的边界"><a href="#指定池的PG的边界" class="headerlink" title="指定池的PG的边界"></a>指定池的PG的边界</h3><p>也可以为一个池指定最小数量的PG。这对于确定执行IO时客户端将看到的并行度的数量的下限很有用，即使池中大多数都是空的。设置下限可以防止Ceph将PG编号减少（或建议减少）到配置的编号以下。</p>
<p>您可以使用以下方法设置池的最小PG数量：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool <span class="keyword">set</span> &lt;pool-<span class="type">name</span>&gt; pg_num_min &lt;num&gt;</span><br></pre></td></tr></table></figure>

<p>您也可以使用命令的可选参数来指定创建池时的最小PG数量。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create --pg-<span class="built_in">num</span>-<span class="built_in">min</span> &lt;<span class="built_in">num</span>&gt; </span><br></pre></td></tr></table></figure>

<h2 id="CEPH参数调整配置"><a href="#CEPH参数调整配置" class="headerlink" title="CEPH参数调整配置"></a>CEPH参数调整配置</h2><h3 id="删除pool"><a href="#删除pool" class="headerlink" title="删除pool"></a>删除pool</h3><p>要删除一存储池，执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool delete &#123;pool-name&#125; [&#123;pool-name&#125; --yes-i-really-really-mean-it]</span><br><span class="line"><span class="comment"># 提示需加参数</span></span><br><span class="line">ceph --admin-daemon /var/run/ceph/ceph-mon.node-1.asok config show | grep mon_allow</span><br><span class="line"><span class="comment">#设置参数</span></span><br><span class="line">ceph --admin-daemon /var/run/ceph/ceph-mon.node-1.asok config <span class="built_in">set</span> mon_allow_pool_delete <span class="literal">true</span> <span class="comment">#需在所有mon节点执行 这个只是临时调整</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或在配置文件添加参数</span></span><br><span class="line">[global]</span><br><span class="line">mon_allow_pool_delete = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#强制推送配置文件</span></span><br><span class="line">ceph-deploy --overwrite-conf config push node-1 node-2 node-3</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启服务</span></span><br></pre></td></tr></table></figure>

<p>如果你给自建的存储池创建了定制的规则集，你不需要存储池时最好删除它。如果你曾严格地创建了用户及其权限给一个存储池，但存储池已不存在，最好也删除那些用户。</p>
<h1 id="调整CRUSH-MAP"><a href="#调整CRUSH-MAP" class="headerlink" title="调整CRUSH MAP"></a>调整CRUSH MAP</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><p><strong>CRUSH</strong> 算法通过计算数据存储位置来确定如何存储和检索。 CRUSH 授权 Ceph 客户端直接连接 OSD ，而非通过一个中央服务器或代理。数据存储、检索算法的使用，使 Ceph 避免了单点故障、性能瓶颈、和伸缩的物理限制。</p>
<p>CRUSH 需要一张集群的 Map，且使用 <code>CRUSH Map</code> 把数据伪随机地、尽量平均地分布到整个集群的 OSD 里。CRUSH Map 包含 OSD 列表、把设备汇聚为物理位置的“桶”列表、和指示 CRUSH 如何复制存储池里的数据的规则列表。</p>
<p>bucket是层次结构中内部节点（主机，机架，行等）的CRUSH术语。CRUSH映射定义了一系列用于描述这些节点的<em>类型</em>。默认情况下，这些类型包括：</p>
<ul>
<li>osd（或设备）</li>
<li>主机host</li>
<li>机壳</li>
<li>机架</li>
<li>行</li>
<li>pdu</li>
<li>pod</li>
<li>机房</li>
<li>数据中心</li>
<li>区</li>
<li>地区</li>
<li>根</li>
</ul>
<p>大多数群集仅使用其中少数几个类型，可以根据需要定义其他类型。</p>
<p>该层次结构是通过<code>osd</code>在叶子的设备（通常为type ），内部节点（具有非设备类型）和type的根节点 构建的<code>root</code>。例如，</p>
<p><img src="/ceph11/index/image-20201107173342143.png"></p>
<h2 id="规则剖析"><a href="#规则剖析" class="headerlink" title="规则剖析"></a>规则剖析</h2><p>查看规则树：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd crush tree</span><br><span class="line">ID CLASS WEIGHT  TYPE NAME       </span><br><span class="line">-1       0.29279 root default    </span><br><span class="line">-3       0.09760     host node-1 </span><br><span class="line"> 0   hdd 0.04880         osd.0   </span><br><span class="line"> 3   hdd 0.04880         osd.3   </span><br><span class="line">-5       0.09760     host node-2 </span><br><span class="line"> 1   hdd 0.04880         osd.1   </span><br><span class="line"> 4   hdd 0.04880         osd.4   </span><br><span class="line">-7       0.09760     host node-3 </span><br><span class="line"> 2   hdd 0.04880         osd.2   </span><br><span class="line"> 5   hdd 0.04880         osd.5</span><br><span class="line"> $ ceph osd osd tree</span><br><span class="line"> $ ceph osd crush dump</span><br><span class="line"> $ ceph osd crush rule <span class="built_in">ls</span></span><br><span class="line">replicated_rule <span class="comment">#默认规则</span></span><br><span class="line">$ ceph osd pool get testpool crush_rule</span><br><span class="line">crush_rule: replicated_rule</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;devices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> #osd设备</span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;osd.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdd&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;osd.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdd&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;osd.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdd&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;osd.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdd&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;osd.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdd&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;osd.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hdd&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> #层级类型</span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;osd&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chassis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rack&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;row&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pdu&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pod&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;room&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;datacenter&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zone&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;region&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;buckets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  #顶层root</span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">19188</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;straw2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rjenkins1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> #下属host</span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-3</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-5</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-7</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default~hdd&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">19188</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;straw2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rjenkins1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-4</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-6</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-8</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-3</span><span class="punctuation">,</span> #node<span class="number">-1</span>节点信息</span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;straw2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rjenkins1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node-1~hdd&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;straw2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rjenkins1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;straw2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rjenkins1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-6</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node-2~hdd&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;straw2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rjenkins1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-7</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;straw2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rjenkins1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">-8</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node-3~hdd&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">6396</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;straw2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rjenkins1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3198</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rule_id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rule_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;replicated_rule&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ruleset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;min_size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;take&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;item&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;item_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chooseleaf_firstn&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;emit&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tunables&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> #一些参数</span><br><span class="line">        <span class="attr">&quot;choose_local_tries&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;choose_local_fallback_tries&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;choose_total_tries&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;chooseleaf_descend_once&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;chooseleaf_vary_r&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;chooseleaf_stable&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;straw_calc_version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;allowed_bucket_algs&quot;</span><span class="punctuation">:</span> <span class="number">54</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;profile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jewel&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;optimal_tunables&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;legacy_tunables&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_required_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jewel&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;require_feature_tunables&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;require_feature_tunables2&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;has_v2_rules&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;require_feature_tunables3&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;has_v3_rules&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;has_v4_buckets&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;require_feature_tunables5&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;has_v5_rules&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;choose_args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="定制CRUSH拓扑架构"><a href="#定制CRUSH拓扑架构" class="headerlink" title="定制CRUSH拓扑架构"></a>定制CRUSH拓扑架构</h2><p>CRUSH Map 主要有 4 个段落。</p>
<ul>
<li>设备：由任意对象存储设备组成，即对应一个 ceph-osd进程的存储器。 Ceph 配置文件里的每个 OSD 都应该有一个设备。</li>
<li>桶类型： 定义了 CRUSH 分级结构里要用的桶类型（ types ），桶由逐级汇聚的存储位置（如行、机柜、机箱、主机等等）及其权重组成。</li>
<li>桶实例： 定义了桶类型后，还必须声明主机的桶类型、以及规划的其它故障域。</li>
<li>规则： 由选择桶的方法组成。</li>
</ul>
<p>要编辑现有的CRUSH映射，请执行以下操作：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/crush-map-edits/#getcrushmap">获取CRUSH地图</a>。</li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/crush-map-edits/#decompilecrushmap">反编译</a>CRUSH映射。</li>
<li>编辑<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/crush-map-edits/#crushmapdevices">设备</a>，存储<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/crush-map-edits/#crushmapbuckets">桶</a>和<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/crush-map-edits/#crushmaprules">规则</a>中的至少一项。</li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/crush-map-edits/#compilecrushmap">重新编译</a>CRUSH映射。</li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rados/operations/crush-map-edits/#setcrushmap">设置CRUSH图</a>。</li>
</ol>
<p><img src="/ceph11/index/image-20201110150639939.png" alt="image-20201110150639939"></p>
<h3 id="两种修改方式"><a href="#两种修改方式" class="headerlink" title="两种修改方式"></a>两种修改方式</h3><h4 id="手动编辑"><a href="#手动编辑" class="headerlink" title="手动编辑"></a><strong>手动编辑</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd getcrushmap -o crushmap.bin <span class="comment">#保存crushmap二进制文件</span></span><br><span class="line">22</span><br><span class="line">$ file crushmap.bin </span><br><span class="line">crushmap.bin: MS Windows icon resource - 16 icons, 1-colors</span><br><span class="line">$ crushtool -d crushmap.bin -o crushmap.txt <span class="comment">#反编译</span></span><br><span class="line">$ file crushmap.txt </span><br><span class="line">crushmap.txt: ASCII text</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># begin crush map</span></span><br><span class="line">tunable choose_local_tries 0</span><br><span class="line">tunable choose_local_fallback_tries 0</span><br><span class="line">tunable choose_total_tries 50</span><br><span class="line">tunable chooseleaf_descend_once 1</span><br><span class="line">tunable chooseleaf_vary_r 1</span><br><span class="line">tunable chooseleaf_stable 1</span><br><span class="line">tunable straw_calc_version 1</span><br><span class="line">tunable allowed_bucket_algs 54</span><br><span class="line"></span><br><span class="line"><span class="comment"># devices</span></span><br><span class="line">device 0 osd.0 class hdd</span><br><span class="line">device 1 osd.1 class hdd</span><br><span class="line">device 2 osd.2 class hdd</span><br><span class="line">device 3 osd.3 class ssd</span><br><span class="line">device 4 osd.4 class ssd</span><br><span class="line">device 5 osd.5 class ssd</span><br><span class="line"></span><br><span class="line"><span class="comment"># types</span></span><br><span class="line"><span class="built_in">type</span> 0 osd</span><br><span class="line"><span class="built_in">type</span> 1 host</span><br><span class="line"><span class="built_in">type</span> 2 chassis</span><br><span class="line"><span class="built_in">type</span> 3 rack</span><br><span class="line"><span class="built_in">type</span> 4 row</span><br><span class="line"><span class="built_in">type</span> 5 pdu</span><br><span class="line"><span class="built_in">type</span> 6 pod</span><br><span class="line"><span class="built_in">type</span> 7 room</span><br><span class="line"><span class="built_in">type</span> 8 datacenter</span><br><span class="line"><span class="built_in">type</span> 9 zone</span><br><span class="line"><span class="built_in">type</span> 10 region</span><br><span class="line"><span class="built_in">type</span> 11 root</span><br><span class="line"></span><br><span class="line"><span class="comment"># buckets</span></span><br><span class="line">host node-1 &#123;</span><br><span class="line">	<span class="built_in">id</span> -3		<span class="comment"># do not change unnecessarily</span></span><br><span class="line">	<span class="built_in">id</span> -4 class hdd		<span class="comment"># do not change unnecessarily</span></span><br><span class="line">	<span class="comment"># weight 0.098</span></span><br><span class="line">	alg straw2</span><br><span class="line">	<span class="built_in">hash</span> 0	<span class="comment"># rjenkins1</span></span><br><span class="line">	item osd.0 weight 0.049</span><br><span class="line">&#125;</span><br><span class="line">host node-2 &#123;</span><br><span class="line">	<span class="built_in">id</span> -5		<span class="comment"># do not change unnecessarily</span></span><br><span class="line">	<span class="built_in">id</span> -6 class hdd		<span class="comment"># do not change unnecessarily</span></span><br><span class="line">	<span class="comment"># weight 0.098</span></span><br><span class="line">	alg straw2</span><br><span class="line">	<span class="built_in">hash</span> 0	<span class="comment"># rjenkins1</span></span><br><span class="line">	item osd.1 weight 0.049</span><br><span class="line">&#125;</span><br><span class="line">host node-3 &#123;</span><br><span class="line">	<span class="built_in">id</span> -7		<span class="comment"># do not change unnecessarily</span></span><br><span class="line">	<span class="built_in">id</span> -8 class hdd		<span class="comment"># do not change unnecessarily</span></span><br><span class="line">	<span class="comment"># weight 0.098</span></span><br><span class="line">	alg straw2</span><br><span class="line">	<span class="built_in">hash</span> 0	<span class="comment"># rjenkins1</span></span><br><span class="line">	item osd.2 weight 0.049</span><br><span class="line">&#125;</span><br><span class="line">host node-1-ssd &#123;</span><br><span class="line">	<span class="comment"># weight 0.098</span></span><br><span class="line">	alg straw2</span><br><span class="line">	<span class="built_in">hash</span> 0	<span class="comment"># rjenkins1</span></span><br><span class="line">	item osd.3 weight 0.049</span><br><span class="line">&#125;</span><br><span class="line">host node-2-ssd &#123;</span><br><span class="line">	<span class="comment"># weight 0.098</span></span><br><span class="line">	alg straw2</span><br><span class="line">	<span class="built_in">hash</span> 0	<span class="comment"># rjenkins1</span></span><br><span class="line">	item osd.4 weight 0.049</span><br><span class="line">&#125;</span><br><span class="line">host node-3-ssd &#123;</span><br><span class="line">	<span class="comment"># weight 0.098</span></span><br><span class="line">	alg straw2</span><br><span class="line">	<span class="built_in">hash</span> 0	<span class="comment"># rjenkins1</span></span><br><span class="line">	item osd.5 weight 0.049</span><br><span class="line">&#125;</span><br><span class="line">root default &#123;</span><br><span class="line">	<span class="built_in">id</span> -1		<span class="comment"># do not change unnecessarily</span></span><br><span class="line">	<span class="built_in">id</span> -2 class hdd		<span class="comment"># do not change unnecessarily</span></span><br><span class="line">	<span class="comment"># weight 0.293</span></span><br><span class="line">	alg straw2</span><br><span class="line">	<span class="built_in">hash</span> 0	<span class="comment"># rjenkins1</span></span><br><span class="line">	item node-1 weight 0.049</span><br><span class="line">	item node-2 weight 0.049</span><br><span class="line">	item node-3 weight 0.049</span><br><span class="line">&#125;</span><br><span class="line">root ssd &#123;</span><br><span class="line">	<span class="comment"># weight 0.293</span></span><br><span class="line">	alg straw2</span><br><span class="line">	<span class="built_in">hash</span> 0	<span class="comment"># rjenkins1</span></span><br><span class="line">	item node-1-ssd weight 0.049</span><br><span class="line">	item node-2-ssd weight 0.049</span><br><span class="line">	item node-3-ssd weight 0.049</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># rules</span></span><br><span class="line">rule replicated_rule &#123;</span><br><span class="line">	<span class="built_in">id</span> 0</span><br><span class="line">	<span class="built_in">type</span> replicated</span><br><span class="line">	min_size 1</span><br><span class="line">	max_size 10</span><br><span class="line">	step take default</span><br><span class="line">	step chooseleaf firstn 0 <span class="built_in">type</span> host</span><br><span class="line">	step emit</span><br><span class="line">&#125;</span><br><span class="line">rule demo_rule &#123;</span><br><span class="line">	<span class="built_in">id</span> 10</span><br><span class="line">	<span class="built_in">type</span> replicated</span><br><span class="line">	min_size 1</span><br><span class="line">	max_size 10</span><br><span class="line">	step take ssd</span><br><span class="line">	step chooseleaf firstn 0 <span class="built_in">type</span> host</span><br><span class="line">	step emit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># end crush map</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crushtool -c crushmap.txt -o crushmap-new.bin <span class="comment">#编译新规则文件</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201110232102291.png" alt="image-20201110232102291"></p>
<p><strong>应用规则</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd setcrushmap -i crushmap-new.bin </span><br><span class="line">23</span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201110232310060.png" alt="image-20201110232310060"></p>
<p><strong>修改rule</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd lspools</span><br><span class="line">2 testpool</span><br><span class="line">3 ceph-demo</span><br><span class="line">4 .rgw.root</span><br><span class="line">...</span><br><span class="line">$ ceph osd pool get ceph-demo crush_rule</span><br><span class="line">crush_rule: replicated_rule <span class="comment">#修改前</span></span><br><span class="line">$ ceph osd pool <span class="built_in">set</span> ceph-demo crush_rule demo_rule</span><br><span class="line"><span class="built_in">set</span> pool 3 crush_rule to demo_rule <span class="comment">#修改后</span></span><br><span class="line">$ ceph osd pool get ceph-demo crush_rule</span><br><span class="line">crush_rule: demo_rule</span><br><span class="line"></span><br><span class="line">$ rbd create ceph-demo/test-rbd.img --size 1G</span><br><span class="line">$ ceph osd map ceph-demo test-rbd.img </span><br><span class="line">osdmap e771 pool <span class="string">&#x27;ceph-demo&#x27;</span> (3) object <span class="string">&#x27;test-rbd.img&#x27;</span> -&gt; pg 3.48f5ff89 (3.9) -&gt; up ([4,3,5], p4) acting ([4,3,5], p4)</span><br></pre></td></tr></table></figure>

<h4 id="命令行调整"><a href="#命令行调整" class="headerlink" title="命令行调整"></a><strong>命令行调整</strong></h4><p><strong>已将crush恢复初始</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ceph osd crush add-bucket ssd root <span class="comment">#从上往下，先添加顶层bucket</span></span><br><span class="line">added bucket ssd <span class="built_in">type</span> root to crush map</span><br><span class="line">$ ceph osd crush add-bucket node-1-ssd host</span><br><span class="line">added bucket node-1-ssd <span class="built_in">type</span> host to crush map</span><br><span class="line">$ ceph osd crush add-bucket node-2-ssd host</span><br><span class="line">$ ceph osd crush add-bucket node-3-ssd host</span><br><span class="line">$ ceph osd tree</span><br><span class="line">ID  CLASS WEIGHT  TYPE NAME       STATUS REWEIGHT PRI-AFF </span><br><span class="line">-12             0 host node-3-ssd                         </span><br><span class="line">-11             0 host node-2-ssd                         </span><br><span class="line">-10             0 host node-1-ssd                         </span><br><span class="line"> -9             0 root ssd                                </span><br><span class="line"> -1       0.29279 root default              </span><br><span class="line"> ...</span><br><span class="line"><span class="comment"># 将bucket加入顶层root ssd</span></span><br><span class="line">$ ceph osd crush move node-1-ssd root=ssd</span><br><span class="line">$ ceph osd crush move node-2-ssd root=ssd</span><br><span class="line">$ ceph osd crush move node-3-ssd root=ssd</span><br><span class="line"><span class="comment"># 将osd移动到host</span></span><br><span class="line">$ ceph osd crush move osd.3 host=node-1-ssd root=ssd</span><br><span class="line">$ ceph osd crush move osd.4 host=node-2-ssd root=ssd</span><br><span class="line">$ ceph osd crush move osd.5 host=node-3-ssd root=ssd</span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201111170121442.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改osd class</span></span><br><span class="line">$ ceph osd crush rm-device-class 3 <span class="comment">#先删除</span></span><br><span class="line">$ ceph osd crush set-device-class ssd 3 <span class="comment">#在设置</span></span><br><span class="line"><span class="comment"># 创建rule</span></span><br><span class="line"><span class="comment"># osd crush rule create-replicated &lt;name&gt; &lt;root&gt; &lt;type&gt; &#123;&lt;class&gt;&#125;</span></span><br><span class="line">$ ceph osd crush rule create-replicated ssd-demo ssd host ssd</span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><p>操作前先备份</p>
</li>
<li><p>保留每次修改的bin文件</p>
</li>
<li><p>初始就规划好</p>
</li>
<li><p>重启osd crushmap会变动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#增加osd配置文件</span></span><br><span class="line">[osd]</span><br><span class="line">osd crush update on start = flase</span><br><span class="line">ceph-deploy --overwrite-conf config push node-1 node-2 node-3</span><br><span class="line"><span class="comment"># 重启osd</span></span><br><span class="line">systemctl reset-failed ceph-osd@0.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加配置后新加osd需手动添加crushmap</p>
</li>
</ul>
<h1 id="RBD高级功能"><a href="#RBD高级功能" class="headerlink" title="RBD高级功能"></a>RBD高级功能</h1><h2 id="RBD回收站机制"><a href="#RBD回收站机制" class="headerlink" title="RBD回收站机制"></a>RBD回收站机制</h2><p>正常的 <code>rbd image</code> 一旦删除了就没了，但是 ceph rbd 提供了回收站方式给你反悔的机会。</p>
<p><strong>实验</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ rbd create ceph-demo/ceph-trash.img --size 1G</span><br><span class="line">$ rbd info ceph-demo/ceph-trash.img</span><br><span class="line">rbd image <span class="string">&#x27;ceph-trash.img&#x27;</span>:</span><br><span class="line">	size 1 GiB <span class="keyword">in</span> 256 objects</span><br><span class="line">	order 22 (4 MiB objects)</span><br><span class="line">	snapshot_count: 0</span><br><span class="line">	<span class="built_in">id</span>: 60403c5044e18</span><br><span class="line">	block_name_prefix: rbd_data.60403c5044e18</span><br><span class="line">	format: 2</span><br><span class="line">	features: layering, exclusive-lock, object-map, fast-diff, deep-flatten</span><br><span class="line">	op_features: </span><br><span class="line">	flags: </span><br><span class="line">	create_timestamp: Wed Nov 11 19:57:02 2020</span><br><span class="line">	access_timestamp: Wed Nov 11 19:57:02 2020</span><br><span class="line">	modify_timestamp: Wed Nov 11 19:57:02 2020</span><br><span class="line">$ rbd <span class="built_in">rm</span> ceph-demo/ceph-trash.img <span class="comment">#直接删除后毛都不留</span></span><br><span class="line">Removing image: 100% complete...done.</span><br><span class="line">$ rbd -p ceph-demo trash <span class="built_in">ls</span> <span class="comment"># 查看回收站</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 使用回收站删除</span></span><br><span class="line">rbd trash move [--pool &lt;pool&gt;] [--namespace &lt;namespace&gt;] </span><br><span class="line">                      [--image &lt;image&gt;] [--expires-at &lt;expires-at&gt;] </span><br><span class="line">                      &lt;image-spec&gt; </span><br><span class="line">$ rbd trash move ceph-demo/test-rbd.img --expires-at 20201130</span><br><span class="line">$ rbd -p ceph-demo trash <span class="built_in">ls</span>  <span class="comment">#过期自动清理</span></span><br><span class="line">567c52ba8a29b test-rbd.img</span><br><span class="line"></span><br><span class="line"><span class="comment">###回收镜像</span></span><br><span class="line">rbd trash restore -p ceph-demo 567c52ba8a29b</span><br></pre></td></tr></table></figure>

<h2 id="镜像制作快照"><a href="#镜像制作快照" class="headerlink" title="镜像制作快照"></a>镜像制作快照</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rbd create ceph-demo/rbd-tst.img --image-feature layering --size 1G</span><br><span class="line">$ rbd device map ceph-demo/rbd-tst.img</span><br><span class="line">$ mkfs.ext4 /dev/rbd0</span><br><span class="line">$ mount /dev/rbd0 /media</span><br><span class="line">$ <span class="built_in">echo</span> 20201111 &gt; /media/file20201111</span><br><span class="line">$ <span class="built_in">sync</span> <span class="comment">#同步数据</span></span><br><span class="line">$ rbd snap create ceph-demo/rbd-tst.img@snap20201111 <span class="comment">#创建快照</span></span><br><span class="line">$ rbd snap <span class="built_in">ls</span> ceph-demo/rbd-tst.img</span><br><span class="line">SNAPID NAME         SIZE  PROTECTED TIMESTAMP                </span><br><span class="line">     4 snap20201111 1 GiB           Wed Nov 11 22:15:25 2020</span><br></pre></td></tr></table></figure>

<h2 id="快照数据恢复"><a href="#快照数据恢复" class="headerlink" title="快照数据恢复"></a>快照数据恢复</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> /media/file1 -f</span><br><span class="line"><span class="comment"># rbd snap rollback [&lt;pool-name&gt;/[&lt;namespace&gt;/]]&lt;image-name&gt;@&lt;snapshot-name&gt;)</span></span><br><span class="line">$ umount /media <span class="comment">#先卸载</span></span><br><span class="line">$ rbd snap rollback ceph-demo/rbd-tst.img@snap20201111</span><br><span class="line">Rolling back to snapshot: 100% complete...done.</span><br><span class="line">$ mount /dev/rbd0 /media/</span><br></pre></td></tr></table></figure>

<h2 id="删除RBD"><a href="#删除RBD" class="headerlink" title="删除RBD"></a>删除RBD</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全部卸载</span></span><br><span class="line">$ rbd unmap ceph-demo/rbd-tst.img <span class="comment">#卸载镜像</span></span><br><span class="line"><span class="comment">#rbd snap purge &#123;pool-name&#125;/&#123;namespace&#125;</span></span><br><span class="line">$ rbd snap purge ceph-demo/rbd-tst.img  <span class="comment">#清除所有快照</span></span><br><span class="line">$ rbd snap remove ceph-demo/rbd-tst.img@snap20201111 <span class="comment">#单个删除</span></span><br><span class="line">$ rbd remove ceph-demo/rbd-tst.img <span class="comment">#删除镜像</span></span><br><span class="line">$ rbd device <span class="built_in">ls</span></span><br><span class="line"><span class="built_in">id</span> pool      namespace image       snap device    </span><br><span class="line">0  ceph-demo           rbd-tst.img -    /dev/rbd0</span><br></pre></td></tr></table></figure>

<h2 id="镜像克隆机制"><a href="#镜像克隆机制" class="headerlink" title="镜像克隆机制"></a>镜像克隆机制</h2><p>Ceph支持创建块设备快照的许多写时复制（COW）克隆的功能。快照分层使Ceph块设备客户端可以非常快速地创建图像。例如，您可能会在写入了Linux VM的情况下创建块设备映像。然后，对映像进行快照，保护快照，并根据需要创建尽可能多的写时复制克隆。快照是只读的，因此克隆快照可以简化语义，从而可以快速创建克隆。</p>
<p><img src="/ceph11/index/image-20201112194658307.png"></p>
<p><img src="/ceph11/index/image-20201112195805183.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbd clone &#123;pool-name&#125;/&#123;parent-image&#125;@&#123;snap-name&#125; &#123;pool-name&#125;/&#123;child-image-name&#125;</span></span><br><span class="line">$ rbd snap create ceph-demo/rbd-tst.img@template <span class="comment"># 创建镜像快照	</span></span><br><span class="line">$ rbd snap protect ceph-demo/rbd-tst.img@template <span class="comment">#镜像保护</span></span><br><span class="line">$ rbd snap <span class="built_in">rm</span> ceph-demo/rbd-tst.img@template <span class="comment">#无法删除</span></span><br><span class="line">Removing snap: 0% complete...failed.</span><br><span class="line">rbd: snapshot <span class="string">&#x27;template&#x27;</span> is protected from removal.</span><br><span class="line">2020-11-12 20:04:38.434 7f49ae2a3c80 -1 librbd::Operations: snapshot is protected</span><br><span class="line"><span class="comment"># 从快照克隆镜像</span></span><br><span class="line">$ rbd <span class="built_in">clone</span> ceph-demo/rbd-tst.img@template ceph-demo/vm1-clone.img</span><br></pre></td></tr></table></figure>

<h2 id="快照子项"><a href="#快照子项" class="headerlink" title="快照子项"></a>快照子项</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##rbd children &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snapshot-name&#125;</span></span><br><span class="line">$ rbd children ceph-demo/rbd-tst.img</span><br><span class="line">ceph-demo/vm1-clone.img</span><br><span class="line">ceph-demo/vm2-clone.img</span><br></pre></td></tr></table></figure>

<h2 id="解除依赖关系"><a href="#解除依赖关系" class="headerlink" title="解除依赖关系"></a>解除依赖关系</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#rbd flatten &#123;pool-name&#125;/&#123;image-name&#125;</span></span><br><span class="line">$ rbd flatten ceph-demo/vm1-clone.img</span><br><span class="line">Image flatten: 100% complete...done.</span><br><span class="line">$ rbd children ceph-demo/rbd-tst.img</span><br><span class="line">ceph-demo/vm2-clone.img</span><br><span class="line">$ rbd info ceph-demo/vm2-clone.img</span><br><span class="line">rbd image <span class="string">&#x27;vm2-clone.img&#x27;</span>:</span><br><span class="line">...</span><br><span class="line">	parent: ceph-demo/rbd-tst.img@template <span class="comment">#存在依赖关系</span></span><br><span class="line">	overlap: 1 GiB</span><br></pre></td></tr></table></figure>

<h2 id="RBD备份与恢复"><a href="#RBD备份与恢复" class="headerlink" title="RBD备份与恢复"></a>RBD备份与恢复</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ rbd <span class="built_in">export</span> ceph-demo/vm2-clone.img /root/test.img <span class="comment">#备份</span></span><br><span class="line">Exporting image: 100% complete...done.</span><br><span class="line">$ <span class="built_in">du</span> -sh /root/test.img</span><br><span class="line">32M	/root/test.img</span><br><span class="line">$ rbd import /root/test.img ceph-demo/vm2-clone-new.img <span class="comment">#导入</span></span><br><span class="line"><span class="comment">## 导入存在镜像会报错，按提示忽略</span></span><br></pre></td></tr></table></figure>

<h2 id="增量备份与恢复"><a href="#增量备份与恢复" class="headerlink" title="增量备份与恢复"></a>增量备份与恢复</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 111 &gt; /media/file20201111-new</span><br><span class="line">$ <span class="built_in">sync</span></span><br><span class="line">$ rbd snap create ceph-demo/rbd-tst.img@v1</span><br><span class="line">$ rbd export-diff ceph-demo/rbd-tst.img@v1 rbd-tst.img@v1</span><br><span class="line">$ <span class="built_in">du</span> -sh ./*</span><br><span class="line">7.4M	./rbd-tst.img@v1 <span class="comment">##增量导出大小</span></span><br><span class="line">32M	./test.img</span><br><span class="line"><span class="comment">##挂载之前导入的镜像</span></span><br><span class="line">$ rbd map ceph-demo/vm2-clone-new.img</span><br><span class="line">$ <span class="built_in">mkdir</span> /vm2-clone-new</span><br><span class="line">$ mount /dev/rbd1 /vm2-clone-new</span><br><span class="line">$ ll /vm2-clone-new</span><br><span class="line">总用量 24</span><br><span class="line">-rw-r--r-- 1 root root    13 11月 13 15:27 file20201111</span><br><span class="line"><span class="comment">###导入增量备份</span></span><br><span class="line">$ rbd import-diff /root/rbd-tst.img@v1 ceph-demo/vm2-clone-new.img</span><br><span class="line"><span class="comment">#重新挂载rbd</span></span><br><span class="line">$ ll /vm2-clone-new</span><br><span class="line">总用量 24</span><br><span class="line">-rw-r--r-- 1 root root    13 11月 13 15:27 file20201111</span><br><span class="line">-rw-r--r-- 1 root root     4 11月 13 15:49 file20201111-new</span><br></pre></td></tr></table></figure>

<h2 id="导入导出总结"><a href="#导入导出总结" class="headerlink" title="导入导出总结"></a>导入导出总结</h2><p><img src="/ceph11/index/image-20201112205640001.png"></p>
<h1 id="RGW高可用集群"><a href="#RGW高可用集群" class="headerlink" title="RGW高可用集群"></a>RGW高可用集群</h1><h2 id="拓展RGW集群"><a href="#拓展RGW集群" class="headerlink" title="拓展RGW集群"></a>拓展RGW集群</h2><p>之前部署只有一个RGW网关</p>
<p><img src="/ceph11/index/image-20201114141237208.png"></p>
<p><img src="/ceph11/index/image-20201114141537505.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ceph-deploy</span><br><span class="line">$ ceph-deploy rgw create node-2 </span><br></pre></td></tr></table></figure>

<p><strong>可以修改端口</strong></p>
<p><img src="/ceph11/index/image-20201114142245017.png"></p>
<h2 id="搭建高可用环境"><a href="#搭建高可用环境" class="headerlink" title="搭建高可用环境"></a>搭建高可用环境</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>端口</th>
<th>软件</th>
<th>VIP+端口</th>
</tr>
</thead>
<tbody><tr>
<td>node-1</td>
<td>10.211.55.201</td>
<td>81</td>
<td>rgw+ha+kp</td>
<td>10.211.55.200:80</td>
</tr>
<tr>
<td>node-2</td>
<td>10.211.55.202</td>
<td>81</td>
<td>rgw+ha+kp</td>
<td>10.211.55.200:8</td>
</tr>
</tbody></table>
<h3 id="配置keepalived"><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a>配置keepalived</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ yum install keepalived libnl3-devel ipset-devel -y</span><br><span class="line"><span class="comment">#### node-1</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id RGW  <span class="comment">#</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   <span class="comment">#vrrp_strict</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_haproxy &#123; <span class="comment">#健康检查脚本,检测到异常时，权重降低2</span></span><br><span class="line">	script <span class="string">&quot;killall -0 haproxy&quot;</span></span><br><span class="line">	interval 2 <span class="comment">#检测间隔</span></span><br><span class="line">	weight -2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance RGW &#123;</span><br><span class="line">    state MASTER <span class="comment">#master角色</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100 <span class="comment">#权重100</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.211.55.200/24  <span class="comment">#VIP地址</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">    	chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​	</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### node-2</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id RGW  <span class="comment">#</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   <span class="comment">#vrrp_strict</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_haproxy &#123; <span class="comment">#健康检查脚本</span></span><br><span class="line">	script <span class="string">&quot;killall -0 haproxy&quot;</span></span><br><span class="line">	interval 2</span><br><span class="line">	weight -2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance RGW &#123;</span><br><span class="line">    state BACKUP <span class="comment">#BACKUP角色</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99 <span class="comment">#权重99</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.211.55.200/24  <span class="comment">#VIP地址</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">    	chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="配置haproxy"><a href="#配置haproxy" class="headerlink" title="配置haproxy"></a>配置haproxy</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">global</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">log</span>         <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local2</span><br><span class="line"></span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     <span class="number">4000</span></span><br><span class="line">    <span class="keyword">user</span>        haproxy</span><br><span class="line">    <span class="keyword">group</span>       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    # turn <span class="keyword">on</span> stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    <span class="keyword">log</span>                     <span class="keyword">global</span></span><br><span class="line">    <span class="keyword">option</span>                  httplog</span><br><span class="line">    <span class="keyword">option</span>                  dontlognull</span><br><span class="line">    <span class="keyword">option</span> http-<span class="keyword">server</span>-<span class="keyword">close</span></span><br><span class="line">    <span class="keyword">option</span> forwardfor       <span class="keyword">except</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span></span><br><span class="line">    <span class="keyword">option</span>                  redispatch</span><br><span class="line">    retries                 <span class="number">3</span></span><br><span class="line">    timeout http-request    <span class="number">10</span>s</span><br><span class="line">    timeout queue           <span class="number">1</span>m</span><br><span class="line">    timeout <span class="keyword">connect</span>         <span class="number">10</span>s</span><br><span class="line">    timeout client          <span class="number">1</span>m</span><br><span class="line">    timeout <span class="keyword">server</span>          <span class="number">1</span>m</span><br><span class="line">    timeout http-keep-alive <span class="number">10</span>s</span><br><span class="line">    timeout <span class="keyword">check</span>           <span class="number">10</span>s</span><br><span class="line">    maxconn                 <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">frontend  http_web *:<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    default_backend rgw</span><br><span class="line"></span><br><span class="line">backend rgw</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    mode http</span><br><span class="line">    <span class="keyword">server</span> node<span class="number">-1</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.201</span>:<span class="number">7480</span> <span class="keyword">check</span></span><br><span class="line">    <span class="keyword">server</span> ndoe<span class="number">-2</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.202</span>:<span class="number">7480</span> <span class="keyword">check</span></span><br></pre></td></tr></table></figure>

<h3 id="修改客户端指向"><a href="#修改客户端指向" class="headerlink" title="修改客户端指向"></a>修改客户端指向</h3><h4 id="s3"><a href="#s3" class="headerlink" title="s3"></a>s3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~/.s3cfg</span><br><span class="line">host_base = 10.211.55.200:80</span><br><span class="line">host_bucket = 10.211.55.200:80/%(bucket)s</span><br><span class="line">$ s3cmd <span class="built_in">ls</span></span><br><span class="line">2020-10-30 12:49  s3://ceph-s3-<span class="built_in">test</span></span><br><span class="line">2020-10-30 12:48  s3://my-new-bucket</span><br><span class="line">2020-10-30 13:50  s3://swift-demo</span><br><span class="line">$ s3cmd mb s3://test-1</span><br><span class="line">Bucket <span class="string">&#x27;s3://test-1/&#x27;</span> created</span><br><span class="line">$ s3cmd put <span class="built_in">test</span> s3://test-1/</span><br><span class="line">upload: <span class="string">&#x27;test&#x27;</span> -&gt; <span class="string">&#x27;s3://test-1/test&#x27;</span>  [1 of 1]</span><br><span class="line"> 61 of 61   100% <span class="keyword">in</span>    0s     2.00 KB/s  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="swift"><a href="#swift" class="headerlink" title="swift"></a>swift</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改环境变量/etc/profile</span></span><br><span class="line">$ swift list</span><br><span class="line">ceph-s3-test</span><br><span class="line">my-new-bucket</span><br><span class="line">swift-demo</span><br><span class="line">test-1</span><br></pre></td></tr></table></figure>

<h1 id="CEPH集群测试"><a href="#CEPH集群测试" class="headerlink" title="CEPH集群测试"></a>CEPH集群测试</h1><h2 id="mon-1"><a href="#mon-1" class="headerlink" title="mon"></a>mon</h2><p>模式为<code>选举</code> 最多挂n&#x2F;2-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#配置文件</span></span></span><br><span class="line">mon_host = 10.211.55.201,10.211.55.202,10.211.55.203</span><br></pre></td></tr></table></figure>

<h2 id="mds-1"><a href="#mds-1" class="headerlink" title="mds"></a>mds</h2><p>模式为<code>一主多备</code>,确保集群中至少有1个</p>
<h2 id="RGW"><a href="#RGW" class="headerlink" title="RGW"></a>RGW</h2><p>ha+kp高可用</p>
<h2 id="OSD坏盘"><a href="#OSD坏盘" class="headerlink" title="OSD坏盘"></a>OSD坏盘</h2><p>对象为3副本，最多挂2个节点</p>
<h2 id="fio性能压测评估"><a href="#fio性能压测评估" class="headerlink" title="fio性能压测评估"></a>fio性能压测评估</h2><h3 id="4K随机写-IOPS"><a href="#4K随机写-IOPS" class="headerlink" title="4K随机写-IOPS"></a>4K随机写-IOPS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ fio -filename=/media/fio.img&lt;文件名&gt; -direct=1 \</span><br><span class="line">-iodepth 32&lt;深度对应numjobs并发,每个并发队列深度为32&gt; \</span><br><span class="line">-thread -rw=randwrite&lt;类型为随机写&gt; -ioengine=libaio&lt;引擎&gt; \</span><br><span class="line">-bs=4k&lt;块大小&gt; -size=200m -numjobs=8&lt;并发,对应cpu核数&gt; \</span><br><span class="line">-runtime=60 -group_reporting -name=mytest</span><br><span class="line">$ yum install sysstat -y</span><br><span class="line">$ watch -n 0.5 iostat -x <span class="comment">#磁盘io信息</span></span><br><span class="line">$ ceph osd perf <span class="comment">#osd延迟</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201114214342564.png" alt="虚拟机稀烂的数据"></p>
<p><img src="/ceph11/index/image-20201114215425196.png" alt="image-20201114215425196"></p>
<h3 id="4K随机读-IOPS"><a href="#4K随机读-IOPS" class="headerlink" title="4K随机读-IOPS"></a>4K随机读-IOPS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fio -filename=/media/fio.img -direct=1 -iodepth 32 -thread -rw=randread -ioengine=libaio -bs=4k -size=200m -numjobs=8 -runtime=60 -group_reporting -name=mytest</span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201114221925729.png" alt="image-20201114221925729"></p>
<h3 id="4K随机读写-IOPS-r70-w30"><a href="#4K随机读写-IOPS-r70-w30" class="headerlink" title="4K随机读写-IOPS r70% w30%"></a>4K随机读写-IOPS r70% w30%</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fio -filename=/media/fio.img -direct=1 -iodepth 32 -thread -rw=randrw -rwmixread=70 -ioengine=libaio -bs=4k -size=200m -numjobs=8 -runtime=60 -group_reporting -name=mytest</span><br></pre></td></tr></table></figure>

<h3 id="1M顺序写-吞吐"><a href="#1M顺序写-吞吐" class="headerlink" title="1M顺序写-吞吐"></a>1M顺序写-吞吐</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fio -filename=/media/fio.img -direct=1 -iodepth 32 -thread -rw=write  -ioengine=libaio -bs=1m -size=200m -numjobs=8 -runtime=60 -group_reporting -name=mytest</span><br></pre></td></tr></table></figure>

<h2 id="RBD-Bench压力测试"><a href="#RBD-Bench压力测试" class="headerlink" title="RBD Bench压力测试"></a>RBD Bench压力测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rbd <span class="built_in">help</span> bench </span><br><span class="line">$  rbd bench ceph-demo/rbd-tst.img --io-size 4K --io-threads 16 --io-total</span><br><span class="line">...</span><br><span class="line">elapsed:    49  ops:    51200  ops/sec:  1040.25  bytes/sec: 4260872.35</span><br></pre></td></tr></table></figure>

<h1 id="CEPH与K8s集成"><a href="#CEPH与K8s集成" class="headerlink" title="CEPH与K8s集成"></a>CEPH与K8s集成</h1><p>官方文档<a target="_blank" rel="noopener" href="https://v1-18.docs.kubernetes.io/docs/concepts/storage/volumes/">https://v1-18.docs.kubernetes.io/docs/concepts/storage/volumes/</a></p>
<h2 id="Ceph与volumes集成"><a href="#Ceph与volumes集成" class="headerlink" title="Ceph与volumes集成"></a>Ceph与volumes集成</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载并安装sealos, sealos是个golang的二进制工具，直接下载拷贝到bin目录即可, release页面也可下载</span></span><br><span class="line">$ wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/latest/sealos &amp;&amp; \</span><br><span class="line">    <span class="built_in">chmod</span> +x sealos &amp;&amp; <span class="built_in">mv</span> sealos /usr/bin </span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载离线资源包</span></span><br><span class="line">$ wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/7b6af025d4884fdd5cd51a674994359c-1.18.0/kube1.18.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装一个kubernetes单节点</span></span><br><span class="line">sealos init --passwd <span class="string">&#x27;123456&#x27;</span> \</span><br><span class="line">	--master 10.211.55.10 --node 10.211.55.10 \</span><br><span class="line">	--pkg-url /root/kube1.18.0.tar.gz \</span><br><span class="line">	--version v1.18.0</span><br><span class="line">	</span><br><span class="line">yum -y install ceph-common <span class="comment">#在k8s节点安装包</span></span><br></pre></td></tr></table></figure>

<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>1、创建pool和用户</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">node</span><span class="title">-1</span> ~]<span class="comment"># ceph osd pool create kubernetes 8 8 </span></span><br></pre></td></tr></table></figure>

<p>2、创建认证用户</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node-1 ~]</span><span class="comment"># ceph auth get-or-create client.kubernetes mon &#x27;profile rbd&#x27; osd &#x27;profile rbd pool=kubernetes&#x27;</span></span><br><span class="line"><span class="section">[client.kubernetes]</span></span><br><span class="line">    <span class="attr">key</span> = AQD/<span class="number">6</span>LBfg19MIhAA4UGpvND9amAsVjJtsDfvtQ==</span><br></pre></td></tr></table></figure>

<p>3、创建secrets对象存储将Ceph的认证key存储在Secrets中</p>
<p>获取步骤2生成的key，并将其加密为base64格式</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">node</span><span class="title">-1</span> ~]<span class="comment"># echo AQD/6LBfg19MIhAA4UGpvND9amAsVjJtsDfvtQ== | base64 </span></span><br><span class="line"><span class="attr">QVFELzZMQmZnMTlNSWhBQTRVR3B2TkQ5YW1Bc1ZqSnRzRGZ2dFE9PQo=</span></span><br></pre></td></tr></table></figure>

<p>创建定义secrets对象</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Secret</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> ceph-secret</span><br><span class="line"><span class="symbol">type:</span> <span class="string">&quot;kubernetes.io/rbd&quot;</span></span><br><span class="line"><span class="symbol">data:</span></span><br><span class="line"><span class="symbol">  key:</span> QVFELzZMQmZnMTlNSWhBQTRVR3B2TkQ5YW1Bc1ZqSnRzRGZ2dFE9PQo=</span><br></pre></td></tr></table></figure>

<p>生成secrets</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">node</span><span class="title">-1</span> volumes]<span class="comment"># kubectl apply -f secret.yaml </span></span><br><span class="line">secret/ceph-secret created</span><br><span class="line"></span><br><span class="line">[root@<span class="keyword">node</span><span class="title">-1</span> volumes]<span class="comment"># kubectl get secret</span></span><br><span class="line">NAME                  <span class="keyword">TYPE</span>                                  DATA   AGE</span><br><span class="line">ceph-secret           kubernetes.io/rbd                     <span class="number">1</span>      <span class="number">10s</span></span><br><span class="line">default-token-hn65d   kubernetes.io/service-account-token   <span class="number">3</span>      <span class="number">41</span>d</span><br></pre></td></tr></table></figure>

<h2 id="容器中调用RBD-volumes"><a href="#容器中调用RBD-volumes" class="headerlink" title="容器中调用RBD volumes"></a>容器中调用RBD volumes</h2><p>1、创建rbd块</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@node-1</span> <span class="string">~</span>]<span class="comment"># rbd create -p kubernetes --image-feature layering rbd.img --size 10G</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@node-1</span> <span class="string">~</span>]<span class="comment"># rbd info kubernetes/rbd.img</span></span><br><span class="line"><span class="string">rbd</span> <span class="string">image</span> <span class="attr">&#x27;rbd.img&#x27;:</span></span><br><span class="line">    <span class="string">size</span> <span class="number">10</span> <span class="string">GiB</span> <span class="string">in</span> <span class="number">2560 </span><span class="string">objects</span></span><br><span class="line">    <span class="string">order</span> <span class="number">22</span> <span class="string">(4</span> <span class="string">MiB</span> <span class="string">objects)</span></span><br><span class="line">    <span class="attr">id:</span> <span class="string">519576b8b4567</span></span><br><span class="line">    <span class="attr">block_name_prefix:</span> <span class="string">rbd_data.519576b8b4567</span></span><br><span class="line">    <span class="attr">format:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">features:</span> <span class="string">layering</span></span><br><span class="line">    <span class="attr">op_features:</span> </span><br><span class="line">    <span class="attr">flags:</span> </span><br><span class="line">    <span class="attr">create_timestamp:</span> <span class="string">Mon</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">23</span><span class="string">:27:02</span> <span class="number">2020</span></span><br></pre></td></tr></table></figure>

<p>2、pod中引用RBD volumes</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">[root@node-1 volumes]# cat pods.yaml </span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">volume-rbd-demo</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">containers</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">name: pod-with-rbd</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">    <span class="attribute">imagePullPolicy</span><span class="punctuation">:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">name: www</span></span><br><span class="line">      <span class="attribute">containerPort</span><span class="punctuation">:</span> <span class="string">80</span></span><br><span class="line">      <span class="attribute">protocol</span><span class="punctuation">:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attribute">volumeMounts</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">name: rbd-demo</span></span><br><span class="line">      <span class="attribute">mountPath</span><span class="punctuation">:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">name: rbd-demo</span></span><br><span class="line">    <span class="attribute">rbd</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">monitors</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">10.211.55.201:6789</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">10.211.55.202:6789</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">10.211.55.203:6789</span></span><br><span class="line">      <span class="attribute">pool</span><span class="punctuation">:</span> <span class="string">kubernetes</span></span><br><span class="line">      <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">rbd.img</span></span><br><span class="line">      <span class="attribute">fsType</span><span class="punctuation">:</span> <span class="string">ext4 </span></span><br><span class="line">      <span class="attribute">user</span><span class="punctuation">:</span> <span class="string">kubernetes</span></span><br><span class="line">      <span class="attribute">secretRef</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">ceph-secret</span></span><br></pre></td></tr></table></figure>

<h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><p>1、生成pod</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">node</span><span class="title">-1</span> volumes]<span class="comment"># kubectl apply -f pods.yaml </span></span><br><span class="line">pod/volume-rbd-demo configured</span><br><span class="line">[root@<span class="keyword">node</span><span class="title">-1</span> volumes]<span class="comment"># kubectl get pods </span></span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">demo-<span class="number">8</span>ffbcf7c5-r2wzf   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">21h</span></span><br><span class="line">volume-rbd-demo        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">43m</span></span><br></pre></td></tr></table></figure>

<p>2、查看挂载的情况，可以看到RBD块存储挂载至data目录</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node<span class="number">-1</span> volumes]# kubectl exec -it volume-rbd-demo -- df -h</span><br><span class="line"><span class="symbol">Filesystem</span>      <span class="symbol">Size</span>  <span class="symbol">Used</span> <span class="symbol">Avail</span> <span class="symbol">Use</span><span class="comment">% Mounted on</span></span><br><span class="line">rootfs           <span class="number">50</span><span class="symbol">G</span>  <span class="number">6.7</span><span class="symbol">G</span>   <span class="number">41</span><span class="symbol">G</span>  <span class="number">15</span><span class="comment">% /</span></span><br><span class="line">overlay          <span class="number">50</span><span class="symbol">G</span>  <span class="number">6.7</span><span class="symbol">G</span>   <span class="number">41</span><span class="symbol">G</span>  <span class="number">15</span><span class="comment">% /</span></span><br><span class="line">tmpfs            <span class="number">64</span><span class="symbol">M</span>     <span class="number">0</span>   <span class="number">64</span><span class="symbol">M</span>   <span class="number">0</span><span class="comment">% /dev</span></span><br><span class="line">tmpfs           <span class="number">920</span><span class="symbol">M</span>     <span class="number">0</span>  <span class="number">920</span><span class="symbol">M</span>   <span class="number">0</span><span class="comment">% /sys/fs/cgroup</span></span><br><span class="line">/dev/rbd0       <span class="number">9.8</span><span class="symbol">G</span>   <span class="number">37</span><span class="symbol">M</span>  <span class="number">9.7</span><span class="symbol">G</span>   <span class="number">1</span><span class="comment">% /data</span></span><br></pre></td></tr></table></figure>

<h2 id="Ceph与PV-x2F-PVC集成"><a href="#Ceph与PV-x2F-PVC集成" class="headerlink" title="Ceph与PV&#x2F;PVC集成"></a>Ceph与PV&#x2F;PVC集成</h2><h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><p>参考步骤一，创建好pool，镜像，用户认证，secrets</p>
<h3 id="定义PV和PVC"><a href="#定义PV和PVC" class="headerlink" title="定义PV和PVC"></a>定义PV和PVC</h3><p>1、PV定义，定义一块存储，抽象化为PV</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ rbd create -p kubernetes --image-feature layering demo-1.img --size 10G</span><br><span class="line">[root@node-1 pv_and_pvc]<span class="comment"># cat pv.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-demo</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">   - ReadWriteOnce</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10G</span><br><span class="line">  rbd:</span><br><span class="line">    monitors:</span><br><span class="line">     - 10.211.55.201:6789</span><br><span class="line">     - 10.211.55.202:6789</span><br><span class="line">     - 10.211.55.203:6789</span><br><span class="line">    pool: kubernetes</span><br><span class="line">    image: demo-1.img </span><br><span class="line">    fsType: ext4</span><br><span class="line">    user: kubernetes</span><br><span class="line">    secretRef:</span><br><span class="line">      name: ceph-secret</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  storageClassName: rbd</span><br></pre></td></tr></table></figure>

<p>2、PVC定义，引用PV</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@node-1</span> <span class="string">pv_and_pvc</span>]<span class="comment"># cat pvc.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeName:</span> <span class="string">rbd-demo</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10G</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">rbd</span></span><br></pre></td></tr></table></figure>

<p>3、生成PV和PVC</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node-1 pv_and_pvc]<span class="comment"># kubectl apply -f pv.yaml </span></span><br><span class="line">persistentvolume/rbd-demo created</span><br><span class="line"></span><br><span class="line">[root@node-1 pv_and_pvc]<span class="comment"># kubectl get pv</span></span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">rbd-demo   10G        RWO            Retain           Available           rbd                     9s</span><br><span class="line"></span><br><span class="line">[root@node-1 pv_and_pvc]<span class="comment"># kubectl apply -f pvc.yaml </span></span><br><span class="line">persistentvolumeclaim/pvc-demo created</span><br><span class="line">[root@node-1 pv_and_pvc]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME       STATUS    VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-demo   Pending   rbd-demo   0                         rbd            2s</span><br></pre></td></tr></table></figure>

<h3 id="Pod中引用PVC"><a href="#Pod中引用PVC" class="headerlink" title="Pod中引用PVC"></a>Pod中引用PVC</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@node-1</span> <span class="string">pv_and_pvc</span>]<span class="comment"># cat pod-demo.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rbd</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rbd</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">pvc-demo</span></span><br></pre></td></tr></table></figure>

<p>文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/happylab/2488904">https://blog.51cto.com/happylab/2488904</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/examples/tree/master/volumes/rbd">https://github.com/kubernetes/examples/tree/master/volumes/rbd</a></li>
<li><a href="https://horus-k.github.io/2020/09/17/kubeasz%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%BA%8C%E8%BF%9B%E5%88%B6k8s%E9%9B%86%E7%BE%A4/">https://horus-k.github.io/2020/09/17/kubeasz%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%BA%8C%E8%BF%9B%E5%88%B6k8s%E9%9B%86%E7%BE%A4/</a></li>
</ul>
<h2 id="Ceph与StorageClass集成"><a href="#Ceph与StorageClass集成" class="headerlink" title="Ceph与StorageClass集成"></a>Ceph与StorageClass集成</h2><p><img src="/ceph11/index/image-20201115174324449.png"></p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>创建所需的ServiceAccount和RBAC ClusterRole &#x2F; ClusterRoleBinding Kubernetes对象。这些对象不一定需要针对您的Kubernetes环境进行自定义，因此可以从 ceph -csi部署YAML中按原样使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-provisioner-rbac.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-nodeplugin-rbac.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-rbdplugin-provisioner.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-rbdplugin.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl apply -f csi-provisioner-rbac.yaml</span><br><span class="line">kubectl apply -f csi-nodeplugin-rbac.yaml</span><br><span class="line">kubectl apply -f csi-rbdplugin-provisioner.yaml</span><br><span class="line">kubectl apply -f csi-rbdplugin.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config.json:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    [</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        &quot;clusterID&quot;: &quot;a96a9084-601e-46ca-a8b1-cf6b1ab5edf1&quot;,</span></span><br><span class="line"><span class="string">        &quot;monitors&quot;: [</span></span><br><span class="line"><span class="string">          &quot;10.211.55.201:6789&quot;,</span></span><br><span class="line"><span class="string">          &quot;10.211.55.202:6789&quot;,</span></span><br><span class="line"><span class="string">          &quot;10.211.55.203:6789&quot;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string"></span><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-csi-config</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">csi-rbd-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="attr">userID:</span> <span class="string">kubernetes</span></span><br><span class="line">  <span class="attr">userKey:</span> <span class="string">QVFELzZMQmZnMTlNSWhBQTRVR3B2TkQ5YW1Bc1ZqSnRzRGZ2dFE9PQo=</span></span><br></pre></td></tr></table></figure>

<h3 id="创建sc"><a href="#创建sc" class="headerlink" title="创建sc"></a>创建sc</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">官网少个configmap报错</span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/ceph/</span>ceph-csi<span class="regexp">/blob/m</span>aster<span class="regexp">/examples/</span>kms<span class="regexp">/vault/</span>kms-config.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">&gt;</span> <span class="string">csi-rbd-sc.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">csi-rbd-sc</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">rbd.csi.ceph.com</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">   <span class="attr">clusterID:</span> <span class="string">a96a9084-601e-46ca-a8b1-cf6b1ab5edf1</span></span><br><span class="line">   <span class="attr">pool:</span> <span class="string">kubernetes</span></span><br><span class="line">   <span class="attr">csi.storage.k8s.io/provisioner-secret-name:</span> <span class="string">csi-rbd-secret</span></span><br><span class="line">   <span class="attr">csi.storage.k8s.io/provisioner-secret-namespace:</span> <span class="string">default</span></span><br><span class="line">   <span class="attr">csi.storage.k8s.io/node-stage-secret-name:</span> <span class="string">csi-rbd-secret</span></span><br><span class="line">   <span class="attr">csi.storage.k8s.io/node-stage-secret-namespace:</span> <span class="string">default</span></span><br><span class="line">   <span class="attr">imageFeatures:</span> <span class="string">layering</span> <span class="comment">#定义特性</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">mountOptions:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">discard</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">csi-rbd-sc.yaml</span></span><br></pre></td></tr></table></figure>

<h3 id="创建pvc"><a href="#创建pvc" class="headerlink" title="创建pvc"></a><strong>创建pvc</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">&gt;</span> <span class="string">raw-block-pvc.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">raw-block-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Block</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">csi-rbd-sc</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">raw-block-pvc.yaml</span></span><br></pre></td></tr></table></figure>

<p>创建pvc后申请pv出错，权限不足</p>
<p>修改为admin权限后重新创建</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ceph auth list</span></span><br></pre></td></tr></table></figure>

<p><img src="/ceph11/index/image-20201115210128101.png" alt="image-20201115210128101"></p>
<h2 id="容器调用StorageClass"><a href="#容器调用StorageClass" class="headerlink" title="容器调用StorageClass"></a>容器调用StorageClass</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">csi-rbd-demo-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-server</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypvc</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/www/html</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypvc</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">rbd-pvc</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod.yaml</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果没有升级内核会报错</li>
</ul>
<p><img src="/ceph11/index/image-20201116150526801.png"></p>
<p><img src="/ceph11/index/image-20201116151706061.png"></p>
<ul>
<li><p>可根据提示关闭rbd特性</p>
</li>
<li><p>或者修改ceph配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ceph --admin-daemon /var/run/ceph/ceph-mon.node-1.asok config show | grep features</span><br><span class="line">    <span class="string">&quot;enable_experimental_unrecoverable_data_corrupting_features&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mon_debug_no_initial_persistent_features&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rbd_default_features&quot;</span>: <span class="string">&quot;61&quot;</span>,</span><br><span class="line">将rbd_default_features改为1 <span class="comment">##好像没用，要在sc里修改,生效需删除重建</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/ceph11/index/image-20201116154123566.png"></p>
<h1 id="Ceph与KVM集成"><a href="#Ceph与KVM集成" class="headerlink" title="Ceph与KVM集成"></a>Ceph与KVM集成</h1><h1 id="CEPH与OpenStack集成"><a href="#CEPH与OpenStack集成" class="headerlink" title="CEPH与OpenStack集成"></a>CEPH与OpenStack集成</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">我们安装的是all-in-one环境的openstack,测试机IP：192.168.1.10</span><br><span class="line">[root@openstack ~]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br><span class="line">内存:4G    硬盘:80G    CPU:4核</span><br><span class="line"></span><br><span class="line">1)、[root@openstack ~]<span class="comment"># vim /etc/environment </span></span><br><span class="line">LANG=en_US.utf-8</span><br><span class="line">LC_ALL=en_US.utf-8</span><br><span class="line"></span><br><span class="line">2）、禁用firewalld、NetworkManager</span><br><span class="line">[root@openstack ~]<span class="comment"># systemctl stop firewalld &amp;&amp;  systemctl disable firewalld</span></span><br><span class="line">[root@openstack ~]<span class="comment"># systemctl stop NetworkManager &amp;&amp; systemctl disable NetworkManager</span></span><br><span class="line">3)、关闭selinux </span><br><span class="line">[root@openstack ~]<span class="comment"># vim /etc/selinux/config SELINUX=disabled </span></span><br><span class="line">[root@openstack ~]<span class="comment"># setenforce 0 </span></span><br><span class="line">[root@openstack ~]<span class="comment"># getenforce Permissive </span></span><br><span class="line">4)、 添加软件源和repo源，这里我添加的是阿里云的源，你也可以用其他的</span><br><span class="line">[root@openstack ~]<span class="comment"># yum install -y net-tools wget</span></span><br><span class="line">[root@openstack ~]<span class="comment">#curl -o /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo </span></span><br><span class="line">[root@openstack ~]<span class="comment">#curl -o /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo </span></span><br><span class="line">[root@openstack ~]<span class="comment">#cat &gt; /etc/yum.repos.d/openstack-train.repo &lt;&lt; EOF	 </span></span><br><span class="line">[train]</span><br><span class="line">name=openstack train</span><br><span class="line">baseurl=https://mirrors.aliyun.com/centos/7/cloud/x86_64/openstack-train/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br><span class="line">yum clean all &amp;&amp; yum makecache</span><br></pre></td></tr></table></figure>

<p>centos7.8回退leatherman版本</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">yum downgrade leatherman</span></span><br></pre></td></tr></table></figure>

<p>2、安装pakcstack</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@openstack ~]<span class="comment"># yum install -y openstack-packstack python-pip centos-release-openstack-train</span></span><br><span class="line">在家目录下生成answer文件</span><br><span class="line">[root@openstack ~]<span class="comment"># packstack --gen-answer-file=answer-file-fbo.conf</span></span><br><span class="line">[root@openstack ~]<span class="comment"># packstack --answer-file=./answer-file-fbo.conf</span></span><br><span class="line"></span><br><span class="line">或者 packstack --allinone</span><br></pre></td></tr></table></figure>

<h1 id="Ceph管理与监控"><a href="#Ceph管理与监控" class="headerlink" title="Ceph管理与监控"></a>Ceph管理与监控</h1><h2 id="Dashboard安装"><a href="#Dashboard安装" class="headerlink" title="Dashboard安装"></a>Dashboard安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ yum install ceph-mgr-dashboard</span><br><span class="line"><span class="comment">#在正在运行的Ceph集群中，可以通过以下方式启用Ceph仪表板：</span></span><br><span class="line">$ ceph mgr module <span class="built_in">enable</span> dashboard <span class="comment">#无法开启</span></span><br><span class="line">$ ceph mgr module <span class="built_in">ls</span></span><br><span class="line">$ ceph mgr module <span class="built_in">enable</span> dashboard --force <span class="comment">#强制开启</span></span><br></pre></td></tr></table></figure>

<h3 id="SSL-x2F-TLS支持"><a href="#SSL-x2F-TLS支持" class="headerlink" title="SSL &#x2F; TLS支持"></a>SSL &#x2F; TLS支持</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph dashboard <span class="built_in">create</span>-<span class="built_in">self</span>-signed-cert</span><br></pre></td></tr></table></figure>

<p>仪表板绑定到TCP &#x2F; IP地址和TCP端口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph config <span class="built_in">set</span> mgr mgr/dashboard/server_addr 10.211.55.201</span><br><span class="line">ceph config <span class="built_in">set</span> mgr mgr/dashboard/server_port 8080</span><br><span class="line">ceph config <span class="built_in">set</span> mgr mgr/dashboard/ssl_server_port 8443</span><br><span class="line">ceph mgr servicesdashboard</span><br><span class="line"><span class="comment">#创建用户</span></span><br><span class="line">ceph dashboard ac-user-create admin admin123 administrator</span><br></pre></td></tr></table></figure>

<h2 id="启用Prometheus模块"><a href="#启用Prometheus模块" class="headerlink" title="启用Prometheus模块"></a>启用Prometheus模块</h2>
      </div>
      
      
      
    </div>

    
    


</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">屈辉</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.6m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">23:55</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
