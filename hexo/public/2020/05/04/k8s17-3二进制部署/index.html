<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"horus-k.github.io","root":"/","scheme":"Mist","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="K8s简介 Kubernetes（简称k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能。，努力成为跨主机集群的自动部署、扩展以及运行应用程序容器的平台。 它支持一系列容器工具">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s17.3二进制部署">
<meta property="og:url" content="https://horus-k.github.io/2020/05/04/k8s17-3%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/index.html">
<meta property="og:site_name" content="Q&#39;s blog">
<meta property="og:description" content="K8s简介 Kubernetes（简称k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能。，努力成为跨主机集群的自动部署、扩展以及运行应用程序容器的平台。 它支持一系列容器工具">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-04T02:39:35.000Z">
<meta property="article:modified_time" content="2020-05-11T05:27:20.251Z">
<meta property="article:author" content="屈辉">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://horus-k.github.io/2020/05/04/k8s17-3%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>k8s17.3二进制部署 | Q's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Q's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一些个人文档笔记</p>
  </div>

  <div class="site-nav-right"></div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">84</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">27</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">177</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Horus-K" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://horus-k.github.io/2020/05/04/k8s17-3%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="屈辉">
      <meta itemprop="description" content="开心就好">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Q's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s17.3二进制部署
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-04 10:39:35" itemprop="dateCreated datePublished" datetime="2020-05-04T10:39:35+08:00">2020-05-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-11 13:27:20" itemprop="dateModified" datetime="2020-05-11T13:27:20+08:00">2020-05-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>K8s简介</p>
<p>Kubernetes（简称k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能。，努力成为跨主机集群的自动部署、扩展以及运行应用程序容器的平台。 它支持一系列容器工具, 包括Docker等。</p>
<p># kubernetes</p>
<a id="more"></a>

<h1 id="注意-本文所有操作均在所有节点执行"><a href="#注意-本文所有操作均在所有节点执行" class="headerlink" title="注意 本文所有操作均在所有节点执行"></a>注意 本文所有操作均在所有节点执行</h1><p>本文环境</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">配置</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Kubernetes版本</td>
<td align="center">v1.17.3</td>
</tr>
<tr>
<td align="center">Cluster Pod CIDR</td>
<td align="center">10.244.0.0/16</td>
</tr>
<tr>
<td align="center">Cluster Service CIDR</td>
<td align="center">10.250.0.0/24</td>
</tr>
<tr>
<td align="center">kubernetes service</td>
<td align="center">10.250.0.1</td>
</tr>
<tr>
<td align="center">dns service</td>
<td align="center">10.250.0.10</td>
</tr>
</tbody></table>
<p>本文档主要介绍在裸机环境下以二进制的方式安装部署kubernetes</p>
<p>本次文档主要是对于kubernetes 1.17.3版本</p>
<p>内容主要有环境准备安装配置docker 升级内核 调整系统参数</p>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">IP</th>
<th align="center">组件</th>
<th align="center">配置</th>
</tr>
</thead>
<tbody><tr>
<td align="center">k8s-master1</td>
<td align="center">192.168.220.101</td>
<td align="center">apiserver、controller-manager、schedule、docker-ce</td>
<td align="center">2核 4G</td>
</tr>
<tr>
<td align="center">k8s-master2</td>
<td align="center">192.168.220.102</td>
<td align="center">apiserver、controller-manager、schedule、docker-ce</td>
<td align="center">2核 4G</td>
</tr>
<tr>
<td align="center">k8s-node1</td>
<td align="center">192.168.220.103</td>
<td align="center">kube-proxy、kubelet、docker-ce,etcd</td>
<td align="center">2核 4G</td>
</tr>
<tr>
<td align="center">k8s-node1</td>
<td align="center">192.168.220.104</td>
<td align="center">kube-proxy、kubelet、docker-ce,etcd</td>
<td align="center">2核 4G</td>
</tr>
<tr>
<td align="center">k8s-node1</td>
<td align="center">192.168.220.105</td>
<td align="center">kube-proxy、kubelet、docker-ce,etcd</td>
<td align="center">2核 4G</td>
</tr>
</tbody></table>
<p>以下操作除非具体说明的步骤 其他的均在所有节点执行</p>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a><strong><em>环境变量</em></strong></h3><p>此环境变量为主节点（控制节点）的主机名和IP地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> VIP=192.168.220.100</span><br><span class="line"><span class="built_in">export</span> MASTER1_HOSTNAME=k8s-master1</span><br><span class="line"><span class="built_in">export</span> MASTER1_IP=192.168.220.101</span><br><span class="line"><span class="built_in">export</span> MASTER2_HOSTNAME=k8s-master2</span><br><span class="line"><span class="built_in">export</span> MASTER2_IP=192.168.220.102</span><br><span class="line"><span class="built_in">export</span> NODE1_HOSTNAME=k8s-node1</span><br><span class="line"><span class="built_in">export</span> NODE1_IP=192.168.220.103</span><br><span class="line"><span class="built_in">export</span> NODE1_HOSTNAME=k8s-node2</span><br><span class="line"><span class="built_in">export</span> NODE1_IP=192.168.220.104</span><br><span class="line"><span class="built_in">export</span> NODE1_HOSTNAME=k8s-node3</span><br><span class="line"><span class="built_in">export</span> NODE1_IP=192.168.220.105</span><br></pre></td></tr></table></figure>

<h3 id="SSH免密-时间同步-主机名修改"><a href="#SSH免密-时间同步-主机名修改" class="headerlink" title="SSH免密/时间同步/主机名修改"></a><strong><em>SSH免密/时间同步/主机名修改</em></strong></h3><p>· SSH免密</p>
<p>· NTP时间同步</p>
<p>· 主机名修改</p>
<p>· 环境变量生成</p>
<p>· Host 解析</p>
<p>这里需要说一下，所有的密钥分发以及后期拷贝等都在master1上操作，因为master1做免密了</p>
<p>k8s集群所有的机器都需要进行host解析</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line"><span class="number">192.168.220.101</span> k8s-master1</span><br><span class="line"><span class="number">192.168.220.102</span> k8s-master2</span><br><span class="line"><span class="number">192.168.220.103</span> k8s-node1</span><br><span class="line"><span class="number">192.168.220.104</span> k8s-node2</span><br><span class="line"><span class="number">192.168.220.105</span> k8s-node3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>批量免密</p>
<p># 做免密前请修改好主机名对应的host</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum -y install expect</span><br><span class="line">ssh-keygen -t rsa -P <span class="string">""</span> -f /root/.ssh/id_rsa</span><br><span class="line">for i in <span class="number">192.168</span><span class="number">.220</span><span class="number">.101</span> <span class="number">192.168</span><span class="number">.220</span><span class="number">.102</span> <span class="number">192.168</span><span class="number">.220</span><span class="number">.103</span> <span class="number">192.168</span><span class="number">.220</span><span class="number">.104</span> <span class="number">192.168</span><span class="number">.220</span><span class="number">.105</span>;do</span><br><span class="line">expect -c <span class="string">"</span></span><br><span class="line"><span class="string">spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@$i</span></span><br><span class="line"><span class="string">    expect &#123;</span></span><br><span class="line"><span class="string">        <span class="subst">\"</span>*yes/no*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>yes\r<span class="subst">\"</span>; exp_continue&#125;</span></span><br><span class="line"><span class="string">        <span class="subst">\"</span>*password*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>quhuixx\r<span class="subst">\"</span>; exp_continue&#125;</span></span><br><span class="line"><span class="string">        <span class="subst">\"</span>*Password*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>quhuixx\r<span class="subst">\"</span>;&#125;</span></span><br><span class="line"><span class="string">    &#125; "</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>切记所有机器需要自行设定ntp,否则不只HA下apiserver通信有问题,各种千奇百怪的问题。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntp</span><br><span class="line">systemctl <span class="builtin-name">enable</span> ntpd</span><br><span class="line">systemctl start ntpd</span><br><span class="line">ntpdate -u time1.aliyun.com</span><br><span class="line">hwclock --systohc</span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure>

<p>测试通信</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span>  k8s-master1 k8s-master2 k8s-node1 k8s-node2 k8s-node3; <span class="keyword">do</span> ssh root@<span class="variable">$i</span> <span class="string">"hostname"</span>;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="升级内核"><a href="#升级内核" class="headerlink" title="升级内核"></a>升级内核</h3><p>安装内核语言编译器（内核是用perl语言编写的）</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> perl</span><br></pre></td></tr></table></figure>

<p>下载密钥和yum源</p>
<p>导入密钥</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --<span class="keyword">import</span> <span class="string">https:</span><span class="comment">//www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br></pre></td></tr></table></figure>

<p>安装7版本的yum源文件</p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -<span class="symbol">y</span> install https:<span class="comment">//www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span></span><br></pre></td></tr></table></figure>

<p>安装 ml版本 5版本的内核名字叫ml</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum  --enablerepo=<span class="string">"elrepo-kernel"</span>  -y <span class="keyword">install</span> kernel-ml.x86_64</span><br></pre></td></tr></table></figure>

<p>附：4.4版本内核安装方法</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum   --enablerepo=<span class="string">"elrepo-kernel"</span> -y <span class="keyword">install</span> kernel-lt.x86_64</span><br></pre></td></tr></table></figure>

<p>然后配置从新的内核启动</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-<span class="keyword">set</span>-<span class="keyword">default</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>然后重新生成grub2.cfg 使虚拟机使用新内核启动</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-mkconfig -o <span class="regexp">/boot/g</span>rub2<span class="regexp">/grub.cfg</span></span><br></pre></td></tr></table></figure>

<h3 id="调整系统内核参数"><a href="#调整系统内核参数" class="headerlink" title="调整系统内核参数"></a>调整系统内核参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>然后执行sysctl -p 使配置的内核响应参数生效</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sysctl -p</span></span><br></pre></td></tr></table></figure>

<h3 id="关闭防火墙、selinux、swap、NetworkManager"><a href="#关闭防火墙、selinux、swap、NetworkManager" class="headerlink" title="关闭防火墙、selinux、swap、NetworkManager"></a>关闭防火墙、selinux、swap、NetworkManager</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span><br><span class="line">systemctl stop NetworkManager</span><br><span class="line">systemctl disable NetworkManager</span><br></pre></td></tr></table></figure>

<h3 id="修改资源限制"><a href="#修改资源限制" class="headerlink" title="修改资源限制"></a>修改资源限制</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo "* soft nofile 65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo "* hard nofile 65536" &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo "* soft nproc 65536"  &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo "* hard nproc 65536"  &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo "* soft memlock unlimited"  &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo "* hard memlock unlimited"  &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<h3 id="常用软件安装"><a href="#常用软件安装" class="headerlink" title="常用软件安装"></a>常用软件安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bridge-utils chrony ipvsadm ipset sysstat conntrack libseccomp wget tcpdump screen vim nfs-utils bind-utils wget socat telnet sshpass net-tools sysstat lrzsz yum-utils device-mapper-persistent-data lvm2 tree nc lsof strace nmon iptraf iftop rpcbind mlocate ipvsadm</span><br></pre></td></tr></table></figure>

<h3 id="加载内核ipvs模块"><a href="#加载内核ipvs模块" class="headerlink" title="加载内核ipvs模块"></a>加载内核ipvs模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>

<h3 id="安装docker-ce："><a href="#安装docker-ce：" class="headerlink" title="安装docker-ce："></a>安装docker-ce：</h3><p>添加yun源</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/yum.repos.d/docker-ce.repo &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">[aliyun-docker-ce]</span><br><span class="line"><span class="attribute">name</span>=aliyun-docker-ce</span><br><span class="line"><span class="attribute">baseurl</span>=https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/</span><br><span class="line"><span class="attribute">enable</span>=1</span><br><span class="line"><span class="attribute">gpgcheck</span>=1</span><br><span class="line"><span class="attribute">gpgkey</span>=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>安装docker-ce</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> docker-ce</span><br></pre></td></tr></table></figure>

<p>重启docker并设置为开机自启</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">restart docker</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">enable docker</span></span><br></pre></td></tr></table></figure>

<h3 id="然后重启系统-验证内核是否升级成功"><a href="#然后重启系统-验证内核是否升级成功" class="headerlink" title="然后重启系统 验证内核是否升级成功"></a>然后重启系统 验证内核是否升级成功</h3><h1 id="下载命令"><a href="#下载命令" class="headerlink" title="下载命令"></a>下载命令</h1><h3 id="下载cfssl以及cfssljson命令"><a href="#下载cfssl以及cfssljson命令" class="headerlink" title="下载cfssl以及cfssljson命令"></a>下载cfssl以及cfssljson命令</h3><p>此举目的是下载创建证书以及配置文件需要的命令</p>
<p><strong>PKI基础概念</strong></p>
<p><strong>什么是PKI？</strong></p>
<p>公开密钥基础建设（英语：Public Key Infrastructure，缩写：PKI），又称公开密钥基础架构、公钥基础建设、公钥基础设施、公开密码匙基础建设或公钥基础架构，是一组由硬件、软件、参与者、管理政策与流程组成的基础架构，其目的在于创造、管理、分配、使用、存储以及撤销数字证书。（节选维基百科）</p>
<p>PKI是借助CA（权威数字证书颁发/认证机构）将用户的个人身份跟公开密钥链接在一起，它能够确保每个用户身份的唯一性，这种链接关系是通过注册和发布过程实现，并且根据担保级别，链接关系可能由CA和各种软件或在人为监督下完成。PKI用来确定链接关系的这一角色称为RA（Registration Authority, 注册管理中心），RA能够确保公开密钥和个人身份链接，可以防抵赖，防篡改。在微软的公钥基础建设下，RA又被称为CA，目前大多数称为CA。</p>
<p><strong>PKI组成要素</strong></p>
<p>从上面可以得知PKI的几个主要组成要素，用户（使用PKI的人或机构），认证机构（CA，颁发证书的人或机构），仓库（保存证书的数据库）等。</p>
<p><strong>非对称加密</strong></p>
<p>本文提到的密钥均为非对称加密，有公钥和私钥之分，并且他们总是成对出现，它们的特点就是其中一个加密的数据，只能使用另一个解密，即使它本身也无法解密，也就是说公钥加密的，私钥可以解密，私钥加密的，公钥可以解密。</p>
<p><strong>证书签名请求CSR</strong></p>
<p>它是向CA机构申请数字证书时使用的请求文件，这里的CSR不是证书，而向权威证书颁发机构获得签名证书的申请，当CA机构颁发的证书过期时，你可以使用相同的CSR来申请新的证书，此时key不变。</p>
<p><strong>数字签名</strong></p>
<p>数字签名就是“非对称加密+摘要算法”，其目的不是为了加密，而是为了防抵赖或者他们篡改数据。其核心思想是：比如A要给B发送数据，A先用摘要算法得到数据的指纹，然后用A的私钥加密指纹，加密后的指纹就是A的签名，B收到数据和A的签名后，也用同样的摘要算法计算指纹，然后用A公开的公钥解密签名，比较两个指纹，如果相同，说明数据没有被篡改，确实是A发过来的数据。假设C想改A发给B的数据来欺骗B，因为篡改数据后指纹会变，要想跟A的签名里面的指纹一致，就得改签名，但由于没有A的私钥，所以改不了，如果C用自己的私钥生成一个新的签名，B收到数据后用A的公钥根本就解不开。(来源于网络)</p>
<p><strong>数字证书格式</strong></p>
<p>数字证书格式有很多，比如.pem，.cer或者.crt等。</p>
<p><strong>PKI工作流程</strong></p>
<p>下图来源于网络，上半部分最右边就是CA机构，可以颁发证书。证书订阅人，首先去申请一个证书，为了申请这个证书，需要去登记，告诉它，我是谁，我属于哪个组织，到了登记机构，再通过CSR，发送给CA中心，CA中心通过验证通过之后 ，会颁发一对公钥和私钥，并且公钥会在CA中心存一份；证书订阅人拿到证书以后，部署在服务器；</p>
<p>当用户访问我们的web服务器时，它会请求我们的证书，服务器会把公钥发送给我们的客户端，客户端会去验证我们证书的合法性，客户端是如何验证证书是否有效呢？CA中心会把过期证书放在CRL服务器上面 ，这个CRL服务会把所有过期的证书形成一条链条，所以他的性能非常的差，所以又推出了OCSP程序，OCSP可以就一个证书进行查询，它是否过期，浏览器可以直接去查询OCSP响应程序，但OCSP响应程序效率还不是很高，最终往往我们会把web服务器如nginx有一个ocsp开关，当我们打开这个开关以后，会有nginx服务器主动的去ocsp服务器去查询，这样大量的客户端直接从web服务器就可以直接获取到证书是否有效。</p>
<p><strong>CFSSL介绍</strong></p>
<p><strong>CFSSL是什么？</strong></p>
<p>cfssl是使用go编写，由CloudFlare开源的一款PKI/TLS工具。主要程序有cfssl，是CFSSL的命令行工具，cfssljson用来从cfssl程序获取JSON输出，并将证书，密钥，CSR和bundle写入文件中。</p>
<h3 id="安装CFSSL"><a href="#安装CFSSL" class="headerlink" title="安装CFSSL"></a>安装CFSSL</h3><p>可能下载时间较长</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">https:</span><span class="comment">//pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line">wget <span class="string">https:</span><span class="comment">//pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line">wget <span class="string">https:</span><span class="comment">//pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>cfssl</span><br><span class="line">mv cfssljson_linux-amd64 <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 <span class="regexp">/usr/</span>bin/cfssl-certinfo</span><br><span class="line">cfssl version</span><br></pre></td></tr></table></figure>

<p>版本应该是1.2.0及以上版本</p>
<p>显示信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Version:</span> <span class="number">1.2</span><span class="number">.0</span></span><br><span class="line"><span class="attr">Revision:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">Runtime:</span> <span class="string">go1.6</span></span><br></pre></td></tr></table></figure>

<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><h3 id="注意-本文所有操作均在master1节点执行"><a href="#注意-本文所有操作均在master1节点执行" class="headerlink" title="注意 本文所有操作均在master1节点执行"></a>注意 本文所有操作均在master1节点执行</h3><p>主要内容为生成kubernetes集群所需要的各种证书</p>
<p>主要有两个部分 生成etcd的证书 和生成kubernetes组件的证书</p>
<h2 id="生成etcd证书"><a href="#生成etcd证书" class="headerlink" title="生成etcd证书"></a>生成etcd证书</h2><p>1 创建生成证书和临时存放证书的目录</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /root/ssl/&#123;etcd,kubernetes&#125; -p</span><br></pre></td></tr></table></figure>

<p>进入etcd目录</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/root/</span>ssl<span class="regexp">/etcd/</span></span><br></pre></td></tr></table></figure>

<p>2 创建用来生成CA文件的JSON配置文件</p>
<p>此CA文件只用与etcd的证书</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> &lt;&lt; EOF | tee <span class="keyword">ca</span>-config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"876000h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"etcd"</span>: &#123;</span><br><span class="line">         <span class="string">"expiry"</span>: <span class="string">"876000h"</span>,</span><br><span class="line">         <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>server auth 表示client可以对使用该ca对server提供的证书进行验证</p>
<p>client auth 表示server可以使用该ca对client提供的证书进行验证</p>
<p>3 创建用来生成CA证书签名请求（CSR）的JSON配置文件</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> &lt;&lt; EOF | tee <span class="keyword">ca</span>-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd CA"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>4 生成CA证书和私钥</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca <span class="keyword">ca</span>-csr.json | cfssljson -bare <span class="keyword">ca</span></span><br></pre></td></tr></table></figure>

<p>输出内容</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">14</span> [INFO] generating a new CA key <span class="keyword">and</span> certificate <span class="keyword">from</span> CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">14</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">14</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">14</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">14</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">35</span>:<span class="number">14</span> [INFO] signed certificate with serial number <span class="number">76399392328271693420688681207409409662642174207</span></span><br></pre></td></tr></table></figure>

<p>查看生成的CA证书和私钥</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> ca*<span class="string">.pem</span></span><br></pre></td></tr></table></figure>

<p>输出内容</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ca-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">ca</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<p>5 创建etcd证书请求</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; <span class="symbol">EOF</span> | tee etcd-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"200.200.100.71"</span>,</span><br><span class="line">      <span class="string">"200.200.100.72"</span>,</span><br><span class="line">      <span class="string">"200.200.100.73"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">EOF</span></span><br></pre></td></tr></table></figure>

<p>6 生成etcd证书和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=etcd etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure>

<p>输出内容</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">39</span>:<span class="number">16</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">39</span>:<span class="number">16</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">39</span>:<span class="number">16</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">39</span>:<span class="number">17</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">39</span>:<span class="number">17</span> [INFO] signed certificate with serial number <span class="number">276878925110307603699002043209122885766807800060</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">39</span>:<span class="number">17</span> [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance <span class="keyword">and</span> Management</span><br><span class="line">of Publicly-Trusted Certificates, v<span class="number">.1</span><span class="number">.1</span><span class="number">.6</span>, <span class="keyword">from</span> the CA/Browser Forum (https:<span class="comment">//cabforum.org);</span></span><br><span class="line">specifically, section <span class="number">10.2</span><span class="number">.3</span> (<span class="string">"Information Requirements"</span>).</span><br></pre></td></tr></table></figure>

<p>7 查看生成的所有etcd证书</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> | <span class="keyword">grep</span> pem</span><br></pre></td></tr></table></figure>

<p>输出的4个文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ca-key</span><span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">ca</span><span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">etcd-key</span><span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">etcd</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<h2 id="生成kubernetes组件证书"><a href="#生成kubernetes组件证书" class="headerlink" title="生成kubernetes组件证书"></a>生成kubernetes组件证书</h2><p>切换到kubernetes组件证书申请和存放目录</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/root/</span>ssl<span class="regexp">/kubernetes/</span></span><br></pre></td></tr></table></figure>

<h3 id="新建CA配置文件"><a href="#新建CA配置文件" class="headerlink" title="新建CA配置文件"></a>新建CA配置文件</h3><p>用于kubernetes集群的组件和admin角色</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-<span class="built_in">config</span>.<span class="keyword">json </span>&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"8760h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">         <span class="string">"expiry"</span>: <span class="string">"8760h"</span>,</span><br><span class="line">         <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>新建CA凭证签发请求文件</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt;<span class="symbol">EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"200.200.100.71"</span>,</span><br><span class="line">    <span class="string">"200.200.100.72"</span>,</span><br><span class="line">    <span class="string">"200.200.100.73"</span>,</span><br><span class="line">    <span class="string">"200.200.100.70"</span></span><br><span class="line"> ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">EOF</span></span><br></pre></td></tr></table></figure>

<p>生成CA凭证和私钥</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca <span class="keyword">ca</span>-csr.json | cfssljson -bare <span class="keyword">ca</span></span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">56</span>:<span class="number">26</span> [INFO] generating a new CA key <span class="keyword">and</span> certificate <span class="keyword">from</span> CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">56</span>:<span class="number">26</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">56</span>:<span class="number">26</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">56</span>:<span class="number">26</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">56</span>:<span class="number">26</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">56</span>:<span class="number">26</span> [INFO] signed certificate with serial number <span class="number">679742542757179200541008226092035525850208663173</span></span><br></pre></td></tr></table></figure>

<p>查看创建的证书和私钥</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> ca*<span class="string">.pem</span></span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ca-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">ca</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<h3 id="client与server凭证"><a href="#client与server凭证" class="headerlink" title="client与server凭证"></a>client与server凭证</h3><p>创建admin client 凭证签发请求文件</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; <span class="keyword">admin</span>-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "admin",</span><br><span class="line">  "hosts": [],</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "China",</span><br><span class="line">      "L": "Beijing",</span><br><span class="line">      "O": "system:masters",</span><br><span class="line">      "OU": "Kubernetes",</span><br><span class="line">      "ST": "Beijing"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>创建admin client 凭证和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line">  admin-csr.json | cfssljson -bare admin</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">38</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">38</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">38</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">38</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">38</span> [INFO] signed certificate with serial number <span class="number">514625224786356937263551808946632861542829130401</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">38</span> [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance <span class="keyword">and</span> Management</span><br><span class="line">of Publicly-Trusted Certificates, v<span class="number">.1</span><span class="number">.1</span><span class="number">.6</span>, <span class="keyword">from</span> the CA/Browser Forum (https:<span class="comment">//cabforum.org);</span></span><br><span class="line">specifically, section <span class="number">10.2</span><span class="number">.3</span> (<span class="string">"Information Requirements"</span>).</span><br></pre></td></tr></table></figure>

<p>查看生成的文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">admin</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">admin-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">admin</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<h3 id="生成kubelet客户端凭证"><a href="#生成kubelet客户端凭证" class="headerlink" title="生成kubelet客户端凭证"></a>生成kubelet客户端凭证</h3><p>kubernetes使用special-purpose authorization mode(被称作 Node Authorizer) 授权来自kubelet的API请求</p>
<p>为了通过Node Authorizer的授权，kubelet 必须使用一个署名为system:node:的凭证来证明它属于system:nodes用户组。</p>
<p>本节将会给每台节点（包括master节点）创建凭证和私钥</p>
<p>创建master1节点的凭证签发请求文件</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF <span class="string">| tee k8s-master1-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:node:$&#123;MASTER1_HOSTNAME&#125;"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:nodes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成master节点的证书和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-hostname</span>=<span class="variable">$&#123;MASTER1_HOSTNAME&#125;</span>,$&#123;MASTER1_IP&#125; \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line"> k8s-master1-csr.json | cfssljson -bare k8s-master1</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] signed certificate with serial number <span class="number">340503546795644080420594727795505971193705840974</span></span><br></pre></td></tr></table></figure>

<p>输出的文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">k8s-master</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">k8s-master1-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">k8s-master1</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<p>创建master2节点的凭证签发请求文件</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF <span class="string">| tee k8s-master2-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:node:$&#123;MASTER2_HOSTNAME&#125;"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:nodes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成master2节点的证书和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-hostname</span>=<span class="variable">$&#123;MASTER2_HOSTNAME&#125;</span>,$&#123;MASTER2_IP&#125; \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line"> k8s-master2-csr.json | cfssljson -bare k8s-master2</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">08</span>:<span class="number">33</span> [INFO] signed certificate with serial number <span class="number">340503546795644080420594727795505971193705840974</span></span><br></pre></td></tr></table></figure>

<p>输出的文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">k8s-master</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">k8s-master1-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">k8s-master1</span><span class="selector-class">.pem</span> <span class="selector-tag">k8s-master2-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">k8s-master2</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<p>创建master3节点的凭证签发请求文件</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF <span class="string">| tee k8s-master3-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:node:$&#123;MASTER3_HOSTNAME&#125;"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:nodes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成k8s-node节点的证书和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-hostname</span>=<span class="variable">$&#123;MASTER3_HOSTNAME&#125;</span>,$&#123;MASTER3_IP&#125; \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line">  k8s-master3-csr.json | cfssljson -bare k8s-master3</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">11</span>:<span class="number">22</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">11</span>:<span class="number">22</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">11</span>:<span class="number">22</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">11</span>:<span class="number">22</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">11</span>:<span class="number">22</span> [INFO] signed certificate with serial number <span class="number">329201759031912279536498320815194792351902510021</span></span><br></pre></td></tr></table></figure>

<p>输出的文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">k8s-master3</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">k8s-master3-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">k8s-master3</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<p>创建k8s-node1节点的凭证签发请求文件</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF <span class="string">| tee k8s-node1-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:node:$&#123;NODE1_HOSTNAME&#125;"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:nodes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成k8s-node1节点的证书和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-hostname</span>=<span class="variable">$&#123;NODE1_HOSTNAME&#125;</span>,$&#123;NODE1_IP&#125; \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line">  k8s-node1-csr.json | cfssljson -bare k8s-node1</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">16</span>:<span class="number">27</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">16</span>:<span class="number">27</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">16</span>:<span class="number">27</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">16</span>:<span class="number">27</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">16</span>:<span class="number">27</span> [INFO] signed certificate with serial number <span class="number">11529605845303364851563251013549393798169113866</span></span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">k8s-node1</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">k8s-node1-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">k8s-node1</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<p>8 创建master组件需要的证书</p>
<h3 id="创建kube-controller-manager客户端凭证"><a href="#创建kube-controller-manager客户端凭证" class="headerlink" title="创建kube-controller-manager客户端凭证"></a>创建kube-controller-manager客户端凭证</h3><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成证书和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line">  kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">29</span>:<span class="number">06</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">29</span>:<span class="number">06</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">29</span>:<span class="number">06</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">29</span>:<span class="number">06</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">29</span>:<span class="number">06</span> [INFO] signed certificate with serial number <span class="number">173346030426505912970345315612511532042452194730</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">29</span>:<span class="number">06</span> [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance <span class="keyword">and</span> Management</span><br><span class="line">of Publicly-Trusted Certificates, v<span class="number">.1</span><span class="number">.1</span><span class="number">.6</span>, <span class="keyword">from</span> the CA/Browser Forum (https:<span class="comment">//cabforum.org);</span></span><br><span class="line">specifically, section <span class="number">10.2</span><span class="number">.3</span> (<span class="string">"Information Requirements"</span>).</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">kube-con</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">kube-controller-manager-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">kube-controller-manager</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<h3 id="创建kube-proxy客户端凭证"><a href="#创建kube-proxy客户端凭证" class="headerlink" title="创建kube-proxy客户端凭证"></a>创建kube-proxy客户端凭证</h3><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;<span class="symbol">EOF</span> |tee kube-proxy-csr.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:node-proxier"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">EOF</span></span><br></pre></td></tr></table></figure>

<p>生成证书和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line">  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">31</span>:<span class="number">11</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">31</span>:<span class="number">11</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">31</span>:<span class="number">11</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">31</span>:<span class="number">11</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">31</span>:<span class="number">11</span> [INFO] signed certificate with serial number <span class="number">3973180903081703880688638425637585151040946194</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">31</span>:<span class="number">11</span> [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance <span class="keyword">and</span> Management</span><br><span class="line">of Publicly-Trusted Certificates, v<span class="number">.1</span><span class="number">.1</span><span class="number">.6</span>, <span class="keyword">from</span> the CA/Browser Forum (https:<span class="comment">//cabforum.org);</span></span><br><span class="line">specifically, section <span class="number">10.2</span><span class="number">.3</span> (<span class="string">"Information Requirements"</span>).</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">kube-proxy</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">kube-proxy-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">kube-proxy</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<h3 id="创建kube-scheduler凭证签发"><a href="#创建kube-scheduler凭证签发" class="headerlink" title="创建kube-scheduler凭证签发"></a>创建kube-scheduler凭证签发</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF <span class="string">| tee kube-scheduler-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成证书</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line">  kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">18</span>:<span class="number">57</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">18</span>:<span class="number">57</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">18</span>:<span class="number">57</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">18</span>:<span class="number">57</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">18</span>:<span class="number">57</span> [INFO] signed certificate with serial number <span class="number">56094122509645103760584094055826646549201635795</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">18</span>:<span class="number">57</span> [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance <span class="keyword">and</span> Management</span><br><span class="line">of Publicly-Trusted Certificates, v<span class="number">.1</span><span class="number">.1</span><span class="number">.6</span>, <span class="keyword">from</span> the CA/Browser Forum (https:<span class="comment">//cabforum.org);</span></span><br><span class="line">specifically, section <span class="number">10.2</span><span class="number">.3</span> (<span class="string">"Information Requirements"</span>).</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">kube-sch</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">kube-scheduler-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">kube-scheduler</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<h3 id="创建kubernetes-证书"><a href="#创建kubernetes-证书" class="headerlink" title="创建kubernetes 证书"></a>创建kubernetes 证书</h3><p>为了保证客户端与kubernetes API的认证，kubernetes API Server 凭证中必须包含master的静态IP地址</p>
<p>此IP地址使用上面配置的环境变量</p>
<p>创建kubernetes API Server 凭证签发请求文件</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;<span class="symbol">EOF</span> | tee kubernetes-csr.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">   <span class="string">"127.0.0.1"</span>,</span><br><span class="line">   <span class="string">"200.200.100.71"</span>,</span><br><span class="line">   <span class="string">"200.200.100.72"</span>,</span><br><span class="line">   <span class="string">"200.200.100.73"</span>,</span><br><span class="line">   <span class="string">"200.200.100.70"</span>,</span><br><span class="line">   <span class="string">"10.250.0.1"</span>,</span><br><span class="line">   <span class="string">"kubernetes"</span>,</span><br><span class="line">   <span class="string">"kubernetes.default"</span>,</span><br><span class="line">   <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">   <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">   <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">EOF</span></span><br></pre></td></tr></table></figure>

<p>生成kubernetes API Server 凭证与私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line">  kubernetes-csr.json | cfssljson -bare kubernetes</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">03</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">03</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">03</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">03</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">03</span> [INFO] signed certificate with serial number <span class="number">319608271292119912072742471756939391576493389087</span></span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">kubernetes</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">kubernetes-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">kubernetes</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<p>Service Account 证书</p>
<p>创建凭证签发问</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; <span class="class"><span class="keyword">service</span>-<span class="title">account</span>-csr.json &lt;&lt;EOF</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"service-accounts"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"China"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成证书和私钥</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes \</span><br><span class="line">  service-account-csr.json | cfssljson -bare service-account</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">25</span>:<span class="number">31</span> [INFO] generate received request</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">25</span>:<span class="number">31</span> [INFO] received CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">25</span>:<span class="number">31</span> [INFO] generating key: rsa<span class="number">-2048</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">25</span>:<span class="number">31</span> [INFO] encoded CSR</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">25</span>:<span class="number">31</span> [INFO] signed certificate with serial number <span class="number">538955391110960009078645942634491132767864895292</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">12</span> <span class="number">20</span>:<span class="number">25</span>:<span class="number">31</span> [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance <span class="keyword">and</span> Management</span><br><span class="line">of Publicly-Trusted Certificates, v<span class="number">.1</span><span class="number">.1</span><span class="number">.6</span>, <span class="keyword">from</span> the CA/Browser Forum (https:<span class="comment">//cabforum.org);</span></span><br><span class="line">specifically, section <span class="number">10.2</span><span class="number">.3</span> (<span class="string">"Information Requirements"</span>).</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">service</span>*<span class="selector-class">.pem</span></span><br><span class="line"><span class="selector-tag">service-account-key</span><span class="selector-class">.pem</span>  <span class="selector-tag">service-account</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure>

<p>9 拷贝etcd证书到相应节点的相应目录</p>
<p>创建etcd目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3;<span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"---<span class="variable">$host</span>---"</span></span><br><span class="line">  ssh root@<span class="variable">$host</span> <span class="string">"mkdir /usr/local/etcd/&#123;bin,ssl,data,json,src&#125; -p"</span>; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>拷贝etcd证书</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd ..<span class="regexp">/etcd/</span></span><br><span class="line">拷贝方法一；</span><br><span class="line">scp etcd-key.pem etcd.pem ca.pem ca-key.pem k8s-<span class="string">master1:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>ssl/</span><br><span class="line">scp etcd-key.pem etcd.pem ca.pem ca-key.pem k8s-<span class="string">master2:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>ssl/</span><br><span class="line">scp etcd-key.pem etcd.pem ca.pem ca-key.pem k8s-<span class="string">master3:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>ssl/</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">拷贝方法二；</span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; \</span><br><span class="line">     do     </span><br><span class="line">    echo <span class="string">"--- $host---"</span></span><br><span class="line">    scp -r *.pem <span class="string">$host:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>ssl/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="配置和生成kubernetes配置文件"><a href="#配置和生成kubernetes配置文件" class="headerlink" title="配置和生成kubernetes配置文件"></a>配置和生成kubernetes配置文件</h1><p>本文档是kubernetes1.17.3二进制安装的第四篇</p>
<h3 id="注意-本文所有操作均在master节点执行"><a href="#注意-本文所有操作均在master节点执行" class="headerlink" title="注意 本文所有操作均在master节点执行"></a>注意 本文所有操作均在master节点执行</h3><p>本文将主要介绍创建kubeconfig配置文件 她们是kubernetes客户端与API Server 认证与鉴权的保证</p>
<p>kubectl是kubernetes命令行客户端，一般情况集群都开启了TLS认证，kubectl或其它客户端每次与集群kube-apiserver交互都少不了身份验证，目前有两种常用认证方式，使用证书和token，这两种方式也是最通用的方式，本节简单说下kubectl客户端如何使用证书的认证方式访问集群。</p>
<p>使用证书的方式，一般情况下我们需要创建一个kubeconfig配置文件，这个文件用来组织有关集群、用户、命名空间和身份认证机制的信息。kubectl使用kubeconfig配置文件来查找选择集群所需信息，并且集群kube-apiserver进行通信，kubectl默认查到${HOME}/.kube目录下面的config文件，当然也可以通过设置KUBECONFIG环境变量或者在命令行使用–kubeconfig参数指定kubeconfig配置文件。</p>
<p><strong>配置详情</strong></p>
<table>
<thead>
<tr>
<th align="center">步骤</th>
<th align="center">配置选项</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1. 设置集群信息</td>
<td align="center">set-cluster</td>
<td align="center">kubectl config 设置集群信息时使用</td>
</tr>
<tr>
<td align="center">–certificate-authority</td>
<td align="center">设置集群的根证书路径</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">–embed-certs</td>
<td align="center">将–certificate-authority根证书写入到kubeconfig中</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">–server</td>
<td align="center">指定访问集群的socket</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">–kubeconfig</td>
<td align="center">kubeconfig配置文件路径</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">2. 设置客户端参数</td>
<td align="center">set-credentials</td>
<td align="center">kubectl config 设置客户端认证信息</td>
</tr>
<tr>
<td align="center">–client-certificate</td>
<td align="center">指定kubectl使用的证书路径</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">–client-key</td>
<td align="center">指定kubectl使用的私钥路径</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">–embed-certs</td>
<td align="center">将kubectl使用的证书和私钥写入到kubeconfig中</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">–kubeconfig</td>
<td align="center">kubeconfig配置文件路径</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">3. 设置上下文信息</td>
<td align="center">set-context</td>
<td align="center">kubectl config 设置上下文参数</td>
</tr>
<tr>
<td align="center">–cluster</td>
<td align="center">配置使用哪个集群信息，set-cluster中设置的</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">–user</td>
<td align="center">配置使用哪个客户端，set-credentials中设置的</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">–kubeconfig</td>
<td align="center">kubeconfig配置文件路径</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">4. kubeconfig中使用哪个上下文</td>
<td align="center">use-context</td>
<td align="center">kubectl config 设置使用哪个上下文信息</td>
</tr>
</tbody></table>
<p>客户端认证配置</p>
<p>本节将会创建用于 kube-proxy kube-controll-manager kube-scheduler 和kubelet 的kubeconfig文件</p>
<h3 id="kubelet配置文件"><a href="#kubelet配置文件" class="headerlink" title="kubelet配置文件"></a>kubelet配置文件</h3><p>为了确保Node Authorizer授权 kubelet配置文件中的客户端证书必须匹配Node名字</p>
<p>Node名字还使用生成证书那一节配置的环境变量</p>
<p>为所有节点创建kubeconfig配置（都在master节点操作）</p>
<p>生成配置文件所在的目录就在上一节生成kubernetes组件所在的目录</p>
<p>首先安装kubectl</p>
<p>这里一次性将所有需要的软件都安装上</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">wget --timestamping \</span><br><span class="line">  <span class="string">"https://storage.googleapis.com/kubernetes-release/release/v1.17.3/bin/linux/amd64/kube-apiserver"</span> \</span><br><span class="line">  <span class="string">"https://storage.googleapis.com/kubernetes-release/release/v1.17.3/bin/linux/amd64/kube-controller-manager"</span> \</span><br><span class="line">  <span class="string">"https://storage.googleapis.com/kubernetes-release/release/v1.17.3/bin/linux/amd64/kube-scheduler"</span> \</span><br><span class="line">  <span class="string">"https://storage.googleapis.com/kubernetes-release/release/v1.17.3/bin/linux/amd64/kubectl"</span></span><br><span class="line">chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者一次性下载</span></span><br><span class="line">https:<span class="regexp">//</span>dl.k8s.io<span class="regexp">/v1.17.3/</span>kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#解压缩</span></span><br><span class="line">tar -zxvf <span class="regexp">/root/</span>kubernetes-server-<span class="number">1.17</span>.<span class="number">3</span>-linux-amd64.tar.gz  --strip-components=<span class="number">3</span> -C <span class="regexp">/usr/</span>local<span class="regexp">/bin kubernetes/</span>server<span class="regexp">/bin/</span>kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝文件至另外两个master节点</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">  echo <span class="string">"---$host---"</span></span><br><span class="line">  scp <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; <span class="variable">$host</span>:<span class="regexp">/usr/</span>local<span class="regexp">/bin/</span></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝文件至node节点</span></span><br><span class="line">scp <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>kube&#123;let,-proxy&#125; k8s-node1:<span class="regexp">/usr/</span>local<span class="regexp">/bin/</span></span><br><span class="line">cd <span class="regexp">/root/</span>ssl<span class="regexp">/kubernetes/</span></span><br></pre></td></tr></table></figure>

<p>不用环境变量的方法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master1.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:node:k8s-master1 \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=k8s-master1.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=k8s-master1-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master1.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=system:node:k8s-master1 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master1.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=k8s-master1.kubeconfig</span><br></pre></td></tr></table></figure>

<p>使用环境变量的方法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=<span class="variable">$&#123;MASTER1_HOSTNAME&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:node:<span class="variable">$&#123;MASTER1_HOSTNAME&#125;</span> \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=<span class="variable">$&#123;MASTER1_HOSTNAME&#125;</span>.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=<span class="variable">$&#123;MASTER1_HOSTNAME&#125;</span>-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=<span class="variable">$&#123;MASTER1_HOSTNAME&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=system:node:$&#123;MASTER1_HOSTNAME&#125; \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=<span class="variable">$&#123;MASTER1_HOSTNAME&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=<span class="variable">$&#123;MASTER1_HOSTNAME&#125;</span>.kubeconfig</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ls k8s-master<span class="number">*c</span>onfig</span><br><span class="line">k8s-master1.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master2.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:node:k8s-master2 \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=k8s-master2.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=k8s-master2-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master2.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=system:node:k8s-master2 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master2.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=k8s-master2.kubeconfig</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ls</span> <span class="selector-tag">k8s-master</span>*<span class="selector-tag">config</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">k8s-master1</span><span class="selector-class">.kubeconfig</span> <span class="selector-tag">k8s-master2</span><span class="selector-class">.kubeconfig</span></span><br></pre></td></tr></table></figure>

<p>k8s-master3节点的配置文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master3.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:node:k8s-master3 \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=k8s-master3.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=k8s-master3-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master3.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=system:node:k8s-master3 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-master3.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=k8s-master3.kubeconfig</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls k8s-master3*<span class="built_in">config</span></span><br><span class="line">k8s-master3.kubeconfig</span><br></pre></td></tr></table></figure>

<p>k8s-node1节点配置文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-node1.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:node:k8s-node1 \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=k8s-node1.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=k8s-node1-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-node1.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=system:node:k8s-node1 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=k8s-node1.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=k8s-node1.kubeconfig</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls k8s-node1*<span class="built_in">config</span></span><br><span class="line">k8s-node1.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="kube-proxy配置文件"><a href="#kube-proxy配置文件" class="headerlink" title="kube-proxy配置文件"></a>kube-proxy配置文件</h3><p>为kube-proxy服务生成kubeconfig配置文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:kube-proxy \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=kube-proxy.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=kube-proxy-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=system:kube-proxy \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls kube-proxy*<span class="built_in">config</span></span><br><span class="line">kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="kube-controller-manager配置文件"><a href="#kube-controller-manager配置文件" class="headerlink" title="kube-controller-manager配置文件"></a>kube-controller-manager配置文件</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:kube-controller-manager \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=kube-controller-manager.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=kube-controller-manager-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=system:kube-controller-manager \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> kube-<span class="keyword">con</span>*config</span><br><span class="line">kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="kube-scheduler配置文件"><a href="#kube-scheduler配置文件" class="headerlink" title="kube-scheduler配置文件"></a>kube-scheduler配置文件</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:kube-scheduler \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=kube-scheduler.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=kube-scheduler-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=system:kube-scheduler \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls kube-sch*<span class="built_in">config</span></span><br><span class="line">kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="Admin配置文件"><a href="#Admin配置文件" class="headerlink" title="Admin配置文件"></a>Admin配置文件</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes-training \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=https://$&#123;VIP&#125;:8443 \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials admin \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=admin.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=admin-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes-training \</span><br><span class="line">  <span class="attribute">--user</span>=admin \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=admin.kubeconfig</span><br></pre></td></tr></table></figure>

<p>输出文件</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls ad*<span class="built_in">config</span></span><br><span class="line">admin.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="配置和生成密钥"><a href="#配置和生成密钥" class="headerlink" title="配置和生成密钥"></a>配置和生成密钥</h3><p>Kubernetes 存储了集群状态、应用配置和密钥等很多不同的数据。而 Kubernetes 也支持集群数据的加密存储。</p>
<p>本部分将会创建加密密钥以及一个用于加密 Kubernetes Secrets 的 加密配置文件。</p>
<p>所有操作主节点执行</p>
<p>加密密钥<br>建立加密密钥:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENCRYPTION_KEY=<span class="constructor">$(<span class="params">head</span> -<span class="params">c</span> 32 <span class="operator">/</span><span class="params">dev</span><span class="operator">/</span><span class="params">urandom</span> | <span class="params">base64</span>)</span></span><br></pre></td></tr></table></figure>

<p>加密配置文件<br>生成名为 encryption-config.yaml 的加密配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">encryption-config.yaml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EncryptionConfig</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">providers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">aescbc:</span></span><br><span class="line">          <span class="attr">keys:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">key1</span></span><br><span class="line">              <span class="attr">secret:</span> <span class="string">$&#123;ENCRYPTION_KEY&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">identity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h3 id="分发证书文件"><a href="#分发证书文件" class="headerlink" title="分发证书文件"></a>分发证书文件</h3><p>将 kubelet 与 kube-proxy kubeconfig 配置文件复制到每个 worker 节点上：</p>
<p>创建配置文件目录</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3 k8s-node1 ; <span class="keyword">do</span> ssh root@<span class="variable">$host</span> "<span class="keyword">mkdir</span> -p \</span><br><span class="line">  /opt/cni/bin \</span><br><span class="line">  /<span class="keyword">var</span>/lib/kubelet \</span><br><span class="line">  /<span class="keyword">var</span>/lib/kube-proxy \</span><br><span class="line">  /<span class="keyword">var</span>/lib/kubernetes \</span><br><span class="line">  /<span class="keyword">var</span>/<span class="keyword">run</span>/kubernetes " ; done</span><br></pre></td></tr></table></figure>

<p>将 admin、kube-controller-manager 与 kube-scheduler kubeconfig 配置文件复制到每个控制节点上：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">分发文件方法一；</span><br><span class="line">scp  ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \</span><br><span class="line">  service-account-key.pem service-account.pem \</span><br><span class="line">  encryption-config.yaml \</span><br><span class="line">  kube-controller-manager.kubeconfig kube-scheduler.kubeconfig k8s-<span class="symbol">master1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/</span></span><br><span class="line">  scp admin.kubeconfig k8s-<span class="symbol">master1:</span>~<span class="regexp">/</span></span><br><span class="line"><span class="regexp">  </span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">scp  ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \</span></span><br><span class="line"><span class="regexp">  service-account-key.pem service-account.pem \</span></span><br><span class="line"><span class="regexp">  encryption-config.yaml \</span></span><br><span class="line"><span class="regexp">  kube-controller-manager.kubeconfig kube-scheduler.kubeconfig k8s-master2:/var</span><span class="regexp">/lib/kubernetes</span><span class="regexp">/</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">scp  ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \</span></span><br><span class="line"><span class="regexp">  service-account-key.pem service-account.pem \</span></span><br><span class="line"><span class="regexp">  encryption-config.yaml \</span></span><br><span class="line"><span class="regexp">  kube-controller-manager.kubeconfig kube-scheduler.kubeconfig k8s-master3:/var</span><span class="regexp">/lib/kubernetes</span><span class="regexp">/</span></span><br><span class="line"><span class="regexp">分发文件方法二；</span></span><br><span class="line"><span class="regexp">  </span></span><br><span class="line"><span class="regexp">for NODE in k8s-master1 k8s-master2 k8s-master3; do</span></span><br><span class="line"><span class="regexp">  echo "-----$NODE------"</span></span><br><span class="line"><span class="regexp">  scp ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \</span></span><br><span class="line"><span class="regexp">  service-account-key.pem service-account.pem \</span></span><br><span class="line"><span class="regexp">  encryption-config.yaml \</span></span><br><span class="line"><span class="regexp">  kube-controller-manager.kubeconfig kube-scheduler.kubeconfig $NODE:/var</span><span class="regexp">/lib/kubernetes</span><span class="regexp">/;</span></span><br><span class="line"><span class="regexp">done</span></span><br><span class="line"><span class="regexp">scp  k8s-master1-key.pem  k8s-master1.pem k8s-master1:/var</span><span class="regexp">/lib/kubelet</span><span class="regexp">/</span></span><br><span class="line"><span class="regexp">scp  k8s-master1.kubeconfig k8s-master1:/var</span><span class="regexp">/lib/kubelet</span><span class="regexp">/kubeconfig</span></span><br><span class="line"><span class="regexp">scp  kube-proxy.kubeconfig k8s-master1:/var</span><span class="regexp">/lib/kube</span>-proxy/kubeconfig</span><br><span class="line">scp  kube-proxy.pem k8s-<span class="symbol">master1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/</span></span><br><span class="line">scp  kube-proxy-key.pem k8s-<span class="symbol">master1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/</span></span><br><span class="line">scp kube-controller-manager-key.pem k8s-<span class="symbol">master1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/<span class="title">kube</span>-<span class="title">controller</span>-<span class="title">manager</span>-<span class="title">key</span>.<span class="title">pem</span>                                           </span></span><br><span class="line">scp kube-controller-manager.pem k8s-<span class="symbol">master1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/</span></span><br><span class="line">scp kube-scheduler.pem k8s-<span class="symbol">master1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/<span class="title">kube</span>-<span class="title">scheduler</span>.<span class="title">pem</span></span></span><br><span class="line">scp kube-scheduler-key.pem k8s-<span class="symbol">master1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scp  k8s-master2-key.pem  k8s-master2.pem k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubelet</span>/</span></span><br><span class="line">scp  k8s-master2.kubeconfig k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubelet</span>/<span class="title">kubeconfig</span></span></span><br><span class="line">scp  kube-proxy.kubeconfig k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/<span class="title">kubeconfig</span></span></span><br><span class="line">scp  kube-proxy-key.pem k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/</span></span><br><span class="line">scp  kube-proxy.pem k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/</span></span><br><span class="line">scp kube-controller-manager-key.pem k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/<span class="title">kube</span>-<span class="title">controller</span>-<span class="title">manager</span>-<span class="title">key</span>.<span class="title">pem</span>                                           </span></span><br><span class="line">scp kube-controller-manager.pem k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/</span></span><br><span class="line">scp kube-scheduler.pem k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/<span class="title">kube</span>-<span class="title">scheduler</span>.<span class="title">pem</span></span></span><br><span class="line">scp kube-scheduler-key.pem k8s-<span class="symbol">master2:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/</span></span><br><span class="line"></span><br><span class="line">scp  k8s-master3-key.pem  k8s-master3.pem k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubelet</span>/</span></span><br><span class="line">scp  k8s-master3.kubeconfig k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubelet</span>/<span class="title">kubeconfig</span></span></span><br><span class="line">scp  kube-proxy.kubeconfig k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/<span class="title">kubeconfig</span></span></span><br><span class="line">scp  kube-proxy-key.pem k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/</span></span><br><span class="line">scp  kube-proxy.pem k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/</span></span><br><span class="line">scp kube-controller-manager-key.pem k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/<span class="title">kube</span>-<span class="title">controller</span>-<span class="title">manager</span>-<span class="title">key</span>.<span class="title">pem</span>                                           </span></span><br><span class="line">scp kube-controller-manager.pem k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/</span></span><br><span class="line">scp kube-scheduler.pem k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/<span class="title">kube</span>-<span class="title">scheduler</span>.<span class="title">pem</span></span></span><br><span class="line">scp kube-scheduler-key.pem k8s-<span class="symbol">master3:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scp  ca.pem k8s-<span class="symbol">node1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubernetes</span>/</span></span><br><span class="line">scp  k8s-node1-key.pem  k8s-node1.pem k8s-<span class="symbol">node1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubelet</span>/</span></span><br><span class="line">scp  k8s-node1.kubeconfig k8s-<span class="symbol">node1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubelet</span>/<span class="title">kubeconfig</span></span></span><br><span class="line">scp  kube-proxy.kubeconfig k8s-<span class="symbol">node1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/<span class="title">kubeconfig</span></span></span><br><span class="line">scp  kube-proxy-key.pem k8s-<span class="symbol">node1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/</span></span><br><span class="line">scp  kube-proxy.pem k8s-<span class="symbol">node1:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">kube</span>-<span class="title">proxy</span>/</span></span><br></pre></td></tr></table></figure>

<p>kubernetes的组件都是无状态的，所有集群的状态都存储在etcd集群中</p>
<h2 id><a href="#" class="headerlink" title></a></h2><h1 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h1><p>etcd目录结构</p>
<p>软件包解压目录</p>
<p>/usr/local/etcd/src/</p>
<p>ssl证书申请文件</p>
<p>/usr/local/etcd/json</p>
<p>ssl证书文件</p>
<p>/usr/local/etcd/ssl/</p>
<p>可执行文件</p>
<p>/usr/local/etcd/bin/</p>
<p>工作目录</p>
<p>/usr/local/etcd/data/</p>
<p>etcd的目录在生成证书的最后已经全部创建 并且证书文件也全部拷贝完成</p>
<h3 id="下载etcd二进制包并解压"><a href="#下载etcd二进制包并解压" class="headerlink" title="下载etcd二进制包并解压"></a>下载etcd二进制包并解压</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd</span><br><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/etcd-io/</span>etcd<span class="regexp">/releases/</span>download<span class="regexp">/v3.4.1/</span>etcd-v3.<span class="number">4.1</span>-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf etcd-v3.<span class="number">4.1</span>-linux-amd64.tar.gz -C <span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>src<span class="regexp">/</span></span><br></pre></td></tr></table></figure>

<p>复制可执行文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">复制方法一；</span><br><span class="line">scp -p <span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>src<span class="regexp">/etcd-v3.4.1-linux-amd64/</span>etcd k8s-<span class="string">master1:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>bin/</span><br><span class="line">scp -p <span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>src<span class="regexp">/etcd-v3.4.1-linux-amd64/</span>etcdctl k8s-<span class="string">master1:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>bin/</span><br><span class="line"></span><br><span class="line">scp -p <span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>src<span class="regexp">/etcd-v3.4.1-linux-amd64/</span>etcd k8s-<span class="string">master2:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>bin/</span><br><span class="line">scp -p <span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>src<span class="regexp">/etcd-v3.4.1-linux-amd64/</span>etcdctl k8s-<span class="string">master2:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>bin/</span><br><span class="line"></span><br><span class="line">scp -p <span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>src<span class="regexp">/etcd-v3.4.1-linux-amd64/</span>etcd k8s-<span class="string">master3:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>bin/</span><br><span class="line">scp -p <span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>src<span class="regexp">/etcd-v3.4.1-linux-amd64/</span>etcdctl k8s-<span class="string">master2:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>bin/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">复制方法二；</span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span>  k8s-master1 k8s-master2 k8s-master3; do</span><br><span class="line">  echo <span class="string">"----$host----"</span></span><br><span class="line">  scp -p <span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>src<span class="regexp">/etcd-v3.4.1-linux-amd64/</span>etcd* <span class="string">$host:</span><span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>bin/;</span><br><span class="line">  ssh $host <span class="string">"ln -s /usr/local/etcd/bin/* /usr/bin/"</span>;</span><br><span class="line">done</span><br><span class="line">或者直接复制执行文件到 <span class="regexp">/usr/</span>bin,这里方便管理复制到<span class="regexp">/usr/</span>local<span class="regexp">/etcd/</span>bin下</span><br></pre></td></tr></table></figure>

<h3 id="设置etcd系统服务文件"><a href="#设置etcd系统服务文件" class="headerlink" title="设置etcd系统服务文件"></a>设置etcd系统服务文件</h3><p>在/etc/systemd/system/目录下导入文件etcd.service</p>
<p>配置master节点的配置文件：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">配置master1的etcd</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | tee /etc/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Etcd Server</span><br><span class="line"><span class="attribute">Documentation</span>=https://coreos.com/etcd/docs/latest/</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"><span class="attribute">Wants</span>=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/etcd/bin/etcd  \\</span><br><span class="line">  <span class="attribute">--name</span>=etcd00   \\</span><br><span class="line">  <span class="attribute">--data-dir</span>=/usr/local/etcd/data/  \\</span><br><span class="line">  <span class="attribute">--listen-peer-urls</span>=https://$MASTER1_IP:2380 \\</span><br><span class="line">  <span class="attribute">--listen-client-urls</span>=https://$MASTER1_IP:2379,https://127.0.0.1:2379  \\</span><br><span class="line">  <span class="attribute">--advertise-client-urls</span>=https://$MASTER1_IP:2379  \\</span><br><span class="line">  <span class="attribute">--initial-advertise-peer-urls</span>=https://$MASTER1_IP:2380  \\</span><br><span class="line">  <span class="attribute">--initial-cluster</span>=etcd00=https://$MASTER1_IP:2380,etcd01=https://$MASTER2_IP:2380,etcd02=https://$MASTER3_IP:2380 \\</span><br><span class="line">  <span class="attribute">--initial-cluster-token</span>=etcd-cluster \\</span><br><span class="line">  <span class="attribute">--initial-cluster-state</span>=new \\</span><br><span class="line">  <span class="attribute">--cert-file</span>=/usr/local/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--key-file</span>=/usr/local/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  <span class="attribute">--peer-cert-file</span>=/usr/local/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--peer-key-file</span>=/usr/local/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  <span class="attribute">--trusted-ca-file</span>=/usr/local/etcd/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--peer-trusted-ca-file</span>=/usr/local/etcd/ssl/ca.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置master2的etcd</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | tee /etc/systemd/system/etcd2.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Etcd Server</span><br><span class="line"><span class="attribute">Documentation</span>=https://coreos.com/etcd/docs/latest/</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"><span class="attribute">Wants</span>=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/etcd/bin/etcd  \\</span><br><span class="line">  <span class="attribute">--name</span>=etcd01   \\</span><br><span class="line">  <span class="attribute">--data-dir</span>=/usr/local/etcd/data/  \\</span><br><span class="line">  <span class="attribute">--listen-peer-urls</span>=https://$MASTER2_IP:2380 \\</span><br><span class="line">  <span class="attribute">--listen-client-urls</span>=https://$MASTER2_IP:2379,https://127.0.0.1:2379  \\</span><br><span class="line">  <span class="attribute">--advertise-client-urls</span>=https://$MASTER2_IP:2379  \\</span><br><span class="line">  <span class="attribute">--initial-advertise-peer-urls</span>=https://$MASTER2_IP:2380  \\</span><br><span class="line">  <span class="attribute">--initial-cluster</span>=etcd00=https://$MASTER1_IP:2380,etcd01=https://$MASTER2_IP:2380,etcd02=https://$MASTER3_IP:2380 \\</span><br><span class="line">  <span class="attribute">--initial-cluster-token</span>=etcd-cluster \\</span><br><span class="line">  <span class="attribute">--initial-cluster-state</span>=new \\</span><br><span class="line">  <span class="attribute">--cert-file</span>=/usr/local/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--key-file</span>=/usr/local/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  <span class="attribute">--peer-cert-file</span>=/usr/local/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--peer-key-file</span>=/usr/local/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  <span class="attribute">--trusted-ca-file</span>=/usr/local/etcd/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--peer-trusted-ca-file</span>=/usr/local/etcd/ssl/ca.pem</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scp /etc/systemd/system/etcd2.service k8s-master2:/etc/systemd/system/etcd.service</span><br><span class="line">rm -rf /etc/systemd/system/etcd2.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置master3的etcd</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | tee /etc/systemd/system/etcd3.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Etcd Server</span><br><span class="line"><span class="attribute">Documentation</span>=https://coreos.com/etcd/docs/latest/</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"><span class="attribute">Wants</span>=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/etcd/bin/etcd  \\</span><br><span class="line">  <span class="attribute">--name</span>=etcd02   \\</span><br><span class="line">  <span class="attribute">--data-dir</span>=/usr/local/etcd/data/  \\</span><br><span class="line">  <span class="attribute">--listen-peer-urls</span>=https://$MASTER3_IP:2380 \\</span><br><span class="line">  <span class="attribute">--listen-client-urls</span>=https://$MASTER3_IP:2379,https://127.0.0.1:2379  \\</span><br><span class="line">  <span class="attribute">--advertise-client-urls</span>=https://$MASTER3_IP:2379  \\</span><br><span class="line">  <span class="attribute">--initial-advertise-peer-urls</span>=https://$MASTER3_IP:2380  \\</span><br><span class="line">  <span class="attribute">--initial-cluster</span>=etcd00=https://$MASTER1_IP:2380,etcd01=https://$MASTER2_IP:2380,etcd02=https://$MASTER3_IP:2380 \\</span><br><span class="line">  <span class="attribute">--initial-cluster-token</span>=etcd-cluster \\</span><br><span class="line">  <span class="attribute">--initial-cluster-state</span>=new \\</span><br><span class="line">  <span class="attribute">--cert-file</span>=/usr/local/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--key-file</span>=/usr/local/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  <span class="attribute">--peer-cert-file</span>=/usr/local/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--peer-key-file</span>=/usr/local/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  <span class="attribute">--trusted-ca-file</span>=/usr/local/etcd/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--peer-trusted-ca-file</span>=/usr/local/etcd/ssl/ca.pem</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scp /etc/systemd/system/etcd3.service k8s-master3:/etc/systemd/system/etcd.service</span><br><span class="line">rm -rf /etc/systemd/system/etcd3.service</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">配置选项</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">wal</td>
<td align="center">存放预写式日志,文件中记录了整个数据变化的全部历程，数据的修改在提交前，都要先写入到WAL中</td>
</tr>
<tr>
<td align="center">data-dir</td>
<td align="center">指定节点的数据存储目录（包括：节点ID、集群ID、集群初始化配置、Snapshot文件等），如果未指定，会写在当前目录</td>
</tr>
<tr>
<td align="center">wal-dir</td>
<td align="center">存放预写式日志，文件中记录了整个数据变化的全部历程，数据的修改在提交前，都要先写入到WAL中，如果未指定，写在–data-dir目录下面</td>
</tr>
<tr>
<td align="center">name</td>
<td align="center">节点名称，如果–initial-cluster-state=new这个值为new，哪么–name的参数值必须位于–initial-cluster列表中</td>
</tr>
<tr>
<td align="center">cert-file</td>
<td align="center">客户端与服务器之间TLS证书文件的路径</td>
</tr>
<tr>
<td align="center">key-file</td>
<td align="center">客户端与服务器之间TLS密钥文件的路径</td>
</tr>
<tr>
<td align="center">trusted-ca-file</td>
<td align="center">签名client证书的CA证书，用于验证client证书</td>
</tr>
<tr>
<td align="center">peer-cert-file</td>
<td align="center">对等服务器TLS证书文件的路径</td>
</tr>
<tr>
<td align="center">peer-key-file</td>
<td align="center">对等服务器TLS密钥文件的路径</td>
</tr>
<tr>
<td align="center">peer-client-cert-auth</td>
<td align="center">启用对等客户端证书验证</td>
</tr>
<tr>
<td align="center">client-cert-auth</td>
<td align="center">启用客户端验证</td>
</tr>
<tr>
<td align="center">listen-peer-urls</td>
<td align="center">与集群其它成员之间的通信地址</td>
</tr>
<tr>
<td align="center">initial-advertise-peer-urls</td>
<td align="center">通告给集群其它节点，本地的对等URL地址</td>
</tr>
<tr>
<td align="center">listen-client-urls</td>
<td align="center">监听本地端口，对外提供服务的地址</td>
</tr>
<tr>
<td align="center">advertise-client-urls</td>
<td align="center">客户端URL，用于通告集群的其余部分</td>
</tr>
<tr>
<td align="center">initial-cluster-token</td>
<td align="center">集群的token，整个集群中保持一致</td>
</tr>
<tr>
<td align="center">initial-cluster</td>
<td align="center">集群中的所有信息节点</td>
</tr>
<tr>
<td align="center">initial-cluster-state</td>
<td align="center">初始化集群状态，默认为new</td>
</tr>
<tr>
<td align="center">auto-compaction-mode</td>
<td align="center">配置基于时间的三种模式</td>
</tr>
<tr>
<td align="center">auto-compaction-retention</td>
<td align="center">设置保留历史时间为1小时</td>
</tr>
<tr>
<td align="center">max-request-bytes</td>
<td align="center">服务器将接受的最大客户端请求大小</td>
</tr>
<tr>
<td align="center">quota-backend-bytes</td>
<td align="center">当后端大小超过给定的配额时，报警</td>
</tr>
<tr>
<td align="center">heartbeat-interval</td>
<td align="center">心跳间隔的时间，单位毫秒</td>
</tr>
<tr>
<td align="center">election-timeout</td>
<td align="center">选举超时时间，单位毫秒</td>
</tr>
</tbody></table>
<h3 id="所有节点启动etcd服务并设置为开机自启"><a href="#所有节点启动etcd服务并设置为开机自启" class="headerlink" title="所有节点启动etcd服务并设置为开机自启"></a>所有节点启动etcd服务并设置为开机自启</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">启动服务方法一（每台单独执行）；</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> etcd.service &amp;&amp; systemctl restart etcd.service &amp;</span><br><span class="line"></span><br><span class="line">启动服务方法二（master1执行）；</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">    ssh <span class="variable">$NODE</span> <span class="string">"systemctl daemon-reload"</span></span><br><span class="line">    ssh <span class="variable">$NODE</span> <span class="string">"systemctl enable --now etcd"</span> &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<p>如果有某一台节点启动失败 请手动启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart etcd.service</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">    ssh <span class="variable">$NODE</span> <span class="string">"systemctl daemon-reload"</span></span><br><span class="line">    ssh <span class="variable">$NODE</span> <span class="string">"systemctl start etcd"</span> &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<h3 id="检查etcd集群状态"><a href="#检查etcd集群状态" class="headerlink" title="检查etcd集群状态"></a>检查etcd集群状态</h3><p>三个节点的IP</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">-<span class="ruby">-cacert=<span class="regexp">/usr/local</span><span class="regexp">/etcd/ssl</span><span class="regexp">/ca.pem \</span></span></span><br><span class="line"><span class="ruby">--cert=<span class="regexp">/usr/local</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd.pem \</span></span></span><br><span class="line"><span class="ruby">--key=<span class="regexp">/usr/local</span><span class="regexp">/etcd/ssl</span><span class="regexp">/etcd-key.pem \</span></span></span><br><span class="line"><span class="ruby">--endpoints=<span class="string">"https://200.200.100.71:2379,\</span></span></span><br><span class="line"><span class="ruby"><span class="symbol">https:</span>/<span class="regexp">/200.200.100.72:2379,https:/</span><span class="regexp">/200.200.100.73:2379" endpoint health</span></span></span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http<span class="variable">s:</span>//<span class="number">200.200</span>.<span class="number">100.71</span>:<span class="number">2379</span> <span class="keyword">is</span> healthy: successfully committed proposa<span class="variable">l:</span> took = <span class="number">14.100152</span>ms</span><br><span class="line">http<span class="variable">s:</span>//<span class="number">200.200</span>.<span class="number">100.72</span>:<span class="number">2379</span> <span class="keyword">is</span> healthy: successfully committed proposa<span class="variable">l:</span> took = <span class="number">29.074303</span>ms</span><br></pre></td></tr></table></figure>

<p>全部节点为healthy 表明etcd集群搭建成功</p>
<h1 id="部署keepalived-HAProxy"><a href="#部署keepalived-HAProxy" class="headerlink" title="部署keepalived+HAProxy"></a>部署keepalived+HAProxy</h1><p>1.信息可以按照自己的环境填写，或者和我相同</p>
<p>2.网卡名称都为eth0，如有不相同建议修改下面配置，或者直接修改centos7网卡为eth0</p>
<p>3.cluster dns或domain有改变的话,需要修改kubelet-conf.yml</p>
<p>HA(haproxy+keepalived) 单台master就不要用HA了</p>
<p>首先所有master安装haproxy+keeplived</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for <span class="keyword">NODE</span> <span class="title">in</span> k8s-master1 k8s-master2 k8s-master3; do</span><br><span class="line">  echo <span class="string">"--- $NODE---"</span></span><br><span class="line">  ssh $<span class="keyword">NODE</span> <span class="title">'yum</span> install haproxy keepalived -y' &amp;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>安装完记得检查 (是每台master进行检查)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3;<span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"--- <span class="variable">$NODE</span> ---"</span></span><br><span class="line">  ssh <span class="variable">$NODE</span> <span class="string">"rpm -qa|grep haproxy"</span></span><br><span class="line">  ssh <span class="variable">$NODE</span> <span class="string">"rpm -qa|grep keepalived"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>在k8s-master1修改配置文件，并分发给其他master</p>
<p>· haproxy配置文件修改</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">  log     127.0.0.1 local2</span><br><span class="line">  chroot   /var/lib/haproxy</span><br><span class="line">  pidfile   /var/run/haproxy.pid</span><br><span class="line">  maxconn   4000</span><br><span class="line"> <span class="built_in"> user </span>   haproxy</span><br><span class="line"> <span class="built_in"> group </span>   haproxy</span><br><span class="line">  daemon</span><br><span class="line"> </span><br><span class="line">defaults</span><br><span class="line">  mode          tcp</span><br><span class="line">  log           global</span><br><span class="line">  retries         3</span><br><span class="line">  timeout connect     10s</span><br><span class="line">  timeout<span class="built_in"> client </span>    1m</span><br><span class="line">  timeout<span class="built_in"> server </span>    1m</span><br><span class="line"> </span><br><span class="line">frontend kubernetes</span><br><span class="line">  bind *:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  default_backend kubernetes-apiserver</span><br><span class="line"> </span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line"> <span class="built_in"> server </span>k8s-master1 200.200.100.71:6443 check maxconn 2000</span><br><span class="line"> <span class="built_in"> server </span>k8s-master2 200.200.100.72:6443 check maxconn 2000</span><br><span class="line"> <span class="built_in"> server </span>k8s-master3 200.200.100.73:6443 check maxconn 2000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>#在最后一行修改或者添加我们的master节点，端口默认是8443、这里更改了默认端口</p>
<p>· keeplived配置文件修改</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; <span class="literal">EOF</span> | tee /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_haproxy.sh"</span> </span><br><span class="line">  interval <span class="number">3</span></span><br><span class="line">  fall <span class="number">10</span></span><br><span class="line">  timeout <span class="number">9</span></span><br><span class="line">  rise <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">  <span class="section">state</span> MASTER     #备服务器上改为BACKUP</span><br><span class="line">  interface ens18    #改为自己的接口</span><br><span class="line">  virtual_router_id <span class="number">51</span></span><br><span class="line">  priority <span class="number">100</span>     #备服务器上改为小于<span class="number">100</span>的数字，<span class="number">90</span>,<span class="number">80</span></span><br><span class="line">  advert_int <span class="number">1</span></span><br><span class="line">  mcast_src_ip <span class="number">200.200</span><span class="number">.100</span><span class="number">.71</span>  #本机IP</span><br><span class="line">  nopreempt</span><br><span class="line">  authentication &#123;</span><br><span class="line">    auth_type PASS</span><br><span class="line">    auth_pass <span class="number">1111</span></span><br><span class="line">  &#125;</span><br><span class="line">  unicast_peer &#123;</span><br><span class="line">    <span class="number">200.200</span><span class="number">.100</span><span class="number">.72</span>    #除本机外其余两个master的IP节点</span><br><span class="line">    <span class="number">200.200</span><span class="number">.100</span><span class="number">.73</span></span><br><span class="line">  &#125;</span><br><span class="line">  virtual_ipaddress &#123;</span><br><span class="line">    <span class="number">200.200</span><span class="number">.100</span><span class="number">.70</span>     #虚拟vip，自己设定</span><br><span class="line">  &#125;</span><br><span class="line">  track_script &#123;</span><br><span class="line">    check_haproxy</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="literal">EOF</span></span><br></pre></td></tr></table></figure>

<p>另外keepalived需要修改</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router_id LVS_DEVEL_1 修改为不同</span><br><span class="line"><span class="keyword">state</span> BACKUP   备用</span><br><span class="line">priority <span class="number">101</span>   优先级需要修改</span><br></pre></td></tr></table></figure>

<p>#unicast_peer 为master节点IP</p>
<p>#virtual_ipaddress 为VIP地址，自行修改</p>
<p>#interface 物理网卡地址</p>
<p>添加keeplived健康检查脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/check_haproxy.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">A=\`ps -C haproxy --no-header | wc -l\`</span><br><span class="line"><span class="keyword">if</span> [ \<span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">systemctl stop keepalived</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line"> chmod +x /etc/keepalived/check_haproxy.sh</span><br></pre></td></tr></table></figure>

<p>##注意修改VIP地址</p>
<p>分发keeplived及haproxy文件给所有master</p>
<p># 分发文件</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">  echo <span class="string">"--- $NODE ---"</span></span><br><span class="line">  scp -r /etc/haproxy/haproxy.cfg <span class="variable">$NODE</span><span class="symbol">:/etc/haproxy/</span></span><br><span class="line">  scp -r /etc/keepalived/keepalived.conf <span class="variable">$NODE</span><span class="symbol">:/etc/keepalived/</span></span><br><span class="line">  scp -r /etc/keepalived/check_haproxy.sh  <span class="variable">$NODE</span><span class="symbol">:/etc/keepalived/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>ping下vip看看能通否,先等待大概四五秒等keepalived和haproxy起来</p>
<p>ping 200.200.100.70</p>
<p>这里的70是我们漂移IP (VIP)</p>
<p>如果vip没起来就是keepalived没起来就每个节点上去restart下keepalived或者确认下配置文件/etc/keepalived/keepalived.conf里网卡名和ip是否注入成功</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for <span class="keyword">NODE</span> <span class="title">in</span> k8s-master1 k8s-master2 k8s-master3; do</span><br><span class="line">  echo <span class="string">"--- $NODE ---"</span></span><br><span class="line">  ssh $<span class="keyword">NODE</span> <span class="title">'systemctl</span> enable --now haproxy keepalived'</span><br><span class="line">  ssh $<span class="keyword">NODE</span>  <span class="title">'systemctl</span> restart haproxy keepalived'</span><br><span class="line">done</span><br><span class="line">systemctl status keepalived</span><br><span class="line">systemctl status haproxy</span><br></pre></td></tr></table></figure>

<h1 id="部署master节点"><a href="#部署master节点" class="headerlink" title="部署master节点"></a>部署master节点</h1><h3 id="注意-本文所有操作均在master节点执行-1"><a href="#注意-本文所有操作均在master节点执行-1" class="headerlink" title="注意 本文所有操作均在master节点执行"></a>注意 本文所有操作均在master节点执行</h3><p>本文主要介绍kubernetes master组件的安装</p>
<p>附 v1.17.3版本软件包的下载地址</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>dl.k8s.io<span class="regexp">/v1.17.3/</span>kubernetes-server-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>本部分将会在控制节点上部署 Kubernetes 控制服务。每个控制节点上需要部署的服务包括：Kubernetes API Server、Scheduler 以及 Controller Manager 等。</p>
<h3 id="下载并安装kubernetes组件可执行文件"><a href="#下载并安装kubernetes组件可执行文件" class="headerlink" title="下载并安装kubernetes组件可执行文件"></a>下载并安装kubernetes组件可执行文件</h3><p>kubectl 文件已经下载过了 可以选择不下载</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="comment">--timestamping \</span></span><br><span class="line">  "https://storage.googleapis.com/kubernetes-<span class="keyword">release</span>/<span class="keyword">release</span>/v1<span class="number">.17</span><span class="number">.3</span>/<span class="keyword">bin</span>/linux/amd64/kube-apiserver<span class="string">" \</span></span><br><span class="line"><span class="string">  "</span>https://storage.googleapis.com/kubernetes-<span class="keyword">release</span>/<span class="keyword">release</span>/v1<span class="number">.17</span><span class="number">.3</span>/<span class="keyword">bin</span>/linux/amd64/kube-controller-manager<span class="string">" \</span></span><br><span class="line"><span class="string">  "</span>https://storage.googleapis.com/kubernetes-<span class="keyword">release</span>/<span class="keyword">release</span>/v1<span class="number">.17</span><span class="number">.3</span>/<span class="keyword">bin</span>/linux/amd64/kube-scheduler<span class="string">" \</span></span><br><span class="line"><span class="string">  "</span>https://storage.googleapis.com/kubernetes-<span class="keyword">release</span>/<span class="keyword">release</span>/v1<span class="number">.17</span><span class="number">.3</span>/<span class="keyword">bin</span>/linux/amd64/kubectl<span class="string">"</span></span><br><span class="line"><span class="string">chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">解压缩</span></span><br><span class="line"><span class="string">tar -zxvf /root/kubernetes-server-1.17.3-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for host in k8s-master1 k8s-master2 k8s-master3; do</span></span><br><span class="line"><span class="string">  echo "</span><span class="comment">---$host---"</span></span><br><span class="line">  cd /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/</span><br><span class="line">  scp kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; $host:/usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scp  /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/kube&#123;let,-proxy&#125; k8s-node1:/usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/</span><br></pre></td></tr></table></figure>

<p>使kubectl命令可以使用table键</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">source /usr/share/bash-completion/bash_completion </span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">cat &gt; /var/lib/kubernetes/audit-policy.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">  # The following requests were manually identified as high-volume and low-risk, so drop them.</span><br><span class="line">  -<span class="ruby"> <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - endpoints</span></span><br><span class="line"><span class="ruby">          - services</span></span><br><span class="line"><span class="ruby">          - services/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-proxy'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - watch</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes</span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">userGroups:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:nodes'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">namespaces:</span></span></span><br><span class="line"><span class="ruby">      - kube-system</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - endpoints</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-controller-manager'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-scheduler'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:endpoint-controller'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - namespaces</span></span><br><span class="line"><span class="ruby">          - namespaces/status</span></span><br><span class="line"><span class="ruby">          - namespaces/finalize</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:apiserver'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log HPA fetching metrics.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-controller-manager'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - list</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log these read-only URLs.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">nonResourceURLs:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'/healthz*'</span></span></span><br><span class="line"><span class="ruby">      - <span class="regexp">/version</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'/swagger*'</span></span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log events requests.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - events</span></span><br><span class="line"><span class="ruby">  <span class="comment"># node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">          - pods/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - kubelet</span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:node-problem-detector'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:node-problem-detector'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">      - patch</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">          - pods/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">userGroups:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:nodes'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">      - patch</span></span><br><span class="line"><span class="ruby">  <span class="comment"># deletecollection calls can be large, don't log responses for expected namespace deletions</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:namespace-controller'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - deletecollection</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span></span><br><span class="line"><span class="ruby">  <span class="comment"># so only log at the Metadata level.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Metadata</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - secrets</span></span><br><span class="line"><span class="ruby">          - configmaps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - tokenreviews</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Get repsonses can be large; skip them.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> admissionregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiextensions.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> autoscaling</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> batch</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> certificates.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> extensions</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> networking.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> policy</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> rbac.authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> scheduling.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> settings.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> storage.k8s.io</span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - list</span></span><br><span class="line"><span class="ruby">      - watch</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Default level for known APIs</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> RequestResponse</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> admissionregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiextensions.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> autoscaling</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> batch</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> certificates.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> extensions</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> networking.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> policy</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> rbac.authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> scheduling.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> settings.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> storage.k8s.io</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Default level for all other requests.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Metadata</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">EOF</span></span><br></pre></td></tr></table></figure>

<p>拷贝配置文件到其他master节点</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">  echo <span class="string">"---$host---"</span></span><br><span class="line">  scp /var/lib/kubernetes/audit-policy.yaml  <span class="variable">$host</span><span class="symbol">:/var/lib/kubernetes/audit-policy</span>.yaml</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="生成kube-apiserver-service配置启动文件"><a href="#生成kube-apiserver-service配置启动文件" class="headerlink" title="生成kube-apiserver.service配置启动文件"></a>生成kube-apiserver.service配置启动文件</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes API Server</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/bin/kube-apiserver \\</span><br><span class="line">  <span class="attribute">--advertise-address</span>=<span class="variable">$VIP</span> \\</span><br><span class="line">  <span class="attribute">--default-not-ready-toleration-seconds</span>=360 \\</span><br><span class="line">  <span class="attribute">--default-unreachable-toleration-seconds</span>=360 \\</span><br><span class="line">  <span class="attribute">--feature-gates</span>=DynamicAuditing=true \\</span><br><span class="line">  <span class="attribute">--max-mutating-requests-inflight</span>=2000 \\</span><br><span class="line">  <span class="attribute">--max-requests-inflight</span>=4000 \\</span><br><span class="line">  <span class="attribute">--default-watch-cache-size</span>=200 \\</span><br><span class="line">  <span class="attribute">--delete-collection-workers</span>=2 \\</span><br><span class="line">  <span class="attribute">--encryption-provider-config</span>=/var/lib/kubernetes/encryption-config.yaml  \\</span><br><span class="line">  <span class="attribute">--etcd-cafile</span>=/usr/local/etcd/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--etcd-certfile</span>=/usr/local/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--etcd-keyfile</span>=/usr/local/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  <span class="attribute">--etcd-servers</span>=https://$MASTER1_IP:2379,https://$MASTER2_IP:2379,https://$MASTER3_IP:2379 \\</span><br><span class="line">  <span class="attribute">--bind-address</span>=0.0.0.0 \\</span><br><span class="line">  <span class="attribute">--secure-port</span>=6443 \\</span><br><span class="line">  <span class="attribute">--tls-cert-file</span>=/var/lib/kubernetes/kubernetes.pem \\</span><br><span class="line">  <span class="attribute">--tls-private-key-file</span>=/var/lib/kubernetes/kubernetes-key.pem \\</span><br><span class="line">  <span class="attribute">--insecure-port</span>=0 \\</span><br><span class="line">  --audit-dynamic-configuration \\</span><br><span class="line">  <span class="attribute">--audit-log-maxage</span>=15 \\</span><br><span class="line">  <span class="attribute">--audit-log-maxbackup</span>=3 \\</span><br><span class="line">  <span class="attribute">--audit-log-maxsize</span>=100 \\</span><br><span class="line">  --audit-log-truncate-enabled \\</span><br><span class="line">  <span class="attribute">--audit-log-path</span>=/var/log/audit.log \\</span><br><span class="line">  <span class="attribute">--audit-policy-file</span>=/var/lib/kubernetes/audit-policy.yaml \\</span><br><span class="line">  --profiling \\</span><br><span class="line">  <span class="attribute">--anonymous-auth</span>=<span class="literal">false</span> \\</span><br><span class="line">  <span class="attribute">--client-ca-file</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  --enable-bootstrap-token-auth \\</span><br><span class="line">  <span class="attribute">--requestheader-allowed-names</span>=<span class="string">"aggregator"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-client-ca-file</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-extra-headers-prefix</span>=<span class="string">"X-Remote-Extra-"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-group-headers</span>=X-Remote-Group \\</span><br><span class="line">  <span class="attribute">--requestheader-username-headers</span>=X-Remote-User \\</span><br><span class="line">  <span class="attribute">--service-account-key-file</span>=/var/lib/kubernetes/service-account.pem \\</span><br><span class="line">  <span class="attribute">--authorization-mode</span>=Node,RBAC \\</span><br><span class="line">  <span class="attribute">--runtime-config</span>=api/all=true \\</span><br><span class="line">  <span class="attribute">--enable-admission-plugins</span>=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \\</span><br><span class="line">  <span class="attribute">--allow-privileged</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--apiserver-count</span>=3 \\</span><br><span class="line">  <span class="attribute">--event-ttl</span>=168h \\</span><br><span class="line">  <span class="attribute">--kubelet-certificate-authority</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  <span class="attribute">--kubelet-client-certificate</span>=/var/lib/kubernetes/kubernetes.pem \\</span><br><span class="line">  <span class="attribute">--kubelet-client-key</span>=/var/lib/kubernetes/kubernetes-key.pem \\</span><br><span class="line">  <span class="attribute">--kubelet-https</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--kubelet-timeout</span>=10s \\</span><br><span class="line">  <span class="attribute">--proxy-client-cert-file</span>=/var/lib/kube-proxy/kube-proxy.pem \\</span><br><span class="line">  <span class="attribute">--proxy-client-key-file</span>=/var/lib/kube-proxy/kube-proxy-key.pem \\</span><br><span class="line">  <span class="attribute">--service-cluster-ip-range</span>=10.250.0.0/16 \\</span><br><span class="line">  <span class="attribute">--service-node-port-range</span>=30000-32767 \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"></span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>拷贝配置文件到另外节点</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>kube-apiserver.service k8s-<span class="string">master2:</span><span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span></span><br><span class="line">scp <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>kube-apiserver.service k8s-<span class="string">master3:</span><span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span></span><br></pre></td></tr></table></figure>

<p>配置详解如下</p>
<table>
<thead>
<tr>
<th align="center">配置选项</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–advertise-address</td>
<td align="center">向集群成员通知 apiserver 消息的 IP 地址，这个地址必须能够被集群中其他成员访问，如果 IP 地址为空，将会使用 –bind-address，如果未指定 –bind-address，将会使用主机的默认接口地址</td>
</tr>
<tr>
<td align="center">–default-not-ready-toleration-seconds</td>
<td align="center">表示 notReady状态的容忍度秒数：默认情况下，NoExecute 被添加到尚未具有此容忍度的每个 Pod 中</td>
</tr>
<tr>
<td align="center">–default-unreachable-toleration-seconds</td>
<td align="center">表示 unreachable状态的容忍度秒数：默认情况下，NoExecute 被添加到尚未具有此容忍度的每个 Pod 中</td>
</tr>
<tr>
<td align="center">–feature-gates=DynamicAuditing=true</td>
<td align="center">用于实验性质的特性开关组,每个key=value表示</td>
</tr>
<tr>
<td align="center">–max-mutating-requests-inflight=2000</td>
<td align="center">在给定时间内进行中可变请求的最大数量，当超过该值时，服务将拒绝所有请求，0 值表示没有限制（默认值 200）</td>
</tr>
<tr>
<td align="center">–max-requests-inflight=4000</td>
<td align="center">在给定时间内进行中不可变请求的最大数量，当超过该值时，服务将拒绝所有请求，0 值表示没有限制。（默认值 400）</td>
</tr>
<tr>
<td align="center">–default-watch-cache-size=200</td>
<td align="center">默认监视缓存大小，0 表示对于没有设置默认监视大小的资源，将禁用监视缓存</td>
</tr>
<tr>
<td align="center">–delete-collection-workers=2</td>
<td align="center">用于 DeleteCollection 调用的工作者数量，这被用于加速 namespace 的清理( 默认值 1)</td>
</tr>
<tr>
<td align="center">–encryption-provider-config</td>
<td align="center">将Secret数据加密存储到etcd中的配置文件</td>
</tr>
<tr>
<td align="center">–etcd-cafile</td>
<td align="center">用于etcd 通信的 SSL CA 文件</td>
</tr>
<tr>
<td align="center">–etcd-certfile</td>
<td align="center">用于 etcd 通信的的 SSL 证书文件</td>
</tr>
<tr>
<td align="center">–etcd-keyfile</td>
<td align="center">用于 etcd 通信的 SSL 密钥文件 .</td>
</tr>
<tr>
<td align="center">–etcd-servers</td>
<td align="center">连接的 etcd 服务器列表 , 形式为（scheme://ip:port)，使用逗号分隔</td>
</tr>
<tr>
<td align="center">–bind-address</td>
<td align="center">监听 –seure-port 的 IP 地址，被关联的接口必须能够被集群其它节点和 CLI/web 客户端访问，如果为空，则将使用所有接口（0.0.0.0）</td>
</tr>
<tr>
<td align="center">–secure-port=6443</td>
<td align="center">用于监听具有认证授权功能的 HTTPS 协议的端口，默认值是6443</td>
</tr>
<tr>
<td align="center">–tls-cert-file</td>
<td align="center">包含用于 HTTPS 的默认 x509 证书的文件，（如果有 CA 证书，则附加于 server 证书之后），如果启用了 HTTPS 服务，并且没有提供 –tls-cert-file 和 –tls-private-key-file，则将为公共地址生成一个自签名的证书和密钥并保存于 /var/run/kubernetes 目录中</td>
</tr>
<tr>
<td align="center">–tls-private-key-file</td>
<td align="center">包含匹配 –tls-cert-file 的 x509 证书私钥的文件</td>
</tr>
<tr>
<td align="center">–insecure-port=0</td>
<td align="center">监听不安全端口，默认值是8080，设置为0，表示禁用不安全端口</td>
</tr>
<tr>
<td align="center">–audit-dynamic-configuration</td>
<td align="center">动态审计配置</td>
</tr>
<tr>
<td align="center">–audit-log-maxage=15</td>
<td align="center">基于文件名中的时间戳，旧审计日志文件的最长保留天数</td>
</tr>
<tr>
<td align="center">–audit-log-maxbackup=3</td>
<td align="center">旧审计日志文件的最大保留个数</td>
</tr>
<tr>
<td align="center">–audit-log-maxsize=100</td>
<td align="center">审计日志被轮转前的最大兆字节数</td>
</tr>
<tr>
<td align="center">–audit-log-truncate-enabled</td>
<td align="center">是否启用事件和batch截断功能。</td>
</tr>
<tr>
<td align="center">–audit-log-path</td>
<td align="center">如果设置，表示所有到apiserver的请求都会记录到这个文件中，‘-’表示写入标准输出</td>
</tr>
<tr>
<td align="center">–audit-policy-file</td>
<td align="center">定义审计策略配置文件的路径，需要打开 ‘AdvancedAuditing’ 特性开关，AdvancedAuditing 需要一个配置来启用审计功能</td>
</tr>
<tr>
<td align="center">–profiling</td>
<td align="center">在 web 接口 host:port/debug/pprof/ 上启用 profiling（默认值 true）</td>
</tr>
<tr>
<td align="center">–anonymous-auth</td>
<td align="center">启用到 API server 的安全端口的匿名请求，未被其他认证方法拒绝的请求被当做匿名请求，匿名请求的用户名为 system:anonymous，用户组名为 system:unauthenticated（默认值 true）</td>
</tr>
<tr>
<td align="center">–client-ca-file</td>
<td align="center">如果设置此标志，对于任何请求，如果存包含 client-ca-file 中的 authorities 签名的客户端证书，将会使用客户端证书中的 CommonName 对应的身份进行认证</td>
</tr>
<tr>
<td align="center">–enable-bootstrap-token-auth</td>
<td align="center">启用此选项以允许 ‘kube-system’ 命名空间中的 ‘bootstrap.kubernetes.io/token’ 类型密钥可以被用于 TLS 的启动认证</td>
</tr>
<tr>
<td align="center">–requestheader-allowed-names</td>
<td align="center">使用 –requestheader-username-headers 指定的，允许在头部提供用户名的客户端证书通用名称列表。如果为空，任何通过 –requestheader-client-ca-file 中 authorities 验证的客户端证书都是被允许的</td>
</tr>
<tr>
<td align="center">–requestheader-client-ca-file</td>
<td align="center">在信任请求头中以 –requestheader-username-headers 指示的用户名之前，用于验证接入请求中客户端证书的根证书捆绑</td>
</tr>
<tr>
<td align="center">–requestheader-extra-headers-prefix=“X-Remote-Extra-”</td>
<td align="center">用于检查的请求头的前缀列表，建议使用 X-Remote-Extra-</td>
</tr>
<tr>
<td align="center">–requestheader-group-headers=X-Remote-Group</td>
<td align="center">用于检查群组的请求头列表，建议使用 X-Remote-Group</td>
</tr>
<tr>
<td align="center">–requestheader-username-headers=X-Remote-User</td>
<td align="center">用于检查用户名的请求头列表，建议使用 X-Remote-User</td>
</tr>
<tr>
<td align="center">–service-account-key-file</td>
<td align="center">包含 PEM 加密的 x509 RSA 或 ECDSA 私钥或公钥的文件，用于验证 ServiceAccount 令牌，如果设置该值，–tls-private-key-file 将会被使用，指定的文件可以包含多个密钥，并且这个标志可以和不同的文件一起多次使用</td>
</tr>
<tr>
<td align="center">–authorization-mode=Node,RBAC</td>
<td align="center">在安全端口上进行权限验证的插件的顺序列表，以逗号分隔的列表，包括：AlwaysAllow,AlwaysDeny,ABAC,Webhook,RBAC,Node.（默认值 “AlwaysAllow”）</td>
</tr>
<tr>
<td align="center">–runtime-config=api/all=true</td>
<td align="center">传递给 apiserver 用于描述运行时配置的键值对集合</td>
</tr>
<tr>
<td align="center">–enable-admission-plugins=NodeRestriction</td>
<td align="center">资源限制的相关配置</td>
</tr>
<tr>
<td align="center">–allow-privileged=true</td>
<td align="center">如果为 true, 将允许特权容器</td>
</tr>
<tr>
<td align="center">–apiserver-count=3</td>
<td align="center">集群中运行的 apiserver 数量，必须为正数（默认值 1</td>
</tr>
<tr>
<td align="center">–event-ttl=168h</td>
<td align="center">事件驻留时间（默认值 1h0m0s)</td>
</tr>
<tr>
<td align="center">–kubelet-certificate-authority</td>
<td align="center">证书 authority 的文件路径</td>
</tr>
<tr>
<td align="center">–kubelet-client-certificate</td>
<td align="center">用于 TLS 的客户端证书文件路径</td>
</tr>
<tr>
<td align="center">–kubelet-client-key</td>
<td align="center">用于 TLS 的客户端证书密钥文件路径</td>
</tr>
<tr>
<td align="center">–kubelet-https=true</td>
<td align="center">为 kubelet 启用 https（默认值 true）</td>
</tr>
<tr>
<td align="center">–kubelet-timeout=10s</td>
<td align="center">kubelet 操作超时时间（默认值5秒）</td>
</tr>
<tr>
<td align="center">–proxy-client-cert-file</td>
<td align="center">当必须调用外部程序时，用于证明 aggregator 或者 kube-apiserver 的身份的客户端证书，包括代理到用户 api-server 的请求和调用 webhook 准入控制插件的请求，它期望这个证书包含一个来自于 CA 中的 –requestheader-client-ca-file 标记的签名，该 CA 在 kube-system 命名空间的 ‘extension-apiserver-authentication’ configmap 中发布，从 Kube-aggregator 收到调用的组件应该使用该 CA 进行他们部分的双向 TLS 验证</td>
</tr>
<tr>
<td align="center">–proxy-client-key-file</td>
<td align="center">当必须调用外部程序时，用于证明 aggregator 或者 kube-apiserver 的身份的客户端证书密钥。包括代理到用户 api-server 的请求和调用 webhook 准入控制插件的请求</td>
</tr>
<tr>
<td align="center">–service-cluster-ip-range</td>
<td align="center">Service网络地址分配 ，CIDR 表示的 IP 范围，服务的 cluster ip 将从中分配， 一定不要和分配给 nodes 和 pods 的 IP 范围产生重叠</td>
</tr>
<tr>
<td align="center">–service-node-port-range</td>
<td align="center">Service使用的端口范围</td>
</tr>
<tr>
<td align="center">–logtostderr=true</td>
<td align="center">输出日志到标准错误控制台，不输出到文件</td>
</tr>
<tr>
<td align="center">–v=2</td>
<td align="center">指定输出日志的级别</td>
</tr>
</tbody></table>
<h3 id="生成kube-controller-manager-service-配置启动文件"><a href="#生成kube-controller-manager-service-配置启动文件" class="headerlink" title="生成kube-controller-manager.service 配置启动文件"></a>生成kube-controller-manager.service 配置启动文件</h3><p>kube-controller-manager（k8s控制器管理器）是一个守护进程，它通过kube-apiserver监视集群的共享状态（kube-apiserver收集或监视到的一些集群资源状态，供kube-controller-manager或其它客户端watch）, 控制器管理器并尝试将当前的状态向所定义的状态迁移（移动、靠近），它本身是有状态的，会修改集群状态信息，如果多个控制器管理器同时生效，则会有一致性问题，所以kube-controller-manager的高可用，只能是主备模式，而kubernetes集群是采用租赁锁实现leader选举，需要在启动参数中加入–leader-elect=true。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Controller Manager</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/bin/kube-controller-manager \\</span><br><span class="line">  --profiling \\</span><br><span class="line">  <span class="attribute">--cluster-name</span>=kubernetes \\</span><br><span class="line">  <span class="attribute">--controllers</span>=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">  <span class="attribute">--kube-api-qps</span>=1000 \\</span><br><span class="line">  <span class="attribute">--kube-api-burst</span>=2000 \\</span><br><span class="line">  --leader-elect \\</span><br><span class="line">  --use-service-account-credentials\\</span><br><span class="line">  <span class="attribute">--concurrent-service-syncs</span>=2 \\</span><br><span class="line">  <span class="attribute">--bind-address</span>=0.0.0.0 \\</span><br><span class="line">  <span class="attribute">--secure-port</span>=10257 \\</span><br><span class="line">  <span class="attribute">--tls-cert-file</span>=/var/lib/kubernetes/kube-controller-manager.pem \\</span><br><span class="line">  <span class="attribute">--tls-private-key-file</span>=/var/lib/kubernetes/kube-controller-manager-key.pem \\</span><br><span class="line">  <span class="attribute">--port</span>=10252 \\</span><br><span class="line">  <span class="attribute">--authentication-kubeconfig</span>=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  <span class="attribute">--client-ca-file</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-client-ca-file</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-extra-headers-prefix</span>=<span class="string">"X-Remote-Extra-"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-group-headers</span>=X-Remote-Group \\</span><br><span class="line">  <span class="attribute">--requestheader-username-headers</span>=X-Remote-User \\</span><br><span class="line">  <span class="attribute">--authorization-kubeconfig</span>=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  <span class="attribute">--cluster-signing-cert-file</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  <span class="attribute">--cluster-signing-key-file</span>=/var/lib/kubernetes/ca-key.pem \\</span><br><span class="line">  <span class="attribute">--experimental-cluster-signing-duration</span>=876000h \\</span><br><span class="line">  <span class="attribute">--horizontal-pod-autoscaler-sync-period</span>=10s \\</span><br><span class="line">  <span class="attribute">--concurrent-deployment-syncs</span>=10 \\</span><br><span class="line">  <span class="attribute">--concurrent-gc-syncs</span>=30 \\</span><br><span class="line">  <span class="attribute">--node-cidr-mask-size</span>=24 \\</span><br><span class="line">  <span class="attribute">--service-cluster-ip-range</span>=10.250.0.0/16 \\</span><br><span class="line">  <span class="attribute">--pod-eviction-timeout</span>=6m \\</span><br><span class="line">  <span class="attribute">--terminated-pod-gc-threshold</span>=10000 \\</span><br><span class="line">  <span class="attribute">--root-ca-file</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  <span class="attribute">--service-account-private-key-file</span>=/var/lib/kubernetes/service-account-key.pem \\</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"></span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>原第22行出问题的配置项</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">--requestheader-allowed-names</span>=<span class="string">""</span> \\</span><br></pre></td></tr></table></figure>

<p>拷贝配置文件到另外节点</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>kube-controller-manager.service k8s-<span class="string">master2:</span><span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span></span><br><span class="line">scp <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>kube-controller-manager.service k8s-<span class="string">master3:</span><span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span></span><br></pre></td></tr></table></figure>

<p><strong>配置详解</strong></p>
<table>
<thead>
<tr>
<th align="center">配置选项</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–profiling</td>
<td align="center">通过web界面启动分析接口，host:port/debug/pprof/</td>
</tr>
<tr>
<td align="center">–cluster-name=kubernetes</td>
<td align="center">集群名称，默认是kubernetes</td>
</tr>
<tr>
<td align="center">–controllers=*,bootstrapsigner,tokencleaner</td>
<td align="center">*是启用默认启用所有控制器，但bootstrapsigner,tokencleaner 这两个控制器默认是禁用的，需要人为指定启用</td>
</tr>
<tr>
<td align="center">–kube-api-qps=1000</td>
<td align="center">与kube-apiserver通信时的QPS</td>
</tr>
<tr>
<td align="center">–kube-api-burst=2000</td>
<td align="center">与kube-apiserver通信时使用</td>
</tr>
<tr>
<td align="center">–leader-elect</td>
<td align="center">高可用时启用选举功能</td>
</tr>
<tr>
<td align="center">–use-service-account-credentials</td>
<td align="center">如果为true，为每个控制器使用单独的service account</td>
</tr>
<tr>
<td align="center">–concurrent-service-syncs=2</td>
<td align="center">允许同时同步Service数量，数字越大，服务管理响应越快，同时消耗更多的CPU和网络资源；</td>
</tr>
<tr>
<td align="center">–bind-address=0.0.0.0</td>
<td align="center">监控地址</td>
</tr>
<tr>
<td align="center">–secure-port=10257</td>
<td align="center">提供HTTPS服务，默认端口为10257，如果为0，不提供https服务</td>
</tr>
<tr>
<td align="center">–tls-cert-file</td>
<td align="center">指定x509证书文件，如果启用了HTTPS服务，但是 –tls-cert-file和–tls-private-key-file 未提供，则会为公共地址生成自签名证书和密钥，并将其保存到–cert-dir指定的目录中。</td>
</tr>
<tr>
<td align="center">–tls-private-key-file</td>
<td align="center">指定与–tls-cert-file对应的私钥</td>
</tr>
<tr>
<td align="center">–port=10252</td>
<td align="center">提供HTTP服务，不认证，如果设置0，不提供HTTP服务，默认值是10252</td>
</tr>
<tr>
<td align="center">–authentication-kubeconfig</td>
<td align="center">kube-controller-kube-controller-manager也是kube-apiserver的客户端，也可以使用kubeconfig方式访问kube-apiserver，</td>
</tr>
<tr>
<td align="center">–client-ca-file</td>
<td align="center">启用客户端证书认证</td>
</tr>
<tr>
<td align="center">–requestheader-allowed-names=“aggregator”</td>
<td align="center">允许通过的客户端证书Common Name列表，可以提供 –requestheader-username-headers 中的 Header 的用户名。如果为空，则所有通过–requestheader-client-ca-file校验的都允许通过</td>
</tr>
<tr>
<td align="center">–requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem</td>
<td align="center">针对收到的请求，在信任–requestheader-username-header指定的header里包含的用户名之前，验证客户端证书的根证书</td>
</tr>
<tr>
<td align="center">–requestheader-extra-headers-prefix=“X-Remote-Extra-”</td>
<td align="center">要检查的请求头前缀列表，建议使用 X-Remote-Extra-</td>
</tr>
<tr>
<td align="center">–requestheader-group-headers=X-Remote-Group</td>
<td align="center">请求头中需要检查的组名</td>
</tr>
<tr>
<td align="center">–requestheader-username-headers=X-Remote-User</td>
<td align="center">请求头中需要检查的用户名</td>
</tr>
<tr>
<td align="center">–authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</td>
<td align="center">指定kubeconfig配置文件路径</td>
</tr>
<tr>
<td align="center">–cluster-signing-cert-file=/etc/kubernetes/cert/ca.pem</td>
<td align="center">指定用于集群签发的所有集群范围内证书文件（根证书文件）</td>
</tr>
<tr>
<td align="center">–cluster-signing-key-file=/etc/kubernetes/cert/ca-key.pem</td>
<td align="center">指定集群签发证书的key</td>
</tr>
<tr>
<td align="center">–experimental-cluster-signing-duration=876000h</td>
<td align="center">证书签发时间</td>
</tr>
<tr>
<td align="center">–horizontal-pod-autoscaler-sync-period=10s</td>
<td align="center">HPA控制器检查周期</td>
</tr>
<tr>
<td align="center">–concurrent-deployment-syncs=10</td>
<td align="center">允许并发同步的Deployment对象的数量，更大的数量等于更快的部署响应</td>
</tr>
<tr>
<td align="center">–concurrent-gc-syncs=30</td>
<td align="center">允许并发同步的垃圾收集器数量。默认值20</td>
</tr>
<tr>
<td align="center">–node-cidr-mask-size=24</td>
<td align="center">node节点的CIDR掩码，默认是24</td>
</tr>
<tr>
<td align="center">–service-cluster-ip-range=10.254.0.0/16</td>
<td align="center">集群Services 的CIDR范围</td>
</tr>
<tr>
<td align="center">–pod-eviction-timeout=6m</td>
<td align="center">在失败节点删除Pod的宽限期，默认是300秒</td>
</tr>
<tr>
<td align="center">–terminated-pod-gc-threshold=10000</td>
<td align="center">在Pod垃圾收集器开始删除终止Pod前，允许存在终止的Pod数量，默认是12500</td>
</tr>
<tr>
<td align="center">–root-ca-file=/etc/kubernetes/cert/ca.pem</td>
<td align="center">如果设置，该根证书权限将包含service acount的toker secret，这必须是一个有效的PEM编码CA 包</td>
</tr>
<tr>
<td align="center">–service-account-private-key-file=/etc/kubernetes/cert/ca-key.pem</td>
<td align="center">包含用于签署service account token的PEM编码RSA或者ECDSA私钥的文件名</td>
</tr>
<tr>
<td align="center">–kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</td>
<td align="center">指定kubeconfig配置文件</td>
</tr>
<tr>
<td align="center">–logtostderr=true</td>
<td align="center">错误日志到标准输出，而不是文件</td>
</tr>
<tr>
<td align="center">–v=2</td>
<td align="center">日志级别</td>
</tr>
</tbody></table>
<p> 1 控制器管理器管理控制器，各个控制器负责监视（watch）apiserver暴露的集群状态，并不断地尝试把当前状态向所期待的状态迁移；</p>
<ol>
<li>配置使用kubeconfig访问kube-apiserver安全端口；</li>
<li>默认非安全端口10252，安全端口10257；</li>
<li>kube-controller-manager 3节点高可用，去竞争锁，成为leader；</li>
</ol>
<h3 id="生成kube-scheduler-service配置启动文件"><a href="#生成kube-scheduler-service配置启动文件" class="headerlink" title="生成kube-scheduler.service配置启动文件"></a>生成kube-scheduler.service配置启动文件</h3><p>kube-scheduler作为kubemaster核心组件运行在master节点上面，主要是watch kube-apiserver中未被调度的Pod，如果有，通过调度算法找到最适合的节点Node，然后通过kube-apiserver以对象（pod名称、Node节点名称等）的形式写入到etcd中来完成调度，kube-scheduler的高可用与kube-controller-manager一样，需要使用选举的方式产生。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">  echo <span class="string">"---<span class="variable">$host</span>---"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"mkdir /etc/kubernetes/config/ -p"</span></span><br><span class="line">done</span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/kubernetes/config/kube-scheduler.yaml</span><br><span class="line">apiVersion: kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeSchedulerConfiguration</span><br><span class="line">bindTimeoutSeconds: 600</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/var/lib/kubernetes/kube-scheduler.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">enableContentionProfiling: <span class="literal">false</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">hardPodAffinitySymmetricWeight: 1</span><br><span class="line">healthzBindAddress: 127.0.0.1:10251</span><br><span class="line">leaderElection:</span><br><span class="line">  leaderElect: <span class="literal">true</span> </span><br><span class="line">metricsBindAddress: <span class="variable">$MASTER1_IP</span>:10251</span><br><span class="line">EOF</span><br><span class="line">cat &lt;&lt;EOF | tee /etc/systemd/system/kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Scheduler</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/bin/kube-scheduler \\</span><br><span class="line">  <span class="attribute">--config</span>=/etc/kubernetes/config/kube-scheduler.yaml \\</span><br><span class="line">  <span class="attribute">--bind-address</span>=<span class="variable">$MASTER1_IP</span> \\</span><br><span class="line">  <span class="attribute">--secure-port</span>=10259 \\</span><br><span class="line">  <span class="attribute">--port</span>=10251 \\</span><br><span class="line">  <span class="attribute">--tls-cert-file</span>=/var/lib/kubernetes/kube-scheduler.pem \\</span><br><span class="line">  <span class="attribute">--tls-private-key-file</span>=/var/lib/kubernetes/kube-scheduler-key.pem \\</span><br><span class="line">  <span class="attribute">--authentication-kubeconfig</span>=/var/lib/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  <span class="attribute">--client-ca-file</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-allowed-names</span>=<span class="string">"aggregator"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-client-ca-file</span>=/var/lib/kubernetes/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-extra-headers-prefix</span>=<span class="string">"X-Remote-Extra-"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-group-headers</span>=X-Remote-Group \\</span><br><span class="line">  <span class="attribute">--requestheader-username-headers</span>=X-Remote-User \\</span><br><span class="line">  <span class="attribute">--authorization-kubeconfig</span>=/var/lib/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>拷贝配置文件到另外节点并修改其配置！！！</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scp <span class="regexp">/etc/</span>kubernetes<span class="regexp">/config/</span>kube-scheduler.yaml k8s-<span class="string">master2:</span><span class="regexp">/etc/</span>kubernetes<span class="regexp">/config/</span></span><br><span class="line">scp <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>kube-scheduler.service k8s-<span class="string">master2:</span><span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scp <span class="regexp">/etc/</span>kubernetes<span class="regexp">/config/</span>kube-scheduler.yaml k8s-<span class="string">master3:</span><span class="regexp">/etc/</span>kubernetes<span class="regexp">/config/</span></span><br><span class="line">scp <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>kube-scheduler.service k8s-<span class="string">master3:</span><span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span></span><br></pre></td></tr></table></figure>

<p><strong>启动参数详解</strong></p>
<table>
<thead>
<tr>
<th align="center">配置选项</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–config=/etc/kubernetes/kube-scheduler.yaml</td>
<td align="center">配置文件的路径</td>
</tr>
<tr>
<td align="center">–bind-address=</td>
<td align="center">监控地址</td>
</tr>
<tr>
<td align="center">–secure-port=10259</td>
<td align="center">监听的安全端口，设置为0，不提供安全端口</td>
</tr>
<tr>
<td align="center">–port=10251</td>
<td align="center">监听非安全端口，设置为0，不提供非安全端口</td>
</tr>
<tr>
<td align="center">–tls-cert-file=/etc/kubernetes/cert/kube-scheduler.pem</td>
<td align="center">包含默认的 HTTPS x509 证书的文件，（CA证书（如果有）在服务器证书之后并置），如果启用了 HTTPS 服务，并且未提供 –tls-cert-file 和 –tls-private-key-file，则会为公共地址生成一个自签名证书和密钥，并将其保存到 –cert-dir 指定的目录中</td>
</tr>
<tr>
<td align="center">–tls-private-key-file=/etc/kubernetes/cert/kube-scheduler-key.pem</td>
<td align="center">包含与 –tls-cert-file 匹配的默认 x509 私钥的文件</td>
</tr>
<tr>
<td align="center">–authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</td>
<td align="center">指定kube-scheduler做为kube-apiserver客户端时使用kubeconfig文件</td>
</tr>
<tr>
<td align="center">–client-ca-file=/etc/kubernetes/cert/ca.pem</td>
<td align="center">如果已设置，由 client-ca-file 中的授权机构签名的客户端证书的任何请求都将使用与客户端证书的 CommonName 对应的身份进行身份验证</td>
</tr>
<tr>
<td align="center">–requestheader-allowed-names=“aggregator”</td>
<td align="center">客户端证书通用名称列表允许在 –requestheader-username-headers 指定的头部中提供用户名。如果为空，则允许任何由权威机构 –requestheader-client-ca-file 验证的客户端证书。</td>
</tr>
<tr>
<td align="center">–requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem</td>
<td align="center">在信任 –requestheader-username-headers 指定的头部中的用户名之前用于验证传入请求上的客户端证书的根证书包。警告：通常不依赖于传入请求已经完成的授权。</td>
</tr>
<tr>
<td align="center">–requestheader-extra-headers-prefix=“X-Remote-Extra-”</td>
<td align="center">要检查请求头部前缀列表。建议使用 X-Remote-Extra-</td>
</tr>
<tr>
<td align="center">–requestheader-group-headers=X-Remote-Group</td>
<td align="center">用于检查组的请求头部列表。建议使用 X-Remote-Group</td>
</tr>
<tr>
<td align="center">–requestheader-username-headers=X-Remote-User</td>
<td align="center">用于检查用户名的请求头部列表。X-Remote-User 很常见。</td>
</tr>
<tr>
<td align="center">–authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</td>
<td align="center">指向具有足够权限以创建 subjectaccessreviews.authorization.k8s.io 的 ‘core’ kubernetes 服务器的 kubeconfig 文件，这是可选的，如果为空，则禁止所有未经授权跳过的请求</td>
</tr>
<tr>
<td align="center">–logtostderr=true</td>
<td align="center">日志记录到标准错误而不是文件</td>
</tr>
<tr>
<td align="center">–v=2</td>
<td align="center">日志级别详细程度的数字</td>
</tr>
</tbody></table>
<ol>
<li>kube-scheduler提供非安全端口10251， 安全端口10259；</li>
<li>kube-scheduler 部署3节点高可用，通过选举产生leader；</li>
<li>它监视kube-apiserver提供的watch接口，它根据预选和优选策略两个环节找一个最佳适配，然后调度到此节点；</li>
</ol>
<h3 id="启动各组件"><a href="#启动各组件" class="headerlink" title="启动各组件"></a>启动各组件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"---<span class="variable">$host</span>---"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"systemctl daemon-reload"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"systemctl enable --now kube-apiserver kube-controller-manager kube-scheduler"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"---<span class="variable">$host</span>---"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"systemctl daemon-reload"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"systemctl restart kube-apiserver kube-controller-manager kube-scheduler"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"---<span class="variable">$host</span>---"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"systemctl daemon-reload"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"systemctl stop kube-apiserver kube-controller-manager kube-scheduler"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>请等待10秒以便 kubernetes api server初始化</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="keyword">status</span> kube-apiserver</span><br><span class="line">systemctl <span class="keyword">status</span> kube-controller-manager</span><br><span class="line">systemctl <span class="keyword">status</span> kube-scheduler</span><br></pre></td></tr></table></figure>

<h3 id="拷贝admin-的kubeconfig-为kubectl默认读取的-kube-config"><a href="#拷贝admin-的kubeconfig-为kubectl默认读取的-kube-config" class="headerlink" title="拷贝admin 的kubeconfig 为kubectl默认读取的.kube/config"></a>拷贝admin 的kubeconfig 为kubectl默认读取的.kube/config</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd</span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3; <span class="keyword">do</span></span><br><span class="line">  echo <span class="string">"---<span class="variable">$host</span>---"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"mkdir /root/.kube -p"</span></span><br><span class="line">  scp /root/ssl/kubernetes/admin.kubeconfig <span class="variable">$host</span>:/root/.kube/config</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>查看集群信息</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kubectl</span> cluster-<span class="literal">info</span></span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Kubernetes master <span class="keyword">is</span> running at https://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8443</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span> further <span class="keyword">debug</span> <span class="keyword">and</span> diagnose <span class="keyword">cluster</span> problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br></pre></td></tr></table></figure>

<p>查看 cs信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">get</span> cs</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="-1"><a href="#-1" class="headerlink" title></a></h3><h1 id="Kubelet-RBAC-授权"><a href="#Kubelet-RBAC-授权" class="headerlink" title="Kubelet RBAC 授权"></a>Kubelet RBAC 授权</h1><h3 id="注意-本文所有操作均在master节点执行-2"><a href="#注意-本文所有操作均在master节点执行-2" class="headerlink" title="注意 本文所有操作均在master节点执行"></a>注意 本文所有操作均在master节点执行</h3><p>本节将会配置 API Server 访问 Kubelet API 的 RBAC 授权。访问 Kubelet API 是获取 metrics、日志以及执行容器命令所必需的。</p>
<p>所有操作均在主节点操作</p>
<p>这里设置 Kubeket –authorization-mode 为 Webhook 模式。Webhook 模式使用 SubjectAccessReview API 来决定授权。<br>创建 system:kube-apiserver-to-kubelet ClusterRole 以允许请求 Kubelet API 和执行大部分来管理 Pods 的任务:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /root/ssl/kubernetes</span><br><span class="line"><span class="keyword">cat</span> &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -<span class="keyword">f</span> -</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadat<span class="variable">a:</span></span><br><span class="line">  annotation<span class="variable">s:</span></span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  label<span class="variable">s:</span></span><br><span class="line">    kubernetes.io/bootstrappin<span class="variable">g:</span> rbac-defaults</span><br><span class="line">  name: <span class="built_in">system</span>:kube-apiserver-<span class="keyword">to</span>-kubelet</span><br><span class="line">rule<span class="variable">s:</span></span><br><span class="line">  - apiGroup<span class="variable">s:</span></span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resource<span class="variable">s:</span></span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/<span class="built_in">log</span></span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">    <span class="keyword">verb</span><span class="variable">s:</span></span><br><span class="line">      - <span class="string">"*"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clusterrole.rbac.<span class="keyword">authorization</span>.k8s.io/<span class="keyword">system</span>:kube-apiserver-<span class="keyword">to</span>-kubelet created</span><br></pre></td></tr></table></figure>

<p>Kubernetes API Server 使用客户端凭证授权 Kubelet 为 kubernetes 用户，此凭证用 –kubelet-client-certificate flag 来定义。</p>
<p>绑定 system:kube-apiserver-to-kubelet ClusterRole 到 kubernetes 用户:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cat</span> <span class="string">&lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">system:kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">""</span></span><br><span class="line"><span class="attr">roleRef</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">apiGroup</span>: <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind</span>: <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">system:kube-apiserver-to-kubelet</span></span><br><span class="line"><span class="attr">subjects</span>:<span class="string"></span></span><br><span class="line">  <span class="meta">-</span> <span class="string">apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line">    <span class="attr">kind</span>: <span class="string">User</span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">EOF</span></span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clusterrolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span>.io/system:kube-apiserver created</span><br></pre></td></tr></table></figure>

<h1 id="部署node节点"><a href="#部署node节点" class="headerlink" title="部署node节点"></a>部署node节点</h1><h3 id="注意-本文所有操作所有节点执行"><a href="#注意-本文所有操作所有节点执行" class="headerlink" title="注意 本文所有操作所有节点执行"></a>注意 本文所有操作所有节点执行</h3><p>本部分将会部署 Kubernetes 工作节点。每个节点上将会安装以下服务：<br>container networking plugins<br>kubelet<br>kube-proxy</p>
<p>安装依赖<br>安装 OS 依赖组件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3 k8s-node1;<span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"---<span class="variable">$host</span>---"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"yum install -y socat conntrack ipset"</span>;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>socat 命令用于支持 kubectl port-forward 命令。</p>
<p>下载worker 二进制文件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/containernetworking/</span>plugins<span class="regexp">/releases/</span>download<span class="regexp">/v0.8.2/</span>cni-plugins-linux-amd64-v0.<span class="number">8.2</span>.tgz</span><br></pre></td></tr></table></figure>

<p>解压cni插件</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf cni-plugins-linux-amd64-v0.<span class="number">8.2</span>.tgz -C /opt/cni/bin/</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master2 k8s-master3 k8s-node1; <span class="keyword">do</span></span><br><span class="line">  echo <span class="string">"---$host---"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"mkdir /opt/cni/bin/ -p"</span></span><br><span class="line">  scp /opt/cni/bin/* <span class="variable">$host</span><span class="symbol">:/opt/cni/bin/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>生成kubelet.service systemd服务文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | sudo tee /etc/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Kubelet</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/kubernetes/kubernetes</span><br><span class="line"><span class="attribute">After</span>=docker.service</span><br><span class="line"><span class="attribute">Requires</span>=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/bin/kubelet \\</span><br><span class="line">   <span class="attribute">--config</span>=/var/lib/kubelet/kubelet-config.yaml \\</span><br><span class="line">  <span class="attribute">--image-pull-progress-deadline</span>=2m \\</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/var/lib/kubelet/kubeconfig \\</span><br><span class="line">  <span class="attribute">--pod-infra-container-image</span>=cargo.caicloud.io/caicloud/pause-amd64:3.1 \\</span><br><span class="line">  <span class="attribute">--network-plugin</span>=cni \\</span><br><span class="line">  <span class="attribute">--register-node</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2 \\</span><br><span class="line">  <span class="attribute">--container-runtime</span>=docker \\</span><br><span class="line">  <span class="attribute">--container-runtime-endpoint</span>=unix:///var/run/dockershim.sock \\</span><br><span class="line">  <span class="attribute">--image-pull-progress-deadline</span>=15m</span><br><span class="line"></span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>拷贝启动文件到其他节点</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master2 k8s-master3 k8s-node1; <span class="keyword">do</span></span><br><span class="line">  echo <span class="string">"---$host---"</span></span><br><span class="line">  scp /etc/systemd/system/kubelet.service <span class="variable">$host</span><span class="symbol">:/etc/systemd/system/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p><strong>配置参数详解</strong></p>
<table>
<thead>
<tr>
<th align="center">配置选项</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–bootstrap-kubeconfig</td>
<td align="center">指定令牌认证文件</td>
</tr>
<tr>
<td align="center">–cert-dir</td>
<td align="center">设置kube-controller-manager生成证书和私钥的目录</td>
</tr>
<tr>
<td align="center">–cni-conf-dir=</td>
<td align="center">指定cni配置文件目录</td>
</tr>
<tr>
<td align="center">–container-runtime=docker</td>
<td align="center">指定容器运行时引擎</td>
</tr>
<tr>
<td align="center">–container-runtime-endpoint=</td>
<td align="center">监听的unix socket位置（Windows上面为 tcp 端口）。</td>
</tr>
<tr>
<td align="center">–root-dir=</td>
<td align="center">kubelet 保存数据的目录，默认：/var/lib/kubelet</td>
</tr>
<tr>
<td align="center">–kubeconfig=</td>
<td align="center">kubelet作为客户端使用的kubeconfig认证文件，此文件是由kube-controller-mananger生成的</td>
</tr>
<tr>
<td align="center">–config=</td>
<td align="center">指定kubelet配置文件</td>
</tr>
<tr>
<td align="center">–hostname-override=</td>
<td align="center">用来配置该节点在集群中显示的主机名，kubelet设置了-–hostname-override参数后，kube-proxy也需要设置，否则会出现找不到Node的情况</td>
</tr>
<tr>
<td align="center">–pod-infra-container-image=</td>
<td align="center">每个pod中的network/ipc 名称空间容器将使用的镜像</td>
</tr>
<tr>
<td align="center">–image-pull-progress-deadline=</td>
<td align="center">镜像拉取进度最大时间，如果在这段时间拉取镜像没有任何进展，将取消拉取，默认：1m0s</td>
</tr>
<tr>
<td align="center">–volume-plugin-dir=</td>
<td align="center">第三方卷插件的完整搜索路径，默认：”/usr/libexec/kubernetes/kubelet-plugins/volume/exec/“</td>
</tr>
<tr>
<td align="center">–logtostderr=true</td>
<td align="center">日志记录到标准错误而不是文件</td>
</tr>
<tr>
<td align="center">–v=2</td>
<td align="center">日志级别详细程度的数字</td>
</tr>
</tbody></table>
<p>master1节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">/var/lib/kubelet/kubelet-config.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">  <span class="attr">anonymous:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">webhook:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">x509:</span></span><br><span class="line">    <span class="attr">clientCAFile:</span> <span class="string">"/var/lib/kubernetes/ca.pem"</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">Webhook</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">"cluster.local"</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"10.250.0.10"</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">"15m"</span></span><br><span class="line"><span class="attr">tlsCertFile:</span> <span class="string">"/var/lib/kubelet/k8s-master1.pem"</span></span><br><span class="line"><span class="attr">tlsPrivateKeyFile:</span> <span class="string">"/var/lib/kubelet/k8s-master1-key.pem"</span></span><br><span class="line"><span class="attr">address:</span> <span class="string">"$MASTER1_IP"</span></span><br><span class="line"><span class="attr">staticPodPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">syncFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">fileCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">httpCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">staticPodURL:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="attr">readOnlyPort:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">serverTLSBootstrap:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">registryPullQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">registryBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">eventRecordQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">eventBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">enableDebuggingHandlers:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enableContentionProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="string">"$MASTER1_IP"</span></span><br><span class="line"><span class="attr">nodeStatusUpdateFrequency:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">nodeStatusReportFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">imageMinimumGCAge:</span> <span class="string">2m</span></span><br><span class="line"><span class="attr">imageGCHighThresholdPercent:</span> <span class="number">85</span></span><br><span class="line"><span class="attr">imageGCLowThresholdPercent:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">volumeStatsAggPeriod:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">kubeletCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">systemCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupRoot:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupsPerQOS:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">10m</span></span><br><span class="line"><span class="attr">hairpinMode:</span> <span class="string">promiscuous-bridge</span></span><br><span class="line"><span class="attr">maxPods:</span> <span class="number">220</span></span><br><span class="line"><span class="attr">podCIDR:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line"><span class="attr">podPidsLimit:</span> <span class="number">-1</span></span><br><span class="line"><span class="attr">resolvConf:</span> <span class="string">/etc/resolv.conf</span></span><br><span class="line"><span class="attr">maxOpenFiles:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">kubeAPIQPS:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">kubeAPIBurst:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">serializeImagePulls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">evictionHard:</span></span><br><span class="line">  <span class="attr">memory.available:</span> <span class="string">"100Mi"</span></span><br><span class="line">  <span class="attr">nodefs.available:</span> <span class="string">"10%"</span></span><br><span class="line">  <span class="attr">nodefs.inodesFree:</span> <span class="string">"5%"</span></span><br><span class="line">  <span class="attr">imagefs.available:</span> <span class="string">"15%"</span></span><br><span class="line"><span class="attr">evictionSoft:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">enableControllerAttachDetach:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">containerLogMaxSize:</span> <span class="string">20Mi</span></span><br><span class="line"><span class="attr">containerLogMaxFiles:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">systemReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">kubeReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">systemReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kubeReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">enforceNodeAllocatable:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>master2节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">/var/lib/kubelet/k8s-master2.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">  <span class="attr">anonymous:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">webhook:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">x509:</span></span><br><span class="line">    <span class="attr">clientCAFile:</span> <span class="string">"/var/lib/kubernetes/ca.pem"</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">Webhook</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">"cluster.local"</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"10.250.0.10"</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">"15m"</span></span><br><span class="line"><span class="attr">tlsCertFile:</span> <span class="string">"/var/lib/kubelet/k8s-master2.pem"</span></span><br><span class="line"><span class="attr">tlsPrivateKeyFile:</span> <span class="string">"/var/lib/kubelet/k8s-master2-key.pem"</span></span><br><span class="line"><span class="attr">address:</span> <span class="string">"$MASTER2_IP"</span></span><br><span class="line"><span class="attr">staticPodPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">syncFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">fileCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">httpCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">staticPodURL:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="attr">readOnlyPort:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">serverTLSBootstrap:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">registryPullQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">registryBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">eventRecordQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">eventBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">enableDebuggingHandlers:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enableContentionProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="string">"$MASTER2_IP"</span></span><br><span class="line"><span class="attr">nodeStatusUpdateFrequency:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">nodeStatusReportFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">imageMinimumGCAge:</span> <span class="string">2m</span></span><br><span class="line"><span class="attr">imageGCHighThresholdPercent:</span> <span class="number">85</span></span><br><span class="line"><span class="attr">imageGCLowThresholdPercent:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">volumeStatsAggPeriod:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">kubeletCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">systemCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupRoot:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupsPerQOS:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">10m</span></span><br><span class="line"><span class="attr">hairpinMode:</span> <span class="string">promiscuous-bridge</span></span><br><span class="line"><span class="attr">maxPods:</span> <span class="number">220</span></span><br><span class="line"><span class="attr">podCIDR:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line"><span class="attr">podPidsLimit:</span> <span class="number">-1</span></span><br><span class="line"><span class="attr">resolvConf:</span> <span class="string">/etc/resolv.conf</span></span><br><span class="line"><span class="attr">maxOpenFiles:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">kubeAPIQPS:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">kubeAPIBurst:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">serializeImagePulls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">evictionHard:</span></span><br><span class="line">  <span class="attr">memory.available:</span> <span class="string">"100Mi"</span></span><br><span class="line">  <span class="attr">nodefs.available:</span> <span class="string">"10%"</span></span><br><span class="line">  <span class="attr">nodefs.inodesFree:</span> <span class="string">"5%"</span></span><br><span class="line">  <span class="attr">imagefs.available:</span> <span class="string">"15%"</span></span><br><span class="line"><span class="attr">evictionSoft:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">enableControllerAttachDetach:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">containerLogMaxSize:</span> <span class="string">20Mi</span></span><br><span class="line"><span class="attr">containerLogMaxFiles:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">systemReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">kubeReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">systemReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kubeReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">enforceNodeAllocatable:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">scp</span> <span class="string">/var/lib/kubelet/k8s-master2.yaml</span> <span class="string">k8s-master2:/var/lib/kubelet/kubelet-config.yaml</span></span><br><span class="line"><span class="string">rm</span> <span class="string">-rf</span> <span class="string">/var/lib/kubelet/k8s-master2.yaml</span></span><br></pre></td></tr></table></figure>

<p>k8s-master3 节点的配置文件 在master主机上写入文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">/var/lib/kubelet/k8s-master3.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">  <span class="attr">anonymous:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">webhook:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">x509:</span></span><br><span class="line">    <span class="attr">clientCAFile:</span> <span class="string">"/var/lib/kubernetes/ca.pem"</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">Webhook</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">"cluster.local"</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"10.250.0.10"</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">"15m"</span></span><br><span class="line"><span class="attr">tlsCertFile:</span> <span class="string">"/var/lib/kubelet/k8s-master3.pem"</span></span><br><span class="line"><span class="attr">tlsPrivateKeyFile:</span> <span class="string">"/var/lib/kubelet/k8s-master3-key.pem"</span></span><br><span class="line"><span class="attr">address:</span> <span class="string">"$MASTER3_IP"</span></span><br><span class="line"><span class="attr">staticPodPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">syncFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">fileCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">httpCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">staticPodURL:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="attr">readOnlyPort:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">serverTLSBootstrap:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">registryPullQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">registryBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">eventRecordQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">eventBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">enableDebuggingHandlers:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enableContentionProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="string">"$MASTER3_IP"</span></span><br><span class="line"><span class="attr">nodeStatusUpdateFrequency:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">nodeStatusReportFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">imageMinimumGCAge:</span> <span class="string">2m</span></span><br><span class="line"><span class="attr">imageGCHighThresholdPercent:</span> <span class="number">85</span></span><br><span class="line"><span class="attr">imageGCLowThresholdPercent:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">volumeStatsAggPeriod:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">kubeletCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">systemCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupRoot:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupsPerQOS:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">10m</span></span><br><span class="line"><span class="attr">hairpinMode:</span> <span class="string">promiscuous-bridge</span></span><br><span class="line"><span class="attr">maxPods:</span> <span class="number">220</span></span><br><span class="line"><span class="attr">podCIDR:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line"><span class="attr">podPidsLimit:</span> <span class="number">-1</span></span><br><span class="line"><span class="attr">resolvConf:</span> <span class="string">/etc/resolv.conf</span></span><br><span class="line"><span class="attr">maxOpenFiles:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">kubeAPIQPS:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">kubeAPIBurst:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">serializeImagePulls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">evictionHard:</span></span><br><span class="line">  <span class="attr">memory.available:</span> <span class="string">"100Mi"</span></span><br><span class="line">  <span class="attr">nodefs.available:</span> <span class="string">"10%"</span></span><br><span class="line">  <span class="attr">nodefs.inodesFree:</span> <span class="string">"5%"</span></span><br><span class="line">  <span class="attr">imagefs.available:</span> <span class="string">"15%"</span></span><br><span class="line"><span class="attr">evictionSoft:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">enableControllerAttachDetach:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">containerLogMaxSize:</span> <span class="string">20Mi</span></span><br><span class="line"><span class="attr">containerLogMaxFiles:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">systemReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">kubeReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">systemReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kubeReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">enforceNodeAllocatable:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">scp</span> <span class="string">/var/lib/kubelet/k8s-master3.yaml</span> <span class="string">k8s-master3:/var/lib/kubelet/kubelet-config.yaml</span></span><br><span class="line"><span class="string">rm</span> <span class="string">-rf</span> <span class="string">/var/lib/kubelet/k8s-master3.yaml</span></span><br></pre></td></tr></table></figure>

<p>k8s-node1节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">/var/lib/kubelet/k8s-node1.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">  <span class="attr">anonymous:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">webhook:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">x509:</span></span><br><span class="line">    <span class="attr">clientCAFile:</span> <span class="string">"/var/lib/kubernetes/ca.pem"</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">Webhook</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">"cluster.local"</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"10.250.0.10"</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">"15m"</span></span><br><span class="line"><span class="attr">address:</span> <span class="string">"$NODE1_IP"</span></span><br><span class="line"><span class="attr">staticPodPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">syncFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">fileCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">httpCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">staticPodURL:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="attr">readOnlyPort:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">serverTLSBootstrap:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">registryPullQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">registryBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">eventRecordQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">eventBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">enableDebuggingHandlers:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enableContentionProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="string">"$NODE1_IP"</span></span><br><span class="line"><span class="attr">nodeStatusUpdateFrequency:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">nodeStatusReportFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">imageMinimumGCAge:</span> <span class="string">2m</span></span><br><span class="line"><span class="attr">imageGCHighThresholdPercent:</span> <span class="number">85</span></span><br><span class="line"><span class="attr">imageGCLowThresholdPercent:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">volumeStatsAggPeriod:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">kubeletCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">systemCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupRoot:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupsPerQOS:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">10m</span></span><br><span class="line"><span class="attr">hairpinMode:</span> <span class="string">promiscuous-bridge</span></span><br><span class="line"><span class="attr">maxPods:</span> <span class="number">220</span></span><br><span class="line"><span class="attr">podCIDR:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line"><span class="attr">podPidsLimit:</span> <span class="number">-1</span></span><br><span class="line"><span class="attr">resolvConf:</span> <span class="string">/etc/resolv.conf</span></span><br><span class="line"><span class="attr">maxOpenFiles:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">kubeAPIQPS:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">kubeAPIBurst:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">serializeImagePulls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">evictionHard:</span></span><br><span class="line">  <span class="attr">memory.available:</span> <span class="string">"100Mi"</span></span><br><span class="line">  <span class="attr">nodefs.available:</span> <span class="string">"10%"</span></span><br><span class="line">  <span class="attr">nodefs.inodesFree:</span> <span class="string">"5%"</span></span><br><span class="line">  <span class="attr">imagefs.available:</span> <span class="string">"15%"</span></span><br><span class="line"><span class="attr">evictionSoft:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">enableControllerAttachDetach:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">containerLogMaxSize:</span> <span class="string">20Mi</span></span><br><span class="line"><span class="attr">containerLogMaxFiles:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">systemReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">kubeReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">systemReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kubeReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">enforceNodeAllocatable:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="attr">tlsCertFile:</span> <span class="string">"/var/lib/kubelet/k8s-node1.pem"</span></span><br><span class="line"><span class="attr">tlsPrivateKeyFile:</span> <span class="string">"/var/lib/kubelet/k8s-node1-key.pem"</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">scp</span> <span class="string">/var/lib/kubelet/k8s-node1.yaml</span> <span class="string">k8s-node1:/var/lib/kubelet/kubelet-config.yaml</span></span><br><span class="line"><span class="string">rm</span> <span class="string">-rf</span> <span class="string">/var/lib/kubelet/k8s-node1.yaml</span></span><br></pre></td></tr></table></figure>

<p><strong>配置详解</strong></p>
<table>
<thead>
<tr>
<th align="center">配置选项</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">address</td>
<td align="center">kubelet 服务监听的地址</td>
</tr>
<tr>
<td align="center">staticPodPath: “”</td>
<td align="center">kubelet 会定期的扫描这个文件夹下的YAML/JSON 文件来创建/删除静态Pod，使用kubeadm安装时非常有用</td>
</tr>
<tr>
<td align="center">syncFrequency: 1m</td>
<td align="center">同步运行容器和配置之间的最大时间间隔，默认为1m</td>
</tr>
<tr>
<td align="center">fileCheckFrequency: 20s</td>
<td align="center">检查新数据配置文件的周期，默认 20s</td>
</tr>
<tr>
<td align="center">httpCheckFrequency: 20s</td>
<td align="center">通过 http 检查新数据的周期，默认 20s</td>
</tr>
<tr>
<td align="center">staticPodURL: “”</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">port: 10250</td>
<td align="center">kubelet 服务的端口，默认 10250</td>
</tr>
<tr>
<td align="center">readOnlyPort: 0</td>
<td align="center">没有认证/授权的只读 kubelet 服务端口 ，设置为 0 表示禁用，默认 10255</td>
</tr>
<tr>
<td align="center">rotateCertificates</td>
<td align="center">远程认证，默认为false</td>
</tr>
<tr>
<td align="center">serverTLSBootstrap: true</td>
<td align="center">kubelet安全引导认证，重启 Kubelet，会发现出现了新的 CSR</td>
</tr>
<tr>
<td align="center">authentication:</td>
<td align="center">认证方式有以下几种</td>
</tr>
<tr>
<td align="center">anonymous:</td>
<td align="center">匿名</td>
</tr>
<tr>
<td align="center">enabled: false</td>
<td align="center">值为false</td>
</tr>
<tr>
<td align="center">webhook:</td>
<td align="center">webhook的方式</td>
</tr>
<tr>
<td align="center">enabled: true</td>
<td align="center">值为true</td>
</tr>
<tr>
<td align="center">x509:</td>
<td align="center">x509认证</td>
</tr>
<tr>
<td align="center">clientCAFile: “/etc/kubernetes/cert/ca.pem”</td>
<td align="center">集群ca证书</td>
</tr>
<tr>
<td align="center">authorization:</td>
<td align="center">授权</td>
</tr>
<tr>
<td align="center">mode: Webhook</td>
<td align="center">授权webhook</td>
</tr>
<tr>
<td align="center">registryPullQPS</td>
<td align="center">限制每秒拉取镜像个数，设置为 0 表示不限制， 默认 5</td>
</tr>
<tr>
<td align="center">registryBurst</td>
<td align="center">仅当 –registry-qps 大于 0 时使用，设置拉取镜像的最大并发数，允许同时拉取的镜像数，不能超过 registry-qps ，默认 10</td>
</tr>
<tr>
<td align="center">eventRecordQPS</td>
<td align="center">限制每秒创建的事件数目，设置为0则不限制，默认为5</td>
</tr>
<tr>
<td align="center">eventBurst</td>
<td align="center">当–event-qps大于0时，临时允许该事件记录值超过设定值，但不能超过 event-qps 的值，默认10</td>
</tr>
<tr>
<td align="center">enableDebuggingHandlers</td>
<td align="center">启用用于日志收集和本地运行容器和命令的服务端端点，默认值：true</td>
</tr>
<tr>
<td align="center">enableContentionProfiling</td>
<td align="center">如果启用了 profiling，则启用性能分析锁</td>
</tr>
<tr>
<td align="center">healthzPort</td>
<td align="center">本地 healthz 端点的端口，设置为 0 将禁用，默认值：10248</td>
</tr>
<tr>
<td align="center">healthzBindAddress</td>
<td align="center">监听healthz 端口的地址</td>
</tr>
<tr>
<td align="center">clusterDomain: “cluster.local”</td>
<td align="center">集群域名, kubelet 将配置所有容器除了主机搜索域还将搜索当前域</td>
</tr>
<tr>
<td align="center">clusterDNS:</td>
<td align="center">DNS 服务器的IP地址列表</td>
</tr>
<tr>
<td align="center">- “10.254.0.2”</td>
<td align="center">指定一个DNS服务器地址</td>
</tr>
<tr>
<td align="center">nodeStatusUpdateFrequency: 10s</td>
<td align="center">node节点状态更新上报频率，默认：10s</td>
</tr>
<tr>
<td align="center">nodeStatusReportFrequency: 1m</td>
<td align="center">node节点上报自身状态频率，默认：1m</td>
</tr>
<tr>
<td align="center">imageMinimumGCAge: 2m</td>
<td align="center">设置镜像最少多久没有被使用才会被清理</td>
</tr>
<tr>
<td align="center">imageGCHighThresholdPercent: 85</td>
<td align="center">设置镜像占用磁盘比率最大值，超过此值将执行镜像垃圾回收，默认 85</td>
</tr>
<tr>
<td align="center">imageGCLowThresholdPercent: 80</td>
<td align="center">设置镜像占用磁盘比率最小值，低于此值将停止镜像垃圾回收，默认 80</td>
</tr>
<tr>
<td align="center">volumeStatsAggPeriod: 1m</td>
<td align="center">指定kubelet计算和缓存所有容器组及卷的磁盘使用量时间间隔，设置为0禁用卷计算，默认：1m</td>
</tr>
<tr>
<td align="center">kubeletCgroups: “”</td>
<td align="center">可选的 cgroups 的绝对名称来创建和运行 kubelet</td>
</tr>
<tr>
<td align="center">systemCgroups: “”</td>
<td align="center">可选的 cgroups 的绝对名称，用于将未包含在 cgroup 内的所有非内核进程放置在根目录 / 中，修改这个参数需要重启</td>
</tr>
<tr>
<td align="center">cgroupRoot: “”</td>
<td align="center">Pods 可选的root cgroup, 这是由container runtime，在最佳工作的基础上处理的，默认值: ‘’，意思是使用container runtime的默认处理</td>
</tr>
<tr>
<td align="center">cgroupsPerQOS: true</td>
<td align="center">支持创建QoS cgroup的层级结构，如果是true，最高层级的</td>
</tr>
<tr>
<td align="center">cgroupDriver: systemd</td>
<td align="center">Kubelet用来操作主机cgroups的驱动</td>
</tr>
<tr>
<td align="center">runtimeRequestTimeout: 10m</td>
<td align="center">除了长时间运行的请求(pull,logs,exec，attach)以外，所有runtime请求的超时时间，当触发超时时，kubelet会取消请求，抛出一个错误并稍后重试，默认值:2m0s</td>
</tr>
<tr>
<td align="center">hairpinMode: promiscuous-bridge</td>
<td align="center">Kubelet该怎么设置hairpin promiscuous-bridge.这个参数允许Service的端点试图访问自己的Service。如果网络没有正确配置为 “hairpin” 流量，通常当 kube-proxy 以 iptables 模式运行，并且 Pod 与桥接网络连接时，就会发生这种情况。Kubelet 公开了一个 hairpin-mode 标志，如果 pod 试图访问他们自己的 Service VIP，就可以让 Service 的 endpoints 重新负载到他们自己身上。hairpin-mode 标志必须设置为 hairpin-veth 或者 promiscuous-bridge。</td>
</tr>
<tr>
<td align="center">maxPods</td>
<td align="center">当前 kubelet 可以运行的容器组数目，默认：110</td>
</tr>
<tr>
<td align="center">podCIDR</td>
<td align="center">pod使用的CIDR网段</td>
</tr>
<tr>
<td align="center">podPidsLimit: -1</td>
<td align="center">pod中设置PID限制</td>
</tr>
<tr>
<td align="center">resolvConf</td>
<td align="center">用作容器DNS解析配置的解析器配置文件，默认： “/etc/resolv.conf”</td>
</tr>
<tr>
<td align="center">maxOpenFiles: 1000000</td>
<td align="center">kubelet 进程可以打开的文件数目，默认：1000000</td>
</tr>
<tr>
<td align="center">kubeAPIQPS</td>
<td align="center">与kube-apiserver会话时的QPS，默认：15</td>
</tr>
<tr>
<td align="center">kubeAPIBurst</td>
<td align="center">与kube-apiserver会话时的并发数，默认：10</td>
</tr>
<tr>
<td align="center">serializeImagePulls: false</td>
<td align="center">禁止一次只拉取一个镜像</td>
</tr>
<tr>
<td align="center">evictionHard:</td>
<td align="center">一个清理阈值的集合，达到该阈值将触发一次容器清理</td>
</tr>
<tr>
<td align="center">memory.available: “100Mi”</td>
<td align="center">小gf 100Mi时清理</td>
</tr>
<tr>
<td align="center">nodefs.available: “10%”</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">nodefs.inodesFree: “5%”</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">imagefs.available: “15%”</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">evictionSoft: {}</td>
<td align="center">清理阈值的集合，如果达到一个清理周期将触发一次容器清理</td>
</tr>
<tr>
<td align="center">enableControllerAttachDetach: true</td>
<td align="center">允许附加/分离控制器来管理调度到当前节点的附加/分离卷，并禁用kubelet执行任何附加/分离操作，默认：true</td>
</tr>
<tr>
<td align="center">failSwapOn: true</td>
<td align="center">如果在节点上启用了swap，kubelet将启动失败</td>
</tr>
<tr>
<td align="center">containerLogMaxSize: 20Mi</td>
<td align="center">容器日志容量最大值</td>
</tr>
<tr>
<td align="center">containerLogMaxFiles: 10</td>
<td align="center">容器日志文件数最大值</td>
</tr>
<tr>
<td align="center">systemReserved: {}</td>
<td align="center"><a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/，系统守护进程争取资源预留，这里均设置为默认值" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/，系统守护进程争取资源预留，这里均设置为默认值</a></td>
</tr>
<tr>
<td align="center">kubeReserved: {}</td>
<td align="center">kubernetes 系统守护进程争取资源预留，这里均设置为默认值</td>
</tr>
<tr>
<td align="center">systemReservedCgroup: “”</td>
<td align="center">要选择性的在系统守护进程上执行 kube-reserved，需要把 kubelet 的 –kube-reserved-cgroup 标志的值设置为 kube 守护进程的父控制组要想在系统守护进程上可选地执行 system-reserved，请指定 –system-reserved-cgroup kubelet 标志的值为 OS 系统守护进程的父级控制组，这里均设置为默认值</td>
</tr>
<tr>
<td align="center">kubeReservedCgroup: “”</td>
<td align="center">要选择性的在系统守护进程上执行 kube-reserved，需要把 kubelet 的 –kube-reserved-cgroup 标志的值设置为 kube 守护进程的父控制组这里均设置为默认值</td>
</tr>
<tr>
<td align="center">enforceNodeAllocatable: [“pods”]</td>
<td align="center">无论何时，如果所有 pod 的总用量超过了 Allocatable，驱逐 pod 的措施将被执行</td>
</tr>
</tbody></table>
<p>kubelet组件采用主动的查询机制，定期向kube-apiserver获取当前节点应该处理的任务，如果有任务分配到了自己身上（如创建Pod），从而他去处理这些任务；</p>
<p>kubelet暴露了两个端口10248，http形式的healthz服务，另一个是10250，https服务，其实还有一个只读的10255端口，这里是禁用的。</p>
<h3 id="生成kube-proxy-服务启动文件"><a href="#生成kube-proxy-服务启动文件" class="headerlink" title="生成kube-proxy 服务启动文件"></a>生成kube-proxy 服务启动文件</h3><p>本文是二进制安装kubernetes v1.17.0 之kube-proxy，kube-proxy是什么，这里就不得不说下service，service是一组Pod的抽象集合，它相当于一组Pod的负载均衡器，负责将请求分发到对应的pod，kube-proxy就是负责service的实现的，当请求到达service时，它通过label关联到后端并转发到某个Pod；kube-proxy提供了三种负载均衡模式：用户空间、iptables、ipvs，网上有很多关于这三种模式的区别，这里先不详述，本文采用ipvs。</p>
<p>kube-proxy需要运行在所有节点上（因为我们master节点也有Pod，如果没有的话，可以只部署在非master节点上），kube-proxy它主动的去监听kube-apiserver中service和endpoint的变化情况，然后根据定义的模式，创建路由规则，并提供服务service IP（headless类型的service无IP）和负载均衡功能。注意：在所有节点安装ipvsadm和ipset命令，加载ip_vs内核模块，准备章节已经执行过。</p>
<p>master节点上操作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">/var/lib/kube-proxy/kube-proxy-config.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line">  <span class="attr">burst:</span> <span class="number">200</span></span><br><span class="line">  <span class="attr">kubeconfig:</span> <span class="string">"/var/lib/kube-proxy/kubeconfig"</span></span><br><span class="line">  <span class="attr">qps:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">bindAddress:</span> <span class="string">$VIP</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="string">$VIP:10256</span></span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="string">$VIP:10249</span></span><br><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">clusterCIDR:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">"ipvs"</span></span><br><span class="line"><span class="attr">portRange:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kubeProxyIPTablesConfiguration:</span></span><br><span class="line">  <span class="attr">masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">kubeProxyIPVSConfiguration:</span></span><br><span class="line">  <span class="attr">scheduler:</span> <span class="string">rr</span></span><br><span class="line">  <span class="attr">excludeCIDRs:</span> <span class="string">[]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">for</span> <span class="string">host</span> <span class="string">in</span> <span class="string">k8s-master2</span> <span class="string">k8s-master3;do</span></span><br><span class="line">  <span class="string">echo</span> <span class="string">"---$host---"</span></span><br><span class="line">  <span class="string">scp</span> <span class="string">/var/lib/kube-proxy/kube-proxy-config.yaml</span> <span class="string">$host:/var/lib/kube-proxy/</span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">node配置</span></span><br><span class="line"></span><br><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">k8s-node1.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line">  <span class="attr">burst:</span> <span class="number">200</span></span><br><span class="line">  <span class="attr">kubeconfig:</span> <span class="string">"/var/lib/kube-proxy/kubeconfig"</span></span><br><span class="line">  <span class="attr">qps:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">bindAddress:</span> <span class="string">$NODE1_IP</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="string">$NODE1_IP:10256</span></span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="string">$NODE1_IP:10249</span></span><br><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">clusterCIDR:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">"ipvs"</span></span><br><span class="line"><span class="attr">portRange:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kubeProxyIPTablesConfiguration:</span></span><br><span class="line">  <span class="attr">masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">kubeProxyIPVSConfiguration:</span></span><br><span class="line">  <span class="attr">scheduler:</span> <span class="string">rr</span></span><br><span class="line">  <span class="attr">excludeCIDRs:</span> <span class="string">[]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">scp</span> <span class="string">k8s-node1.yaml</span> <span class="string">k8s-node1:/var/lib/kube-proxy/kube-proxy-config.yaml</span></span><br><span class="line"><span class="string">rm</span> <span class="string">-rf</span> <span class="string">k8s-node1.yaml</span></span><br></pre></td></tr></table></figure>

<p><strong>配置详解</strong></p>
<table>
<thead>
<tr>
<th align="center">配置选项</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">clientConnection</td>
<td align="center">与kube-apiserver交互时的参数设置</td>
</tr>
<tr>
<td align="center">burst: 200</td>
<td align="center">临时允许该事件记录值超过qps设定值</td>
</tr>
<tr>
<td align="center">kubeconfig</td>
<td align="center">kube-proxy 客户端连接 kube-apiserver 的 kubeconfig 文件路径设置</td>
</tr>
<tr>
<td align="center">qps: 100</td>
<td align="center">与kube-apiserver交互时的QPS，默认值5</td>
</tr>
<tr>
<td align="center">bindAddress</td>
<td align="center">kube-proxy监听地址</td>
</tr>
<tr>
<td align="center">healthzBindAddress</td>
<td align="center">用于检查服务的IP地址和端口，默认：0.0.0.0:10256</td>
</tr>
<tr>
<td align="center">metricsBindAddress</td>
<td align="center">metrics服务的ip地址和端口，默认：127.0.0.1:10249</td>
</tr>
<tr>
<td align="center">enableProfiling</td>
<td align="center">如果设为true，则通过/debug/pprof处理程序上的web界面进行概要分析</td>
</tr>
<tr>
<td align="center">clusterCIDR</td>
<td align="center">kube-proxy 根据 –cluster-cidr 判断集群内部和外部流量，指定 –cluster-cidr 或 –masquerade-all 选项后 kube-proxy 才会对访问 Service IP 的请求做 SNAT</td>
</tr>
<tr>
<td align="center">hostnameOverride</td>
<td align="center">参数值必须与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 ipvs 规则；</td>
</tr>
<tr>
<td align="center">mode</td>
<td align="center">使用 ipvs 模式</td>
</tr>
<tr>
<td align="center">portRange</td>
<td align="center">主机端口的范围(beginPort- endport，单端口或beginPort+偏移量)，可用于代理服务流量。如果(未指定，0，或0-0)端口将被随机选择</td>
</tr>
<tr>
<td align="center">kubeProxyIPTablesConfiguration:</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">masqueradeAll: false</td>
<td align="center">如果使用纯iptables代理，SNAT所有通过服务集群ip发送的通信</td>
</tr>
<tr>
<td align="center">kubeProxyIPVSConfiguration:</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">scheduler: rr</td>
<td align="center">当proxy为ipvs模式时，ipvs调度类型</td>
</tr>
<tr>
<td align="center">excludeCIDRs: []</td>
<td align="center"></td>
</tr>
</tbody></table>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Kube Proxy</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/bin/kube-proxy \\</span><br><span class="line">  <span class="attribute">--config</span>=/var/lib/kube-proxy/kube-proxy-config.yaml \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>拷贝启动配置文件到其他节点</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master2 k8s-master3 k8s-node1; <span class="keyword">do</span></span><br><span class="line">  echo <span class="string">"---$host---"</span></span><br><span class="line">  scp /etc/systemd/system/kube-proxy.service <span class="variable">$host</span><span class="symbol">:/etc/systemd/system/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>启动worker服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> k8s-master1 k8s-master2 k8s-master3 k8s-node1; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"---<span class="variable">$host</span>---"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"systemctl daemon-reload"</span></span><br><span class="line">  ssh <span class="variable">$host</span> <span class="string">"systemctl enable --now kubelet kube-proxy"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">systemctl status kubelet</span><br><span class="line">systemctl status kube-proxy</span><br></pre></td></tr></table></figure>

<p>此时所有节点的kubelet启动之后 会自动加入集群</p>
<p>查看集群节点</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">get</span> nodes</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME     STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   NotReady   &lt;none&gt;   <span class="number">9</span>s    v1<span class="number">.17</span><span class="number">.3</span></span><br><span class="line">k8s-master2   NotReady   &lt;none&gt;   <span class="number">9</span>s    v1<span class="number">.17</span><span class="number">.3</span></span><br><span class="line">k8s-master3   NotReady   &lt;none&gt;   <span class="number">39</span>m   v1<span class="number">.17</span><span class="number">.3</span></span><br><span class="line">k8s-node1     NotReady   &lt;none&gt;   <span class="number">39</span>m   v1<span class="number">.17</span><span class="number">.3</span></span><br></pre></td></tr></table></figure>

<p>可以看到 所有的节点都已经成功加入集群</p>
<p>状态显示 NotReady 是因为没有配置网络插件 配置好网络插件就 Ready了</p>
<h1 id="部署网络配置"><a href="#部署网络配置" class="headerlink" title="部署网络配置"></a>部署网络配置</h1><h3 id="注意-本文所有操作均在master节点执行-3"><a href="#注意-本文所有操作均在master节点执行-3" class="headerlink" title="注意 本文所有操作均在master节点执行"></a>注意 本文所有操作均在master节点执行</h3><p>本文主要介绍部署网络 dns 插件</p>
<p>本文的网络插件选用的是calico 以容器的方式运行<br>本文的dns’插件选用的是coredns以容器的方式运行</p>
<h3 id="安装calico网络"><a href="#安装calico网络" class="headerlink" title="安装calico网络"></a>安装calico网络</h3><p>下载calico网络插件的yaml文件</p>
<p>1.16版本的kubernetes calico网络插件应选用3.9及以上的版本</p>
<p>本文选用3.10</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https:<span class="regexp">//</span>docs.projectcalico.org<span class="regexp">/v3.10/m</span>anifests<span class="regexp">/calico.yaml -O</span></span><br></pre></td></tr></table></figure>

<p>修改网络插件yaml文件内容</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's|<span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>|<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>|' calico.yaml</span><br></pre></td></tr></table></figure>

<p>应用yaml文件</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">apply</span> -f calico.yaml</span><br></pre></td></tr></table></figure>

<p>查看pod状态</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">get</span> pods -n kube-<span class="keyword">system</span></span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers<span class="number">-6</span>d85fdfbd8<span class="number">-8</span>v2hs   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7</span>m40s</span><br><span class="line">calico-node<span class="number">-984f</span>d                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7</span>m40s</span><br><span class="line">calico-node-n5kn8                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7</span>m40s</span><br><span class="line">calico-node-q4p7c                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7</span>m40s</span><br></pre></td></tr></table></figure>

<p>网络插件安装成功</p>
<h3 id="安装coredns插件"><a href="#安装coredns插件" class="headerlink" title="安装coredns插件"></a>安装coredns插件</h3><p>先下载jq命令(coredns提供的部署脚本需要使用jq命令对生成的yaml文件进行整理)</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="symbol">https:</span>/<span class="regexp">/github.com/stedolan</span><span class="regexp">/jq/releases</span><span class="regexp">/download/jq</span>-<span class="number">1.6</span>/jq-linux64 -O /usr/bin/jq</span><br><span class="line">chmod a+x /usr/bin/jq</span><br></pre></td></tr></table></figure>

<p>克隆GitHub仓库</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install git</span><br><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/coredns/deployment.git</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd deployment/kubernetes/</span><br><span class="line">./deploy.sh -i <span class="number">10.250</span><span class="number">.0</span><span class="number">.10</span> | kubectl apply -f -</span><br></pre></td></tr></table></figure>

<p>ip为开头写的集群dns的IP</p>
<p>输出信息</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span>.io/system:coredns created</span><br><span class="line">clusterrolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span>.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure>

<p>查看pod</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale -n kube-<span class="keyword">system</span> deployment coredns <span class="comment">--replicas=3</span></span><br><span class="line">kubectl <span class="built_in">get</span> pods -n kube-<span class="keyword">system</span></span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers<span class="number">-6</span>d85fdfbd8<span class="number">-8</span>v2hs   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">91</span>m</span><br><span class="line">calico-node<span class="number">-984f</span>d                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">91</span>m</span><br><span class="line">calico-node-n5kn8                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">91</span>m</span><br><span class="line">calico-node-q4p7c                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">91</span>m</span><br><span class="line">coredns<span class="number">-68567</span>cdb47<span class="number">-6</span>j7bb                   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m31s</span><br><span class="line">coredns<span class="number">-68567</span>cdb47<span class="number">-7</span>nwcg                   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m31s</span><br></pre></td></tr></table></figure>

<p>可以看到calico网络和coredns插件都好了</p>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>进入pod内部 pingbaidu.com</p>
<p>如果能ping同 则插件部署完毕</p>
<h3 id="安装Ingress-nginx插件"><a href="#安装Ingress-nginx插件" class="headerlink" title="安装Ingress-nginx插件"></a>安装Ingress-nginx插件</h3><p>yaml文件</p>
<p>点击上方超链接 将yaml文件的所有内容复制下来 保存到主节点的nginx-ingress.yaml文件内</p>
<p>然后</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">apply</span> -f nginx-ds.yaml</span><br></pre></td></tr></table></figure>

<p>输出信息</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">namespace/ingress-nginx created</span><br><span class="line">configmap/nginx-configuration created</span><br><span class="line">configmap/tcp-services created</span><br><span class="line">configmap/udp-services created</span><br><span class="line">serviceaccount/nginx-ingress-serviceaccount created</span><br><span class="line">clusterrole<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span>.io/nginx-ingress-clusterrole created</span><br><span class="line">role<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span>.io/nginx-ingress-role created</span><br><span class="line">rolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span>.io/nginx-ingress-role-nisa-binding created</span><br><span class="line">clusterrolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span>.io/nginx-ingress-clusterrole-nisa-binding created</span><br><span class="line">daemonset.apps/nginx-ingress-controller created</span><br></pre></td></tr></table></figure>

<p>然后查看Pod</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">get</span> pods -n ingress-nginx -o wide</span><br></pre></td></tr></table></figure>

<p>输出信息 全部为Running即可</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                             READY   STATUS    RESTARTS   AGE     IP              NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ingress-controller<span class="number">-8</span>xzrd   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m13s   <span class="number">200.200</span><span class="number">.100</span><span class="number">.73</span>   k8s-node    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ingress-controller-c84dv   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m13s   <span class="number">200.200</span><span class="number">.100</span><span class="number">.74</span>   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ingress-controller-qlpn5   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m13s   <span class="number">200.200</span><span class="number">.100</span><span class="number">.71</span>   master   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>Ingress-nginx插件安装完毕</p>
<h1 id="集群部署完毕"><a href="#集群部署完毕" class="headerlink" title="集群部署完毕"></a>集群部署完毕</h1>
    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/29/k8s/helm%E5%AE%89%E8%A3%85/" rel="prev" title="helm安装">
      <i class="fa fa-chevron-left"></i> helm安装
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/05/04/k8s17-3%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-test/" rel="next" title="k8s17.3二进制部署-test">
      k8s17.3二进制部署-test <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
      
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#注意-本文所有操作均在所有节点执行"><span class="nav-number">1.</span> <span class="nav-text">注意 本文所有操作均在所有节点执行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#环境准备"><span class="nav-number">2.</span> <span class="nav-text">环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境变量"><span class="nav-number">2.0.1.</span> <span class="nav-text">环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSH免密-时间同步-主机名修改"><span class="nav-number">2.0.2.</span> <span class="nav-text">SSH免密&#x2F;时间同步&#x2F;主机名修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#升级内核"><span class="nav-number">2.0.3.</span> <span class="nav-text">升级内核</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整系统内核参数"><span class="nav-number">2.0.4.</span> <span class="nav-text">调整系统内核参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭防火墙、selinux、swap、NetworkManager"><span class="nav-number">2.0.5.</span> <span class="nav-text">关闭防火墙、selinux、swap、NetworkManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改资源限制"><span class="nav-number">2.0.6.</span> <span class="nav-text">修改资源限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用软件安装"><span class="nav-number">2.0.7.</span> <span class="nav-text">常用软件安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载内核ipvs模块"><span class="nav-number">2.0.8.</span> <span class="nav-text">加载内核ipvs模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装docker-ce："><span class="nav-number">2.0.9.</span> <span class="nav-text">安装docker-ce：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#然后重启系统-验证内核是否升级成功"><span class="nav-number">2.0.10.</span> <span class="nav-text">然后重启系统 验证内核是否升级成功</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#下载命令"><span class="nav-number">3.</span> <span class="nav-text">下载命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载cfssl以及cfssljson命令"><span class="nav-number">3.0.1.</span> <span class="nav-text">下载cfssl以及cfssljson命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装CFSSL"><span class="nav-number">3.0.2.</span> <span class="nav-text">安装CFSSL</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#生成证书"><span class="nav-number">4.</span> <span class="nav-text">生成证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注意-本文所有操作均在master1节点执行"><span class="nav-number">4.0.1.</span> <span class="nav-text">注意 本文所有操作均在master1节点执行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生成etcd证书"><span class="nav-number">4.1.</span> <span class="nav-text">生成etcd证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生成kubernetes组件证书"><span class="nav-number">4.2.</span> <span class="nav-text">生成kubernetes组件证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建CA配置文件"><span class="nav-number">4.2.1.</span> <span class="nav-text">新建CA配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#client与server凭证"><span class="nav-number">4.2.2.</span> <span class="nav-text">client与server凭证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成kubelet客户端凭证"><span class="nav-number">4.2.3.</span> <span class="nav-text">生成kubelet客户端凭证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建kube-controller-manager客户端凭证"><span class="nav-number">4.2.4.</span> <span class="nav-text">创建kube-controller-manager客户端凭证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建kube-proxy客户端凭证"><span class="nav-number">4.2.5.</span> <span class="nav-text">创建kube-proxy客户端凭证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建kube-scheduler凭证签发"><span class="nav-number">4.2.6.</span> <span class="nav-text">创建kube-scheduler凭证签发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建kubernetes-证书"><span class="nav-number">4.2.7.</span> <span class="nav-text">创建kubernetes 证书</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置和生成kubernetes配置文件"><span class="nav-number">5.</span> <span class="nav-text">配置和生成kubernetes配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注意-本文所有操作均在master节点执行"><span class="nav-number">5.0.1.</span> <span class="nav-text">注意 本文所有操作均在master节点执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet配置文件"><span class="nav-number">5.0.2.</span> <span class="nav-text">kubelet配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-proxy配置文件"><span class="nav-number">5.0.3.</span> <span class="nav-text">kube-proxy配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-controller-manager配置文件"><span class="nav-number">5.0.4.</span> <span class="nav-text">kube-controller-manager配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-scheduler配置文件"><span class="nav-number">5.0.5.</span> <span class="nav-text">kube-scheduler配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Admin配置文件"><span class="nav-number">5.0.6.</span> <span class="nav-text">Admin配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置和生成密钥"><span class="nav-number">5.0.7.</span> <span class="nav-text">配置和生成密钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发证书文件"><span class="nav-number">5.0.8.</span> <span class="nav-text">分发证书文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-number">5.1.</span> <span class="nav-text"></span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署etcd集群"><span class="nav-number">6.</span> <span class="nav-text">部署etcd集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载etcd二进制包并解压"><span class="nav-number">6.0.1.</span> <span class="nav-text">下载etcd二进制包并解压</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置etcd系统服务文件"><span class="nav-number">6.0.2.</span> <span class="nav-text">设置etcd系统服务文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有节点启动etcd服务并设置为开机自启"><span class="nav-number">6.0.3.</span> <span class="nav-text">所有节点启动etcd服务并设置为开机自启</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查etcd集群状态"><span class="nav-number">6.0.4.</span> <span class="nav-text">检查etcd集群状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署keepalived-HAProxy"><span class="nav-number">7.</span> <span class="nav-text">部署keepalived+HAProxy</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署master节点"><span class="nav-number">8.</span> <span class="nav-text">部署master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注意-本文所有操作均在master节点执行-1"><span class="nav-number">8.0.1.</span> <span class="nav-text">注意 本文所有操作均在master节点执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载并安装kubernetes组件可执行文件"><span class="nav-number">8.0.2.</span> <span class="nav-text">下载并安装kubernetes组件可执行文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成kube-apiserver-service配置启动文件"><span class="nav-number">8.0.3.</span> <span class="nav-text">生成kube-apiserver.service配置启动文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成kube-controller-manager-service-配置启动文件"><span class="nav-number">8.0.4.</span> <span class="nav-text">生成kube-controller-manager.service 配置启动文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成kube-scheduler-service配置启动文件"><span class="nav-number">8.0.5.</span> <span class="nav-text">生成kube-scheduler.service配置启动文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动各组件"><span class="nav-number">8.0.6.</span> <span class="nav-text">启动各组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝admin-的kubeconfig-为kubectl默认读取的-kube-config"><span class="nav-number">8.0.7.</span> <span class="nav-text">拷贝admin 的kubeconfig 为kubectl默认读取的.kube&#x2F;config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#-1"><span class="nav-number">8.0.8.</span> <span class="nav-text"></span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubelet-RBAC-授权"><span class="nav-number">9.</span> <span class="nav-text">Kubelet RBAC 授权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注意-本文所有操作均在master节点执行-2"><span class="nav-number">9.0.1.</span> <span class="nav-text">注意 本文所有操作均在master节点执行</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署node节点"><span class="nav-number">10.</span> <span class="nav-text">部署node节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注意-本文所有操作所有节点执行"><span class="nav-number">10.0.1.</span> <span class="nav-text">注意 本文所有操作所有节点执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成kube-proxy-服务启动文件"><span class="nav-number">10.0.2.</span> <span class="nav-text">生成kube-proxy 服务启动文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署网络配置"><span class="nav-number">11.</span> <span class="nav-text">部署网络配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注意-本文所有操作均在master节点执行-3"><span class="nav-number">11.0.1.</span> <span class="nav-text">注意 本文所有操作均在master节点执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装calico网络"><span class="nav-number">11.0.2.</span> <span class="nav-text">安装calico网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装coredns插件"><span class="nav-number">11.0.3.</span> <span class="nav-text">安装coredns插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证"><span class="nav-number">11.0.4.</span> <span class="nav-text">验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Ingress-nginx插件"><span class="nav-number">11.0.5.</span> <span class="nav-text">安装Ingress-nginx插件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#集群部署完毕"><span class="nav-number">12.</span> <span class="nav-text">集群部署完毕</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">屈辉</p>
  <div class="site-description" itemprop="description">开心就好</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">84</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">屈辉</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.1
  </div> -->

        








      </div>
    </footer>
  </div>

  
  
  <script color='3423,34,234' opacity='0.35' zIndex='-1' count='150' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
