<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"horus-k.github.io","root":"/","scheme":"Mist","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="EFK由ElasticSearch、Fluentd和Kiabana三个开源工具组成。其中Elasticsearch是一款分布式搜索引擎，能够用于日志的检索，Fluentd是一个实时开源的数据收集器,而Kibana 是一款能够为Elasticsearch 提供分析和可视化的 Web 平台。这三款开源工具的组合为日志数据提供了分布式的实时搜集与分析的监控系统。 而在此之前，业界是采用ELK(Elast">
<meta property="og:type" content="article">
<meta property="og:title" content="Fluentd-简单使用">
<meta property="og:url" content="https://horus-k.github.io/2020/06/04/k8s/Fluentd-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="Q&#39;s blog">
<meta property="og:description" content="EFK由ElasticSearch、Fluentd和Kiabana三个开源工具组成。其中Elasticsearch是一款分布式搜索引擎，能够用于日志的检索，Fluentd是一个实时开源的数据收集器,而Kibana 是一款能够为Elasticsearch 提供分析和可视化的 Web 平台。这三款开源工具的组合为日志数据提供了分布式的实时搜集与分析的监控系统。 而在此之前，业界是采用ELK(Elast">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://horus-k.github.io/2020/06/04/k8s/Fluentd-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/7982144-229c6bba4b89cb0a.png">
<meta property="og:image" content="https://horus-k.github.io/2020/06/04/k8s/Fluentd-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/7982144-f32d3f8ef05eca8c.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9644303-473ea2b50ceab1f1?imageMogr2/auto-orient/strip%7CimageView2/2/w/790/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9644303-3651dc5bbcaa8a44?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9644303-fa62d035c442126b?imageMogr2/auto-orient/strip%7CimageView2/2/w/868/format/webp">
<meta property="article:published_time" content="2020-06-04T13:12:32.000Z">
<meta property="article:modified_time" content="2020-06-06T11:17:04.280Z">
<meta property="article:author" content="屈辉">
<meta property="article:tag" content="Fluentd">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://horus-k.github.io/2020/06/04/k8s/Fluentd-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/7982144-229c6bba4b89cb0a.png">

<link rel="canonical" href="https://horus-k.github.io/2020/06/04/k8s/Fluentd-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Fluentd-简单使用 | Q's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Q's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一些个人文档笔记</p>
  </div>

  <div class="site-nav-right"></div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">84</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">27</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">177</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Horus-K" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://horus-k.github.io/2020/06/04/k8s/Fluentd-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="屈辉">
      <meta itemprop="description" content="开心就好">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Q's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Fluentd-简单使用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-04 21:12:32" itemprop="dateCreated datePublished" datetime="2020-06-04T21:12:32+08:00">2020-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-06 19:17:04" itemprop="dateModified" datetime="2020-06-06T19:17:04+08:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>EFK由ElasticSearch、Fluentd和Kiabana三个开源工具组成。其中Elasticsearch是一款分布式搜索引擎，能够用于日志的检索，Fluentd是一个实时开源的数据收集器,而Kibana 是一款能够为Elasticsearch 提供分析和可视化的 Web 平台。这三款开源工具的组合为日志数据提供了分布式的实时搜集与分析的监控系统。</p>
<p>而在此之前，业界是采用ELK(Elasticsearch + Logstash + Kibana)来管理日志。Logstash是一个具有实时渠道能力的数据收集引擎,但和fluentd相比，它在效能上表现略逊一筹，故而逐渐被fluentd取代，ELK也随之变成EFK。</p>
<a id="more"></a>

<h3 id="ELK架构"><a href="#ELK架构" class="headerlink" title="ELK架构"></a>ELK架构</h3><p>为了更好的了解EFK的架构，首先，我们先理解下ELK架构。在此之前，<br> 我们需要清楚如下几个概念：</p>
<ul>
<li>Log Source：日志来源。在微服务中，我们的日志主要来源于日志文件和Docker容器，日志文件包括服务器log，例如Nginx access log（记录了哪些用户，哪些页面以及用户浏览器、ip和其他的访问信息）, error log(记录服务器错误日志)等。</li>
<li>Logstash：数据收集处理引擎，可用于传输docker各个容器中的日志给EK。支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作，然后存储以供后续使用。</li>
<li>Filebeat：和Logstash一样属于日志收集处理工具，基于原先 Logstash-fowarder 的源码改造出来的。与Logstash相比，filebeat更加轻量，占用资源更少</li>
<li>ElasticSearch:日志搜索引擎</li>
<li>Kibana:用于日志展示的可视化工具</li>
<li>Grafana:类似Kibana，可对后端的数据进行实时展示</li>
</ul>
<p>下图是ELK架构，采用ElasticSearch、Kibana、Grafana、Filebeat来管理Docker容器日志。</p>
<p><img src="/2020/06/04/k8s/Fluentd-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/7982144-229c6bba4b89cb0a.png" alt="img"></p>
<p>由图可知，当我们在Docker中运行应用（application）时，filebeat收集容器中的日志。ElasticSearch收到日志对日志进行实时存储、搜索与分析。我们可在Kibana和Grafana这两个可视化工具中查看日志的操作结果。</p>
<h3 id="EFK架构"><a href="#EFK架构" class="headerlink" title="EFK架构"></a>EFK架构</h3><p>Fluentd是一个开源的数据收集器，专为处理数据流设计，使用JSON作为数据格式。它采用了插件式的架构，具有高可扩展性高可用性，同时还实现了高可靠的信息转发。</p>
<p>因此，我们加入Fluentd来收集日志。加入后的EFK架构如图所示。</p>
<p><img src="/2020/06/04/k8s/Fluentd-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/7982144-f32d3f8ef05eca8c.png" alt="img"></p>
<h1 id="架构选型"><a href="#架构选型" class="headerlink" title="架构选型"></a>架构选型</h1><ol>
<li>存储层： Elasticsearch 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。</li>
<li>展示层：Kibana   是 Elasticsearch 的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览 Elasticsearch 日志数据。</li>
<li>缓存层：  需要收集大数据量的日志一般使用Redis、kafka做为中间缓存层来缓冲数据。</li>
<li>采集层：</li>
</ol>
<ul>
<li><p>Fluentd：是一个流行的开源数据收集器， 具有众多插件，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。</p>
</li>
<li><p>Fluentd-bit： 更适用于嵌入设备等资源受限的场景。占用系统资源较少，在插件可以满足需求的同时，无疑是更好的选择。另外Fluent Bit 提供了输出插件，可以把数据发给 Fluentd，因此他们可以在系统中作为独立服务互相协作。对比如下</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/9644303-473ea2b50ceab1f1?imageMogr2/auto-orient/strip%7CimageView2/2/w/790/format/webp" alt="img"></p>
<p>在这里插入图片描述</p>
</li>
<li><p>Logstash：ES官方推荐，使用它有很多插件，灵活性很高，但由于是java语言编写，占用资源较高，一般作为过滤格式使用，当然也可以单独使用。</p>
</li>
<li><p>Filebeat： ES官方新一代采集工具，是一个轻量级的日志传输工具，使用Golang语言编写，占用资源低，一般作为采集日志使用，当然也可以单独使用，同样它和Logstash可以互相协作。</p>
</li>
</ul>
<p>详见：<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdeveloper.51cto.com%2Fart%2F201904%2F595529.htm" target="_blank" rel="noopener">详解日志采集工具–Logstash、Filebeat、Fluentd、Logagent对比</a></p>
<p>相关架构图如下：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/9644303-3651dc5bbcaa8a44?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p><img src="https:////upload-images.jianshu.io/upload_images/9644303-fa62d035c442126b?imageMogr2/auto-orient/strip%7CimageView2/2/w/868/format/webp" alt="img"></p>
<p>本文所使用架构<br> Fluentd（采集），Elasticsearch （存储），kibana（展示）</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h3 id="安装前配置"><a href="#安装前配置" class="headerlink" title="安装前配置"></a>安装前配置</h3><h5 id="ntp时间同步-重要"><a href="#ntp时间同步-重要" class="headerlink" title="ntp时间同步(重要)"></a>ntp时间同步(重要)</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install ntp</span><br><span class="line">vim <span class="regexp">/etc/</span>ntp.conf  <span class="regexp">//</span>添加要同步的时间服务器</span><br><span class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/ntpd start</span></span><br></pre></td></tr></table></figure>

<h5 id="文件打开数"><a href="#文件打开数" class="headerlink" title="文件打开数"></a>文件打开数</h5><p>查看当前设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n</span><br></pre></td></tr></table></figure>

<p>增加最大文件打开数，修改<code>/etc/security/limits.conf</code></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root soft nofile <span class="number">65536</span></span><br><span class="line">root hard nofile <span class="number">65536</span></span><br><span class="line">* soft nofile <span class="number">65536</span></span><br><span class="line">* hard nofile <span class="number">65536</span></span><br></pre></td></tr></table></figure>

<h5 id="修改-etc-sysctl-conf，添加如下内容"><a href="#修改-etc-sysctl-conf，添加如下内容" class="headerlink" title="修改/etc/sysctl.conf，添加如下内容"></a>修改<code>/etc/sysctl.conf</code>，添加如下内容</h5><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">net.core.somaxconn</span> = <span class="number">1024</span></span><br><span class="line"><span class="attr">net.core.netdev_max_backlog</span> = <span class="number">5000</span></span><br><span class="line"><span class="attr">net.core.rmem_max</span> = <span class="number">16777216</span></span><br><span class="line"><span class="attr">net.core.wmem_max</span> = <span class="number">16777216</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_wmem</span> = <span class="number">4096</span> <span class="number">12582912</span> <span class="number">16777216</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_rmem</span> = <span class="number">4096</span> <span class="number">12582912</span> <span class="number">16777216</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_max_syn_backlog</span> = <span class="number">8096</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_slow_start_after_idle</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_tw_reuse</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">net.ipv4.ip_local_port_range</span> = <span class="number">10240</span> <span class="number">65535</span></span><br></pre></td></tr></table></figure>

<p>配置生效</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sysctl -p</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">yum安装</span><br><span class="line"></span><br><span class="line">curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent3.sh | sh</span><br><span class="line"></span><br><span class="line">命令</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始、停止、重启、查看状态</span></span><br><span class="line">/etc/init.d/td-agent start</span><br><span class="line">/etc/init.d/td-agent stop</span><br><span class="line">/etc/init.d/td-agent restart</span><br><span class="line">/etc/init.d/td-agent status</span><br><span class="line"><span class="comment"># 配置文件</span></span><br><span class="line">/etc/td-agent/td-agent.conf</span><br><span class="line"><span class="comment"># 日志文件</span></span><br><span class="line">/var/<span class="built_in">log</span>/td-agent/td-agent.log</span><br><span class="line"><span class="comment"># 查询进程</span></span><br><span class="line">ps -ef | grep td-agent</span><br><span class="line">对应配置文件路径</span><br><span class="line">| 项目                       路径   </span><br><span class="line">| 主配置文件        /etc/td-agent/td-agent.conf  </span><br><span class="line">| 主程序           /usr/sbin/td-agent  </span><br><span class="line">| 程序日志         /var/<span class="built_in">log</span>/td-agent/td-agent.log  </span><br><span class="line">| ruby程序位置     /opt/td-agent/embedded/bin/ruby  </span><br><span class="line">| pid位置         /var/run/td-atent/td-agent.pid </span><br><span class="line">查看默认主配置文件的配置</span><br><span class="line"><span class="comment"># egrep -v "^#|^$" /etc/td-agent/td-agent.conf</span></span><br><span class="line">&lt;match td.*.*&gt;</span><br><span class="line">  @<span class="built_in">type</span> tdlog</span><br><span class="line">  apikey YOUR_API_KEY</span><br><span class="line">  auto_create_table</span><br><span class="line">  buffer_type file</span><br><span class="line">  buffer_path /var/<span class="built_in">log</span>/td-agent/buffer/td</span><br><span class="line">  &lt;secondary&gt;</span><br><span class="line">    @<span class="built_in">type</span> file</span><br><span class="line">    path /var/<span class="built_in">log</span>/td-agent/failed_records</span><br><span class="line">  &lt;/secondary&gt;</span><br><span class="line">&lt;/match&gt;</span><br><span class="line">&lt;match debug.**&gt;</span><br><span class="line">  @<span class="built_in">type</span> stdout</span><br><span class="line">&lt;/match&gt;</span><br><span class="line">&lt;<span class="built_in">source</span>&gt;</span><br><span class="line">  @<span class="built_in">type</span> forward</span><br><span class="line">&lt;/<span class="built_in">source</span>&gt;</span><br><span class="line">&lt;<span class="built_in">source</span>&gt;</span><br><span class="line">  @<span class="built_in">type</span> http</span><br><span class="line">  port 8888</span><br><span class="line">&lt;/<span class="built_in">source</span>&gt;</span><br><span class="line">&lt;<span class="built_in">source</span>&gt;</span><br><span class="line">  @<span class="built_in">type</span> debug_agent</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">  port 24230</span><br><span class="line">&lt;/<span class="built_in">source</span>&gt;</span><br><span class="line"></span><br><span class="line">默认配置下的监听状态</span><br><span class="line"></span><br><span class="line"><span class="comment"># netstat -utpln |grep ruby </span></span><br><span class="line">tcp        0      0 0.0.0.0:8888                0.0.0.0:*                   LISTEN      818/ruby            </span><br><span class="line">tcp        0      0 0.0.0.0:24224               0.0.0.0:*                   LISTEN      823/ruby            </span><br><span class="line">tcp        0      0 127.0.0.1:24230             0.0.0.0:*                   LISTEN      823/ruby            </span><br><span class="line">udp        0      0 0.0.0.0:24224               0.0.0.0:*                               823/ruby</span><br></pre></td></tr></table></figure>



<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Ruby安装</span><br><span class="line"></span><br><span class="line">卸载自带的<span class="keyword">ruby</span></span><br><span class="line"></span><br><span class="line">yum <span class="built_in">remove</span> <span class="keyword">ruby</span> -<span class="keyword">y</span></span><br><span class="line"></span><br><span class="line">安装ruby2.<span class="number">5</span></span><br><span class="line"></span><br><span class="line">下载地址: http://www.<span class="keyword">ruby</span>-lang.org/<span class="keyword">en</span>/downloads/</span><br><span class="line">tar zxvf <span class="keyword">ruby</span>-<span class="number">2.5</span>.<span class="number">1</span>.tar.gz</span><br><span class="line">mv ./<span class="keyword">ruby</span>-<span class="number">2.5</span>.<span class="number">1</span> /usr/local/<span class="keyword">ruby</span>-<span class="number">2.5</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">cd</span> /usr/local/<span class="keyword">ruby</span>-<span class="number">2.5</span>.<span class="number">1</span></span><br><span class="line">./configure</span><br><span class="line"><span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install</span><br><span class="line">​</span><br></pre></td></tr></table></figure>

<p>gem换源</p>
<h1 id="列出默认源"><a href="#列出默认源" class="headerlink" title="列出默认源"></a>列出默认源</h1><p>gem sources</p>
<h1 id="移除默认源"><a href="#移除默认源" class="headerlink" title="移除默认源"></a>移除默认源</h1><p>gem sources –remove <a href="https://rubygems.org/" target="_blank" rel="noopener">https://rubygems.org/</a></p>
<h1 id="添加ruby-china源"><a href="#添加ruby-china源" class="headerlink" title="添加ruby-china源"></a>添加ruby-china源</h1><p>gem sources -a <a href="https://gems.ruby-china.com/" target="_blank" rel="noopener">https://gems.ruby-china.com/</a></p>
<p>安装编译环境和软件包依赖</p>
<p>yum install gcc gcc-c++ make automake autoconf libtool openssl-devel jemalloc-devel gmp-devel -y</p>
<p>安装fluentd</p>
<p>gem install fluentd –no-ri –no-rdoc<br>安装fluentd插件</p>
<h1 id="查询插件"><a href="#查询插件" class="headerlink" title="查询插件"></a>查询插件</h1><p>gem search fluent-plugin -rd # 列出github地址</p>
<h1 id="安装mongo插件"><a href="#安装mongo插件" class="headerlink" title="安装mongo插件"></a>安装mongo插件</h1><p>gem install fluent-plugin-mongo –no-ri –no-rdoc</p>
<p>初始化fluentd</p>
<p>fluentd –setup /etc/fluentd</p>
<p>我没成功过     。。。。</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta"># 测试</span></span><br><span class="line"></span><br><span class="line">通过<span class="number">8888</span>端口提交一条日志</span><br></pre></td></tr></table></figure>
<p> curl -X POST -d ‘json={“json”:”message”}’ <a href="http://localhost:8888/debug.test" target="_blank" rel="noopener">http://localhost:8888/debug.test</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">查看输出的日志</span><br></pre></td></tr></table></figure>
<h1 id="tail-n-1-var-log-td-agent-td-agent-log"><a href="#tail-n-1-var-log-td-agent-td-agent-log" class="headerlink" title="tail -n 1 /var/log/td-agent/td-agent.log"></a>tail -n 1 /var/log/td-agent/td-agent.log</h1><p>2018-02-09 00:09:06.719633187 +0800 debug.test: {“json”:”message”}</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="quote">&gt; 以上就是官方给出的最简化的demo，作用不大，但可以初步理解fluentd的工作方式</span></span><br><span class="line"></span><br><span class="line"><span class="section">## CS结构</span></span><br><span class="line"></span><br><span class="line">![<span class="string">schema</span>](<span class="link">Fluentd-简单使用/20130604161830500</span>)</span><br><span class="line"></span><br><span class="line">数据流的处理都是双向的，既有Input方向也有Output方向。</span><br><span class="line">角色：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>日志转发 //client承担此角色</span><br><span class="line"><span class="bullet">- </span>日志聚合 //server扮演此角色</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; `日志转发` 通常安装在每个节点上以接收本地日志，一旦接收到数据，通过网络将其转发到server端。</span></span><br><span class="line">&gt;</span><br><span class="line"><span class="quote">&gt; `日志聚合` 接收转发而来的数据，缓冲，过滤并定期通过插件将数据上传到其他存储程序、本地文件等媒介中。</span></span><br><span class="line"></span><br><span class="line">==client、server使用同一样部署方式，区别在于配置文件的不同。==</span><br><span class="line"></span><br><span class="line"><span class="section"># 配置讲解</span></span><br><span class="line"></span><br><span class="line"><span class="section">### `td-agent.conf`配置的组成部分</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span><span class="code">`source`</span> directives determine the input sources.</span><br><span class="line"><span class="bullet">- </span><span class="code">`match`</span> directives determine the output destinations.</span><br><span class="line"><span class="bullet">- </span><span class="code">`filter`</span> directives determine the event processing pipelines.</span><br><span class="line"><span class="bullet">- </span><span class="code">`system`</span> directives set system wide configuration.</span><br><span class="line"><span class="bullet">- </span><span class="code">`label`</span> directives group the output and filter for internal routing</span><br><span class="line"><span class="bullet">- </span><span class="code">`@include`</span> directives include other files.</span><br></pre></td></tr></table></figure>
<p>source： 定义输入，数据的来源,input方向<br>match：定义输出，下一步的去向，如写入文件，或者发送到指定软件存储。output方向<br>filter：定义过滤，也即事件处理流水线，一般在输入和输出之间运行，可减少字段，也可丰富信息。<br>system：系统级别的设置，如日志级别、进程名称。<br>label：定义一组操作，从而实现复用和内部路由。<br>@include：引入其他文件，和Java、python的import类似。<br>//使用最多的就是source、match、filter</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">例如一个source部分：</span><br><span class="line"></span><br><span class="line">##### 安装指定版本插件</span><br></pre></td></tr></table></figure>
<p>td-agent-gem  install fluent-plugin-woothee –version=0.2.1<br>td-agent-gem  install woothee –version=1.4.0</p>
<p>//‘fluent-plugin-woothee’ is a Fluentd filter plugin to parse UserAgent strings and to filter/drop specified categories of user terminals (like ‘pc’, ‘smartphone’ and so on).</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; yum安装的fluentd程序，`td-agent-gem`等价于`<span class="meta-keyword">/opt/</span>td-agent<span class="meta-keyword">/embedded/</span>bin/gem`</span><br><span class="line"></span><br><span class="line">```sh</span><br><span class="line"><span class="meta"># 从 24224/tcp 接收数据</span></span><br><span class="line"><span class="meta"># This is used by log forwarding and the fluent-cat command</span></span><br><span class="line"><span class="params">&lt;source&gt;</span></span><br><span class="line">  @type forward</span><br><span class="line">  port <span class="number">24224</span></span><br><span class="line"><span class="params">&lt;/source&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 从9880/http协议接收数据</span></span><br><span class="line"><span class="meta"># http:<span class="comment">//this.host:9880/myapp.access?json=&#123;"event":"data"&#125;</span></span></span><br><span class="line"><span class="params">&lt;source&gt;</span></span><br><span class="line">  @type http</span><br><span class="line">  port <span class="number">9880</span></span><br><span class="line"><span class="params">&lt;/source&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//@type 是必须有的参数，指定类型就是指定使用的插件</span></span><br><span class="line"><span class="comment">//http：使 fluentd 转变为一个 httpd 端点，以接受进入的 http 报文。</span></span><br><span class="line"><span class="comment">//forward：使 fluentd 转变为一个 TCP 端点，以接受 TCP 报文。</span></span><br></pre></td></tr></table></figure>

<h2 id="插件介绍及安装"><a href="#插件介绍及安装" class="headerlink" title="插件介绍及安装"></a>插件介绍及安装</h2><h5 id="Fluentd有6种类型的插件-或者叫方法-，分别是："><a href="#Fluentd有6种类型的插件-或者叫方法-，分别是：" class="headerlink" title="Fluentd有6种类型的插件(或者叫方法)，分别是："></a>Fluentd有6种类型的插件(或者叫方法)，分别是：</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Input输入：完成输入数据的读取，由<span class="built_in">source</span>部分配置</span><br><span class="line">//常用类型：tail、http、forward、tcp、udp、<span class="built_in">exec</span></span><br><span class="line"></span><br><span class="line">Parser分析：解析插件，常与输入、输处配合使用，多见于`format`字段后面</span><br><span class="line">//常用类型：ltsv、json、自定义等</span><br><span class="line"></span><br><span class="line">Output输出：完成输出数据的操作，由match部分配置</span><br><span class="line">//常用配置：file、forward、copy、stdout、<span class="built_in">exec</span></span><br><span class="line"></span><br><span class="line">filter过滤：过滤插件</span><br><span class="line">//常用配置：grep、ignore、record_transformer</span><br><span class="line"></span><br><span class="line">Buffer缓存：缓存插件，用于缓存数据</span><br><span class="line">//常用配置：file、mem</span><br><span class="line"></span><br><span class="line">Formatter格式化：消息格式化的插件，用于输出，允许用户扩展和重新使用自定义输出格式</span><br><span class="line">//常用类型：ltsv、json等</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：out_forward 转发输出插件将事件转发到其他fluentd节点。 此插件支持负载平衡和自动故障切换，由<code>&lt;server&gt;&lt;/server&gt;</code>标记。 对于复制，请使用 out_copy 插件，</p>
</blockquote>
<p>copy 输出插件将事件复制到多个输出。由<code>&lt;store&gt;&lt;/store&gt;</code>标记</p>
<h5 id="安装一些需要的插件的命令"><a href="#安装一些需要的插件的命令" class="headerlink" title="安装一些需要的插件的命令"></a>安装一些需要的插件的命令</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/td-agent/embedded/bin/gem install woothee fluent-plugin-woothee  fluent-plugin-elasticsearch</span><br></pre></td></tr></table></figure>

<h5 id="安装指定版本插件"><a href="#安装指定版本插件" class="headerlink" title="安装指定版本插件"></a>安装指定版本插件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">td-agent-gem  install fluent-plugin-woothee --version=0.2.1</span><br><span class="line">td-agent-gem  install woothee --version=1.4.0</span><br><span class="line"></span><br><span class="line">//<span class="string">'fluent-plugin-woothee'</span> is a Fluentd filter plugin to parse UserAgent strings and to filter/drop specified categories of user terminals (like <span class="string">'pc'</span>, <span class="string">'smartphone'</span> and so on).</span><br></pre></td></tr></table></figure>

<blockquote>
<p>yum安装的fluentd程序，<code>td-agent-gem</code>等价于<code>/opt/td-agent/embedded/bin/gem</code></p>
</blockquote>
<h1 id="一些例子"><a href="#一些例子" class="headerlink" title="一些例子"></a>一些例子</h1><h2 id="http输入，stdout输出"><a href="#http输入，stdout输出" class="headerlink" title="http输入，stdout输出"></a>http输入，stdout输出</h2><p>例子</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">source</span>&gt;</span><br><span class="line">    @<span class="built_in">type</span> http</span><br><span class="line">    port 8888</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">&lt;/<span class="built_in">source</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;match td3.**&gt;</span><br><span class="line">    <span class="built_in">type</span> stdout</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure>

<p>请求</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8888</span>/td3 -d <span class="symbol">'json</span>=&#123;<span class="string">"hi"</span>:<span class="string">"abc"</span>&#125;'</span><br></pre></td></tr></table></figure>

<p>结果（/var/log/td-agent/td-agent.log）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tail -n1 /var/<span class="built_in">log</span>/td-agent/td-agent.log</span><br><span class="line">2020-06-04 22:13:52.811039879 +0800 td3: &#123;<span class="string">"hi"</span>:<span class="string">"abc"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>格式：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;match td2.**&gt;</span><br><span class="line">    @type mongo</span><br><span class="line">    host <span class="number">10.218</span>.<span class="number">139.216</span></span><br><span class="line">    port <span class="number">27017</span></span><br><span class="line">    database db_log</span><br><span class="line">    collection db_col</span><br><span class="line">    time_format %H-%M-%S:%s  <span class="comment">#时-分-秒.毫秒</span></span><br><span class="line">    <span class="keyword">localtime</span>                                  <span class="comment">#本地时间</span></span><br><span class="line">    flush_interval <span class="number">10</span><span class="keyword">s</span></span><br><span class="line">&lt;<span class="regexp">/match&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="http输入，文件输出"><a href="#http输入，文件输出" class="headerlink" title="http输入，文件输出"></a>http输入，文件输出</h2><p>例子</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mkdir /Data</span><br><span class="line">chown td-agent:td-agent /Data -R</span><br><span class="line"><span class="comment">## Source descriptions</span></span><br><span class="line"><span class="comment"># HTTP input</span></span><br><span class="line"><span class="comment"># POST http://localhost:8888/&lt;tag&gt;?json=&lt;json&gt;</span></span><br><span class="line">&lt;<span class="built_in">source</span>&gt;</span><br><span class="line">    @<span class="built_in">type</span> http</span><br><span class="line">    port 8888</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">&lt;/<span class="built_in">source</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Output</span></span><br><span class="line"><span class="comment"># File output</span></span><br><span class="line"><span class="comment"># match tag=td.*.* and output to file</span></span><br><span class="line">&lt;match td.**&gt;</span><br><span class="line">    @<span class="built_in">type</span> file</span><br><span class="line">    path /Data/test.log</span><br><span class="line">    flush_interval 10s</span><br><span class="line">&lt;/match&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## match tag=td2.*.* and output to file</span></span><br><span class="line">&lt;match td2.**&gt;</span><br><span class="line">    @<span class="built_in">type</span> file</span><br><span class="line">    path /Data/test_2.log</span><br><span class="line">    flush_interval 10s</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure>

<p>http请求：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl</span> http://127.0.0.1:8888/td2 -d <span class="string">'json=&#123;"hi":1&#125;'</span></span><br></pre></td></tr></table></figure>

<p>linux命令：</p>
<p>发POST请求工具：</p>
<p>结果查看：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat test_2.log.20200604_0.log </span><br><span class="line">2020-06-04T22:27:10+08:00	td3	&#123;<span class="string">"hi"</span>:1&#125;</span><br></pre></td></tr></table></figure>

<h2 id="http输入，mongoDB输出"><a href="#http输入，mongoDB输出" class="headerlink" title="http输入，mongoDB输出"></a>http输入，mongoDB输出</h2><p>例子</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Source descriptions</span></span><br><span class="line"><span class="comment"># HTTP input</span></span><br><span class="line"><span class="comment"># POST http://localhost:8888/&lt;tag&gt;?json=&lt;json&gt;</span></span><br><span class="line"><span class="attr">&lt;source&gt;</span></span><br><span class="line">    <span class="meta">@type</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port</span> <span class="string">8888</span></span><br><span class="line">    <span class="attr">bind</span> <span class="string">0.0.0.0</span></span><br><span class="line"><span class="attr">&lt;/source&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Output</span></span><br><span class="line"><span class="comment"># MongoDB output</span></span><br><span class="line"><span class="comment"># match tag=td2.*.* and output to file</span></span><br><span class="line"><span class="meta">&lt;match</span> <span class="string">td2.**&gt;</span></span><br><span class="line">    <span class="meta">@type</span> <span class="string">mongo</span></span><br><span class="line">    <span class="attr">host</span> <span class="string">10.218.139.216</span></span><br><span class="line">    <span class="attr">port</span> <span class="string">27017</span></span><br><span class="line">    <span class="attr">database</span> <span class="string">db_log</span></span><br><span class="line">    <span class="attr">collection</span> <span class="string">db_col</span></span><br><span class="line">    <span class="attr">time_key</span> <span class="string">time</span></span><br><span class="line">    <span class="attr">flush_interval</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">&lt;/match&gt;</span></span><br></pre></td></tr></table></figure>

<p>请求</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8888</span>/td2 -d <span class="string">'json=&#123;"hi":"123"&#125;'</span></span><br></pre></td></tr></table></figure>

<p>结果查询：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">show</span> dbs</span><br><span class="line">db_log  <span class="number">0.078</span>GB</span><br><span class="line"><span class="keyword">local</span>   <span class="number">0.078</span>GB</span><br><span class="line"></span><br><span class="line">&gt; use db_log</span><br><span class="line">switched <span class="keyword">to</span> db db_log</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">show</span> collections</span><br><span class="line">db_col</span><br><span class="line"><span class="keyword">system</span>.indexes</span><br><span class="line"></span><br><span class="line">&gt; db.db_col.find()</span><br><span class="line">&#123; "_id" : ObjectId("56af19dbdfb99f0f50000001"), "hi" : <span class="number">2</span>, "time" : ISODate("2016-02-01T08:39:47Z") &#125;</span><br></pre></td></tr></table></figure>

<h2 id="文件输入，文件输出-json格式化"><a href="#文件输入，文件输出-json格式化" class="headerlink" title="文件输入，文件输出+json格式化"></a>文件输入，文件输出+json格式化</h2><p>format部分可以位于<match>或<filter>部分中。</filter></match></p>
<h3 id="插件类型"><a href="#插件类型" class="headerlink" title="插件类型"></a>插件类型</h3><p>format部分需要@type参数来指定格式化程序插件的类型。 fluentd内置了一些有用的格式化程序插件。安装第三方插件时也可以使用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">format</span>&gt;</span></span><br><span class="line">  @type json</span><br><span class="line"><span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面是一些内置的格式化插件：</p>
<ul>
<li>out_file</li>
<li>json</li>
<li>ltsv</li>
<li>csv</li>
<li>msgpack</li>
<li>hash</li>
<li>single_value</li>
</ul>
<h3 id="参数："><a href="#参数：" class="headerlink" title="参数："></a>参数：</h3><ul>
<li>@type：指定插件类型</li>
</ul>
<h3 id="时间参数"><a href="#时间参数" class="headerlink" title="时间参数"></a>时间参数</h3><ul>
<li>time_type：时间类型<ul>
<li>默认值：float</li>
<li>可选值：float, unixtime, string<ul>
<li>float: 纪元+纳秒(例如:1510544836.154709804)</li>
<li>unixtime: 纪元(例如:1510544815)</li>
<li>string: 使用由<code>time_format</code>、本地时间或时区指定的格式</li>
</ul>
</li>
</ul>
</li>
<li>time_format：时间格式<ul>
<li>默认值：nil</li>
</ul>
</li>
<li>localtime：如果为真，使用本地时间。否则，使用 UTC<ul>
<li>默认值：true</li>
</ul>
</li>
<li>utc：如果为真，使用UTC。否则，使用本地时间<ul>
<li>默认值：false</li>
</ul>
</li>
<li>timezone：指定时区<ul>
<li>默认值：nil</li>
<li>可用的时区格式：<ol>
<li>[+-]HH:MM(例如:+09:00)</li>
<li>[+-]HHMM(例如:+0900)</li>
<li>[+-]HH(例如:+09)</li>
<li>Region/Zone(例如:Asia/Tokyo)</li>
<li>Region/Zone/Zone(例如:America/Argentina/Buenos_Aires)</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="json插件举例："><a href="#json插件举例：" class="headerlink" title="json插件举例："></a>json插件举例：</h3><p>json格式化插件将事件转换为json。默认情况下，json格式化程序结果不包含标签和时间字段。</p>
<p>可用参数：</p>
<ul>
<li><a href="https://soulchild.cn/1717.html" target="_blank" rel="noopener">通用参数</a></li>
<li><a href="https://soulchild.cn/1752.html#" target="_blank" rel="noopener">format参数</a></li>
<li>add_newline: 在结果中添加\n<ul>
<li>默认值：true</li>
</ul>
</li>
</ul>
<p>下面的配置是从/Data/test.log文件中读取内容，并写入文件</p>
<p>我们先来看一下不使用format的显示结果</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;source&gt;</span><br><span class="line">    @<span class="keyword">type</span> tail</span><br><span class="line">    tag   <span class="keyword">test</span>.aa</span><br><span class="line">    path  /Data/<span class="keyword">test</span>.<span class="keyword">log</span></span><br><span class="line">    pos_file /Data/<span class="keyword">test</span>.<span class="keyword">log</span>.pos</span><br><span class="line">    &lt;<span class="keyword">parse</span> **&gt;</span><br><span class="line">      @<span class="keyword">type</span> none</span><br><span class="line">    &lt;/<span class="keyword">parse</span>&gt;</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match <span class="keyword">test</span>.aa&gt;</span><br><span class="line">  @<span class="keyword">type</span> <span class="keyword">file</span></span><br><span class="line">  path /Data/<span class="keyword">test</span>-<span class="keyword">out</span>.<span class="keyword">log</span></span><br><span class="line">  flush_interval 10s</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure>

<p>模拟生成日志：<code>echo &#39;test line 1&#39; &gt;&gt; /Data/test.log</code></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Fluentd/" <i class="fa fa-tag"></i>Fluentd</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/06/02/k8s/Ingress-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" rel="prev" title="Ingress-简单使用">
      <i class="fa fa-chevron-left"></i> Ingress-简单使用
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/06/06/k8s/k8s%E5%AE%89%E8%A3%85apollo/" rel="next" title="k8s安装apollo">
      k8s安装apollo <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
      
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#ELK架构"><span class="nav-number">1.</span> <span class="nav-text">ELK架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EFK架构"><span class="nav-number">2.</span> <span class="nav-text">EFK架构</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#架构选型"><span class="nav-number"></span> <span class="nav-text">架构选型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装"><span class="nav-number"></span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装前配置"><span class="nav-number">1.</span> <span class="nav-text">安装前配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ntp时间同步-重要"><span class="nav-number">1.0.1.</span> <span class="nav-text">ntp时间同步(重要)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#文件打开数"><span class="nav-number">1.0.2.</span> <span class="nav-text">文件打开数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改-etc-sysctl-conf，添加如下内容"><span class="nav-number">1.0.3.</span> <span class="nav-text">修改&#x2F;etc&#x2F;sysctl.conf，添加如下内容</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#列出默认源"><span class="nav-number"></span> <span class="nav-text">列出默认源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#移除默认源"><span class="nav-number"></span> <span class="nav-text">移除默认源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加ruby-china源"><span class="nav-number"></span> <span class="nav-text">添加ruby-china源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查询插件"><span class="nav-number"></span> <span class="nav-text">查询插件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装mongo插件"><span class="nav-number"></span> <span class="nav-text">安装mongo插件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#tail-n-1-var-log-td-agent-td-agent-log"><span class="nav-number"></span> <span class="nav-text">tail -n 1 &#x2F;var&#x2F;log&#x2F;td-agent&#x2F;td-agent.log</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#插件介绍及安装"><span class="nav-number"></span> <span class="nav-text">插件介绍及安装</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Fluentd有6种类型的插件-或者叫方法-，分别是："><span class="nav-number">0.0.1.</span> <span class="nav-text">Fluentd有6种类型的插件(或者叫方法)，分别是：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装一些需要的插件的命令"><span class="nav-number">0.0.2.</span> <span class="nav-text">安装一些需要的插件的命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装指定版本插件"><span class="nav-number">0.0.3.</span> <span class="nav-text">安装指定版本插件</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一些例子"><span class="nav-number"></span> <span class="nav-text">一些例子</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#http输入，stdout输出"><span class="nav-number"></span> <span class="nav-text">http输入，stdout输出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http输入，文件输出"><span class="nav-number"></span> <span class="nav-text">http输入，文件输出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http输入，mongoDB输出"><span class="nav-number"></span> <span class="nav-text">http输入，mongoDB输出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文件输入，文件输出-json格式化"><span class="nav-number"></span> <span class="nav-text">文件输入，文件输出+json格式化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#插件类型"><span class="nav-number">1.</span> <span class="nav-text">插件类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参数："><span class="nav-number">2.</span> <span class="nav-text">参数：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时间参数"><span class="nav-number">3.</span> <span class="nav-text">时间参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#json插件举例："><span class="nav-number">4.</span> <span class="nav-text">json插件举例：</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">屈辉</p>
  <div class="site-description" itemprop="description">开心就好</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">84</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">屈辉</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.1
  </div> -->

        








      </div>
    </footer>
  </div>

  
  
  <script color='3423,34,234' opacity='0.35' zIndex='-1' count='150' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
