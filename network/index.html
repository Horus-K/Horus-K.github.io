<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"horus-k.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"remove","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="学习必备资源软件Local PC：8G+CentOS 7 ：http:&#x2F;&#x2F;www.centos.org&#x2F; version&gt;&#x3D;7.4 Kernel&gt;&#x3D;4.4Wireshark：https:&#x2F;&#x2F;www.wireshark.org&#x2F;Xshell：https:&#x2F;&#x2F;www.netsarang.com&#x2F;en&#x2F;xshell&#x2F;Notepad++：https:&#x2F;&#x2F;notepad-pl">
<meta property="og:type" content="website">
<meta property="og:title" content="k8s network">
<meta property="og:url" content="https://horus-k.github.io/network/index.html">
<meta property="og:site_name" content="Q&#39;s blog">
<meta property="og:description" content="学习必备资源软件Local PC：8G+CentOS 7 ：http:&#x2F;&#x2F;www.centos.org&#x2F; version&gt;&#x3D;7.4 Kernel&gt;&#x3D;4.4Wireshark：https:&#x2F;&#x2F;www.wireshark.org&#x2F;Xshell：https:&#x2F;&#x2F;www.netsarang.com&#x2F;en&#x2F;xshell&#x2F;Notepad++：https:&#x2F;&#x2F;notepad-pl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201119112801791.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201119112855506.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201119113042601.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201119114407628.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201119114820275.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201119114850538.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201123190923769.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201123191225930.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201123191347831.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201124222533450.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201125160513357.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201125160546944.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201126094227071.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201126094310012.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201126143149738.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201126160825399.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201126160834808.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201201143559617.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201201204929623.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201201205025615.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201202203950984.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201209151942902.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201209152531894.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201210163735621.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201210163759273.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201210222018157.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201210223334115.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006114818276.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006204202554.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006204210134.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006205938272.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006205950352.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006210000839.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006210009410.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006210019737.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006210031710.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006210044109.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20211006210059925.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201212172011219.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201212172159024.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201212175352436.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201212175425963.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201212224347391.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201212225721976.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201213104311185.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201213104450382.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201215150810521.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201215151916986.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201216203740857.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201216203758887.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201216203817255.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201216203837098.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201216214822402.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20201219183152754.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20210127095134834.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20210127095153219.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20210127095207361.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20210127095223455.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20210127153848450.png">
<meta property="og:image" content="https://horus-k.github.io/network/index/image-20210212134442446.png">
<meta property="article:published_time" content="2020-11-19T02:50:13.000Z">
<meta property="article:modified_time" content="2021-12-05T04:57:31.850Z">
<meta property="article:author" content="屈辉">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://horus-k.github.io/network/index/image-20201119112801791.png">


<link rel="canonical" href="https://horus-k.github.io/network/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":false,"lang":"zh-CN","comments":true,"permalink":"https://horus-k.github.io/network/index.html","path":"network/index.html","title":"k8s network"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>k8s network | Q's blog
</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Q's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一些个人文档笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">124</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">45</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">265</span></a></li><li class="menu-item menu-item-ceph"><a href="/ceph/" rel="section"><i class="address-book fa-fw"></i>ceph</a></li><li class="menu-item menu-item-k8s"><a href="/categories/k8s/" rel="section"><i class="archive fa-fw"></i>k8s</a></li><li class="menu-item menu-item-network"><a href="/network/" rel="section"><i class="archive fa-fw"></i>network</a></li>
  </ul>
</nav>




</header>
    </div>

    <div class="main-inner page posts-expand">


    
    
    
    <div class="post-block" lang="zh-CN"><header class="post-header">

<h1 class="post-title" itemprop="name headline">k8s network
</h1>

<div class="post-meta-container">
</div>

</header>

      
      
      <div class="post-body">
          <h1 id="学习必备资源"><a href="#学习必备资源" class="headerlink" title="学习必备资源"></a>学习必备资源</h1><h2 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h2><p>Local PC：8G+<br>CentOS 7 ：<a target="_blank" rel="noopener" href="http://www.centos.org/">http://www.centos.org/</a> version&gt;&#x3D;7.4 Kernel&gt;&#x3D;4.4<br>Wireshark：<a target="_blank" rel="noopener" href="https://www.wireshark.org/">https://www.wireshark.org/</a><br>Xshell：<a target="_blank" rel="noopener" href="https://www.netsarang.com/en/xshell/">https://www.netsarang.com/en/xshell/</a><br>Notepad++：<a target="_blank" rel="noopener" href="https://notepad-plus-plus.org/">https://notepad-plus-plus.org/</a><br>VMWare：<a target="_blank" rel="noopener" href="https://my.vmware.com/en/web/vmware/downloads">https://my.vmware.com/en/web/vmware/downloads</a><br>VirtualBox：<a target="_blank" rel="noopener" href="https://www.virtualbox.org/">https://www.virtualbox.org/</a><br>Docker-CE：<a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/centos/">https://docs.docker.com/install/linux/docker-ce/centos/</a><br>Docker-CE：<a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/110806">https://yq.aliyun.com/articles/110806</a><br>Kubernetes：V1.16.0<br>Mirrors：<a target="_blank" rel="noopener" href="https://opsx.alibaba.com/mirror">https://opsx.alibaba.com/mirror</a><br>Note：<a target="_blank" rel="noopener" href="https://www.yinxiang.com/download/">https://www.yinxiang.com/download/</a><br>eNSP：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1n2nZbeMDP49CE6ZDRxZHcA">https://pan.baidu.com/s/1n2nZbeMDP49CE6ZDRxZHcA</a> Extraction code：k8sn</p>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>RFC Docs：<a target="_blank" rel="noopener" href="https://ietf.org/standards/rfcs/">https://ietf.org/standards/rfcs/</a><br>HTTP2：<a target="_blank" rel="noopener" href="https://http2.github.io/">https://http2.github.io/</a><br>Kubernetes Docs：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/Kubernetes">https://github.com/kubernetes/Kubernetes</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/">https://kubernetes.io/docs/concepts/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/">https://kubernetes.io/docs/tasks/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/">https://kubernetes.io/docs/reference/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/">https://kubernetes.io/docs/tutorials/</a></p>
<p>Flannel Docs：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a><br><a target="_blank" rel="noopener" href="https://coreos.com/flannel/docs/latest/">https://coreos.com/flannel/docs/latest/</a></p>
<p>Calico Docs：</p>
<p><a target="_blank" rel="noopener" href="https://www.projectcalico.org/">https://www.projectcalico.org/</a><br><a target="_blank" rel="noopener" href="https://github.com/projectcalico/calico">https://github.com/projectcalico/calico</a></p>
<p>Cilium Docs：</p>
<p><a target="_blank" rel="noopener" href="https://cilium.io/">https://cilium.io/</a><br><a target="_blank" rel="noopener" href="https://github.com/cilium/cilium">https://github.com/cilium/cilium</a></p>
<p>DANM Docs：</p>
<p><a target="_blank" rel="noopener" href="https://www.gitmemory.com/nokia/danm">https://www.gitmemory.com/nokia/danm</a><br><a target="_blank" rel="noopener" href="https://github.com/nokia/danm">https://github.com/nokia/danm</a></p>
<p>Nuage Docs：</p>
<p><a target="_blank" rel="noopener" href="https://www.nuagenetworks.net/">https://www.nuagenetworks.net/</a><br><a target="_blank" rel="noopener" href="https://github.com/nuagenetworks">https://github.com/nuagenetworks</a></p>
<p>Multus Docs： </p>
<p><a target="_blank" rel="noopener" href="https://01.org/kubernetes/building-blocks/multus-cni">https://01.org/kubernetes/building-blocks/multus-cni</a><br><a target="_blank" rel="noopener" href="https://github.com/intel/multus-cni">https://github.com/intel/multus-cni</a></p>
<p>Genie Docs： </p>
<p><a target="_blank" rel="noopener" href="https://asciinema.org/a/118191">https://asciinema.org/a/118191</a><br><a target="_blank" rel="noopener" href="https://github.com/cni-genie/CNI-Genie">https://github.com/cni-genie/CNI-Genie</a></p>
<p>IP：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc791">https://tools.ietf.org/html/rfc791</a><br>RIP：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2453">https://tools.ietf.org/html/rfc2453</a><br>OSPF：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2328">https://tools.ietf.org/html/rfc2328</a><br>BGP：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc1105">https://tools.ietf.org/html/rfc1105</a><br>3GPP：<a target="_blank" rel="noopener" href="https://www.3gpp.org/">https://www.3gpp.org/</a></p>
<p><strong>本事实验环境：</strong></p>
<table>
<thead>
<tr>
<th>软件</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>virtualBox</td>
<td>5.2.30</td>
</tr>
<tr>
<td>wireshark</td>
<td>2.6.20</td>
</tr>
<tr>
<td>eNsp</td>
<td>V100R003C00SPC100</td>
</tr>
</tbody></table>
<h2 id="CentOS安装rpcapd服务（WinPcap）"><a href="#CentOS安装rpcapd服务（WinPcap）" class="headerlink" title="CentOS安装rpcapd服务（WinPcap）"></a>CentOS安装rpcapd服务（WinPcap）</h2><p><strong>安装命令如下：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install byacc glibc-static libgcrypt-devel gcc flex</span><br><span class="line">wget http://www.winpcap.org/install/bin/WpcapSrc_4_1_2.zip</span><br><span class="line">unzip WpcapSrc_4_1_2.zip</span><br><span class="line"><span class="built_in">cd</span> winpcap/wpcap/libpcap</span><br><span class="line"><span class="built_in">chmod</span> +x configure runlex.sh</span><br><span class="line">CFLAGS=-static ./configure</span><br><span class="line">make</span><br><span class="line"><span class="built_in">cd</span> rpcapd</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">./rpcapd -p 2002 -b 172.12.1.201 -n</span><br></pre></td></tr></table></figure>

<h2 id="华为交换机命令"><a href="#华为交换机命令" class="headerlink" title="华为交换机命令"></a>华为交换机命令</h2><h3 id="查看设备的mac-table"><a href="#查看设备的mac-table" class="headerlink" title="查看设备的mac table"></a>查看设备的mac table</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Huawei]dis mac-address</span><br><span class="line"><span class="section">MAC address table of slot 0:</span></span><br><span class="line"><span class="section">-------------------------------------------------------------------------------</span></span><br><span class="line">MAC Address    VLAN/       PEVLAN CEVLAN Port            Type      LSP/LSR-ID  </span><br><span class="line"><span class="section">               VSI/SI                                              MAC-Tunnel  </span></span><br><span class="line"><span class="section">-------------------------------------------------------------------------------</span></span><br><span class="line">5489-9836-6440 1           -      -      GE0/0/3         dynamic   0/-         </span><br><span class="line">5489-983f-5752 1           -      -      GE0/0/2         dynamic   0/-         </span><br><span class="line"><span class="section">5489-98df-112c 1           -      -      GE0/0/1         dynamic   0/-         </span></span><br><span class="line"><span class="section">-------------------------------------------------------------------------------</span></span><br><span class="line">Total matching items on slot 0 displayed = 3 </span><br></pre></td></tr></table></figure>

<h3 id="手工清除mac-address"><a href="#手工清除mac-address" class="headerlink" title="手工清除mac-address"></a>手工清除mac-address</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undo mac-<span class="selector-tag">address</span></span><br></pre></td></tr></table></figure>

<h3 id="配置查看ip"><a href="#配置查看ip" class="headerlink" title="配置查看ip"></a>配置查看ip</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sys</span></span><br><span class="line">int &lt;接口&gt;</span><br><span class="line">ip address <span class="number">172.30.0.1</span> <span class="number">255.255.192.0</span></span><br><span class="line">dis ip </span><br></pre></td></tr></table></figure>

<h3 id="查看arp"><a href="#查看arp" class="headerlink" title="查看arp"></a>查看arp</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dis arp</span></span><br></pre></td></tr></table></figure>

<h2 id="查看配置"><a href="#查看配置" class="headerlink" title="查看配置"></a>查看配置</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dis cu</span></span><br></pre></td></tr></table></figure>



<h1 id="IP-amp-MAC"><a href="#IP-amp-MAC" class="headerlink" title="IP &amp; MAC"></a>IP &amp; MAC</h1><h2 id="Network-MAC-Address"><a href="#Network-MAC-Address" class="headerlink" title="Network-MAC Address"></a>Network-MAC Address</h2><p>MAC（Media Access Control）地址用来定义网络设备的位置。MAC地址由48比特长、12位的16进制数字组成，其中从左到右开始，0到23bit是厂商向IETF等机构申请用来标识厂商的代码(OUI)，24到47bit由厂商自行分派，是各个厂商制造的所有网卡的一个唯一编号。<br>MAC地址可以分为3种类型：</p>
<ul>
<li>物理MAC地址：这种类型的MAC地址唯一的标识了以太网上的一个终端，该地址为全球唯一的硬件地址。</li>
<li>广播MAC地址：全1的MAC地址（FF-FF-FF-FF-FF-FF），用来表示LAN上的所有终端设备。</li>
<li>组播MAC地址：除广播地址外，第8bit为1的MAC地址为组播MAC地址（例如01-00-00-00-00-00），用来代表LAN上的一组终端。</li>
</ul>
<p><strong>静态MAC地址（Static MAC）</strong></p>
<p>由用户通过命令配置的静态转发的MAC地址，静态MAC地址和动态MAC地址的功能不同 ，静态地址一旦被加入，该地址在删除之前将一直有效，不受最大老化时间的限制。</p>
<p><strong>动态MAC地址（Dynamic MAC）</strong></p>
<p>由交换机从接受到报文自动学习到的MAC地址，当端口收到一个报文时，会查找报文的源MAC地址是否存 在于MAC地址表中，如果不存在则会将相应的端口、VLAN和源MAC地址关联起来，并保存到MAC地址表中， 动态MAC地址在达到一定老化时间后会被老化删除，但如果该地址在老化时间内被正确使用过，则会重新 激活该条地址的老化时间，同时MAC地址和端口的对应关系会随着设备所连的交换机的端口的变化而变化。</p>
<p><strong>过滤MAC地址、黑洞MAC地址</strong></p>
<p>由用户通过命令配置的静态过滤的MAC地址，当网关接收到的报文中，源或者目的MAC 地址为过滤MAC地址，则直接丢弃该报文。</p>
<h2 id="Network-MAC-Address-Table"><a href="#Network-MAC-Address-Table" class="headerlink" title="Network-MAC Address Table"></a>Network-MAC Address Table</h2><p>设备学习MAC地址的方法如下：如果从某接口（假设为接口A）收到一个数据帧，设备就会分析该数据帧的源MAC地址（假设为MAC-SOURCE）并认为目的MAC地址为MAC-SOURCE的报文可以由接口A转发；如果MAC地址表中已经包含MAC-SOURCE，设备将对该表项进行更新；</p>
<p>如果MAC地址表中尚未包含MAC-SOURCE，设备则将这个新MAC地址以及该MAC地址对应的接口A作为一个新的表项加入到MAC地址表中。</p>
<p>Note：用户手工配置的静态MAC地址表项和黑洞MAC地址表项不会被动态MAC地址表项覆盖，而动态MAC地址表项可以被静态MAC地址表项和黑洞MAC地址表项覆盖。</p>
<p>设备在转发报文时，根据MAC地址表项信息，会采取以下两种转发方式：</p>
<ul>
<li>单播方式：当MAC地址表中包含与报文目的MAC地址对应的表项时，直接将报文从该表项中的转发出接口发送。</li>
<li>广播方式：当设备收到目的地址为全1的报文，或MAC地址表中没有包含对应报文目的MAC地址的表项时，设备</li>
</ul>
<p>将采取广播方式将报文向除接收接口外的所有接口进行转发。</p>
<img src="/network/index/image-20201119112801791.png" alt style="zoom:67%;">

<h2 id="Network-MAC-Address-Table-Expiring"><a href="#Network-MAC-Address-Table-Expiring" class="headerlink" title="Network-MAC Address Table Expiring"></a>Network-MAC Address Table Expiring</h2><p>MAC地址老化过程：</p>
<p>为适应网络的变化，MAC表需要不断更新。MAC表中自动生成的表项（即动态表项）并非永远有效，每一条表项都有一个生存周期，到达生存周期仍得不到更新的表项将被删除，这个生存周期被称作老化时间。如果在到达生存周期前记录被更新，则该表项的老化时间重新计算。</p>
<img src="/network/index/image-20201119112855506.png" alt="image-20201119112855506" style="zoom:67%;">

<p>设备MAC地址老化时间设置为T。在t1时刻有源MAC地址为00e0-fc00-0001、VLAN为1的报文从某接口进入。假定该接口已加入VLAN 1。</p>
<p>如果之前MAC地址表不存在关于(MAC: 00e0-fc00-0001，VLAN: 1)的任何种类表项，那么这个地址就会作为动态MAC地址表项学习到地址表里，同时该表项的命中标志位被置1。</p>
<p>设备周期性(每经过T时间)地对所有学习到的动态MAC地址表项进行检查。</p>
<ul>
<li>在t2时刻，检查到动态表项(MAC: 00e0-fc00-0001，VLAN: 1)的命中标志位为1，则将该表项的命中标志位置为0，但不删除这条表项。</li>
<li>在t2时刻和t3时刻之间没有这种报文进入设备，那么该表项的命中标志位会一直保持为0。</li>
<li>在t3时刻，设备检查到该表项的命中标志位为0，认为该表项的老化时间到达，将删除此条表项。</li>
</ul>
<h2 id="Network-IP-Address"><a href="#Network-IP-Address" class="headerlink" title="Network-IP Address"></a>Network-IP Address</h2><p>IP地址是在计算机网络中被用来唯一标识一台设备的一组数字。</p>
<p>IPv4地址由32位二进制数值组成，但为了便于用户识别和记忆，采用了“点分十进制表示法”。</p>
<p>采用了这种表示法的IPv4地址由4个点分十进制整数来表示，每个十进制整数对应一个字节。</p>
<p>IPv4地址由如下两部分组成：</p>
<ul>
<li>网络号码字段（Net-id）：用来标识一个网络。</li>
<li>主机号码字段（Host-id）：用来区分一个网络内的不同主机。对于网络号相同的设备，无论实际所处的物理位置如何，它们都是处在同一个网络中。</li>
</ul>
<p><strong>IPv4地址分类：</strong></p>
<p><img src="/network/index/image-20201119113042601.png" alt="image-20201119113042601"></p>
<h2 id="Network-IP-Packet-Format"><a href="#Network-IP-Packet-Format" class="headerlink" title="Network-IP Packet Format"></a>Network-IP Packet Format</h2><p><img src="/network/index/image-20201119114407628.png" alt="image-20201119114407628"></p>
<img src="/network/index/image-20201119114820275.png" alt="image-20201119114820275" style="zoom:67%;">

<table>
<thead>
<tr>
<th>字段</th>
<th>长度</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>版本</td>
<td>4比特</td>
<td>IP协议的版本号，分为IPv4和IPv6协议。</td>
</tr>
<tr>
<td>首部长度</td>
<td>4比特</td>
<td>IPv4的首部长度。</td>
</tr>
<tr>
<td>区分服务</td>
<td>8比特</td>
<td>用来获得更好的服务。只有在使用区分服务时，这个字段才起作用。</td>
</tr>
<tr>
<td>总长度</td>
<td>16比特</td>
<td>指首部和数据之和的长度。</td>
</tr>
<tr>
<td>标识</td>
<td>16比特</td>
<td>IPv4软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1,并将此值赋给标识字段。</td>
</tr>
<tr>
<td>标志</td>
<td>3比特</td>
<td>目前只有两位有意义。最低位为1表示后面“还有分片”的数据报，为0表示这已经是最后一个数据片；中间一位为1表示“不能分片”，为0才允许分片。</td>
</tr>
<tr>
<td>片位移</td>
<td>13比特</td>
<td>指出较长的分组在分片后，该片在原分组中的相对位置。</td>
</tr>
<tr>
<td>TTL</td>
<td>8比特</td>
<td>表示数据报在网络中的寿命，功能是“跳数限制”。</td>
</tr>
<tr>
<td>协议</td>
<td>8比特</td>
<td>指出此数据报携带的数据是使用何种协议。</td>
</tr>
<tr>
<td>首部佥3验和</td>
<td>16比特</td>
<td>数据报每经过一个设备，设备都要重新计算一下首部检验和，若首部未发生变化，则此结果必为0，于是就保留这个数据报。这个字段只检3佥数据报的首部，但不包括数据部分。</td>
</tr>
<tr>
<td>源地址</td>
<td>32比特</td>
<td>报文发送方的IPv4地址。</td>
</tr>
<tr>
<td>目的地址</td>
<td>32比特</td>
<td>报文接收方的IPv4地址。</td>
</tr>
<tr>
<td>选项字段</td>
<td>0~40字节</td>
<td>用来支持排错、测量以及安全等措施。在必要的时候插入值为0的填充字节。</td>
</tr>
<tr>
<td>数据部分</td>
<td>可变</td>
<td>用来填充报文。</td>
</tr>
</tbody></table>
<h2 id="Network-VLSM"><a href="#Network-VLSM" class="headerlink" title="Network - VLSM"></a>Network - VLSM</h2><p>VLSM(可变长子网掩码) 是为了有效的使用无类别域间路由（CIDR）和路由汇聚(route summary)来控制路由表的大小，</p>
<p>它是网络管理员常用的IP寻址技术，VLSM就是其中的常用方式，可以对子网进行层次化编址，以便最有效的利用现有的地址空间。</p>
<p><img src="/network/index/image-20201119114850538.png" alt="image-20201119114850538"></p>
<h2 id="网络模型"><a href="#网络模型" class="headerlink" title="网络模型"></a>网络模型</h2><p><img src="/network/index/image-20201123190923769.png" alt="image-20201123190923769"></p>
<h2 id="IPVLAN"><a href="#IPVLAN" class="headerlink" title="IPVLAN"></a>IPVLAN</h2><h3 id="L2"><a href="#L2" class="headerlink" title="L2"></a>L2</h3><p>ipvlan L2 模式和 macvlan bridge 模式工作原理很相似，父接口作为交换机来转发子接口的数据。</p>
<p>同一个网络的子接口可以通过父接口来转发数据，而如果想发送到其他网络，报文则会通过父接口的路由转发出去。</p>
<p><img src="/network/index/image-20201123191225930.png" alt="image-20201123191225930"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ip netns add net1</span><br><span class="line">ip netns add net2</span><br><span class="line">ip link add ipvlan1 link eth0 type ipvlan mode l2</span><br><span class="line">ip link add ipvlan2 link eth0 type ipvlan mode l2</span><br><span class="line">ip link set ipvlan1 netns net1</span><br><span class="line">ip link set ipvlan2 netns net2</span><br><span class="line">ip netns exec net1 ifconfig ipvlan1 172.12.1.5/24 up</span><br><span class="line">ip netns exec net2 ifconfig ipvlan2 172.12.1.6/24 up</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#访问外网添加路由</span></span></span><br><span class="line">ip netns exec net1 route add -net 0.0.0.0/0 gw 172.12.1.2</span><br><span class="line">ip netns exec net2 route add -net 0.0.0.0/0 gw 172.12.1.2</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> net2 route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         172.12.1.2      0.0.0.0         UG    0      0        0 ipvlan2</span><br><span class="line">172.12.1.0      0.0.0.0         255.255.255.0   U     0      0        0 ipvlan2</span><br></pre></td></tr></table></figure>

<h3 id="L3"><a href="#L3" class="headerlink" title="L3"></a>L3</h3><p>ipvlan 有点像路由器的功能，它在各个虚拟网络和主机网络之间进行不同网络报文的路由转发工作。</p>
<p>只要父接口相同，即使虚拟机&#x2F;容器不在同一个网络，也可以互相 ping 通对方，因为 ipvlan 会在中间做报文的转发工作。</p>
<p><img src="/network/index/image-20201123191347831.png" alt="image-20201123191347831"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ip netns add net1</span><br><span class="line">ip netns add net2</span><br><span class="line">ip <span class="built_in">link</span> add ipvlan1 <span class="built_in">link</span> eth0 <span class="built_in">type</span> ipvlan mode l3</span><br><span class="line">ip <span class="built_in">link</span> add ipvlan2 <span class="built_in">link</span> eth0 <span class="built_in">type</span> ipvlan mode l3</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> ipvlan1 netns net1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> ipvlan2 netns net2</span><br><span class="line">ip netns <span class="built_in">exec</span> net1 ifconfig ipvlan1 172.12.10.5/24 up</span><br><span class="line">ip netns <span class="built_in">exec</span> net2 ifconfig ipvlan2 172.12.20.6/24 up</span><br><span class="line"><span class="comment">##添加路由</span></span><br><span class="line">ip netns <span class="built_in">exec</span> net1 route add -net 172.12.20.0/24 dev ipvlan1</span><br><span class="line">ip netns <span class="built_in">exec</span> net2 route add -net 172.12.10.0/24 dev ipvlan2</span><br></pre></td></tr></table></figure>

<p>无法自己学习路由</p>
<h2 id="MACVLAN"><a href="#MACVLAN" class="headerlink" title="MACVLAN"></a>MACVLAN</h2><p>Macvlan用简单的网桥连接父接口上的所有子接口。</p>
<p>从一个接口到另一个接口的帧将直接发送，而不发送出去。</p>
<p>广播帧被泛洪到所有其他网桥端口和外部接口，但是当它们从VEP交换机返回时，将被丢弃。 </p>
<p>由于所有macvlan子接口MAC地址都是已知的，因此macvlan桥接模式不需要MAC学习，也不需要STP。</p>
<p>桥接模式可在虚拟机之间提供最快的通信，但有一个“缺陷”，您应该注意–如果父接口状态下降，所有macvlan子接口也会下降。 当物理接口断开连接时，VM将无法相互通信。</p>
<p><img src="/network/index/image-20201124222533450.png" alt="image-20201124222533450"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 promisc #开启混杂模式<span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>netns <span class="built_in">add</span> net1<span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>netns <span class="built_in">add</span> net2<span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>link <span class="built_in">add</span> link eth0 name macv1<span class="built_in"> type </span>macvlan mode<span class="built_in"> bridge</span></span><br><span class="line"><span class="built_in">ip </span>link <span class="built_in">add</span> link eth0 name macv2<span class="built_in"> type </span>macvlan mode<span class="built_in"> bridge</span></span><br><span class="line"><span class="built_in">ip </span>link <span class="built_in">set</span> macv1 netns net1<span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>link <span class="built_in">set</span> macv2 netns net2<span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>netns exec net1 ifconfig macv1 172.12.1.5/24 up<span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>netns exec net2 ifconfig macv2 172.12.1.6/24 up</span><br></pre></td></tr></table></figure>

<h1 id="Linux网络"><a href="#Linux网络" class="headerlink" title="Linux网络"></a>Linux网络</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU4MjQ0MTU4Ng==&mid=2247487543&idx=1&sn=fc33ac3574743cc40f9c365ee12d6607&chksm=fdb91f2acace963cc31fae75e756e4e2f932c81b5d6e0373d9f0deffb518d367812508c02f93&mpshare=1&scene=1&srcid=1123KlT4IX6BQOpdWV5RBnhx&sharer_sharetime=1606105541377&sharer_shareid=ca3338040ec98c721a207c338f2b28ab&key=6b64641f420daf84a6e3290aa9c671e729bf319c854c0a0ec398366272f7747e8041fb54fcdbea96e59ca5e0d474dccab6be322473a493af627232eed5b1a76469641429296deae5c1fdc874ea6db4735404d0a1693308f24543e6428e3b4f62e350500b02e503daed80a81053e2291c5a9c6c8ae61a9ea8f37b5de3e38a71a8&ascene=1&uin=MjAyODg3MjIxMQ==&devicetype=Windows+10+x64&version=63000039&lang=zh_CN&exportkey=AxznzQ3Eng4sX/dGqy34KBc=&pass_ticket=W1194pkA1JXLzo/jY3QjrukvfFEVYvO1Ubf2IQqAIYkoCIW4Mrr9HocUwRF9hyl3&wx_header=0">微信文章</a></p>
<h2 id="网络命名空间"><a href="#网络命名空间" class="headerlink" title="网络命名空间"></a>网络命名空间</h2><p>我们知道容器运行时使用 namespace（命名空间）内核功能对系统资源进行分区，以实现某种形式的进程隔离，这样，对一个命名空间中资源的更改不会影响其他命名空间中的资源，包括进程 ID、主机名、用户 ID、文件名和网络接口等。</p>
<p>网络名称空间可以虚拟化网络堆栈，每个网络名称空间都有自己的资源，例如网络接口、IP 地址、路由表、隧道、防火墙等，例如，<code>iptables</code>添加到网络名称空间的规则只会影响进入和离开该名称空间的流量。</p>
<h2 id="VETH-PEER"><a href="#VETH-PEER" class="headerlink" title="VETH PEER"></a>VETH PEER</h2><p><img src="/network/index/image-20201125160513357.png" alt="image-20201125160513357"></p>
<p>veth 接口通常被创建为一个对，其中一端传输的数据会立即被另一端接收，这种类型的接口在容器运行时通常用于在不同网络命名空间之间传输数据包。</p>
<h3 id="配置第一个网络命名空间"><a href="#配置第一个网络命名空间" class="headerlink" title="配置第一个网络命名空间"></a>配置第一个网络命名空间</h3><p>首先我们使用 <code>ip link add</code> 命令创建一对新的 veth 接口：veth0 和 veth1：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一对名为 veth0 和 veth1 的 veth 接口。</span></span><br><span class="line">$ ip <span class="built_in">link</span> add veth0 <span class="built_in">type</span> veth peer name veth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认 veth0 已创建	</span></span><br><span class="line">$ ip <span class="built_in">link</span> show veth0</span><br><span class="line">289: veth0@veth1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 5e:87:<span class="built_in">df</span>:87:af:c7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认 veth1 已创建</span></span><br><span class="line">$ ip <span class="built_in">link</span> show veth1</span><br><span class="line">288: veth1@veth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether be:0d:a4:8c:9f:2a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    </span><br><span class="line"><span class="variable">$ip</span> netns <span class="built_in">exec</span> ns1 ethtool -S veth0</span><br><span class="line">NIC statistics:</span><br><span class="line">     peer_ifindex: 4 <span class="comment">#对端id</span></span><br><span class="line">     rx_queue_0_xdp_packets: 0</span><br><span class="line">     rx_queue_0_xdp_bytes: 0</span><br><span class="line">     rx_queue_0_drops: 0</span><br><span class="line">     rx_queue_0_xdp_redirect: 0</span><br><span class="line">     rx_queue_0_xdp_drops: 0</span><br><span class="line">     rx_queue_0_xdp_tx: 0</span><br><span class="line">     rx_queue_0_xdp_tx_errors: 0</span><br><span class="line">     tx_queue_0_xdp_xmit: 0</span><br><span class="line">     tx_queue_0_xdp_xmit_errors: 0</span><br><span class="line">$ ip a</span><br><span class="line">...</span><br><span class="line">4: veth1@if5: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 8a:5c:72:4b:c4:a3 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></pre></td></tr></table></figure>

<p>veth 接口通常被创建为一个对，其中一端传输的数据会立即被另一端接收，这种类型的接口在容器运行时通常用于在不同网络命名空间之间传输数据包。</p>
<p>让我们创建第一个网络命名空间 ns1，然后我们可以将 veth0 接口分配给这个网络命名空间，并将 <code>10.0.1.0/24</code> 的 IP 地址范围分配给它。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 ns1 网络命名空间</span></span><br><span class="line">$ ip netns add ns1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分配 veth0 接口到 ns1 网络命名空间</span></span><br><span class="line">$ ip link <span class="built_in">set</span> veth0 netns ns1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 10.0.1.0/24 IP 地址范围分配给 veth0 接口</span></span><br><span class="line">$ ip -n ns1 addr add <span class="number">10.0</span>.<span class="number">1.0</span>/<span class="number">24</span> dev veth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 veth0 接口 up 起来</span></span><br><span class="line">$ ip -n ns1 link <span class="built_in">set</span> veth0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 lo 接口 up 起来，因为发往 10.0.1.0/24 的数据（本地的）</span></span><br><span class="line"><span class="comment"># （像 ping）要通过 local（本地）路由表</span></span><br><span class="line"><span class="comment"># 比如要 ping 自己</span></span><br><span class="line">$ ip -n ns1 link <span class="built_in">set</span> lo up </span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认接口已经 up 起来</span></span><br><span class="line">$ ip -n ns1 addr show</span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">289</span>: veth0@if288: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> LOWERLAYERDOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">5</span>e:<span class="number">87</span>:df:<span class="number">87</span>:af:c7 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="number">0</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">10.0</span>.<span class="number">1.0</span>/<span class="number">24</span> scope <span class="keyword">global</span> veth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>现在如果我们从主机和 ns1 两个网络命名空间中去 ping veth0 接口会发生什么呢？</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># veth0 不在主机的根网络命名空间中</span></span><br><span class="line">$<span class="built_in"> ip </span>link show veth0            </span><br><span class="line">Device <span class="string">&quot;veth0&quot;</span> does <span class="keyword">not</span> exist.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从主机网络命名空间中 ping 不通</span></span><br><span class="line">$<span class="built_in"> ping </span>-c10 10.0.1.0<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>10.0.1.0 (10.0.1.0) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 10.0.1.0<span class="built_in"> ping </span>statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 1999ms</span><br></pre></td></tr></table></figure>

<p>我们可以看到直接在主机的根网络命名空间中是找不到 veth0 这个接口的，当然也是 ping 不同 <code>10.0.1.0</code> 这个地址的，因为他们被绑定到 ns1 这个网络命名空间中，所以我们在操作的时候需要切换到这个命名空间下面。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> ip </span>netns exec ns1<span class="built_in"> ping </span>-c10 10.0.1.0<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>10.0.1.0 (10.0.1.0) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.1.0: <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.121 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.1.0: <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.063 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.1.0: <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.066 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.1.0: <span class="attribute">icmp_seq</span>=4 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.109 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.0.1.0<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3000ms</span><br><span class="line">rtt min/avg/max/mdev = 0.063/0.089/0.121/0.028 ms</span><br></pre></td></tr></table></figure>

<p>这里我们使用了一条 <code>ip netns exec</code> 的命令，这个命令允许我们在指定的网络命名空间中去执行任意的命令，可以看到现在我们在 ns1 网络命名空中间去 ping <code>10.0.1.0</code> 就可以通了。</p>
<h3 id="配置第二个网络命名空间"><a href="#配置第二个网络命名空间" class="headerlink" title="配置第二个网络命名空间"></a>配置第二个网络命名空间</h3><p>下面我们用上面的方式来创建第二个网络命名空间 <code>ns2</code>，然后将 veth1 接口分配给这个网络命名空间，并将 <code>10.0.2.0/24</code> 的 IP 地址范围分配给这个接口。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建名为 ns2 的网络命名空间</span></span><br><span class="line">$ ip netns add ns2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分配 veth1 接口到 ns2 网络命名空间</span></span><br><span class="line">$ ip link <span class="built_in">set</span> veth1 netns ns2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 10.0.2.0/24 IP 地址范围分配给 veth1 接口</span></span><br><span class="line">$ ip -n ns2 addr add <span class="number">10.0</span>.<span class="number">2.0</span>/<span class="number">24</span> dev veth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 veth1 接口 up 起来</span></span><br><span class="line">$ ip -n ns2 link <span class="built_in">set</span> veth1 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 lo 口 up 起来（这样可以 ping 通自己）</span></span><br><span class="line">$ ip -n ns2 link <span class="built_in">set</span> lo up </span><br><span class="line"></span><br><span class="line">$ ip -n ns2 addr show</span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">288</span>: veth1@if289: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether be:<span class="number">0</span>d:a4:<span class="number">8</span>c:<span class="number">9</span>f:<span class="number">2</span>a brd ff:ff:ff:ff:ff:ff link-netnsid <span class="number">0</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">10.0</span>.<span class="number">2.0</span>/<span class="number">24</span> scope <span class="keyword">global</span> veth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::bc0d:a4ff:fe8c:<span class="number">9</span>f2a/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>为方便后面设置路由，这里我们为 veth1 接口分配一个不同的子网 IP 范围。和 veth0 接口类似，veth1 接口也不能从主机网络命名空间到达，只能在 ns2 本身的网络命名空间内工作。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> ip </span>link show veth1</span><br><span class="line">Device <span class="string">&quot;veth1&quot;</span> does <span class="keyword">not</span> exist.</span><br><span class="line">$<span class="built_in"> ping </span>-c10 10.0.2.0<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>10.0.2.0 (10.0.2.0) 56(84) bytes of data.</span><br><span class="line"><span class="keyword">From</span> 180.149.159.13 <span class="attribute">icmp_seq</span>=2 Packet filtered</span><br><span class="line">^C</span><br><span class="line">--- 10.0.2.0<span class="built_in"> ping </span>statistics ---</span><br><span class="line">2 packets transmitted, 0 received, +1 errors, 100% packet loss, time 999</span><br><span class="line">$<span class="built_in"> ip </span>netns exec ns2<span class="built_in"> ping </span>-c10 10.0.2.0<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>10.0.2.0 (10.0.2.0) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.2.0: <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.100 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.2.0: <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.096 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.2.0: <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.068 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.0.2.0<span class="built_in"> ping </span>statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 1999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.068/0.088/0.100/0.014 ms</span><br></pre></td></tr></table></figure>

<h3 id="配置子网路由"><a href="#配置子网路由" class="headerlink" title="配置子网路由"></a>配置子网路由</h3><p>虽然在上面的两个网络空间内可以各自访问自己，但是他们互相之间是不能 ping 通的。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> ip </span>netns exec ns1<span class="built_in"> ping </span>-c10 10.0.2.0</span><br><span class="line">connect:<span class="built_in"> Network </span>is unreachable</span><br><span class="line">$<span class="built_in"> ip </span>netns exec ns2<span class="built_in"> ping </span>-c10 10.0.1.0</span><br><span class="line">connect:<span class="built_in"> Network </span>is unreachable</span><br></pre></td></tr></table></figure>

<p>veth0 和 veth1 这两个接口本身也都 up 起来了，而且在各种的网络命名空间中 ping 也能正常工作，所以互相直接不通那很可能和路由有关。下面我们使用 ip 命令来调试下，我们可以通过 <code>ip route get</code> 命令来确定一个数据包所走的路由。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> ip </span>-n ns1<span class="built_in"> route </span><span class="built_in">get</span> 10.0.2.0</span><br><span class="line">RTNETLINK answers:<span class="built_in"> Network </span>is unreachable</span><br><span class="line">$<span class="built_in"> ip </span>-n ns2<span class="built_in"> route </span><span class="built_in">get</span> 10.0.1.0</span><br><span class="line">RTNETLINK answers:<span class="built_in"> Network </span>is unreachable</span><br></pre></td></tr></table></figure>

<p>我们可以看到都是网络不可达，我们来检查下两个网络命名空间中的路由表信息。</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ip -n ns1 route</span><br><span class="line"><span class="number">10.0.1.0</span>/<span class="number">24</span> dev veth0 proto kernel scope link src <span class="number">10</span>.<span class="number">0</span>.<span class="number">1</span>.<span class="number">0</span></span><br><span class="line">$ ip -n ns2 route</span><br><span class="line"><span class="number">10.0.2.0</span>/<span class="number">24</span> dev veth1 proto kernel scope link src <span class="number">10</span>.<span class="number">0</span>.<span class="number">2</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>看到路由表是不是很清晰了，两个网络命名空间的路由表都只有各自 IP 范围的路由条目，并没有通往其他子网的路由，所以当然不能互通了，要解决也很简单，可以使用 <code>ip route add</code> 命令在路由表中插入新的路由条目是不是就可以了。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新 veth0 路由表，添加一条通往 10.0.2.0/24 的路由</span></span><br><span class="line">$<span class="built_in"> ip </span>-n ns1<span class="built_in"> route </span><span class="built_in">add</span> 10.0.2.0/24 dev veth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认发往 10.0.2.0/24 的数据包被路由到 veth0</span></span><br><span class="line">$<span class="built_in"> ip </span>-n ns1<span class="built_in"> route </span><span class="built_in">get</span> 10.0.2.0</span><br><span class="line">10.0.2.0 dev veth0 src 10.0.1.0</span><br><span class="line">    cache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样更新 veth1 路由表，添加一条通往 10.0.1.0/24 的路由</span></span><br><span class="line">$<span class="built_in"> ip </span>-n ns2<span class="built_in"> route </span><span class="built_in">add</span> 10.0.1.0/24 dev veth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认发往 10.0.1.0/24 的数据包被路由到 veth1</span></span><br><span class="line">$<span class="built_in"> ip </span>-n ns2<span class="built_in"> route </span><span class="built_in">get</span> 10.0.1.0</span><br><span class="line">10.0.1.0 dev veth1 src 10.0.2.0</span><br><span class="line">    cache</span><br></pre></td></tr></table></figure>

<p>上面我们在各自的网络命名空间中添加了对方的路由信息，现在我们来尝试 ping 下对方的 veth 接口。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> ip </span>netns exec ns1<span class="built_in"> ping </span>-c10 10.0.2.0<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>10.0.2.0 (10.0.2.0) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.2.0: <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.140 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.2.0: <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.080 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.2.0: <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.091 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.0.2.0<span class="built_in"> ping </span>statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 1999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.080/0.103/0.140/0.028 ms</span><br><span class="line"></span><br><span class="line">$<span class="built_in"> ip </span>netns exec ns2<span class="built_in"> ping </span>-c10 10.0.1.0<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>10.0.1.0 (10.0.1.0) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.1.0: <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.114 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.1.0: <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.084 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.1.0: <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.086 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.0.1.0<span class="built_in"> ping </span>statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2000ms</span><br><span class="line">rtt min/avg/max/mdev = 0.084/0.094/0.114/0.017 ms</span><br></pre></td></tr></table></figure>

<p>可以看到已经通啦！！🎉🎉🎉 此外我们还可以使用 <code>tcpdump</code> 来捕获两个网络命名空间之间传输的数据包。</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ip netns exec ns1 tcpdump -i veth0 icmp -l</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on veth0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">22.080392</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">1</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">22.080464</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">1</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">23.080409</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">2</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">23.080472</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">2</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">24.080357</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">3</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">24.080418</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">3</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">25.080346</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">4</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">25.080401</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">4</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">26.080417</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">5</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">26.080496</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">5</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">27.080454</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">6</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">27.080507</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">6</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">28.080398</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">7</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">28.080456</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">7</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">29.080390</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">8</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">29.080431</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">8</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">30.080524</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">9</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">30.080576</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">9</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">31.081895</span> IP <span class="number">10.0.2.0</span> &gt; <span class="number">10.0.1.0</span>: ICMP echo request, id <span class="number">7253</span>, seq <span class="number">10</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">29</span>:<span class="number">31.081942</span> IP <span class="number">10.0.1.0</span> &gt; <span class="number">10.0.2.0</span>: ICMP echo reply, id <span class="number">7253</span>, seq <span class="number">10</span>, length <span class="number">64</span></span><br><span class="line">^C</span><br><span class="line"><span class="number">20</span> packets captured</span><br><span class="line"><span class="number">20</span> packets received by filter</span><br><span class="line"><span class="number">0</span> packets dropped by kernel</span><br></pre></td></tr></table></figure>

<h3 id="TCP-连接"><a href="#TCP-连接" class="headerlink" title="TCP 连接"></a>TCP 连接</h3><p>最好我们来测试下 TCP 连接，使用 nc 命令在 ns1 命名空间的 7096 端口启动一个 TCP 服务器，然后从 ns2 网络命名空间发起一个 TCP 握手连接。</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip netns <span class="keyword">exec</span> ns1 nc -l <span class="number">10.0</span>.<span class="number">1.0</span> <span class="number">7096</span> -v</span><br><span class="line"><span class="keyword">exec</span> of <span class="string">&quot;nc&quot;</span> failed: No such <span class="keyword">file</span> or <span class="literal">directory</span></span><br></pre></td></tr></table></figure>

<p>上面命令报错是因为我们还没有安装 ns 这个工具，安装完成后就正常了。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -<span class="built_in">y</span> nc</span><br><span class="line"></span><br><span class="line">$ ip netns exec ns1 nc -l <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span> <span class="number">7096</span> -v</span><br><span class="line"><span class="symbol">Ncat:</span> Version <span class="number">7.50</span> ( https://nmap<span class="meta">.org</span>/ncat )</span><br><span class="line"><span class="symbol">Ncat:</span> Listening on <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>:<span class="number">7096</span></span><br></pre></td></tr></table></figure>

<p>然后重新开一个终端进行连接：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 使用 nc 从 ns2 发起 TCP 握手</span></span><br><span class="line">$ ip netns exec ns2 nc <span class="number">-4</span>t <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span> <span class="number">7096</span> -v</span><br><span class="line"><span class="symbol">Ncat:</span> Version <span class="number">7.50</span> ( https://nmap<span class="meta">.org</span>/ncat )</span><br><span class="line"><span class="symbol">Ncat:</span> Connected to <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>:<span class="number">7096.</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 这个时候正常会在前面的服务中看到连接状态</span></span><br><span class="line">$ ip netns exec ns1 nc -l <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span> <span class="number">7096</span> -v</span><br><span class="line"><span class="symbol">Ncat:</span> Version <span class="number">7.50</span> ( https://nmap<span class="meta">.org</span>/ncat )</span><br><span class="line"><span class="symbol">Ncat:</span> Listening on <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>:<span class="number">7096</span></span><br><span class="line"><span class="symbol">Ncat:</span> Connection from <span class="number">10.0</span><span class="number">.2</span><span class="number">.0</span>.</span><br><span class="line"><span class="symbol">Ncat:</span> Connection from <span class="number">10.0</span><span class="number">.2</span><span class="number">.0</span>:<span class="number">34090.</span></span><br></pre></td></tr></table></figure>

<p>一旦 TCP 连接建立，我们就可以从 ns2 向 ns1 发送测试消息了。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ip netns exec ns2 nc <span class="number">-4</span>t <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span> <span class="number">7096</span> -v</span><br><span class="line"><span class="symbol">Ncat:</span> Version <span class="number">7.50</span> ( https://nmap<span class="meta">.org</span>/ncat )</span><br><span class="line"><span class="symbol">Ncat:</span> Connected to <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>:<span class="number">7096.</span></span><br><span class="line">this is a test message  <span class="meta"># 在这里输入一段信息</span></span><br></pre></td></tr></table></figure>

<p>此时我们在 ns1 这边的服务器端也会收到发送的消息。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ip netns exec ns1 nc -l <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span> <span class="number">7096</span> -v</span><br><span class="line">Ncat: <span class="keyword">Version</span> <span class="number">7.50</span> ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Listening <span class="keyword">on</span> <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span>:<span class="number">7096</span></span><br><span class="line">Ncat: <span class="keyword">Connection</span> <span class="keyword">from</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.0</span>.</span><br><span class="line">Ncat: <span class="keyword">Connection</span> <span class="keyword">from</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.0</span>:<span class="number">34090.</span></span><br><span class="line">this <span class="keyword">is</span> a test message</span><br></pre></td></tr></table></figure>

<p>同样我们也可以使用 tcpdump 来抓取所有在两个网络命名空间之间传输的数据包。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">ip</span> <span class="string">netns</span> <span class="string">exec</span> <span class="string">ns1</span> <span class="string">tcpdump</span> <span class="string">-X</span> <span class="string">-i</span> <span class="string">veth0</span> <span class="string">-n</span> <span class="string">tcp</span> <span class="string">-l</span></span><br><span class="line"><span class="attr">tcpdump:</span> <span class="string">verbose</span> <span class="string">output</span> <span class="string">suppressed,</span> <span class="string">use</span> <span class="string">-v</span> <span class="string">or</span> <span class="string">-vv</span> <span class="string">for</span> <span class="string">full</span> <span class="string">protocol</span> <span class="string">decode</span></span><br><span class="line"><span class="string">listening</span> <span class="string">on</span> <span class="string">veth0,</span> <span class="string">link-type</span> <span class="string">EN10MB</span> <span class="string">(Ethernet),</span> <span class="string">capture</span> <span class="string">size</span> <span class="number">262144</span> <span class="string">bytes</span></span><br><span class="line"><span class="number">11</span><span class="string">:42:59.912176</span> <span class="string">IP</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.0</span><span class="number">.34090</span> <span class="string">&gt;</span> <span class="attr">10.0.1.0.7096:</span> <span class="string">Flags</span> [<span class="string">P.</span>]<span class="string">,</span> <span class="string">seq</span> <span class="number">118819706</span><span class="string">:118819735,</span> <span class="string">ack</span> <span class="number">1587208228</span><span class="string">,</span> <span class="string">win</span> <span class="number">229</span><span class="string">,</span> <span class="string">options</span> [<span class="string">nop</span>,<span class="string">nop</span>,<span class="string">TS</span> <span class="string">val</span> <span class="number">1970393377</span> <span class="string">ecr</span> <span class="number">1970365937</span>]<span class="string">,</span> <span class="string">length</span> <span class="number">29</span></span><br><span class="line"> <span class="attr">0x0000:</span>  <span class="number">4500 </span><span class="number">0051 </span><span class="string">ad52</span> <span class="number">4000 </span><span class="number">4006 </span><span class="number">7655 </span><span class="string">0a00</span> <span class="number">0200  </span><span class="string">E..Q.R@.@.vU....</span></span><br><span class="line"> <span class="attr">0x0010:</span>  <span class="string">0a00</span> <span class="number">0100 </span><span class="string">852a</span> <span class="string">1bb8</span> <span class="number">0715 </span><span class="string">0b7a</span> <span class="string">5e9a</span> <span class="string">e024</span>  <span class="string">.....*.....z^..$</span></span><br><span class="line"> <span class="attr">0x0020:</span>  <span class="number">8018 </span><span class="number">00e5</span> <span class="number">1743 </span><span class="number">0000 </span><span class="number">0101 </span><span class="string">080a</span> <span class="number">7571 </span><span class="string">d121</span>  <span class="string">.....C......uq.!</span></span><br><span class="line"> <span class="attr">0x0030:</span>  <span class="number">7571 </span><span class="string">65f1</span> <span class="number">7468 </span><span class="number">6973 </span><span class="number">2069 </span><span class="number">7320 </span><span class="string">616e</span> <span class="string">6f74</span>  <span class="string">uqe.this.is.anot</span></span><br><span class="line"> <span class="attr">0x0040:</span>  <span class="number">6865 </span><span class="number">7220 </span><span class="number">7465 </span><span class="number">7374 </span><span class="string">206d</span> <span class="number">6573 </span><span class="number">7361 </span><span class="number">6765  </span><span class="string">her.test.message</span></span><br><span class="line"> <span class="attr">0x0050:</span>  <span class="string">0a</span>                                       <span class="string">.</span></span><br><span class="line"><span class="number">11</span><span class="string">:42:59.912207</span> <span class="string">IP</span> <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span><span class="number">.7096</span> <span class="string">&gt;</span> <span class="attr">10.0.2.0.34090:</span> <span class="string">Flags</span> [<span class="string">.</span>]<span class="string">,</span> <span class="string">ack</span> <span class="number">29</span><span class="string">,</span> <span class="string">win</span> <span class="number">227</span><span class="string">,</span> <span class="string">options</span> [<span class="string">nop</span>,<span class="string">nop</span>,<span class="string">TS</span> <span class="string">val</span> <span class="number">1970393377</span> <span class="string">ecr</span> <span class="number">1970393377</span>]<span class="string">,</span> <span class="string">length</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">0x0000:</span>  <span class="number">4500 </span><span class="number">0034 </span><span class="number">4612 </span><span class="number">4000 </span><span class="number">4006 </span><span class="string">ddb2</span> <span class="string">0a00</span> <span class="number">0100  </span><span class="string">E..4F.@.@.......</span></span><br><span class="line"> <span class="attr">0x0010:</span>  <span class="string">0a00</span> <span class="number">0200 </span><span class="string">1bb8</span> <span class="string">852a</span> <span class="string">5e9a</span> <span class="string">e024</span> <span class="number">0715 </span><span class="string">0b97</span>  <span class="string">.......*^..$....</span></span><br><span class="line"> <span class="attr">0x0020:</span>  <span class="number">8010 </span><span class="number">00e3</span> <span class="number">1726 </span><span class="number">0000 </span><span class="number">0101 </span><span class="string">080a</span> <span class="number">7571 </span><span class="string">d121</span>  <span class="string">.....&amp;......uq.!</span></span><br><span class="line"> <span class="attr">0x0030:</span>  <span class="number">7571 </span><span class="string">d121</span>                                <span class="string">uq.!</span></span><br></pre></td></tr></table></figure>

<p>当然也可以将这个抓包结果保存下来然后用其他工具比如大白鲨来进行详细的分析。</p>
<h2 id="Linux-Bridge"><a href="#Linux-Bridge" class="headerlink" title="Linux Bridge"></a>Linux Bridge</h2><p><img src="/network/index/image-20201125160546944.png"></p>
<p>yum install bridge-utils</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建命名空间</span></span><br><span class="line">ip netns add ns1</span><br><span class="line">ip netns add ns2</span><br><span class="line"><span class="comment">#首先创建 bridge br0</span></span><br><span class="line">ip l a br0 <span class="built_in">type</span> bridge</span><br><span class="line">ip l s br0 up</span><br><span class="line"><span class="comment">#然后创建两对 veth-pair</span></span><br><span class="line">ip l a veth0 <span class="built_in">type</span> veth peer name br-veth0</span><br><span class="line">ip l a veth1 <span class="built_in">type</span> veth peer name br-veth1</span><br><span class="line"><span class="comment">#分别将两对 veth-pair 加入两个 ns 和 br0</span></span><br><span class="line">ip l s veth0 netns ns1</span><br><span class="line">ip l s br-veth0 master br0</span><br><span class="line">ip l s br-veth0 up</span><br><span class="line">ip l s veth1 netns ns2</span><br><span class="line">ip l s br-veth1 master br0</span><br><span class="line">ip l s br-veth1 up</span><br><span class="line"><span class="comment">#开启本地回环</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip l s lo up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip l s lo up</span><br><span class="line"><span class="comment">#给两个 ns 中的 veth 配置 IP 并启用</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip a a 10.1.1.2/24 dev veth0</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip l s veth0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip a a 10.1.1.3/24 dev veth1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip l s veth1 up</span><br></pre></td></tr></table></figure>

<h2 id="OVS"><a href="#OVS" class="headerlink" title="OVS"></a>OVS</h2><p>Open vSwitch是一个高质量的、多层虚拟交换机，使用开源Apache2.0许可协议，由Nicira Networks开发，主要实现代码为可移植的C代码。它的目的是让大规模网络自动化可以通过编程扩展,同时仍然支持标准的管理接口和协议（例如NetFlow, sFlow, SPAN, RSPAN, CLI, LACP, 802.1ag）。此外,它被设计位支持跨越多个物理服务器的分布式环境，类似于VMware的vNetwork分布式vswitch或Cisco Nexus 1000 V。Open vSwitch支持多种linux 虚拟化技术，包括Xen&#x2F;XenServer， KVM和irtualBox。当前最新代码包主要包括以下模块和特性：</p>
<h3 id="安装OVS："><a href="#安装OVS：" class="headerlink" title="安装OVS："></a>安装OVS：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">yum -y install make gcc openssl-devel autoconf automake rpm-build redhat-rpm-config</span><br><span class="line">yum -y install python-devel openssl-devel kernel-devel kernel-debug-devel libtool wget</span><br><span class="line">wget http://openvswitch.org/releases/openvswitch-2.5.2.tar.gz   //需要Retry//</span><br><span class="line"><span class="built_in">mkdir</span> -p ~/rpmbuild/SOURCES</span><br><span class="line"><span class="built_in">cp</span> openvswitch-2.5.2.tar.gz ~/rpmbuild/SOURCES/</span><br><span class="line"><span class="built_in">cd</span> ~/rpmbuild/SOURCES</span><br><span class="line">tar xvfz openvswitch-2.5.2.tar.gz</span><br><span class="line">sed <span class="string">&#x27;s/openvswitch-kmod, //g&#x27;</span> openvswitch-2.5.2/rhel/openvswitch.spec &gt; openvswitch-2.5.2/rhel/openvswitch_no_kmod.spec</span><br><span class="line"><span class="comment">## 修改bug文件</span></span><br><span class="line">vim /usr/include/linux/netfilter/nf_conntrack_sctp.h</span><br><span class="line">__be32 vtag[IP_CT_DIR_MAX];</span><br><span class="line">uint8_t last_dir;</span><br><span class="line">uint8_t flags;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rpmbuild -bb --nocheck openvswitch-2.5.2/rhel/openvswitch_no_kmod.spec</span><br><span class="line">yum localinstall ~/rpmbuild/RPMS/x86_64/openvswitch-2.5.2-1.x86_64.rpm</span><br><span class="line">systemctl restart  openvswitch</span><br></pre></td></tr></table></figure>

<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p><img src="/network/index/image-20201126094227071.png" alt="image-20201126094227071"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用 ovs 提供的命令创建一个 ovs bridge</span></span><br><span class="line">ovs-vsctl add-br ovs-br</span><br><span class="line">ovs-vsctl show</span><br><span class="line">2349b536-c235-4e10-8c81-804bded82184</span><br><span class="line">    Bridge pvs-br</span><br><span class="line">        Port pvs-br</span><br><span class="line">            Interface ovs-br</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">&quot;2.5.2&quot;</span></span><br><span class="line"><span class="comment">#创建两对 veth-pair</span></span><br><span class="line">ip l a veth0 <span class="built_in">type</span> veth peer name ovs-veth0</span><br><span class="line">ip l a veth1 <span class="built_in">type</span> veth peer name ovs-veth1</span><br><span class="line"><span class="comment">#将 veth-pair 两端分别加入到 ns 和 ovs bridge 中</span></span><br><span class="line">ip l s veth0 netns ns1</span><br><span class="line">ovs-vsctl add-port ovs-br ovs-veth0</span><br><span class="line">ip l s ovs-veth0 up</span><br><span class="line">ip l s veth1 netns ns2</span><br><span class="line">ovs-vsctl add-port ovs-br ovs-veth1</span><br><span class="line">ip l s ovs-veth1 up</span><br><span class="line"><span class="comment">#给 ns 中的 veth 配置 IP 并启用</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip a a 10.1.1.2/24 dev veth0</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip l s veth0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip a a 10.1.1.3/24 dev veth1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip l s veth1 up</span><br></pre></td></tr></table></figure>

<h3 id="OpenStack计算节点拓扑"><a href="#OpenStack计算节点拓扑" class="headerlink" title="OpenStack计算节点拓扑"></a>OpenStack计算节点拓扑</h3><p><img src="/network/index/image-20201126094310012.png"></p>
<h2 id="Linux-IP-FORWARD"><a href="#Linux-IP-FORWARD" class="headerlink" title="Linux IP FORWARD"></a>Linux IP FORWARD</h2><p>&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward &#x3D; 1</p>
<p><img src="/network/index/image-20201126143149738.png" alt="image-20201126143149738"></p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建两个 namespace：</span></span><br><span class="line">ip netns add ns1</span><br><span class="line">ip netns add ns2</span><br><span class="line"><span class="comment">#创建两对 veth-pair，一端分别挂在两个 namespace 中：</span></span><br><span class="line">ip <span class="built_in">link</span> add v1 <span class="built_in">type</span> veth peer name v1_r</span><br><span class="line">ip <span class="built_in">link</span> add v2 <span class="built_in">type</span> veth peer name v2_r</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> v1 netns ns1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> v2 netns ns2</span><br><span class="line"><span class="comment">#分别给两对 veth-pair 端点配上 IP 并启用：</span></span><br><span class="line">ip a a 10.1.1.1/24 dev v1_r</span><br><span class="line">ip l s v1_r up</span><br><span class="line">ip a a 10.1.2.1/24 dev v2_r</span><br><span class="line">ip l s v2_r up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip a a 10.1.1.2/24 dev v1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip l s v1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip a a 10.1.2.2/24 dev v2</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip l s v2 up</span><br><span class="line"><span class="comment">#添加路由：</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 route add -net 10.1.2.0 netmask 255.255.255.0 gw 10.1.1.1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 route add -net 10.1.1.0 netmask 255.255.255.0 gw 10.1.2.1</span><br><span class="line"><span class="comment">#修改内核转发：</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>

<h2 id="Docker-Network-Routing-table"><a href="#Docker-Network-Routing-table" class="headerlink" title="Docker Network[Routing table]"></a>Docker Network[Routing table]</h2><p><img src="/network/index/image-20201126160825399.png" alt="image-20201126160825399"></p>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node-2 $ docker network create net_18 --subnet=172.18.0.0/16</span><br><span class="line">node-1 $ docker run -d --name nginx nginx</span><br><span class="line">node-2 $ docker run -d --name nginx --network=net_18 nginx</span><br><span class="line">node-1 $ route add -net 172.17.0.0 netmask 255.255.0.0 gw 172.12.1.11</span><br><span class="line">node-2 $ route add -net 172.17.0.0 netmask 255.255.0.0 gw 172.12.1.10</span><br><span class="line"><span class="comment"># 互ping能通</span></span><br></pre></td></tr></table></figure>

<h2 id="IPIP-Mode"><a href="#IPIP-Mode" class="headerlink" title="IPIP Mode"></a>IPIP Mode</h2><p><img src="/network/index/image-20201126160834808.png" alt="image-20201126160834808"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建ns</span></span><br><span class="line">ip netns add ns1</span><br><span class="line">ip netns add ns2</span><br><span class="line"><span class="comment"># 添加虚拟网卡对</span></span><br><span class="line">ip <span class="built_in">link</span> add v1 <span class="built_in">type</span> veth peer name v1_r</span><br><span class="line">ip <span class="built_in">link</span> add v2 <span class="built_in">type</span> veth peer name v2_r</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> v1 netns ns1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> v2 netns ns2</span><br><span class="line"><span class="comment"># 添加地址</span></span><br><span class="line">ip a a 10.10.10.1/24 dev v1_r</span><br><span class="line">ip l s v1_r up</span><br><span class="line">ip a a 10.10.20.1/24 dev v2_r</span><br><span class="line">ip l s v2_r up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip a a 10.10.10.2/24 dev v1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip l s v1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip a a 10.10.20.2/24 dev v2</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip l s v2 up</span><br><span class="line"><span class="comment"># 添加路由</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 route add -net 10.10.20.0 netmask 255.255.255.0 gw 10.10.10.1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 route add -net 10.10.10.0 netmask 255.255.255.0 gw 10.10.20.1</span><br><span class="line"><span class="comment"># 添加ip转发</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">Kubernetes Network IPIP Mode</span><br><span class="line"><span class="comment"># 在 ns1 上创建 tun1 和 IPIP tunnel</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip tunnel add tun1 mode ipip remote 10.10.20.2 <span class="built_in">local</span> 10.10.10.2</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip l s tun1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip a a 10.10.100.10 peer 10.10.200.10 dev tun1</span><br><span class="line"><span class="comment"># 在 ns2 上创建 tun1 和 IPIP tunnel</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip tunnel add tun2 mode ipip remote 10.10.10.2 <span class="built_in">local</span> 10.10.20.2</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip l s tun2 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip a a 10.10.200.10 peer 10.10.100.10 dev tun2</span><br><span class="line"><span class="comment"># 上面的命令是在 NS1 上创建 tun 设备 tun1，并设置隧道模式为 ipip，然后还需要设置道端点，用 remote 和 local表示，这是 隧道外层 IP，对应的还有 隧道内层 IP，用 ip addr xx peer xx 配置。</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ping 10.10.200.10 -c 4</span><br><span class="line">PING 10.10.200.10 (10.10.200.10) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.10.200.10: icmp_seq=1 ttl=64 time=0.090 ms</span><br><span class="line">64 bytes from 10.10.200.10: icmp_seq=2 ttl=64 time=0.148 ms</span><br><span class="line">64 bytes from 10.10.200.10: icmp_seq=3 ttl=64 time=0.112 ms</span><br><span class="line">64 bytes from 10.10.200.10: icmp_seq=4 ttl=64 time=0.110 ms</span><br><span class="line">--- 10.10.200.10 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3000ms</span><br><span class="line">rtt min/avg/max/mdev = 0.090/0.115/0.148/0.020 ms</span><br></pre></td></tr></table></figure>

<h1 id="ARP-与-PROXY-ARP"><a href="#ARP-与-PROXY-ARP" class="headerlink" title="ARP 与 PROXY ARP"></a>ARP 与 PROXY ARP</h1><p><code>ARP（Address Resolution Protocol）</code>即地址解析协议， 用于实现从 IP 地址到 MAC 地址的映射，即询问目标IP对应的MAC地址。</p>
<p>在网络通信中，主机和主机通信的数据包需要依据OSI模型从上到下进行数据封装，当数据封装完整后，再向外发出。所以在局域网的通信中，不仅需要源目IP地址的封装，也需要源目MAC的封装。</p>
<p>一般情况下，上层应用程序更多关心IP地址而不关心MAC地址，所以需要通过ARP协议来获知目的主机的MAC地址，完成数据封装。</p>
<p><code>代理 ARP</code>是 ARP 协议的一个变种。 对于没有配置缺省网关的计算机要和其他网络中的计算机实现通信，网关收到源计算机的 ARP 请求会使用自己的 MAC 地址与目标计算机的 IP地址对源计算机进行应答。代理ARP就是将一个主机作为对另一个主机ARP进行应答。它能使得在不影响路由表的情况下添加一个新的 Router，使得子网对该主机来说变得更透明化。同时也会带来巨大的风险，除了ARP欺骗，和某个网段内的 ARP 增加，最重要的就是无法对网络拓扑进行网络概括。代理ARP的使用一般是使用在没有配置默认网关和路由策略的网络上的。</p>
<p><img src="/network/index/image-20201201143559617.png" alt="image-20201201143559617"></p>
<h2 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h2><p>在局域网中，当主机或其它三层网络设备有数据要发送给另一台主机或三层网络设备时，它需要知道对方的网络层地址（即IP地址）。</p>
<p>但是仅有IP地址是不够的，因为IP报文必须封装成帧才能通过物理网络发送，因此发送方还需要知道接收方的物理地址（即MAC地址），这就需要一个从IP地址到MAC地址的映射。</p>
<p>ARP即可以实现将IP地址解析为MAC地址。主机或三层网络设备上会维护一张ARP表，用于存储IP地址和MAC地址的关系。一般ARP表项包括动态ARP表项和静态ARP表项。</p>
<p><img src="/network/index/image-20201201204929623.png" alt="image-20201201204929623"></p>
<h2 id="Proxy-ARP"><a href="#Proxy-ARP" class="headerlink" title="Proxy ARP"></a>Proxy ARP</h2><p>背景：</p>
<ul>
<li><p>企业内部进行子网划分时，可能会出现两个子网网络属于同一网段，但是却不属于同一物理网络的情况，两个子网网络间被路由器分隔。这时可以通过修改网络内主机的路由信息，使发往其它子网的数据先发送到连接不同子网的网关设备上，再由网关设备转发此数据报文。但是这种解决方案需要配置子网中所有主机的路由，并不便于管理和维护。</p>
</li>
<li><p>在网关上部署路由式Proxy ARP功能，可以有效解决子网划分带来的管理和维护方面的问题。路由式Proxy ARP的功能可以使IP地址属于同一网段却不属于同一物理网络的主机间能够相互通信，并且主机上不需要配置缺省网关，便于管理和维护。</p>
</li>
<li><p>路由式Proxy ARP组网如图所示。Router通过接口IF1和IF2连接两个子网网络，接口IF1和接口IF2的IP地址不在同一个网段。子网1内的主机Host_1与接口IF1的IP地址在同一网段，子网2内的主机Host_2与接口IF2的IP地址在同一网段，子网1内的主机Host_1与子网2内的主机Host_2的IP地址也在同一网段。主机Host_1和Host_2上未配置缺省网关。在Router上配置路由式Proxy ARP可以使子网1和子网2内主机间能够相互通信。</p>
</li>
</ul>
<p><img src="/network/index/image-20201201205025615.png" alt="image-20201201205025615"></p>
<h2 id="Linux-Proxy-arp"><a href="#Linux-Proxy-arp" class="headerlink" title="Linux Proxy arp"></a>Linux Proxy arp</h2><p><img src="/network/index/image-20201202203950984.png" alt="image-20201202203950984"></p>
<h3 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node1</span></span><br><span class="line">ip <span class="built_in">link</span> add veth1 <span class="built_in">type</span> veth peer name eth1</span><br><span class="line">ip netns add ns0</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 netns ns0</span><br><span class="line">ip netns <span class="built_in">exec</span> ns0 ip a add 10.1.1.10/24 dev eth1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns0 ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns0 ip route add 169.254.1.1 dev eth1 scope <span class="built_in">link</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns0 ip route add default via 169.254.1.1 dev eth1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth1 up</span><br><span class="line">ip route add 10.1.1.10 dev veth1 scope <span class="built_in">link</span></span><br><span class="line">ip route add 10.1.1.20 via 172.12.1.11 dev eth0</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/veth0/proxy_arp</span><br><span class="line"><span class="comment">#node2</span></span><br><span class="line">ip <span class="built_in">link</span> add veth1 <span class="built_in">type</span> veth peer name eth1</span><br><span class="line">ip netns add ns0</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 netns ns0</span><br><span class="line">ip netns <span class="built_in">exec</span> ns0 ip a add 10.1.1.20/24 dev eth1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns0 ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns0 ip route add 169.254.1.1 dev eth1 scope <span class="built_in">link</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns0 ip route add default via 169.254.1.1 dev eth1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth1 up</span><br><span class="line">ip route add 10.1.1.20 dev veth1 scope <span class="built_in">link</span></span><br><span class="line">ip route add 10.1.1.10 via 172.12.1.10 dev eth0</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/veth0/proxy_arp</span><br></pre></td></tr></table></figure>

<h1 id="SNAT-And-DNAT"><a href="#SNAT-And-DNAT" class="headerlink" title="SNAT And DNAT"></a>SNAT And DNAT</h1><h2 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h2><p>网络地址转换NAT（Network Address Translation）是将IP数据报文头中的IP地址转换为另一个IP地址的过程。</p>
<p>随着Internet的发展和网络应用的增多，IPv4地址枯竭已成为制约网络发展的瓶颈。</p>
<p>尽管IPv6可以从根本上解决IPv4地址空间不足问题，但目前众多网络设备和网络应用大多是基于IPv4的，因此在IPv6广泛应用之前，一些过渡技术（如CIDR、私网地址等）的使用是解决这个问题最主要的技术手段。</p>
<p>NAT主要用于实现内部网络（简称内网，使用私有IP地址）访问外部网络（简称外网，使用公有IP地址）的功能。当内网的主机要访问外网时，通过NAT技术可以将其私网地址转换为公网地址，可以实现多个私网用户共用一个公网地址来访问外部网络。</p>
<img src="/network/index/image-20201209151942902.png" alt="image-20201209151942902" style="zoom:67%;">

<h2 id="Static-SNAT"><a href="#Static-SNAT" class="headerlink" title="Static SNAT"></a>Static SNAT</h2><ul>
<li><p>Static NAT，静态NAT，用于将内部本地地址（私有IP）与内部全局地址（公有IP）进行一对一的映射。缺点是需要每一个内部IP地址需独占一个宝贵的公网IP地址。即，如果某个合法IP地址已经被NAT静态地址转换定义，即使该地址当前没有被使用，也不能被用作其它的地址转换。而且这种方式是静态手工创建的NAT映射，可扩展性不高。</p>
</li>
<li><p>这种方法主要用在内网中存在需要对公网提供服务的服务器的场景，类似的例子有WEB服务器、邮件服务器、FTP服务器等。</p>
</li>
<li><p>Static NAT支持IP对IP的映射，以及端口对端口的映射。</p>
</li>
</ul>
<img src="/network/index/image-20201209152531894.png" alt="image-20201209152531894" style="zoom:67%;">

  

<p><img src="/network/index/image-20201210163735621.png" alt="image-20201210163735621"></p>
<h2 id="Linux-SNAT-源地址映射"><a href="#Linux-SNAT-源地址映射" class="headerlink" title="Linux SNAT 源地址映射"></a>Linux SNAT 源地址映射</h2><p><img src="/network/index/image-20201210163759273.png" alt="image-20201210163759273"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加br0：</span></span><br><span class="line">ip netns add ns1</span><br><span class="line">ip l a br0 <span class="built_in">type</span> bridge</span><br><span class="line">ip l s br0 up</span><br><span class="line"><span class="comment">#配置br0和veth：</span></span><br><span class="line">ip l a veth0 <span class="built_in">type</span> veth peer name br-veth0</span><br><span class="line">ip l s veth0 netns ns1</span><br><span class="line">ip l s br-veth0 master br0</span><br><span class="line">ip l s br-veth0 up</span><br><span class="line"><span class="comment">#配置ns1中接口：</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip a a 10.1.1.2/24 dev veth0</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip l s veth0 up</span><br><span class="line">ip a a 10.1.1.1/24 dev br0</span><br><span class="line">ip l s br0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ifconfig lo up</span><br><span class="line"><span class="comment">#添加路由：</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.1.1.1</span><br><span class="line"><span class="comment">#修改内核转发：</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="comment">#添加SNAT规则：</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.1.1.0/24 ! -o br0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h2 id="Linux-DNAT-目的地址映射"><a href="#Linux-DNAT-目的地址映射" class="headerlink" title="Linux DNAT 目的地址映射"></a>Linux DNAT 目的地址映射</h2><p><img src="/network/index/image-20201210222018157.png" alt="image-20201210222018157"></p>
<h2 id="DNAT-Docker-Network-DNAT"><a href="#DNAT-Docker-Network-DNAT" class="headerlink" title="DNAT - Docker Network-DNAT"></a>DNAT - Docker Network-DNAT</h2><p><img src="/network/index/image-20201210223334115.png" alt="image-20201210223334115"></p>
<h1 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h1><p><img src="/network/index/image-20211006114818276.png" alt="image-20211006114818276"></p>
<p>我们把具有相同功能的规则的集合叫做“表”，所以说，不同功能的规则，我们可以放置在不同的表中进行管理，而 iptables已经为我们定义了4种表，每种表对应了不同的功能，而我们定义的规则也都逃脱不了这4种功能的范围。其 中包含：</p>
<p> • filter表：负责过滤功能，防火墙；内核模块：iptables_filter。 </p>
<p>• nat表：network address translation，网络地址转换功能；内核模块：iptable_nat。 </p>
<p>• mangle：拆解报文，做出修改，并重新封装 的功能；iptable_mangle。 </p>
<p>• raw表：关闭nat表上启用的连接追踪机制；iptable_raw。 </p>
<p>处理动作在iptables中被称为target，动作也可以分为基本动作和扩展动作。 </p>
<p>此处列出一些常用的动作，之后的文章会对它们进行详细的示例与总结： </p>
<ol>
<li>ACCEPT：允许数据包通过。 </li>
<li>DROP：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会 有反应。 </li>
<li>REJECT：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</li>
<li>SNAT：源地址转换，解决内网用户用同一个公网地址上网的问题。</li>
<li>MASQUERADE：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。</li>
<li>DNAT：目标地址转换。 </li>
<li>REDIRECT：在本机做端口映射。 </li>
<li>LOG：在&#x2F;var&#x2F;log&#x2F;messages文件中记录日志信息，然后将数据包传递给下一条规则，也就是说除了记录以外不对 数据包做任何其他操作，仍然让下一条规则去匹配。</li>
</ol>
<p>iptables的概念中已经提到过，在实际操作iptables的过程中，是以“表”作为操作入口的。iptables为我们预定义了4张 表，它们分别是raw表、mangle表、nat表、filter表，不同的表拥有不同的功能。</p>
<p>iptables -t filter -L </p>
<p>我们使用-t选项，指定要操作的表，使用-L选项，查看-t选项对应的表的规则，-L选项的意思是，列出规则，所以，上 述命令的含义为列出filter表的所有规则。</p>
<p><img src="/network/index/image-20211006204202554.png" alt="image-20211006204202554"></p>
<p><img src="/network/index/image-20211006204210134.png" alt="image-20211006204210134"></p>
<h1 id="TCP-与UDP"><a href="#TCP-与UDP" class="headerlink" title="TCP 与UDP"></a>TCP 与UDP</h1><p><img src="/network/index/image-20211006205938272.png" alt="image-20211006205938272"></p>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p><img src="/network/index/image-20211006205950352.png" alt="image-20211006205950352"></p>
<p><img src="/network/index/image-20211006210000839.png" alt="image-20211006210000839"></p>
<p><img src="/network/index/image-20211006210009410.png" alt="image-20211006210009410"></p>
<p><img src="/network/index/image-20211006210019737.png" alt="image-20211006210019737"></p>
<p><img src="/network/index/image-20211006210031710.png" alt="image-20211006210031710"></p>
<p><img src="/network/index/image-20211006210044109.png" alt="image-20211006210044109"></p>
<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><p><img src="/network/index/image-20211006210059925.png" alt="image-20211006210059925"></p>
<h1 id="Route-And-Switch"><a href="#Route-And-Switch" class="headerlink" title="Route And Switch"></a>Route And Switch</h1><p>在因特网中，网络连接设备用来控制网络流量和保证网络数据传输质量。常见的网络连接设备有集线器（Hub）、网桥（Bridge）、交换机（Switch）和路由器（Router）。这些设备的基本原理类似，下面就以路由器为例来介绍一下设备的基本原理。路由器是一种典型的网络连接设备，用来进行路由选择和报文转发。路由器根据收到报文的目的地址选择一条合适的路径（包含一个或多个路由器的网络），然后将报文传送到下一个路由器，路径终端的路由器负责将报文送交目的主机。</p>
<p>路由就是报文从源端到目的端的路径。当报文从路由器到目的网段有多条路由可达时，路由器可以根据路由表中最佳路由进行转发。最佳路由的选取与发现此路由的路由协议的优先级、路由的度量有关。当多条路由的协议优先级与路由度量都相同时，可以实现负载分担，缓解网络压力；当多条路由的协议优先级与路由度量不同时，可以构成路由备份，提高网络的可靠性。</p>
<p>路由是数据通信网络中最基本的要素。路由信息就是指导报文发送的路径信息，路由的过程就是报文转发的过程。</p>
<p>根据路由目的地的不同，路由可划分为：</p>
<ul>
<li><p>网段路由：目的地为网段，IPv4地址子网掩码长度小于32位或IPv6地址前缀长度小于128位。</p>
</li>
<li><p>主机路由：目的地为主机，IPv4地址子网掩码长度为32位或IPv6地址前缀长度为128位。</p>
</li>
</ul>
<p> 根据目的地与该路由器是否直接相连，路由又可划分为：</p>
<ul>
<li><p>直连路由：目的地所在网络与路由器直接相连。</p>
</li>
<li><p>间接路由：目的地所在网络与路由器非直接相连。</p>
</li>
</ul>
<p>根据目的地址类型的不同，路由还可以分为：</p>
<ul>
<li><p>单播路由：表示将报文转发的目的地址是一个单播地址。</p>
</li>
<li><p>组播路由：表示将报文转发的目的地址是一个组播地址。</p>
</li>
</ul>
<h2 id="路由过程"><a href="#路由过程" class="headerlink" title="路由过程"></a>路由过程</h2><p><img src="/network/index/image-20201212172011219.png" alt="image-20201212172011219"></p>
<h2 id="路由协议优先级"><a href="#路由协议优先级" class="headerlink" title="路由协议优先级"></a>路由协议优先级</h2><p>对于相同的目的地，不同的路由协议（包括静态路由）可能会发现不同的路由，但这些路由并不都是最优的。</p>
<p>事实上，在某一时刻，到某一目的地的当前路由仅能由唯一的路由协议来决定。</p>
<p>为了判断最优路由，各路由协议（包括静态路由）都被赋予了一个优先级，当存在多个路由信息源时，具有较高优先级（取值较小）的路由协议发现的路由将成为最优路由，并将最优路由放入本地路由表中。</p>
<p><img src="/network/index/image-20201212172159024.png" alt="image-20201212172159024"></p>
<ol>
<li>其中，0表示直接连接的路由，255表示任何来自不可信源端的路由；数值越小表明优先级越高。</li>
<li>除直连路由（DIRECT）外，各种路由协议的优先级都可由用户手工进行配置。另外，每条静态路由的优先级都可以不相同。</li>
</ol>
<h2 id="静态路由Static-Route"><a href="#静态路由Static-Route" class="headerlink" title="静态路由Static Route"></a>静态路由Static Route</h2><p>路由器根据路由转发数据包，路由可通过手动配置和使用动态路由算法计算产生，其中手动配置的路由就是静态路由。静态路由比动态路由使用更少的带宽，并且不占用CPU资源来计算和分析路由更新。但是当网络发生故障或者拓扑发生变化后，静态路由不会自动更新，必须手动重新配置。静态路由有5个主要的参数：目的地址和掩码、出接口和下一跳、优先级。</p>
<ul>
<li>目的地址和掩码:</li>
</ul>
<p>IPv4的目的地址为点分十进制格式，掩码可以用点分十进制表示，也可用掩码长度（即掩码中连续‘1’的位数）表示。当目的地址和掩码都为零时，表示静态缺省路由。</p>
<ul>
<li>出接口和下一跳地址:</li>
</ul>
<p>在配置静态路由时，根据不同的出接口类型，指定出接口和下一跳地址。</p>
<p>对于点到点类型的接口，只需指定出接口。因为指定发送接口即隐含指定了下一跳地址，这时认为与该接口相连的对端接口地址就是路由的下一跳地址。</p>
<p>对于NBMA（Non Broadcast Multiple Access）类型的接口（如ATM接口），配置下一跳IP地址。因这类接口支持点到多点网络，除了配置静态路由外，还需在链路层建立IP地址到链路层地址的映射，这种情况下，不需要指定出接口。VT接口下可以关联多个虚拟访问接口（Virtual Access Interface），这都会导致出现多个下一跳，无法唯一确定下一跳。</p>
<ul>
<li>静态路由优先级</li>
</ul>
<p>对于不同的静态路由，可以为它们配置不同的优先级，优先级数字越小优先级越高。配置到达相同目的地的多条静态路由，如果指定相同优先级，则可实现负载分担；如果指定不同优先级，则可实现路由备份。</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> dis ip routing-<span class="keyword">table</span> protocol <span class="comment">static</span></span><br></pre></td></tr></table></figure>

<h3 id="实现-4"><a href="#实现-4" class="headerlink" title="实现"></a>实现</h3><p><img src="/network/index/image-20201212175352436.png" alt="image-20201212175352436"></p>
<p><img src="/network/index/image-20201212175425963.png" alt="image-20201212175425963"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AR1</span>]</span><br><span class="line">&lt;Huawei&gt;sys</span><br><span class="line">[<span class="meta">Huawei</span>]sysname AR1</span><br><span class="line">[<span class="meta">AR1</span>]<span class="built_in">int</span> g0/<span class="number">0</span>/<span class="number">0</span></span><br><span class="line">[<span class="meta">AR1-GigabitEthernet0/0/0</span>]ip a <span class="number">192.168</span><span class="number">.12</span><span class="number">.1</span> <span class="number">24</span></span><br><span class="line">[<span class="meta">AR1-GigabitEthernet0/0/0</span>]q</span><br><span class="line">&lt;AR1&gt;dis <span class="built_in">int</span> brief</span><br><span class="line">[<span class="meta">AR1</span>]dis ip <span class="built_in">int</span> b</span><br><span class="line">[<span class="meta">AR1</span>]dis <span class="keyword">this</span></span><br><span class="line">[<span class="meta">AR1</span>]ip route-<span class="keyword">static</span> <span class="number">192.168</span><span class="number">.23</span><span class="number">.0</span> <span class="number">24</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[AR2]</span></span><br><span class="line"><span class="selector-attr">[AR2-GigabitEthernet0/0/0]</span>ip <span class="selector-tag">a</span> <span class="number">192.168</span>.<span class="number">12.2</span> <span class="number">24</span></span><br><span class="line"><span class="selector-attr">[AR2-GigabitEthernet0/0/1]</span>ip <span class="selector-tag">a</span> <span class="number">192.168</span>.<span class="number">23.1</span> <span class="number">24</span></span><br><span class="line"><span class="selector-attr">[AR2-GigabitEthernet0/0/1]</span><span class="attribute">display</span> ip routing-<span class="selector-tag">table</span></span><br></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[AR3]</span><br><span class="line">[AR3-GigabitEthernet0<span class="regexp">/0/</span><span class="number">0</span>]ip a <span class="number">192.168</span>.<span class="number">23.2</span> <span class="number">24</span></span><br><span class="line">[AR3-GigabitEthernet0<span class="regexp">/0/</span><span class="number">0</span>]ip route-<span class="keyword">static</span> <span class="number">192.168</span>.<span class="number">12.0</span> <span class="number">24</span> <span class="number">192.168</span>.<span class="number">23.1</span></span><br></pre></td></tr></table></figure>

<h3 id="Static-Route-Default-Route"><a href="#Static-Route-Default-Route" class="headerlink" title="Static Route - Default Route"></a>Static Route - Default Route</h3><p><img src="/network/index/image-20201212224347391.png" alt="image-20201212224347391"></p>
<h3 id="多出口"><a href="#多出口" class="headerlink" title="多出口"></a>多出口</h3><p><img src="/network/index/image-20201212225721976.png" alt="image-20201212225721976"></p>
<h3 id="Linux-Architecture"><a href="#Linux-Architecture" class="headerlink" title="Linux Architecture"></a>Linux Architecture</h3><p><img src="/network/index/image-20201213104311185.png" alt="image-20201213104311185"></p>
<h3 id="Linux-Static-Route"><a href="#Linux-Static-Route" class="headerlink" title="Linux Static Route"></a>Linux Static Route</h3><p>Linux系统的route命令用于显示和操作IP路由表（show&#x2F;manipulate the IP routing table)。</p>
<p>要实现两个不同的子网之间的通信，需要一台连接两个网络的路由器，或者同时位于两个网络的网关来实现。在Linux系统中，设置路由通常是为了解决以下问题：该Linux系统在一个局域网中，局域网中有一个网关，能够让机器访问internet，那么就需要将网关地址设置为该Linux机器的默认路由。</p>
<p>需要注意的是，直接在命令行下执行route命令来添加路由，不会永久保存，当网卡重启或者机器重启之后，该路由就失效了；可以在&#x2F;etc&#x2F;rc.local中添加route命令来保证该路由设置永久有效。</p>
<p><code>sysctl -w net.ipv4.ip_forward=1</code></p>
<p><img src="/network/index/image-20201213104450382.png" alt="image-20201213104450382"></p>
<h2 id="OSPFv2"><a href="#OSPFv2" class="headerlink" title="OSPFv2"></a>OSPFv2</h2><p>开放式最短路径优先OSPF（Open Shortest Path First）是IETF组织开发的一个基于链路状态的内部网关协议。目前针对IPv4协议使用的是OSPF Version 2（RFC2328）；针对IPv6协议使用OSPF Version 3（RFC2740）。如无特殊说明，本文中所指的OSPF均为OSPF Version 2。</p>
<p>目的：</p>
<p>在OSPF出现前，网络上广泛使用RIP（Routing Information Protocol）作为内部网关协议。<br>由于RIP是基于距离矢量算法的路由协议，存在着收敛慢、路由环路、可扩展性差等问题，所以逐渐被OSPF取代。<br>OSPF作为基于链路状态的协议，能够解决RIP所面临的诸多问题。此外，OSPF还有以下优点：<br>• OSPF采用组播形式收发报文，这样可以减少对其它不运行OSPF路由器的影响。<br>• OSPF支持无类型域间选路（CIDR）。<br>• OSPF支持对等价路由进行负载分担。<br>• OSPF支持报文加密。<br>由于OSPF具有以上优势，使得OSPF作为优秀的内部网关协议被快速接收并广泛使用。</p>
<p>OSPF协议具有以下特点：</p>
<p>• OSPF把自治系统AS（Autonomous System）划分成逻辑意义上的一个或多个区域；<br>• OSPF通过LSA（Link State Advertisement）的形式发布路由；<br>• OSPF依靠在OSPF区域内各设备间交互OSPF报文来达到路由信息的统一；<br>• OSPF报文封装在IP报文内，可以采用单播或组播的形式发送。</p>
<p><img src="/network/index/image-20201215150810521.png" alt="image-20201215150810521"></p>
<h3 id="实现-5"><a href="#实现-5" class="headerlink" title="实现"></a>实现</h3><p><img src="/network/index/image-20201215151916986.png" alt="image-20201215151916986"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&lt;Huawei&gt;sys</span><br><span class="line">Enter system view, <span class="built_in">return</span> user view with Ctrl+Z.</span><br><span class="line">[Huawei]sysname AR1</span><br><span class="line">[AR1]int lo0</span><br><span class="line">[AR1-LoopBack0]ip a 1.1.1.1 32</span><br><span class="line">[AR1-LoopBack0]dis this</span><br><span class="line">[V200R003C00]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255 </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">return</span></span><br><span class="line">[AR1-LoopBack0]q</span><br><span class="line">[AR1]int g0/0/0</span><br><span class="line">[AR1-GigabitEthernet0/0/0]ip a 10.1.12.1 24</span><br><span class="line">Dec 15 2020 15:15:57-08:00 AR1 %%01IFNET/4/LINK_STATE(l)[1]:The line protocol IP</span><br><span class="line"> on the interface GigabitEthernet0/0/0 has entered the UP state. </span><br><span class="line">[AR1-GigabitEthernet0/0/0]dis this</span><br><span class="line">[V200R003C00]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">interface GigabitEthernet0/0/0</span><br><span class="line"> ip address 10.1.12.1 255.255.255.0 </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">return</span></span><br><span class="line">[AR1-GigabitEthernet0/0/0]</span><br><span class="line"></span><br><span class="line">[AR1]ospf router-id 1.1.1.1 </span><br><span class="line">[AR1-ospf-1]area 0</span><br><span class="line">[AR1-ospf-1-area-0.0.0.0]network 1.1.1.1 0.0.0.0 <span class="comment">#宣告网络</span></span><br><span class="line">[AR1-ospf-1-area-0.0.0.0]dis ip routing-table</span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Routing Tables: Public</span><br><span class="line">         Destinations : 8        Routes : 8        </span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">        1.1.1.1/32  Direct  0    0           D   127.0.0.1       LoopBack0</span><br><span class="line">      10.1.12.0/24  Direct  0    0           D   10.1.12.1       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.1.12.1/32  Direct  0    0           D   127.0.0.1       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">    10.1.12.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line">      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line">127.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line">255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line">[AR1-ospf-1-area-0.0.0.0]network 10.1.12.0 0.0.0.255</span><br><span class="line">[AR1-ospf-1-area-0.0.0.0]dis this </span><br><span class="line">[V200R003C00]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"> area 0.0.0.0 </span><br><span class="line">  network 1.1.1.1 0.0.0.0 </span><br><span class="line">  network 10.1.12.0 0.0.0.255 </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">return</span></span><br><span class="line">[AR2-ospf-1-area-0.0.0.0]display ospf peer b</span><br><span class="line"></span><br><span class="line">	 OSPF Process 1 with Router ID 2.2.2.2</span><br><span class="line">		  Peer Statistic Information</span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"> Area Id          Interface                        Neighbor <span class="built_in">id</span>      State    </span><br><span class="line"> 0.0.0.0          GigabitEthernet0/0/0             1.1.1.1          Full        </span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line">[AR1]display ospf routing </span><br><span class="line"></span><br><span class="line">	 OSPF Process 1 with Router ID 1.1.1.1</span><br><span class="line">		  Routing Tables </span><br><span class="line"></span><br><span class="line"> Routing <span class="keyword">for</span> Network </span><br><span class="line"> Destination        Cost  Type       NextHop         AdvRouter       Area</span><br><span class="line"> 1.1.1.1/32         0     Stub       1.1.1.1         1.1.1.1         0.0.0.0</span><br><span class="line"> 10.1.12.0/24       1     Transit    10.1.12.1       1.1.1.1         0.0.0.0</span><br><span class="line"> 2.2.2.2/32         1     Stub       10.1.12.2       2.2.2.2         0.0.0.0</span><br><span class="line"></span><br><span class="line"> Total Nets: 3  </span><br><span class="line"> Intra Area: 3  Inter Area: 0  ASE: 0  NSSA: 0 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;Huawei&gt;sys</span><br><span class="line">Enter system view, <span class="keyword">return</span> user view with Ctrl+Z.</span><br><span class="line">[Huawei]sysna	</span><br><span class="line">[Huawei]sysname AR2</span><br><span class="line">[AR2]<span class="keyword">int</span> lo0</span><br><span class="line">[AR2-LoopBack0]ip a <span class="number">2.2</span>.<span class="number">2.2</span> <span class="number">32</span></span><br><span class="line">[AR2-LoopBack0]dis <span class="keyword">this</span></span><br><span class="line">[V200R003C00]</span><br><span class="line">#</span><br><span class="line"><span class="keyword">interface</span> LoopBack0</span><br><span class="line"> ip address <span class="number">2.2</span>.<span class="number">2.2</span> <span class="number">255.255</span>.<span class="number">255.255</span> </span><br><span class="line">#</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">[AR2-LoopBack0]<span class="keyword">int</span> g0<span class="regexp">/0/</span><span class="number">0</span></span><br><span class="line">[AR2-GigabitEthernet0<span class="regexp">/0/</span><span class="number">0</span>]ip a <span class="number">10.1</span>.<span class="number">12.2</span> <span class="number">24</span></span><br><span class="line">Dec <span class="number">15</span> <span class="number">2020</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">32</span>-<span class="number">08</span>:<span class="number">00</span> AR2 %%<span class="number">01</span>IFNET<span class="regexp">/4/</span>LINK_STATE(l)[<span class="number">0</span>]:The line protocol IP</span><br><span class="line"> on the <span class="keyword">interface</span> GigabitEthernet0<span class="regexp">/0/</span><span class="number">0</span> has entered the UP state. </span><br><span class="line">[AR2-GigabitEthernet0<span class="regexp">/0/</span><span class="number">0</span>]dis <span class="keyword">this</span></span><br><span class="line">[V200R003C00]</span><br><span class="line">#</span><br><span class="line"><span class="keyword">interface</span> GigabitEthernet0<span class="regexp">/0/</span><span class="number">0</span></span><br><span class="line"> ip address <span class="number">10.1</span>.<span class="number">12.2</span> <span class="number">255.255</span>.<span class="number">255.0</span> </span><br><span class="line">#</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">[AR2]ospf router-id <span class="number">2.2</span>.<span class="number">2.2</span></span><br><span class="line">[AR2-ospf-<span class="number">1</span>]area <span class="number">0</span></span><br><span class="line">[AR2-ospf-<span class="number">1</span>-area-<span class="number">0.0</span>.<span class="number">0.0</span>]net	</span><br><span class="line">[AR2-ospf-<span class="number">1</span>-area-<span class="number">0.0</span>.<span class="number">0.0</span>]network <span class="number">2.2</span>.<span class="number">2.2</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">[AR2-ospf-<span class="number">1</span>-area-<span class="number">0.0</span>.<span class="number">0.0</span>]netwo	</span><br><span class="line">[AR2-ospf-<span class="number">1</span>-area-<span class="number">0.0</span>.<span class="number">0.0</span>]network <span class="number">10.1</span>.<span class="number">12.0</span> <span class="number">0.0</span>.<span class="number">0.255</span></span><br></pre></td></tr></table></figure>

<h3 id="OSPFv2-Router-ID"><a href="#OSPFv2-Router-ID" class="headerlink" title="OSPFv2 - Router ID"></a>OSPFv2 - Router ID</h3><p><img src="/network/index/image-20201216203740857.png" alt="image-20201216203740857"></p>
<h3 id="OSPFv2-DR-BDR-备份"><a href="#OSPFv2-DR-BDR-备份" class="headerlink" title="OSPFv2 - DR BDR 备份"></a>OSPFv2 - DR BDR 备份</h3><p><img src="/network/index/image-20201216203758887.png" alt="image-20201216203758887"></p>
<h3 id="OSPFv2-Area-区域"><a href="#OSPFv2-Area-区域" class="headerlink" title="OSPFv2 - Area 区域"></a>OSPFv2 - Area 区域</h3><p><img src="/network/index/image-20201216203817255.png" alt="image-20201216203817255"></p>
<h3 id="OSPFv2-Muti-Area-Configuration-多区域"><a href="#OSPFv2-Muti-Area-Configuration-多区域" class="headerlink" title="OSPFv2 - Muti-Area Configuration 多区域"></a>OSPFv2 - Muti-Area Configuration 多区域</h3><p><img src="/network/index/image-20201216203837098.png" alt="image-20201216203837098"></p>
<h2 id="BGP"><a href="#BGP" class="headerlink" title="BGP"></a>BGP</h2><p><strong>定义</strong>：<br>• 边界网关协议BGP（Border Gateway Protocol）是一种实现自治系统AS（Autonomous System）之间的路由可达，并选择最佳路由的距离矢量路由协议。早期发布的三个版本分别是BGP-1、BGP-2和BGP-3，1994年开始使用BGP-4，2006年之后单播IPv4网络使用的版本是BGP-4，其他网络（如IPv6等）使用的版本是MP-BGP。</p>
<p>• MP-BGP是对BGP-4进行了扩展，来达到在不同网络中应用的目的，BGP-4原有的消息机制和路由机制并没有改变。MP-BGP在IPv6单播网络上的应用称为BGP4+，在IPv4组播网络上的应用称为MBGP（Multicast BGP）。</p>
<p><strong>目的</strong><br>• 为方便管理规模不断扩大的网络，网络被分成了不同的自治系统。1982年，外部网关协议EGP（Exterior GatewayProtocol）被用于实现在AS之间动态交换路由信息。但是EGP设计得比较简单，只发布网络可达的路由信息，而不对路由信息进行优选，同时也没有考虑环路避免等问题，很快就无法满足网络管理的要求。</p>
<p>• BGP是为取代最初的EGP而设计的另一种外部网关协议。不同于最初的EGP，BGP能够进行路由优选、避免路由环路、更高效率的传递路由和维护大量的路由信息。</p>
<p>• 虽然BGP用在AS之间传递路由信息，但并非所有AS之间传递路由信息都要运行BGP。如数据中心上行到Internet的出口上，为了避免Internet海量路由对数据中心内部网络影响，设备采用静态路由代替BGP与外部网络通信。</p>
<p><strong>受益</strong><br>BGP从多方面保证了网络的安全性、灵活性、稳定性、可靠性和高效性：</p>
<p>• BGP采用认证和GTSM的方式，保证了网络的安全性。</p>
<p>• BGP提供了丰富的路由策略，能够灵活的进行路由选路，并且能指导邻居按策略发布路由。</p>
<p>• BGP提供了路由聚合和路由衰减功能用于防止路由振荡，有效提高了网络的稳定性。</p>
<p>• BGP使用TCP作为其传输层协议（端口号为179），并支持BGP与BFD联动、BGP Tracking和BGP GR和NSR，提高了网络的可靠性。</p>
<p>• 在邻居数目多、路由量大且大多邻居有相同出口策略场景下，BGP用按组打包技术极大提高了BGP打包发包性能。</p>
<p><img src="/network/index/image-20201216214822402.png" alt="image-20201216214822402"></p>
<p><img src="/network/index/image-20201219183152754.png" alt="image-20201219183152754"></p>
<h3 id="Packet-Type"><a href="#Packet-Type" class="headerlink" title="Packet Type"></a>Packet Type</h3><p><img src="/network/index/image-20210127095134834.png" alt="image-20210127095134834"></p>
<h3 id="IBGP-And-EBGP"><a href="#IBGP-And-EBGP" class="headerlink" title="IBGP And EBGP"></a>IBGP And EBGP</h3><p><img src="/network/index/image-20210127095153219.png" alt="image-20210127095153219"></p>
<h3 id="Split-Horizon"><a href="#Split-Horizon" class="headerlink" title="Split Horizon"></a>Split Horizon</h3><p><img src="/network/index/image-20210127095207361.png" alt="image-20210127095207361"></p>
<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><p><img src="/network/index/image-20210127095223455.png" alt="image-20210127095223455"></p>
<h4 id="配置基础网络"><a href="#配置基础网络" class="headerlink" title="配置基础网络"></a>配置基础网络</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#AR1</span></span><br><span class="line">[Huawei]sysname AR1</span><br><span class="line">[AR1]int GigabitEthernet 0/0/0</span><br><span class="line">[AR1-GigabitEthernet0/0/0]ip a 10.1.12.1 24</span><br><span class="line">[AR1-GigabitEthernet0/0/0]dis this</span><br><span class="line">ip address 10.1.12.1 255.255.255.0 </span><br><span class="line"></span><br><span class="line">[AR1-GigabitEthernet0/0/0]int l 0</span><br><span class="line">[AR1-LoopBack0]ip a 1.1.1.1 32</span><br><span class="line">[AR1-LoopBack0]dis this</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255 </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#AR2</span></span><br><span class="line">[AR2]int g0/0/0</span><br><span class="line">[AR2-GigabitEthernet0/0/0]ip a 10.1.12.2 24</span><br><span class="line">[AR2-GigabitEthernet0/0/0]int g0/0/1</span><br><span class="line">[AR2-GigabitEthernet0/0/1]ip a 10.1.23.2 24</span><br><span class="line">[AR2-GigabitEthernet0/0/1]int l 0</span><br><span class="line">[AR2-LoopBack0]ip a 2.2.2.2 32</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#AR3</span></span><br><span class="line">[AR3]int g0/0/0</span><br><span class="line">[AR3-GigabitEthernet0/0/0]ip a 10.1.23.3 24</span><br><span class="line">[AR3-GigabitEthernet0/0/0]int l 0</span><br><span class="line">[AR3-LoopBack0]ip a 3.3.3.3 32</span><br></pre></td></tr></table></figure>

<h4 id="配置ospf路由"><a href="#配置ospf路由" class="headerlink" title="配置ospf路由"></a>配置ospf路由</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#AR1	</span></span><br><span class="line">[AR1]ospf router-id 1.1.1.1 </span><br><span class="line">[AR1-ospf-1]a 0</span><br><span class="line">[AR1-ospf-1-area-0.0.0.0]network 10.1.12.0 0.0.0.255</span><br><span class="line">[AR1-ospf-1-area-0.0.0.0]network 1.1.1.1 255.255.255.255</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#AR2</span></span><br><span class="line">[AR2]ospf router-id 2.2.2.2</span><br><span class="line">[AR2-ospf-1]a 0</span><br><span class="line">[AR2-ospf-1-area-0.0.0.0]network 10.1.12.0 0.0.0.255</span><br><span class="line">[AR2-ospf-1-area-0.0.0.0]network 10.1.23.0 0.0.0.255</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#AR3</span></span><br><span class="line">[AR3]ospf router-id 3.3.3.3</span><br><span class="line">[AR3-ospf-1]a 0</span><br><span class="line">[AR3-ospf-1-area-0.0.0.0]network 10.1.23.0 0.0.0.255</span><br><span class="line">[AR3-ospf-1-area-0.0.0.0]network 3.3.3.3 255.255.255.255</span><br></pre></td></tr></table></figure>

<h4 id="检查ospf"><a href="#检查ospf" class="headerlink" title="检查ospf"></a>检查ospf</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[AR1]dis<span class="built_in"> ospf peer </span>b</span><br><span class="line"></span><br><span class="line">	<span class="built_in"> OSPF </span>Process 1 with Router ID 1.1.1.1</span><br><span class="line">		 <span class="built_in"> Peer </span>Statistic Information</span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"><span class="built_in"> Area </span>Id         <span class="built_in"> Interface </span>                      <span class="built_in"> Neighbor </span>id      State    </span><br><span class="line"> 0.0.0.0          GigabitEthernet0/0/0             2.2.2.2          Full        </span><br><span class="line"> ----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[AR1-ospf-1-area-0.0.0.0]dis ospf peer b</span><br><span class="line"></span><br><span class="line">	 OSPF Process 1 with Router ID 1.1.1.1</span><br><span class="line">		  Peer Statistic Information</span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"> Area Id          Interface                        Neighbor <span class="built_in">id</span>      State    </span><br><span class="line"> 0.0.0.0          GigabitEthernet0/0/0             2.2.2.2          Full        </span><br><span class="line"> ----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h4 id="配置IBGP"><a href="#配置IBGP" class="headerlink" title="配置IBGP"></a>配置IBGP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[AR1]bgp 123</span><br><span class="line">[AR1-bgp]router-id 1.1.1.1 <span class="comment">#2.指定BGP的Router ID</span></span><br><span class="line">[AR1-bgp]peer 3.3.3.3 as-number 123 <span class="comment"># 3.配置和自己在同一个AS里边的对端需要建立BGP Peer的TCP对象。自己是2.2.2.2，对端是1.1.1.1[注意，这个后边的as-number是值的是你要建立tcp连接的对端的as 号，不是本端的。]</span></span><br><span class="line">[AR1-bgp]peer 3.3.3.3 connect-interface l0 <span class="comment"># 4.为了防止建立的BGP Peer由于端口down而出现断链，所以建议使用环回口来建立BGP 的Peer。</span></span><br><span class="line">[AR1]dis bgp routing-table </span><br><span class="line"></span><br><span class="line"> BGP Local router ID is 1.1.1.1 </span><br><span class="line"> Status codes: * - valid, &gt; - best, d - damped,</span><br><span class="line">               h - <span class="built_in">history</span>,  i - internal, s - suppressed, S - Stale</span><br><span class="line">               Origin : i - IGP, e - EGP, ? - incomplete</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> Total Number of Routes: 1</span><br><span class="line">      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn</span><br><span class="line"></span><br><span class="line"> *&gt;i  33.33.33.33/32     3.3.3.3         0          100        0      i</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[AR3]bgp 123</span><br><span class="line">[AR3-bgp]router-id 3.3.3.3 </span><br><span class="line">[AR3-bgp]peer 1.1.1.1 as-number 123</span><br><span class="line">[AR3-bgp]peer 1.1.1.1 connect-interface l0</span><br><span class="line">[AR3-bgp]dis bgp peer</span><br><span class="line"></span><br><span class="line"> BGP <span class="built_in">local</span> router ID : 3.3.3.3</span><br><span class="line"> Local AS number : 123</span><br><span class="line"> Total number of peers : 1		  Peers <span class="keyword">in</span> established state : 1</span><br><span class="line"></span><br><span class="line">  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State Pre</span><br><span class="line">fRcv</span><br><span class="line"></span><br><span class="line">  1.1.1.1         4         123        5        5     0 00:03:04 Established    </span><br><span class="line">   0</span><br><span class="line">[AR3-bgp]dis this</span><br><span class="line">[V200R003C00]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">bgp 123</span><br><span class="line"> router-id 3.3.3.3</span><br><span class="line"> peer 1.1.1.1 as-number 123 </span><br><span class="line"> peer 1.1.1.1 connect-interface LoopBack0</span><br><span class="line"> <span class="comment">#</span></span><br><span class="line"> ipv4-family unicast</span><br><span class="line">  undo synchronization</span><br><span class="line">  peer 1.1.1.1 <span class="built_in">enable</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[AR3-bgp]int L0</span><br><span class="line">[AR3-LoopBack0]ip a 3.3.3.3 32</span><br><span class="line">[AR3-bgp]int L 11</span><br><span class="line">[AR3-LoopBack11]ip a 33.33.33.33</span><br><span class="line">[AR3]bgp 123</span><br><span class="line">[AR3-bgp]router-id 3.3.3.3</span><br><span class="line">[AR3-bgp]network 33.33.33.33 32</span><br><span class="line">[AR3-bgp]dis this</span><br><span class="line">[V200R003C00]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">bgp 123</span><br><span class="line"> router-id 3.3.3.3</span><br><span class="line"> peer 1.1.1.1 as-number 123 </span><br><span class="line"> peer 1.1.1.1 connect-interface LoopBack0</span><br><span class="line"> <span class="comment">#</span></span><br><span class="line"> ipv4-family unicast</span><br><span class="line">  undo synchronization</span><br><span class="line">  network 33.33.33.33 255.255.255.255 </span><br><span class="line">  peer 1.1.1.1 <span class="built_in">enable</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">return</span></span><br></pre></td></tr></table></figure>

<h4 id="检查IBGP"><a href="#检查IBGP" class="headerlink" title="检查IBGP"></a>检查IBGP</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[AR1-ospf-1-area-0.0.0.0]<span class="keyword">dis</span> bgp peer</span><br><span class="line"></span><br><span class="line"> BGP <span class="keyword">local</span> router ID : 1.1.1.1</span><br><span class="line"> <span class="keyword">Local</span> <span class="keyword">AS</span> number : 123</span><br><span class="line"> <span class="keyword">Total</span> number of peers : 1		  Peers <span class="keyword">in</span> established state : 1</span><br><span class="line"></span><br><span class="line">  Peer            V          <span class="keyword">AS</span>  MsgRcvd  MsgSent  OutQ  Up/Down       State Pre</span><br><span class="line">fRcv</span><br><span class="line"></span><br><span class="line">  3.3.3.3         4         123        4        4     0 00:02:18 Established    </span><br><span class="line">   0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/network/index/image-20210127153848450.png" alt="image-20210127153848450"></p>
<h4 id="配置EBGP"><a href="#配置EBGP" class="headerlink" title="配置EBGP"></a>配置EBGP</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#AR4</span><br><span class="line">[AR4]<span class="keyword">int</span> g0<span class="regexp">/0/</span><span class="number">0</span></span><br><span class="line">[AR4-GigabitEthernet0<span class="regexp">/0/</span><span class="number">0</span>]ip a <span class="number">10.1</span>.<span class="number">34.4</span> <span class="number">24</span></span><br><span class="line">[AR4-GigabitEthernet0<span class="regexp">/0/</span><span class="number">0</span>]<span class="keyword">int</span> l0</span><br><span class="line">[AR4-LoopBack0]ip a <span class="number">4.4</span>.<span class="number">4.4</span> <span class="number">32</span></span><br></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[AR3]<span class="keyword">int</span> g0<span class="regexp">/0/</span><span class="number">1</span></span><br><span class="line">[AR3-GigabitEthernet0<span class="regexp">/0/</span><span class="number">1</span>]ip a <span class="number">10.1</span>.<span class="number">34.3</span> <span class="number">24</span></span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AR3</span>]bgp <span class="number">123</span></span><br><span class="line">[<span class="meta">AR3</span>]router-id <span class="number">3.3</span><span class="number">.3</span><span class="number">.3</span> </span><br><span class="line">[<span class="meta">AR3-bgp</span>]peer <span class="number">10.1</span><span class="number">.34</span><span class="number">.4</span> <span class="keyword">as</span>-number <span class="number">400</span></span><br></pre></td></tr></table></figure>

<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[AR4]bgp 400</span><br><span class="line">[AR4-bgp]router-id 4.4.4.4</span><br><span class="line">[AR4-bgp]peer 10.1.34.3 <span class="keyword">as</span>-number 123</span><br><span class="line">[AR4-bgp]<span class="keyword">dis</span> bgp peer</span><br><span class="line"> BGP <span class="keyword">local</span> router ID : 4.4.4.4</span><br><span class="line"> <span class="keyword">Local</span> <span class="keyword">AS</span> number : 400</span><br><span class="line"> <span class="keyword">Total</span> number of peers : 1		  Peers <span class="keyword">in</span> established state : 1</span><br><span class="line"></span><br><span class="line">  Peer            V          <span class="keyword">AS</span>  MsgRcvd  MsgSent  OutQ  Up/Down       State Pre</span><br><span class="line">fRcv</span><br><span class="line"></span><br><span class="line">  10.1.34.3       4         123        5        5     0 00:02:46 Established    </span><br><span class="line">   1</span><br><span class="line">[AR4-bgp]network 4.4.4.4 32</span><br></pre></td></tr></table></figure>

<h4 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[AR1-ospf-1-area-0.0.0.0]dis bgp routing-table</span><br><span class="line">   i  4.4.4.4/32         10.1.34.4       0          100        0      400i</span><br><span class="line"> *&gt;i  33.33.33.33/32     3.3.3.3         0          100        0      i</span><br><span class="line"></span><br><span class="line">[AR1-ospf-1-area-0.0.0.0]dis ip routing-table</span><br><span class="line">        1.1.1.1/32  Direct  0    0           D   127.0.0.1       LoopBack0</span><br><span class="line">        3.3.3.3/32  OSPF    10   2           D   10.1.12.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.1.12.0/24  Direct  0    0           D   10.1.12.1       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.1.12.1/32  Direct  0    0           D   127.0.0.1       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">    10.1.12.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.1.23.0/24  OSPF    10   2           D   10.1.12.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">    33.33.33.33/32  IBGP    255  0          RD   3.3.3.3         GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="BGP-RR"><a href="#BGP-RR" class="headerlink" title="BGP RR"></a>BGP RR</h3><p><img src="/network/index/image-20210212134442446.png" alt="image-20210212134442446"></p>
<h3 id="BGP-RR-mechanism"><a href="#BGP-RR-mechanism" class="headerlink" title="BGP RR mechanism"></a>BGP RR mechanism</h3><h1 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h1>
      </div>
      
      
      
    </div>

    
    


</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">屈辉</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.6m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">23:56</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
